<!DOCTYPE html>
<html lang="ru">
<head>
    <!-- ========================================= -->
    <!-- QUANTUM MESSENGER PRO v6.2               -->
    <!-- ========================================= -->
    <!-- ‚úÖ –í–°–ï –ó–í–£–ö–ò –†–ê–ë–û–¢–ê–Æ–¢                    -->
    <!-- ‚úÖ üîä –ó–≤—É–∫ –æ—Ç–ø—Ä–∞–≤–∫–∏/–ø–æ–ª—É—á–µ–Ω–∏—è            -->
    <!-- ‚úÖ üìû –†–∏–Ω–≥—Ç–æ–Ω—ã –∑–≤–æ–Ω–∫–æ–≤                   -->
    <!-- ‚úÖ üë• –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —É—á–∞—Å—Ç–Ω–∏–∫–∞–º–∏             -->
    <!-- ‚úÖ –ì–æ–ª–æ—Å–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è                   -->
    <!-- ‚úÖ üì∏ –ó–∞–≥—Ä—É–∑–∫–∞ –∞–≤–∞—Ç–∞—Ä–∞                   -->
    <!-- ‚úÖ üòÑ 30 —Ä–µ–∞–∫—Ü–∏–π –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏—è            -->
    <!-- ‚úÖ üì§ –ü–µ—Ä–µ—Å—ã–ª–∫–∞ –≤—Å–µ—Ö —Ç–∏–ø–æ–≤               -->
    <!-- ‚úÖ üë§ ¬´–ü–µ—Ä–µ—Å–ª–∞–Ω–æ –æ—Ç ...¬ª                 -->
    <!-- ‚úÖ üñº –§–æ—Ç–æ/–≥–æ–ª–æ—Å–æ–≤—ã–µ –ø–µ—Ä–µ—Å—ã–ª–∞—é—Ç—Å—è        -->
    <!-- ‚úÖ üì∑ –†–ï–ê–õ–¨–ù–ê–Ø –ö–ê–ú–ï–†–ê                    -->
    <!-- ‚úÖ üé• –ó–∞–ø–∏—Å—å –≤–∏–¥–µ–æ —Å –∫–∞–º–µ—Ä—ã              -->
    <!-- ‚úÖ üñ•Ô∏è –ó–∞—Ö–≤–∞—Ç —ç–∫—Ä–∞–Ω–∞/–æ–∫–Ω–∞                -->
    <!-- ‚úÖ üìÅ –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ—Ç–æ/–≤–∏–¥–µ–æ —Ñ–∞–π–ª–æ–≤         -->
    <!-- ‚úÖ üíæ IndexedDB: —Ñ–æ—Ç–æ/–≤–∏–¥–µ–æ/–≥–æ–ª–æ—Å        -->
    <!-- ‚úÖ üìπ –í–∏–¥–µ–æ–∑–≤–æ–Ω–æ–∫: –≤—ã–±–æ—Ä –∏—Å—Ç–æ—á–Ω–∏–∫–∞       -->
    <!-- ‚úÖ üîÄ Swap: –∫–∞–º–µ—Ä–∞ –Ω–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω         -->
    <!-- ‚úÖ üé® 10 —Ç–µ–º + –∫–∞—Å—Ç–æ–º–Ω—ã–π —Ñ–æ–Ω —á–∞—Ç–∞        -->
    <!-- ‚úÖ üöÄ GPU-—É—Å–∫–æ—Ä–µ–Ω–∏–µ –≤–∏–¥–µ–æ (–Ω–µ—Ç –ª–∞–≥–æ–≤)    -->
    <!-- ‚úÖ üéô –ê–≤—Ç–æ-–∫–æ–¥–µ–∫ –≥–æ–ª–æ—Å (–≤—Å–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞)  -->
    <!-- ========================================= -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Quantum Messenger ‚öõ Pro v6.2</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* –í—Å–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Å—Ç–∏–ª–∏ –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
        }
        /* iOS zoom prevention & mobile touch targets */
        input, textarea, select, button {
            font-size: 16px !important;
        }
        @supports (-webkit-touch-callout: none) {
            input, textarea, select {
                font-size: 16px !important;
            }
        }


        :root {
            --primary-color: #667eea;
            --secondary-color: #764ba2;
            --accent-color: #00d4ff;
            --gradient-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --gradient-secondary: linear-gradient(135deg, #00d4ff 0%, #0099ff 100%);
            --gradient-dark: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
            --background-dark: #0a0a0f;
            --background-darker: #07070b;
            --background-darkest: #050507;
            --glass-bg: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.1);
            --text-primary: #ffffff;
            --text-secondary: #b0b0d0;
            --text-glow: 0 0 10px rgba(102, 126, 234, 0.5);
            --border-color: rgba(102, 126, 234, 0.3);
            --hover-color: rgba(102, 126, 234, 0.15);
            --accent-green: #00ff9d;
            --accent-red: #ff3b5c;
            --accent-yellow: #ffd700;
            --accent-cyan: #00f7ff;
            --shadow-neon: 0 0 15px rgba(102, 126, 234, 0.5);
            --shadow-heavy: 0 10px 30px rgba(0, 0, 0, 0.5);
            --neon-effect: none;
            --security-green: #00cc66;
            --security-red: #ff4444;
            --security-yellow: #ffaa00;
        }

        .neon-active {
            --neon-effect: 0 0 10px var(--accent-color), 0 0 20px var(--accent-color);
            --primary-color: #00bfff;
            --accent-color: #00ffff;
        }

        body {
            background: var(--gradient-dark);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
            transition: all 0.3s ease;
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: 
                radial-gradient(circle at 20% 80%, rgba(102, 126, 234, 0.12) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(118, 75, 162, 0.12) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(0, 212, 255, 0.08) 0%, transparent 50%);
            pointer-events: none;
            z-index: -1;
            will-change: auto;
            transform: translateZ(0);
        }

        /* –°—Ç–∏–ª–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ */
        /* security-badge removed */

        @keyframes pulse-security {
            0%, 100% { box-shadow: 0 0 15px rgba(0, 204, 102, 0.3); }
            50% { box-shadow: 0 0 25px rgba(0, 204, 102, 0.6); }
        }

        .security-alert {
            background: rgba(255, 68, 68, 0.1);
            border: 1px solid var(--security-red);
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            animation: shake 0.5s;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        .security-status {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 600;
            margin-left: 10px;
        }

        .security-high {
            background: rgba(0, 204, 102, 0.2);
            color: var(--security-green);
            border: 1px solid var(--security-green);
        }

        .security-medium {
            background: rgba(255, 170, 0, 0.2);
            color: var(--security-yellow);
            border: 1px solid var(--security-yellow);
        }

        .security-low {
            background: rgba(255, 68, 68, 0.2);
            color: var(--security-red);
            border: 1px solid var(--security-red);
        }


        /* ===== AUTH MODAL ===== */
        #authOverlay {
            position: fixed;
            inset: 0;
            background: rgba(5, 5, 15, 0.97);
            z-index: 99999;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(20px);
        }
        #authOverlay.hidden { display: none; }
        .auth-container {
            background: rgba(12, 10, 30, 0.95);
            border: 1px solid var(--glass-border);
            border-radius: 24px;
            padding: 40px 36px;
            width: 90%;
            max-width: 420px;
            box-shadow: 0 0 60px rgba(102, 126, 234, 0.3), 0 20px 60px rgba(0,0,0,0.5);
            animation: slideIn 0.4s ease;
        }
        .auth-logo {
            text-align: center;
            margin-bottom: 30px;
        }
        .auth-logo .atom-icon {
            font-size: 60px;
            display: block;
            margin-bottom: 10px;
            filter: drop-shadow(0 0 20px rgba(102,126,234,0.7));
        }
        .auth-logo h2 {
            font-size: 24px;
            font-weight: 700;
            background: linear-gradient(90deg, #fff, #00d4ff, #667eea);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: 2px;
        }
        .auth-logo p {
            font-size: 13px;
            color: var(--text-secondary);
            margin-top: 6px;
        }
        .auth-tabs {
            display: flex;
            gap: 0;
            margin-bottom: 24px;
            border-radius: 14px;
            overflow: hidden;
            border: 1px solid var(--glass-border);
        }
        .auth-tab {
            flex: 1;
            padding: 14px;
            text-align: center;
            cursor: pointer;
            font-weight: 600;
            font-size: 15px;
            color: var(--text-secondary);
            background: var(--glass-bg);
            border: none;
            transition: all 0.3s;
        }
        .auth-tab.active {
            background: var(--gradient-primary);
            color: white;
        }
        .auth-form { display: none; }
        .auth-form.active { display: block; }
        .auth-field {
            margin-bottom: 16px;
        }
        .auth-field label {
            display: block;
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 6px;
            font-weight: 500;
        }
        .auth-field input {
            width: 100%;
            padding: 14px 16px;
            background: rgba(0,0,0,0.3);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            color: var(--text-primary);
            font-size: 16px;
            transition: all 0.3s;
            -webkit-appearance: none;
        }
        .auth-field input:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 15px rgba(0, 212, 255, 0.2);
        }
        .auth-field input::placeholder {
            color: var(--text-secondary);
            opacity: 0.6;
        }
        .auth-submit {
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: 14px;
            background: var(--gradient-primary);
            color: white;
            font-weight: 700;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 8px;
            min-height: 52px;
        }
        .auth-submit:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }
        .auth-submit:active {
            transform: translateY(0);
        }
        .auth-error {
            color: var(--accent-red);
            font-size: 13px;
            margin-top: 6px;
            display: none;
            padding: 8px 12px;
            background: rgba(255, 59, 92, 0.1);
            border-radius: 8px;
            border: 1px solid rgba(255, 59, 92, 0.2);
        }
        .auth-error.visible { display: block; }
        .auth-accounts {
            margin-top: 20px;
            border-top: 1px solid var(--glass-border);
            padding-top: 16px;
        }
        .auth-accounts-title {
            font-size: 12px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
        }
        .auth-account-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 14px;
            border-radius: 12px;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            cursor: pointer;
            margin-bottom: 8px;
            transition: all 0.2s;
            min-height: 48px;
        }
        .auth-account-item:hover {
            background: var(--hover-color);
            border-color: var(--accent-color);
        }
        .auth-account-item .acc-avatar {
            width: 36px; height: 36px;
            background: var(--gradient-primary);
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 16px; color: white; flex-shrink: 0;
        }
        .auth-account-item .acc-info { flex: 1; min-width: 0; }
        .auth-account-item .acc-name {
            font-weight: 600; font-size: 14px; color: var(--text-primary);
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .auth-account-item .acc-email {
            font-size: 12px; color: var(--text-secondary);
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .auth-account-delete {
            background: none; border: none; color: var(--accent-red);
            cursor: pointer; font-size: 14px; padding: 8px;
            border-radius: 8px; transition: all 0.2s; opacity: 0.5;
            min-width: 36px; min-height: 36px;
            display: flex; align-items: center; justify-content: center;
        }
        .auth-account-delete:hover { opacity: 1; background: rgba(255,59,92,0.1); }

        /* Logout button style */
        .logout-btn {
            width: 100%;
            padding: 14px;
            border: 1px solid var(--accent-red);
            border-radius: 12px;
            background: rgba(255, 59, 92, 0.08);
            color: var(--accent-red);
            font-weight: 600;
            font-size: 15px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            min-height: 48px;
            margin-top: 10px;
        }
        .logout-btn:hover {
            background: rgba(255, 59, 92, 0.15);
            box-shadow: 0 0 15px rgba(255, 59, 92, 0.2);
        }

        /* ===== LOADER ===== */
        #loader {
            position: fixed; top: 0; left: 0;
            width: 100%; height: 100%;
            background: #07071a;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            overflow: hidden;
            transition: opacity 0.6s cubic-bezier(.4,0,.2,1), transform 0.6s cubic-bezier(.4,0,.2,1);
        }
        #loader.hide {
            opacity: 0;
            transform: scale(1.04);
            pointer-events: none;
        }

        /* Particles background */
        .loader-particles {
            position: absolute; inset: 0;
            overflow: hidden;
            pointer-events: none;
        }
        .lp {
            position: absolute;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(102,126,234,0.6), transparent 70%);
            animation: lp-float linear infinite;
            will-change: transform, opacity;
        }
        @keyframes lp-float {
            0%   { transform: translateY(100vh) scale(0); opacity: 0; }
            10%  { opacity: 1; }
            90%  { opacity: 0.6; }
            100% { transform: translateY(-120px) scale(1); opacity: 0; }
        }

        /* Logo wrapper */
        .loader-logo-wrap {
            position: relative;
            width: 160px; height: 160px;
            display: flex; align-items: center; justify-content: center;
            margin-bottom: 32px;
        }

        /* Spinning rings */
        .loader-ring {
            position: absolute; border-radius: 50%;
            border: 2px solid transparent;
            will-change: transform;
        }
        .loader-ring-1 {
            width: 160px; height: 160px;
            border-top-color: #667eea;
            border-right-color: rgba(102,126,234,0.3);
            animation: spin1 1.8s linear infinite;
        }
        .loader-ring-2 {
            width: 130px; height: 130px;
            border-bottom-color: #00d4ff;
            border-left-color: rgba(0,212,255,0.3);
            animation: spin2 1.2s linear infinite reverse;
        }
        .loader-ring-3 {
            width: 100px; height: 100px;
            border-top-color: #764ba2;
            border-right-color: rgba(118,75,162,0.3);
            animation: spin1 2.4s linear infinite;
        }
        @keyframes spin1 { to { transform: rotate(360deg); } }
        @keyframes spin2 { to { transform: rotate(-360deg); } }

        /* Atom core */
        .loader-atom {
            position: relative;
            width: 70px; height: 70px;
            display: flex; align-items: center; justify-content: center;
        }
        .loader-atom-core {
            width: 28px; height: 28px; border-radius: 50%;
            background: radial-gradient(circle at 35% 35%, #a78bfa, #667eea, #302b63);
            box-shadow: 0 0 20px #667eea, 0 0 40px rgba(102,126,234,0.5), 0 0 60px rgba(102,126,234,0.2);
            animation: core-pulse 1.5s ease-in-out infinite;
            position: relative; z-index: 2;
        }
        @keyframes core-pulse {
            0%,100% { transform: scale(1); box-shadow: 0 0 20px #667eea, 0 0 40px rgba(102,126,234,0.5); }
            50%      { transform: scale(1.15); box-shadow: 0 0 30px #00d4ff, 0 0 60px rgba(0,212,255,0.5); }
        }

        /* Orbiting electrons */
        .loader-orbit {
            position: absolute; border-radius: 50%;
            border: 1px solid rgba(102,126,234,0.25);
        }
        .loader-orbit-1 { width: 60px; height: 60px; animation: spin1 1.4s linear infinite; }
        .loader-orbit-2 { width: 60px; height: 60px; transform: rotate(60deg); animation: spin2 1.6s linear infinite; }
        .loader-orbit-3 { width: 60px; height: 60px; transform: rotate(120deg); animation: spin1 1.8s linear infinite; }
        .loader-electron {
            position: absolute; top: -4px; left: 50%; margin-left: -4px;
            width: 8px; height: 8px; border-radius: 50%;
            background: #00d4ff;
            box-shadow: 0 0 8px #00d4ff, 0 0 16px rgba(0,212,255,0.6);
        }
        .loader-orbit-2 .loader-electron { background: #a78bfa; box-shadow: 0 0 8px #a78bfa; }
        .loader-orbit-3 .loader-electron { background: #667eea; box-shadow: 0 0 8px #667eea; }

        /* Text */
        .loader-title {
            font-size: 28px; font-weight: 700; letter-spacing: 3px;
            background: linear-gradient(90deg, #fff 0%, #00d4ff 40%, #667eea 70%, #fff 100%);
            background-size: 200% auto;
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: text-shimmer 2.5s linear infinite;
            margin-bottom: 6px;
        }
        @keyframes text-shimmer {
            0%   { background-position: 0% center; }
            100% { background-position: 200% center; }
        }
        .loader-subtitle {
            font-size: 13px; color: rgba(176,176,208,0.8);
            letter-spacing: 1px; margin-bottom: 36px;
            animation: fadeIn 1s ease both 0.5s;
        }

        /* Progress bar */
        .loader-progress-wrap {
            width: 260px; height: 3px;
            background: rgba(255,255,255,0.08);
            border-radius: 3px; overflow: hidden;
            position: relative; margin-bottom: 12px;
        }
        .loader-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #00d4ff, #764ba2);
            border-radius: 3px;
            width: 0%;
            transition: width 0.4s ease;
            box-shadow: 0 0 10px rgba(0,212,255,0.6);
            position: relative;
        }
        .loader-progress-bar::after {
            content: '';
            position: absolute; right: 0; top: 50%;
            transform: translateY(-50%);
            width: 6px; height: 6px; border-radius: 50%;
            background: #fff;
            box-shadow: 0 0 6px #00d4ff;
        }
        .loader-step-text {
            font-size: 11px; color: rgba(102,126,234,0.9);
            letter-spacing: 1px; height: 16px;
            animation: fadeIn 0.3s ease;
        }

        /* Scan line effect */
        #loader::after {
            content: '';
            position: absolute; top: 0; left: 0;
            width: 100%; height: 2px;
            background: linear-gradient(90deg, transparent, #00d4ff, transparent);
            animation: scan 3s linear infinite;
            opacity: 0.4;
        }
        @keyframes scan {
            0%   { top: 0%; }
            100% { top: 100%; }
        }

        /* HEX grid decoration */
        .loader-hex-bg {
            position: absolute; inset: 0;
            background-image:
                repeating-linear-gradient(0deg, rgba(102,126,234,0.03) 0px, transparent 1px, transparent 40px, rgba(102,126,234,0.03) 40px),
                repeating-linear-gradient(90deg, rgba(102,126,234,0.03) 0px, transparent 1px, transparent 40px, rgba(102,126,234,0.03) 40px);
            pointer-events: none;
        }

        .logo { font-size: 100px; margin-bottom: 30px; position: relative; }
        .molecule {
            font-size: 100px;
            background: var(--gradient-primary);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
            filter: drop-shadow(0 0 20px rgba(102,126,234,0.7));
        }
        @keyframes float {
            0%,100% { transform: translateY(0px) rotate(0deg); }
            50% { transform: translateY(-20px) rotate(180deg); }
        }

        @keyframes pulse-glow {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ */
        #app {
            display: none;
            height: 100vh;
            animation: fadeIn 0.5s ease;
        }
        /* Fallback: –µ—Å–ª–∏ JS –∑–∞–≤–∏—Å, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º authOverlay */
        #authOverlay:not(.hidden) {
            display: flex !important;
        }

        .container {
            display: flex;
            height: 100%;
        }

        /* –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å - Glassmorphism */
        .sidebar {
            width: 280px;
            background: rgba(12, 10, 30, 0.92);
            border-right: 1px solid var(--glass-border);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            box-shadow: var(--shadow-heavy);
            border-radius: 0 20px 20px 0;
            margin: 10px 0 10px 10px;
            contain: layout;
        }

        /* –ß–∞—Ç –æ–±–ª–∞—Å—Ç—å */
        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: transparent;
            margin: 10px 10px 10px 0;
        }

        /* –ü—Ä–æ—Ñ–∏–ª—å */
        .profile {
            padding: 20px;
            border-bottom: 1px solid var(--glass-border);
            display: flex;
            align-items: center;
            gap: 15px;
            background: rgba(12, 10, 30, 0.85);
            border-radius: 15px 15px 0 0;
            margin: 15px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        }

        .user-avatar {
            width: 50px;
            height: 50px;
            background: var(--gradient-primary);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            cursor: pointer;
            border: 2px solid var(--accent-color);
            box-shadow: var(--shadow-neon);
            transition: all 0.3s ease;
            overflow: hidden;        /* ‚Üê –∫–ª—é—á–µ–≤–æ–µ: img –Ω–µ –≤—ã–ª–µ–∑–∞–µ—Ç */
            position: relative;      /* ‚Üê –∫–ª—é—á–µ–≤–æ–µ: img –∞–±—Å–æ–ª—é—Ç–Ω–æ –≤–Ω—É—Ç—Ä–∏ */
            flex-shrink: 0;
        }

        /* –ö–∞—Ä—Ç–∏–Ω–∫–∞ –≤–Ω—É—Ç—Ä–∏ –∞–≤–∞—Ç–∞—Ä–∞ —Å–∞–π–¥–±–∞—Ä–∞ */
        .user-avatar img {
            position: absolute;
            inset: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
            display: block;
        }

        .user-avatar:hover {
            transform: scale(1.1);
            box-shadow: 0 0 25px var(--accent-color);
        }

        .profile-info {
            flex: 1;
        }

        .profile-info h3 {
            font-size: 16px;
            font-weight: 600;
            background: linear-gradient(45deg, #fff, var(--accent-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .profile-info p {
            font-size: 13px;
            color: var(--text-secondary);
        }

        /* ID –±–µ–π–¥–∂ */
        .id-badge {
            background: var(--gradient-secondary);
            color: white;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            margin-top: 5px;
            display: inline-block;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid var(--accent-color);
            box-shadow: 0 0 8px rgba(0, 212, 255, 0.3);
        }

        .id-badge:hover {
            transform: scale(1.05);
            box-shadow: 0 0 15px var(--accent-color);
        }

        .profile-actions {
            display: flex;
            gap: 10px;
        }

        .profile-btn {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            color: var(--text-secondary);
            cursor: pointer;
            padding: 8px;
            border-radius: 10px;
            font-size: 18px;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .profile-btn:hover {
            background: var(--hover-color);
            color: var(--accent-color);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 212, 255, 0.3);
        }

        /* –ü–æ–∏—Å–∫ */
        .search-box {
            padding: 15px;
            position: relative;
            margin: 0 15px;
        }

        .search-input {
            width: 100%;
            padding: 12px 20px 12px 45px;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            font-size: 14px;
            color: var(--text-primary);
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 15px rgba(0, 212, 255, 0.3);
        }

        .search-input::placeholder {
            color: var(--text-secondary);
        }

        .search-icon {
            position: absolute;
            left: 25px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--accent-color);
        }

        .search-results {
            position: absolute;
            top: 100%;
            left: 15px;
            right: 15px;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            margin-top: 10px;
            max-height: 300px;
            overflow-y: auto;
            display: none;
            z-index: 100;
            backdrop-filter: blur(20px);
            box-shadow: var(--shadow-heavy);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .search-result-item {
            padding: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            transition: all 0.3s ease;
        }

        .search-result-item:last-child {
            border-bottom: none;
        }

        .search-result-item:hover {
            background: var(--hover-color);
            transform: translateX(5px);
        }

        /* –ß–∞—Ç—ã */
        .chats {
            flex: 1;
            overflow-y: auto;
            padding: 10px 15px;
        }

        .chat-item {
            padding: 0;
            border-radius: 15px;
            margin-bottom: 8px;
            cursor: pointer;
            position: relative;
            display: flex;
            align-items: stretch;
            transition: background 0.2s ease, border-color 0.2s ease;
            background: var(--glass-bg);
            border: 1px solid transparent;
            overflow: hidden;
        }

        .chat-item:hover {
            background: var(--hover-color);
            border-color: var(--glass-border);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .chat-item.active {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.2), rgba(118, 75, 162, 0.2));
            border-color: var(--accent-color);
            box-shadow: 0 0 20px rgba(102, 126, 234, 0.3);
        }

        .chat-avatar {
            font-size: 22px;
            width: 45px;
            height: 45px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background: var(--gradient-primary);
            color: white;
            position: relative;
        }

        .chat-info {
            flex: 1;
            min-width: 0;
        }

        .chat-name {
            font-weight: 600;
            font-size: 15px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            color: var(--text-primary);
        }

        .chat-last-message {
            font-size: 13px;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .chat-meta {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 5px;
            flex-shrink: 0;
            position: relative;
            z-index: 1;
        }

        /* ===== TG-STYLE 3D PIN PANEL ===== */

        /* 3D-–≥—Ä–∞–Ω—å ‚Äî –∞–±—Å–æ–ª—é—Ç–Ω–∞—è –ø–∞–Ω–µ–ª—å —Å–ø—Ä–∞–≤–∞ */
        .chat-pin-panel {
            position: absolute;
            right: -88px;
            top: 0;
            height: 100%;
            width: 88px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            gap: 4px;
            border-radius: 0 14px 14px 0;
            background: linear-gradient(120deg, rgba(0,180,220,0.22) 0%, rgba(102,126,234,0.32) 100%);
            border-left: 1.5px solid rgba(0,212,255,0.4);
            box-shadow: inset 5px 0 18px rgba(0,0,0,0.35), 0 0 20px rgba(0,212,255,0.12);
            transition: right 0.26s cubic-bezier(0.34, 1.1, 0.64, 1);
            cursor: pointer;
            z-index: 5;
            color: var(--accent-color);
            font-size: 11px;
            font-weight: 700;
            letter-spacing: 0.4px;
            text-align: center;
            pointer-events: none;
        }
        .chat-pin-panel::before {
            content: \'\';
            position: absolute;
            left: -1px;
            top: 12%;
            height: 76%;
            width: 3px;
            background: linear-gradient(to bottom, transparent, rgba(0,212,255,0.8), transparent);
            border-radius: 2px;
        }
        .chat-pin-panel i {
            font-size: 18px;
            margin-bottom: 2px;
            filter: drop-shadow(0 0 6px rgba(0,212,255,0.6));
        }
        .chat-pin-panel span {
            white-space: nowrap;
            font-size: 10px;
            opacity: 0.9;
        }

        /* –ó–æ–Ω–∞-—Ç—Ä–∏–≥–≥–µ—Ä ‚Äî –ø—Ä–∞–≤—ã–µ 52px –∫–∞—Ä—Ç–æ—á–∫–∏ */
        .chat-pin-trigger {
            position: absolute;
            right: 0;
            top: 0;
            width: 52px;
            height: 100%;
            z-index: 3;
            cursor: default;
        }

        /* –°–æ—Å—Ç–æ—è–Ω–∏–µ reveal: –∫–æ–Ω—Ç–µ–Ω—Ç —É–µ–∑–∂–∞–µ—Ç –≤–ª–µ–≤–æ, –ø–∞–Ω–µ–ª—å –≤—ã–µ–∑–∂–∞–µ—Ç */
        .chat-item.pin-reveal .chat-content-shift {
            transform: translateX(-88px) perspective(500px) rotateY(4deg);
        }
        .chat-item.pin-reveal .chat-pin-panel {
            right: 0;
            pointer-events: all;
            z-index: 7;
        }

        /* –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç ‚Äî –ø–ª–∞–≤–Ω–æ —Å–¥–≤–∏–≥–∞–µ—Ç—Å—è */
        .chat-content-shift {
            display: flex;
            align-items: center;
            gap: 15px;
            flex: 1;
            min-width: 0;
            padding: 12px 15px;
            transition: transform 0.26s cubic-bezier(0.34, 1.1, 0.64, 1);
            transform-origin: left center;
        }

        .chat-time {
            font-size: 12px;
            color: var(--accent-color);
        }

        .chat-unread {
            background: var(--gradient-secondary);
            color: white;
            border-radius: 50%;
            width: 22px;
            height: 22px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 600;
            box-shadow: 0 0 10px rgba(0, 212, 255, 0.5);
        }

        /* –®–∞–ø–∫–∞ —á–∞—Ç–∞ */
        .chat-header {
            padding: 15px 25px;
            background: rgba(12, 10, 30, 0.92);
            display: flex;
            align-items: center;
            gap: 15px;
            flex-shrink: 0;
            border-radius: 20px 20px 0 0;
            margin: 15px 15px 0 15px;
            border: 1px solid var(--glass-border);
            border-bottom: none;
        }

        .chat-header-info {
            flex: 1;
        }

        .chat-header-info h2 {
            font-size: 18px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        #chatTitleText {
            background: linear-gradient(45deg, #fff, var(--accent-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .chat-header-info p {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .chat-header-actions {
            display: flex;
            gap: 10px;
        }

        .chat-header-btn {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            color: var(--text-secondary);
            cursor: pointer;
            padding: 10px;
            border-radius: 12px;
            font-size: 20px;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .chat-header-btn:hover {
            background: var(--hover-color);
            color: var(--accent-color);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 212, 255, 0.3);
        }

        /* ===== –ò–ù–õ–ê–ô–ù –ü–ï–†–ï–ò–ú–ï–ù–û–í–ê–ù–ò–ï –í –ó–ê–ì–û–õ–û–í–ö–ï –ß–ê–¢–ê ===== */
        .chat-title-wrap {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            position: relative;
        }
        .chat-title-wrap:hover .rename-hint {
            opacity: 1;
            transform: translateY(0);
        }
        .rename-hint {
            font-size: 11px;
            color: var(--accent-color);
            background: rgba(0,212,255,0.12);
            border: 1px solid rgba(0,212,255,0.3);
            border-radius: 8px;
            padding: 2px 8px;
            opacity: 0;
            transform: translateY(-4px);
            transition: all 0.2s ease;
            pointer-events: none;
            white-space: nowrap;
        }
        .chat-title-input {
            background: rgba(0,0,0,0.3);
            border: 1px solid var(--accent-color);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 18px;
            font-weight: 600;
            padding: 4px 10px;
            outline: none;
            width: 200px;
            box-shadow: 0 0 12px rgba(0,212,255,0.2);
        }

        /* ===== –ó–ê–ö–†–ï–ü–õ–Å–ù–ù–´–ï –ö–û–ù–¢–ê–ö–¢–´ ===== */
        .pinned-chat-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 10px;
            border-radius: 12px;
            background: linear-gradient(135deg, rgba(102,126,234,0.15), rgba(0,212,255,0.08));
            border: 1px solid rgba(0,212,255,0.2);
            margin-bottom: 5px;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }
        .pinned-chat-item:hover {
            background: linear-gradient(135deg, rgba(102,126,234,0.25), rgba(0,212,255,0.15));
            transform: translateX(3px);
            border-color: var(--accent-color);
        }
        .pinned-chat-avatar {
            font-size: 18px;
            width: 34px;
            height: 34px;
            border-radius: 50%;
            background: var(--gradient-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            position: relative;
        }
        .pinned-chat-name {
            flex: 1;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .unpin-btn {
            opacity: 0;
            background: none;
            border: none;
            color: var(--accent-color);
            cursor: pointer;
            font-size: 11px;
            padding: 2px 4px;
            border-radius: 6px;
            transition: all 0.2s;
        }
        .pinned-chat-item:hover .unpin-btn {
            opacity: 1;
        }
        .unpin-btn:hover {
            background: rgba(255,59,92,0.15);
            color: var(--accent-red);
        }
        .pin-indicator {
            position: absolute;
            top: -3px;
            right: -3px;
            font-size: 9px;
            color: var(--accent-color);
        }


        /* –§–æ–Ω —á–∞—Ç–∞ ‚Äî —Å—Ç–∞—Ç–∏—á–Ω—ã–π, —Å—Ç–∞–≤–∏—Ç—Å—è –Ω–∞ chat-area (–Ω–µ —Å–∫—Ä–æ–ª–ª–∏—Ç—Å—è) */
        .chat-area {
            position: relative; /* –¥–ª—è —Ñ–æ–Ω–æ–≤–æ–≥–æ –ø—Å–µ–≤–¥–æ-—ç–ª–µ–º–µ–Ω—Ç–∞ */
        }
        #chatAreaBg::before {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: inherit;
            pointer-events: none;
            z-index: 0;
            background-size: cover;
            background-position: center center;
            background-repeat: no-repeat;
        }
        /* –í—Å–µ –¥–æ—á–µ—Ä–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç—ã –ø–æ–≤–µ—Ä—Ö —Ñ–æ–Ω–∞ */
        #chatAreaBg > * { position: relative; z-index: 1; }

        /* –ê–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–ª–æ–π –¥–ª—è –ø–µ—Ä–µ–ª–∏–≤–∞—é—â–∏—Ö—Å—è –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ */
        #chatPatternLayer {
            position: absolute;
            inset: 0;
            z-index: 0;
            pointer-events: none;
            border-radius: inherit;
            opacity: 0;
            transition: opacity 0.4s;
        }
        #chatPatternLayer.active { opacity: 1; }

        /* –û–≤–µ—Ä–ª–µ–π –∑–∞—Ç–µ–º–Ω–µ–Ω–∏—è –ø–æ–≤–µ—Ä—Ö —Ñ–æ—Ç–æ-—Ñ–æ–Ω–∞ */
        #chatDimOverlay {
            position: absolute;
            inset: 0;
            z-index: 1;
            pointer-events: none;
            border-radius: inherit;
            background: transparent;
            transition: background 0.3s;
        }

        .messages {
            flex: 1;
            padding: 25px;
            overflow-y: auto;
            background: transparent !important; /* —Ñ–æ–Ω –Ω–∞ parent, –Ω–µ –∑–¥–µ—Å—å */
            margin: 0 15px;
            border-radius: 0 0 20px 20px;
            overscroll-behavior: contain;
            scroll-behavior: smooth;
            position: relative;
            z-index: 2; /* –≤—ã—à–µ —Ñ–æ–Ω–∞ –∏ –æ–≤–µ—Ä–ª–µ—è */
        }

        /* ===== –ü–ï–†–ï–õ–ò–í–ê–Æ–©–ò–ï–°–Ø –ü–ê–¢–¢–ï–†–ù–´ ===== */
        @keyframes patternShift {
            0%   { background-position: 0% 0%; }
            25%  { background-position: 100% 0%; }
            50%  { background-position: 100% 100%; }
            75%  { background-position: 0% 100%; }
            100% { background-position: 0% 0%; }
        }
        @keyframes patternPulse {
            0%, 100% { opacity: 0.7; }
            50%       { opacity: 1; }
        }
        @keyframes patternHue {
            0%   { filter: hue-rotate(0deg) brightness(1); }
            33%  { filter: hue-rotate(60deg) brightness(1.1); }
            66%  { filter: hue-rotate(120deg) brightness(0.95); }
            100% { filter: hue-rotate(0deg) brightness(1); }
        }

        .pattern-animated {
            animation: patternShift 12s ease-in-out infinite, patternPulse 6s ease-in-out infinite, patternHue 16s linear infinite;
            background-size: 400% 400%;
        }
        .pattern-animated-fast {
            animation: patternShift 6s ease-in-out infinite, patternHue 10s linear infinite;
            background-size: 300% 300%;
        }

        .message {
            margin: 10px 0;
            padding: 15px 20px;
            border-radius: 20px;
            max-width: 70%;
            word-wrap: break-word;
            position: relative;
            animation: slideIn 0.25s ease;
            border: 1px solid transparent;
            contain: content;
        }

        .my-message {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.3), rgba(118, 75, 162, 0.3));
            margin-left: auto;
            border-bottom-right-radius: 5px;
            border: 1px solid rgba(102, 126, 234, 0.3);
            box-shadow: var(--neon-effect);
        }

        .their-message {
            background: var(--glass-bg);
            margin-right: auto;
            border-bottom-left-radius: 5px;
            border: 1px solid var(--glass-border);
        }

        .message-time {
            font-size: 12px;
            opacity: 0.8;
            margin-top: 5px;
            text-align: right;
            color: var(--text-secondary);
        }

        /* –í–≤–æ–¥ —Å–æ–æ–±—â–µ–Ω–∏—è */
        .input-area {
            padding: 20px;
            background: rgba(15, 12, 35, 0.9);
            flex-shrink: 0;
            border-radius: 20px;
            margin: 0 15px 15px 15px;
            border: 1px solid var(--glass-border);
        }

        .input-row {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .input-actions {
            display: flex;
            gap: 10px;
        }

        .input-btn {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            color: var(--text-secondary);
            cursor: pointer;
            padding: 10px;
            border-radius: 12px;
            font-size: 22px;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .input-btn:hover {
            background: var(--hover-color);
            color: var(--accent-color);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 212, 255, 0.3);
        }

        textarea {
            flex: 1;
            padding: 15px 20px;
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            resize: none;
            font-size: 16px;
            color: var(--text-primary);
            max-height: 120px;
            line-height: 1.4;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        textarea:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 20px rgba(0, 212, 255, 0.3);
        }

        .btn-send {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--gradient-secondary);
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            font-size: 20px;
            box-shadow: 0 5px 15px rgba(0, 212, 255, 0.3);
        }

        .btn-send:hover {
            transform: scale(1.1) rotate(90deg);
            box-shadow: 0 8px 25px rgba(0, 212, 255, 0.5);
        }

        /* –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ */
        .modal {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(5, 5, 20, 0.88);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-content {
            background: var(--glass-bg);
            padding: 30px;
            border-radius: 20px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            border: 1px solid var(--glass-border);
            box-shadow: var(--shadow-heavy);
            backdrop-filter: blur(20px);
            animation: slideIn 0.3s ease;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .modal-title {
            font-size: 24px;
            font-weight: 600;
            background: linear-gradient(45deg, #fff, var(--accent-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .close-modal {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 24px;
            padding: 8px;
            border-radius: 12px;
            transition: all 0.3s ease;
        }

        .close-modal:hover {
            background: var(--accent-red);
            color: white;
            transform: rotate(90deg);
        }

        /* –°–ø–∏—Å–æ–∫ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ */
        .contacts-list {
            flex: 1;
            overflow-y: auto;
            max-height: 400px;
        }

        .contact-item {
            padding: 15px;
            border-radius: 15px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 15px;
            transition: all 0.3s ease;
            margin-bottom: 8px;
            background: var(--glass-bg);
            border: 1px solid transparent;
        }

        .contact-item:hover {
            background: var(--hover-color);
            transform: translateX(5px);
            border-color: var(--glass-border);
        }

        .contact-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            background: var(--gradient-primary);
            color: white;
        }

        .contact-info {
            flex: 1;
        }

        .contact-name {
            font-weight: 600;
            font-size: 16px;
            color: var(--text-primary);
        }

        .contact-status {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .status-dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-online {
            background: var(--accent-green);
            box-shadow: 0 0 10px var(--accent-green);
        }

        .status-offline {
            background: var(--text-secondary);
        }

        .status-away {
            background: var(--accent-yellow);
            box-shadow: 0 0 10px var(--accent-yellow);
        }

        /* –≠–º–æ–¥–∑–∏ –ø–∞–Ω–µ–ª—å */
        .emoji-picker {
            position: absolute;
            bottom: 80px;
            right: 20px;
            background: rgba(15, 12, 41, 0.97);
            border-radius: 20px;
            padding: 15px;
            display: none;
            flex-wrap: wrap;
            gap: 6px;
            max-width: 300px;
            max-height: 260px;
            overflow-y: auto;
            border: 1px solid var(--glass-border);
            box-shadow: var(--shadow-heavy);
            z-index: 100;
        }
        .emoji-grid {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 10px;
        }

        .emoji-item {
            font-size: 24px;
            cursor: pointer;
            text-align: center;
            padding: 10px;
            border-radius: 10px;
            transition: all 0.3s ease;
            background: var(--glass-bg);
        }

        .emoji-item:hover {
            background: var(--hover-color);
            transform: scale(1.2);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        /* –ù–∞—Å—Ç—Ä–æ–π–∫–∏ */
        .settings-tabs {
            display: flex;
            gap: 5px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            overflow: visible;
            margin-bottom: 15px;
            padding: 5px;
            flex-wrap: wrap;
            /* –ñ—ë—Å—Ç–∫–æ –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–æ ‚Äî –Ω–µ —Å–∫—Ä–æ–ª–ª–∏—Ç—Å—è –≤–º–µ—Å—Ç–µ —Å –∫–æ–Ω—Ç–µ–Ω—Ç–æ–º */
            flex-shrink: 0;
            position: relative;
            z-index: 10;
        }

        .settings-tab {
            flex: 1;
            padding: 15px;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
            border-radius: 12px;
        }

        .settings-tab.active {
            background: var(--hover-color);
            color: var(--text-primary);
            font-weight: 600;
        }

        .settings-content {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
        }

        .settings-section {
            margin-bottom: 30px;
        }

        .settings-section h3 {
            font-size: 18px;
            margin-bottom: 15px;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* ===== –¢–ï–ú–ê –ö–ê–†–¢–û–ß–ö–ò ===== */
        .theme-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
            gap: 12px;
            margin-bottom: 6px;
        }
        .theme-card {
            border-radius: 16px;
            overflow: hidden;
            cursor: pointer;
            border: 3px solid transparent;
            transition: all 0.25s ease;
            position: relative;
        }
        .theme-card:hover { transform: translateY(-3px); box-shadow: 0 8px 24px rgba(0,0,0,0.4); }
        .theme-card.selected { border-color: #fff; box-shadow: 0 0 0 2px rgba(255,255,255,0.5), 0 8px 24px rgba(0,0,0,0.5); }
        .theme-card.selected::after {
            content: '‚úì';
            position: absolute;
            top: 8px; right: 8px;
            width: 22px; height: 22px;
            background: rgba(255,255,255,0.9);
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 13px; color: #000; font-weight: 700;
            line-height: 22px; text-align: center;
        }
        .theme-card-preview {
            height: 80px;
            display: flex;
            flex-direction: column;
            padding: 10px;
            gap: 5px;
            justify-content: flex-end;
        }
        .theme-card-bar {
            height: 8px;
            border-radius: 4px;
            opacity: 0.9;
        }
        .theme-card-bar:last-child { width: 60%; }
        .theme-card-name {
            padding: 8px 10px;
            font-size: 11px;
            font-weight: 600;
            letter-spacing: 0.3px;
            text-align: center;
        }

        /* ===== –§–û–ù –ß–ê–¢–ê ===== */
        .chat-bg-preview {
            width: 100%;
            height: 120px;
            border-radius: 14px;
            overflow: hidden;
            background: rgba(0,0,0,0.2);
            border: 2px dashed rgba(255,255,255,0.15);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 12px;
            position: relative;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
        }
        .chat-bg-preview-label {
            color: rgba(255,255,255,0.4);
            font-size: 13px;
            pointer-events: none;
        }
        .chat-bg-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .chat-bg-btn {
            flex: 1;
            padding: 11px 16px;
            border-radius: 12px;
            border: none;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.2s;
            background: var(--gradient-primary);
            color: white;
            min-width: 120px;
        }
        .chat-bg-btn:hover { transform: translateY(-1px); opacity: 0.9; }
        .chat-bg-btn-clear {
            background: rgba(255,59,92,0.2);
            border: 1px solid var(--accent-red);
            color: var(--accent-red);
        }
        .chat-bg-presets {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(62px, 1fr));
            gap: 8px;
        }
        .chat-bg-preset {
            height: 62px;
            border-radius: 10px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s;
            background-size: cover;
            background-position: center;
            position: relative;
            overflow: hidden;
        }
        .chat-bg-preset:hover { transform: scale(1.06); }
        .chat-bg-preset.selected { border-color: white; box-shadow: 0 0 0 1px rgba(255,255,255,0.6); }
        .chat-bg-preset-none {
            display: flex; align-items: center; justify-content: center;
            background: rgba(255,255,255,0.06);
            border: 2px dashed rgba(255,255,255,0.2);
            color: rgba(255,255,255,0.4);
            font-size: 18px;
        }

        .setting-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .setting-label {
            flex: 1;
        }

        .setting-label h4 {
            font-size: 15px;
            margin-bottom: 5px;
            color: var(--text-primary);
        }

        .setting-label p {
            font-size: 13px;
            color: var(--text-secondary);
        }

        /* –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å */
        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 30px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            transition: .4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 4px;
            bottom: 3px;
            background: var(--text-secondary);
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background: var(--gradient-primary);
            border-color: var(--accent-color);
        }

        input:checked + .slider:before {
            transform: translateX(28px);
            background: white;
        }

        /* –ê–≤–∞—Ç–∞—Ä–∫–∏ */
        .avatar-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 15px;
            margin-top: 15px;
        }

        .avatar-option {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            cursor: pointer;
            border: 2px solid transparent;
            background: var(--glass-bg);
            transition: all 0.3s ease;
        }

        .avatar-option:hover {
            border-color: var(--text-secondary);
            transform: scale(1.1);
        }

        .avatar-option.selected {
            border-color: var(--accent-color);
            transform: scale(1.1);
            box-shadow: 0 0 20px var(--accent-color);
        }

        /* –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π */
        .action-buttons {
            display: flex;
            gap: 15px;
            margin-top: 30px;
        }

        .action-btn {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            font-weight: 600;
            font-size: 15px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            backdrop-filter: blur(10px);
        }

        .action-btn-secondary {
            background: var(--glass-bg);
            color: var(--text-primary);
            border: 1px solid var(--glass-border);
        }

        .action-btn-secondary:hover {
            background: var(--hover-color);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .action-btn-primary {
            background: var(--gradient-primary);
            color: white;
            border: 1px solid var(--accent-color);
        }

        .action-btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.5);
        }

        /* –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è */
        .notification {
            position: fixed;
            top: 30px;
            right: 30px;
            background: var(--glass-bg);
            padding: 20px;
            border-radius: 15px;
            border-left: 4px solid var(--accent-color);
            box-shadow: var(--shadow-heavy);
            display: none;
            max-width: 350px;
            z-index: 1000;
            animation: slideIn 0.3s;
            border: 1px solid var(--glass-border);
            backdrop-filter: blur(20px);
        }

        /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                left: 0;
                top: 0;
                height: 100%;
                z-index: 100;
                transform: translateX(-100%);
                margin: 0;
                border-radius: 0;
                width: 85%;
            }

            .sidebar.active {
                transform: translateX(0);
            }

            .chat-area {
                margin: 0;
            }

            .mobile-menu-btn {
                display: block !important;
            }

            .back-btn {
                display: block !important;
            }

            .emoji-picker {
                bottom: 80px;
                right: 10px;
                left: 10px;
                max-height: 250px;
            }
        }

        .mobile-menu-btn {
            display: none;
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 10;
            background: var(--gradient-primary);
            color: white;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            border: none;
            font-size: 20px;
            cursor: pointer;
            box-shadow: var(--shadow-neon);
            transition: all 0.3s ease;
        }

        .mobile-menu-btn:hover {
            transform: scale(1.1);
        }

        .back-btn {
            display: none;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 24px;
            padding: 10px;
            border-radius: 12px;
            transition: all 0.3s ease;
        }

        .back-btn:hover {
            background: var(--hover-color);
            color: var(--accent-color);
        }

        /* –ó–≤–æ–Ω–æ–∫ –∏ –≤–∏–¥–µ–æ–∑–≤–æ–Ω–æ–∫ */
        .call-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--gradient-dark);
            color: white;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            backdrop-filter: blur(10px);
        }

        .call-container {
            background: var(--glass-bg);
            border-radius: 20px;
            padding: 30px;
            border: 1px solid var(--glass-border);
            text-align: center;
            max-width: 400px;
            width: 90%;
            box-shadow: var(--shadow-heavy);
        }

        .call-avatar {
            font-size: 80px;
            width: 120px;
            height: 120px;
            background: var(--gradient-primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            border: 3px solid var(--accent-color);
        }

        .call-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
        }

        .call-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: none;
            font-size: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .accept-call {
            background: var(--accent-green);
            color: white;
        }

        .reject-call {
            background: var(--accent-red);
            color: white;
        }

        .end-call {
            background: var(--accent-red);
            color: white;
            width: 70px;
            height: 70px;
        }

        .call-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 0 20px currentColor;
        }

        /* –î–æ–∫—É–º–µ–Ω—Ç—ã */
        .document-message {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 15px;
            padding: 15px;
            margin-top: 10px;
            transition: all 0.3s ease;
            max-width: 100%;
        }

        .document-content {
            display: flex;
            align-items: center;
            gap: 12px;
            text-decoration: none;
            color: inherit;
            cursor: pointer;
        }

        .document-icon {
            font-size: 28px;
            color: var(--accent-color);
        }

        .document-info {
            flex: 1;
        }

        .document-name {
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 4px;
            word-break: break-all;
        }

        .document-size {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .download-btn {
            color: var(--accent-color);
            text-decoration: none;
            font-size: 12px;
            padding: 5px 10px;
            border: 1px solid var(--accent-color);
            border-radius: 8px;
            transition: all 0.3s ease;
            background: rgba(0, 212, 255, 0.1);
        }

        .download-btn:hover {
            background: var(--accent-color);
            color: var(--background-dark);
        }

        /* –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –¥—Ä—É–≥–∞ */
        .add-friend-form {
            background: rgba(0, 0, 0, 0.2);
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
            border: 1px solid var(--glass-border);
        }

        .add-friend-form input {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--glass-border);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 16px;
        }

        .friends-list {
            margin-top: 20px;
        }

        .friend-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: var(--glass-bg);
            border-radius: 12px;
            margin-bottom: 10px;
            border: 1px solid transparent;
            transition: all 0.3s ease;
        }

        .friend-item:hover {
            border-color: var(--glass-border);
            transform: translateX(5px);
        }

        .friend-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .friend-id {
            color: var(--accent-color);
            font-size: 11px;
            opacity: 0.8;
            background: rgba(0, 212, 255, 0.1);
            padding: 2px 8px;
            border-radius: 8px;
        }

        /* –°–∫—Ä—ã—Ç—ã–π input –¥–ª—è —Ñ–∞–π–ª–æ–≤ */
        #fileInput {
            display: none;
        }

        /* –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--gradient-primary);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--gradient-secondary);
        }

        /* –ê–Ω–∏–º–∞—Ü–∏–∏ */
        .pulse {
            animation: pulse-glow 2s infinite;
        }

        .glow {
            text-shadow: var(--text-glow);
        }

        .neon-border {
            border: 2px solid var(--accent-color);
            box-shadow: 0 0 15px var(--accent-color), inset 0 0 15px var(--accent-color);
        }

        /* –£–ª—É—á—à–µ–Ω–Ω—ã–µ –∞–≤–∞—Ç–∞—Ä—ã */
        .avatar-pulse {
            position: relative;
            will-change: opacity;
        }
        
        .language-badge {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(0, 0, 0, 0.5);
            color: var(--accent-color);
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 10px;
            border: 1px solid var(--accent-color);
        }

        .message-content {
            position: relative;
        }

        .message-language {
            font-size: 10px;
            color: var(--text-secondary);
            position: absolute;
            top: -8px;
            right: 0;
            background: rgba(0, 0, 0, 0.5);
            padding: 1px 5px;
            border-radius: 8px;
            opacity: 0.7;
        }

        .language-selector {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        .language-option {
            padding: 8px 15px;
            border: 1px solid var(--glass-border);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: var(--glass-bg);
        }

        .language-option:hover {
            border-color: var(--accent-color);
            transform: translateY(-2px);
        }

        .language-option.active {
            background: var(--gradient-primary);
            border-color: var(--accent-color);
            color: white;
        }

        .friend-actions {
            display: flex;
            gap: 5px;
        }

        .action-small-btn {
            padding: 5px 10px;
            font-size: 12px;
            border-radius: 8px;
            border: 1px solid var(--glass-border);
            background: var(--glass-bg);
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .action-small-btn:hover {
            background: var(--hover-color);
            transform: translateY(-1px);
        }

        .action-small-btn.delete {
            background: rgba(255, 59, 92, 0.1);
            border-color: var(--accent-red);
            color: var(--accent-red);
        }

        .action-small-btn.delete:hover {
            background: var(--accent-red);
            color: white;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –∑–∞–≥—Ä—É–∑–∫–∏ */
        .download-progress {
            width: 100%;
            height: 3px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            margin-top: 5px;
            overflow: hidden;
            display: none;
        }

        .download-progress-bar {
            height: 100%;
            background: var(--gradient-secondary);
            width: 0%;
            transition: width 0.3s ease;
        }

        .download-complete {
            display: none;
            color: var(--accent-green);
            font-size: 11px;
            margin-top: 5px;
        }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–µ–∫ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ */
        .notification-settings {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 20px;
        }
        
        .notification-setting-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            border: 1px solid var(--glass-border);
        }
        
        .notification-setting-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .notification-badge {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 8px;
            background: var(--gradient-primary);
            color: white;
        }
        
        .notification-badge.silent {
            background: var(--accent-yellow);
        }
        
        .notification-badge.muted {
            background: var(--accent-red);
        }

        /* –í–∏–¥–µ–æ–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –∑–≤–æ–Ω–∫–æ–≤ */
        .video-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            display: none;
            z-index: 10001;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .video-wrapper {
            position: relative;
            width: 100%;
            height: 100%;
            /* –£–±–∏—Ä–∞–µ–º max-width/max-height ‚Äî –æ–Ω–∏ –æ–±—Ä–µ–∑–∞–ª–∏ —ç–∫—Ä–∞–Ω */
        }

        .remote-video {
            width: 100%;
            height: 100%;
            /* contain ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≤—Å—ë –≤–∏–¥–µ–æ —Ü–µ–ª–∏–∫–æ–º –±–µ–∑ –æ–±—Ä–µ–∑–∫–∏ */
            object-fit: contain;
            border-radius: 0;
            background: #000;
            /* GPU-—É—Å–∫–æ—Ä–µ–Ω–∏–µ ‚Äî –∏—Å–ø—Ä–∞–≤–ª—è–µ—Ç –ª–∞–≥–∏ –ø—Ä–∏ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–∏ –Ω–∞ –ü–ö */
            transform: translateZ(0);
            will-change: transform;
            backface-visibility: hidden;
        }

        /* –î–ª—è –∫–∞–º–µ—Ä—ã —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞ ‚Äî cover –≤—ã–≥–ª—è–¥–∏—Ç –ª—É—á—à–µ */
        .remote-video.mode-camera {
            object-fit: cover;
        }

        .local-video {
            position: absolute;
            bottom: 20px;
            right: 20px;
            width: 200px;
            height: 150px;
            object-fit: contain;
            border-radius: 10px;
            border: 2px solid var(--accent-color);
            z-index: 10002;
            background: #000;
            /* GPU-—É—Å–∫–æ—Ä–µ–Ω–∏–µ */
            transform: translateZ(0);
            will-change: transform;
            backface-visibility: hidden;
        }

        .video-controls {
            position: absolute;
            bottom: 40px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 20px;
            z-index: 10003;
        }

        .video-control-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            color: white;
            font-size: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .video-control-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 0 20px currentColor;
        }

        .video-control-btn.end-call {
            background: var(--accent-red);
        }

        .video-control-btn.toggle-camera {
            background: var(--accent-green);
        }

        .video-control-btn.toggle-mic {
            background: var(--accent-color);
        }

        /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏—è */
        .rename-modal {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 30px;
            max-width: 400px;
            width: 90%;
            backdrop-filter: blur(20px);
        }
        
        /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∫–∞–º–µ—Ä—ã */
        .camera-modal {
            max-width: 800px;
            width: 95%;
            height: 80vh;
        }
        
        .camera-preview {
            width: 100%;
            height: 60vh;
            background: #000;
            border-radius: 15px;
            overflow: hidden;
            position: relative;
            margin-bottom: 20px;
        }
        
        #cameraVideo {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: translateZ(0);
            will-change: transform;
            backface-visibility: hidden;
        }
        
        .camera-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 20px;
            pointer-events: none;
        }
        
        .camera-timer {
            font-size: 24px;
            color: white;
            text-align: center;
            background: rgba(0,0,0,0.5);
            padding: 10px 20px;
            border-radius: 20px;
            align-self: center;
        }
        
        .camera-controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
        }
        
        .camera-btn {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            border: none;
            font-size: 28px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        
        .capture-btn {
            background: var(--gradient-primary);
            color: white;
            box-shadow: 0 0 20px rgba(102, 126, 234, 0.5);
        }
        
        .capture-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 0 30px rgba(102, 126, 234, 0.7);
        }
        
        .flip-btn {
            background: var(--glass-bg);
            color: white;
            border: 2px solid var(--glass-border);
        }
        
        .flip-btn:hover {
            background: var(--hover-color);
            transform: scale(1.1);
        }
        
        .camera-countdown {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 100px;
            color: white;
            text-shadow: 0 0 20px rgba(0, 212, 255, 0.7);
            display: none;
        }

        /* –ü–∞–Ω–µ–ª—å –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ */
        .security-panel {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 15px;
            padding: 20px;
            margin: 15px;
            backdrop-filter: blur(10px);
        }

        .security-features {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .security-feature {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            padding: 15px;
            border-left: 4px solid var(--security-green);
        }

        .security-feature.warning {
            border-left-color: var(--security-yellow);
        }

        .security-feature.critical {
            border-left-color: var(--security-red);
        }

        .security-feature i {
            font-size: 24px;
            margin-bottom: 10px;
            display: block;
        }

        .security-feature.enabled i {
            color: var(--security-green);
        }

        .security-feature.disabled i {
            color: var(--security-red);
        }

        /* ========== –ù–û–í–´–ï TELEGRAM-–§–£–ù–ö–¶–ò–ò ========== */

        /* –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é —Å–æ–æ–±—â–µ–Ω–∏—è */
        .msg-context-menu {
            position: fixed;
            background: rgba(20, 20, 35, 0.97);
            border: 1px solid var(--glass-border);
            border-radius: 14px;
            padding: 6px 0;
            z-index: 9000;
            min-width: 180px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.5);
            backdrop-filter: blur(20px);
            animation: fadeIn 0.15s ease;
        }
        .msg-context-menu .ctx-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 16px;
            cursor: pointer;
            font-size: 14px;
            color: var(--text-primary);
            transition: background 0.15s;
        }
        .msg-context-menu .ctx-item:hover {
            background: var(--hover-color);
        }
        .msg-context-menu .ctx-item.danger {
            color: var(--accent-red);
        }
        .msg-context-menu .ctx-item i {
            width: 16px;
            color: var(--accent-color);
        }
        .msg-context-menu .ctx-item.danger i {
            color: var(--accent-red);
        }
        .ctx-separator {
            height: 1px;
            background: var(--glass-border);
            margin: 4px 0;
        }

        /* –†–µ–∞–∫—Ü–∏–∏ */
        .reactions-bar {
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
            margin-top: 6px;
        }
        .reaction-pill {
            background: rgba(102, 126, 234, 0.15);
            border: 1px solid rgba(102, 126, 234, 0.3);
            border-radius: 20px;
            padding: 2px 8px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 4px;
            color: var(--text-secondary);
        }
        .reaction-pill:hover, .reaction-pill.mine {
            background: rgba(102, 126, 234, 0.3);
            border-color: var(--accent-color);
            transform: scale(1.05);
        }
        .reaction-picker {
            position: fixed;
            background: rgba(18, 16, 32, 0.98);
            border: 1px solid rgba(102,126,234,0.35);
            border-radius: 18px;
            padding: 10px 12px;
            display: grid;
            grid-template-columns: repeat(10, 1fr);
            gap: 4px;
            z-index: 8000;
            box-shadow: 0 8px 32px rgba(0,0,0,0.6), 0 0 0 1px rgba(255,255,255,0.05);
            backdrop-filter: blur(20px);
            animation: fadeIn 0.15s ease;
            min-width: 280px;
        }
        .reaction-picker span {
            font-size: 20px;
            cursor: pointer;
            transition: transform 0.12s;
            line-height: 1;
            text-align: center;
            padding: 3px;
            border-radius: 8px;
        }
        .reaction-picker span:hover {
            transform: scale(1.5);
            background: rgba(102,126,234,0.2);
        }

        /* Reply (–æ—Ç–≤–µ—Ç –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ) */
        .reply-preview {
            background: rgba(102, 126, 234, 0.1);
            border-left: 3px solid var(--accent-color);
            border-radius: 0 8px 8px 0;
            padding: 6px 10px;
            margin-bottom: 5px;
            font-size: 13px;
            color: var(--text-secondary);
            max-width: 100%;
        }
        .reply-preview .reply-name {
            color: var(--accent-color);
            font-weight: 600;
            margin-bottom: 2px;
            font-size: 12px;
        }
        .reply-preview .reply-text {
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
        }

        /* –ú–µ—Ç–∫–∞ ¬´–ü–µ—Ä–µ—Å–ª–∞–Ω–æ –æ—Ç ...¬ª */
        .fwd-label {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 11px;
            color: var(--accent-color);
            opacity: 0.85;
            margin-bottom: 4px;
            font-style: italic;
        }
        .fwd-label i { font-size: 10px; }

        /* –ü–∞–Ω–µ–ª—å –æ—Ç–≤–µ—Ç–∞ –≤ –∏–Ω–ø—É—Ç–µ */
        #replyBar {
            display: none;
            background: rgba(102, 126, 234, 0.08);
            border-left: 3px solid var(--accent-color);
            border-radius: 8px;
            padding: 8px 12px;
            margin-bottom: 10px;
            font-size: 13px;
            color: var(--text-secondary);
            position: relative;
        }
        #replyBar .reply-to-name {
            color: var(--accent-color);
            font-weight: 600;
            font-size: 12px;
            margin-bottom: 2px;
        }
        #replyBar .cancel-reply {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 18px;
            padding: 0 4px;
            line-height: 1;
        }
        #replyBar .cancel-reply:hover { color: var(--accent-red); }

        /* –°—Ç–∞—Ç—É—Å –ø—Ä–æ—á—Ç–µ–Ω–∏—è */
        .msg-status {
            font-size: 11px;
            color: var(--accent-color);
            margin-left: 4px;
        }
        .msg-status.read { color: #00d4ff; }

        /* –ó–∞–∫—Ä–µ–ø–ª—ë–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ */
        #pinnedMsgBar {
            display: none;
            background: rgba(102, 126, 234, 0.1);
            border-bottom: 1px solid rgba(102, 126, 234, 0.2);
            padding: 8px 20px;
            margin: 0 15px;
            font-size: 13px;
            cursor: pointer;
            transition: background 0.2s;
            border-radius: 0;
            position: relative;
        }
        #pinnedMsgBar:hover { background: rgba(102, 126, 234, 0.2); }
        #pinnedMsgBar .pin-label {
            color: var(--accent-color);
            font-weight: 600;
            font-size: 11px;
        }
        #pinnedMsgBar .pin-text {
            color: var(--text-secondary);
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
            max-width: 85%;
        }
        #pinnedMsgBar .pin-close {
            position: absolute;
            right: 14px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 16px;
        }
        #pinnedMsgBar .pin-close:hover { color: var(--accent-red); }

        /* –§–æ—Ä–≤–∞—Ä–¥ */
        #forwardModal .forward-contact-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 0;
            cursor: pointer;
            border-radius: 10px;
            padding: 10px;
            transition: background 0.2s;
        }
        #forwardModal .forward-contact-item:hover {
            background: var(--hover-color);
        }
        #forwardModal .forward-contact-item input[type=checkbox] {
            width: 18px; height: 18px;
            cursor: pointer;
        }

        /* ===== BLACKLIST / –ë–õ–û–ö-–õ–ò–°–¢ ===== */
        .blacklist-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: rgba(255, 59, 92, 0.07);
            border: 1px solid rgba(255, 59, 92, 0.25);
            border-radius: 12px;
            margin-bottom: 10px;
            transition: all 0.3s ease;
        }
        .blacklist-item:hover {
            background: rgba(255, 59, 92, 0.12);
            transform: translateX(3px);
        }
        .blacklist-info { flex: 1; }
        .blacklist-name { font-weight: 600; color: var(--text-primary); }
        .blacklist-id { font-size: 11px; color: var(--accent-red); opacity: 0.8; }
        .btn-unblock {
            padding: 6px 14px;
            border-radius: 8px;
            border: 1px solid var(--accent-green);
            background: rgba(0, 255, 157, 0.1);
            color: var(--accent-green);
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
        }
        .btn-unblock:hover { background: var(--accent-green); color: #000; }
        
        /* ===== VOICE MESSAGE / –ì–û–õ–û–°–û–í–û–ï –°–û–û–ë–©–ï–ù–ò–ï ===== */
        .voice-btn-recording {
            background: rgba(255, 59, 92, 0.3) !important;
            border-color: var(--accent-red) !important;
            color: var(--accent-red) !important;
            animation: pulse-rec 1s infinite;
        }
        @keyframes pulse-rec {
            0%, 100% { box-shadow: 0 0 0 0 rgba(255,59,92,0.4); }
            50% { box-shadow: 0 0 0 8px rgba(255,59,92,0); }
        }
        .voice-message-bubble {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 4px;
            min-width: 200px;
        }
        .voice-play-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: none;
            background: var(--gradient-secondary);
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            transition: all 0.2s;
            flex-shrink: 0;
        }
        .voice-play-btn:hover { transform: scale(1.1); }
        .voice-waveform {
            flex: 1;
            height: 30px;
            display: flex;
            align-items: center;
            gap: 2px;
            cursor: pointer;
            position: relative;
        }
        .voice-bar {
            width: 3px;
            background: var(--accent-color);
            border-radius: 2px;
            opacity: 0.7;
            transition: background 0.2s;
        }
        .voice-bar.played { background: var(--accent-green); opacity: 1; }
        .voice-duration {
            font-size: 12px;
            color: var(--text-secondary);
            min-width: 35px;
            text-align: right;
        }
        
        /* Video call improved */
        #videoContainer { background: linear-gradient(135deg, #0a0a1a, #150d2e); }
        .video-call-info {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            text-align: center;
            z-index: 10003;
            background: rgba(0,0,0,0.5);
            padding: 10px 24px;
            border-radius: 24px;
            backdrop-filter: blur(16px);
            border: 1px solid rgba(255,255,255,0.1);
            display: flex;
            align-items: center;
            gap: 14px;
        }
        .video-call-name { font-size: 17px; font-weight: 600; color: white; }
        .video-call-timer { font-size: 14px; color: var(--accent-color); font-variant-numeric: tabular-nums; letter-spacing: 1px; }
        .video-source-badge {
            font-size: 11px;
            padding: 3px 10px;
            border-radius: 10px;
            font-weight: 700;
            letter-spacing: 0.5px;
        }
        .vsb-camera { background: rgba(0,255,157,0.2); color: var(--accent-green); border: 1px solid var(--accent-green); }
        .vsb-screen  { background: rgba(0,212,255,0.2); color: var(--accent-color); border: 1px solid var(--accent-color); }
        .vsb-none    { background: rgba(180,180,180,0.15); color: #aaa; border: 1px solid #555; }

        .local-video-wrapper {
            position: absolute;
            bottom: 110px;
            right: 20px;
            width: 160px;
            border-radius: 14px;
            overflow: hidden;
            border: 2px solid var(--accent-color);
            box-shadow: 0 0 24px rgba(0,212,255,0.4);
            cursor: move;
            z-index: 10002;
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        .local-video-wrapper.source-screen  { border-color: var(--accent-color); box-shadow: 0 0 24px rgba(0,212,255,0.5); }
        .local-video-wrapper.source-none    { border-color: #555; box-shadow: none; }
        .local-video-wrapper.source-camera  { border-color: var(--accent-green); box-shadow: 0 0 20px rgba(0,255,157,0.3); }
        .local-video-wrapper.source-front   { border-color: var(--accent-green); box-shadow: 0 0 20px rgba(0,255,157,0.3); }

        #localVideo {
            width: 100%;
            height: auto;
            display: block;
            border-radius: 0;
            border: none;
            position: static;
            bottom: auto;
            right: auto;
            background: #000;
            /* –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é contain ‚Äî –≤–∏–¥–Ω–æ –≤–µ—Å—å —ç–∫—Ä–∞–Ω */
            object-fit: contain;
        }
        /* –î–ª—è –∫–∞–º–µ—Ä—ã ‚Äî cover —Å–º–æ—Ç—Ä–∏—Ç—Å—è –ª—É—á—à–µ (–Ω–µ—Ç —á—ë—Ä–Ω—ã—Ö –ø–æ–ª–æ—Å) */
        .local-video-wrapper.source-camera #localVideo,
        .local-video-wrapper.source-front #localVideo {
            object-fit: cover;
            height: 120px;
        }
        /* –î–ª—è —ç–∫—Ä–∞–Ω–∞ ‚Äî contain –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω —á—Ç–æ–±—ã –≤–∏–¥–µ—Ç—å –≤–µ—Å—å —ç–∫—Ä–∞–Ω */
        .local-video-wrapper.source-screen #localVideo {
            object-fit: contain;
            height: auto;
            max-height: 200px;
        }

        .cam-placeholder {
            width: 100%;
            min-height: 90px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 8px;
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            font-size: 30px;
            color: rgba(255,255,255,0.3);
            padding: 16px 0;
        }
        .cam-placeholder span { font-size: 11px; color: rgba(255,255,255,0.35); letter-spacing: 0.5px; }

        .video-no-cam {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 15px;
            color: var(--text-secondary);
        }
        .video-no-cam i { font-size: 80px; opacity: 0.3; }
        .video-no-cam-avatar {
            width: 120px; height: 120px; border-radius: 50%;
            background: var(--gradient-primary);
            display: flex; align-items: center; justify-content: center;
            font-size: 52px;
            box-shadow: 0 0 40px rgba(102,126,234,0.4);
        }

        /* Source picker panel */
        .video-source-picker {
            position: absolute;
            bottom: 110px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(10,10,30,0.92);
            border: 1px solid rgba(255,255,255,0.12);
            border-radius: 20px;
            padding: 16px 20px;
            backdrop-filter: blur(20px);
            display: none;
            gap: 12px;
            z-index: 10010;
            box-shadow: 0 8px 40px rgba(0,0,0,0.6);
            min-width: 320px;
        }
        .video-source-picker.open { display: flex; }
        .vsp-title {
            font-size: 12px;
            color: var(--text-secondary);
            text-align: center;
            width: 100%;
            margin-bottom: 4px;
            letter-spacing: 1px;
            text-transform: uppercase;
        }
        .vsp-options { display: flex; gap: 12px; width: 100%; }
        .vsp-option {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            padding: 14px 10px;
            border-radius: 14px;
            background: rgba(255,255,255,0.06);
            border: 2px solid transparent;
            cursor: pointer;
            transition: all 0.25s;
            color: white;
        }
        .vsp-option:hover { background: rgba(255,255,255,0.12); transform: translateY(-2px); }
        .vsp-option.active { border-color: var(--accent-color); background: rgba(0,212,255,0.12); }
        .vsp-option.active.green { border-color: var(--accent-green); background: rgba(0,255,157,0.1); }
        .vsp-option i { font-size: 24px; }
        .vsp-option span { font-size: 12px; color: var(--text-secondary); text-align: center; line-height: 1.3; }

        .video-control-btn.active { background: var(--gradient-secondary) !important; color: white; }
        .video-control-btn.cam-off { background: rgba(255,59,92,0.3) !important; border-color: var(--accent-red) !important; }
        .video-controls { gap: 12px; flex-wrap: wrap; justify-content: center; max-width: 380px; }
        .video-control-btn { position: relative; }
        .video-control-btn .vbtn-label {
            position: absolute;
            bottom: -18px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 10px;
            color: rgba(255,255,255,0.5);
            white-space: nowrap;
            pointer-events: none;
        }

        /* No-camera animated background */
        .nocam-bg {
            position: absolute; inset: 0;
            background: radial-gradient(circle at 30% 40%, rgba(102,126,234,0.15) 0%, transparent 60%),
                        radial-gradient(circle at 70% 70%, rgba(118,75,162,0.12) 0%, transparent 50%);
            animation: nocam-shift 8s ease-in-out infinite alternate;
        }
        @keyframes nocam-shift {
            0%   { background-position: 0% 0%; }
            100% { background-position: 100% 100%; }
        }

        /* ===== VIDEO SWAP ===== */
        /* –ö–æ–≥–¥–∞ localVideo —Ä–∞–∑–≤—ë—Ä–Ω—É—Ç –Ω–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω */
        .local-video-wrapper.fullscreen-local {
            position: absolute;
            inset: 0;
            width: 100% !important;
            height: 100% !important;
            border-radius: 0 !important;
            border: none !important;
            box-shadow: none !important;
            cursor: default !important;
            z-index: 10001;
            transition: all 0.35s cubic-bezier(.4,0,.2,1);
            background: #000;
        }
        /* fullscreen –∫–∞–º–µ—Ä–∞ ‚Äî cover (–∫—Ä–∞—Å–∏–≤–æ –∑–∞–ø–æ–ª–Ω—è–µ—Ç) */
        .local-video-wrapper.fullscreen-local.source-camera #localVideo,
        .local-video-wrapper.fullscreen-local.source-front #localVideo {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        /* fullscreen —ç–∫—Ä–∞–Ω ‚Äî contain (–≤–µ—Å—å –∫–æ–Ω—Ç–µ–Ω—Ç –≤–∏–¥–µ–Ω) */
        .local-video-wrapper.fullscreen-local.source-screen #localVideo,
        .local-video-wrapper.fullscreen-local #localVideo {
            width: 100%;
            height: 100%;
            object-fit: contain;
            max-height: none;
        }

        /* –ö–æ–≥–¥–∞ remoteVideoArea —Å–≤—ë—Ä–Ω—É—Ç –≤ –º–∏–Ω–∏-–æ–∫–Ω–æ */
        #remoteVideoArea.minimized-remote {
            position: absolute;
            bottom: 110px;
            left: 20px;
            width: 160px !important;
            height: auto !important;
            border-radius: 14px;
            overflow: hidden;
            border: 2px solid rgba(255,255,255,0.3);
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
            z-index: 10004;
            cursor: pointer;
            transition: all 0.35s cubic-bezier(.4,0,.2,1);
            flex-direction: column;
            min-height: 90px;
        }
        #remoteVideoArea.minimized-remote .video-no-cam { font-size: 12px; padding: 10px; }
        #remoteVideoArea.minimized-remote .video-no-cam-avatar { width: 40px; height: 40px; font-size: 20px; }
        #remoteVideoArea.minimized-remote .video-no-cam > div:last-child { display: none; }
        #remoteVideoArea.minimized-remote #remoteVideoName { font-size: 11px !important; }
        #remoteVideoArea.minimized-remote .nocam-bg { display: none; }
        #remoteVideoArea.minimized-remote .remote-video {
            width: 100%;
            height: auto;
            display: block !important;
            object-fit: cover;
        }

        /* –ö–Ω–æ–ø–∫–∞ —Å–≤–∞–ø–∞ –Ω–∞ local-video-wrapper */
        .local-video-wrapper .swap-btn {
            position: absolute;
            top: 6px;
            right: 6px;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: rgba(0,0,0,0.55);
            border: 1px solid rgba(255,255,255,0.25);
            color: white;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 10010;
            transition: background 0.2s, transform 0.2s;
            backdrop-filter: blur(6px);
        }
        .local-video-wrapper .swap-btn:hover { background: rgba(0,212,255,0.4); transform: scale(1.15); }

        /* –ü–æ–¥—Å–∫–∞–∑–∫–∞ "–Ω–∞–∂–º–∏ —á—Ç–æ–±—ã –≤–µ—Ä–Ω—É—Ç—å" –ø–æ–≤–µ—Ä—Ö remote-mini */
        #remoteVideoArea.minimized-remote::after {
            content: '‚Üï';
            position: absolute;
            top: 5px;
            right: 7px;
            font-size: 14px;
            color: rgba(255,255,255,0.7);
            pointer-events: none;
        }

        /* –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è/—Å–∫—Ä—ã—Ç–∏—è */
        .local-video-wrapper {
            transition: all 0.35s cubic-bezier(.4,0,.2,1);
        }
        #remoteVideoArea {
            transition: all 0.35s cubic-bezier(.4,0,.2,1);
        }
        
        /* Blocked chat indicator */
        .blocked-badge {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            background: rgba(255,59,92,0.15);
            border: 1px solid var(--accent-red);
            color: var(--accent-red);
            padding: 4px 10px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 600;
        }
        .blocked-chat-overlay {
            background: rgba(255,59,92,0.05);
            border: 1px solid rgba(255,59,92,0.2);
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            margin: 10px 0;
            color: var(--accent-red);
            font-size: 13px;
        }
        .input-blocked {
            opacity: 0.5;
            pointer-events: none;
        }
        .blocked-bar {
            padding: 12px 20px;
            background: rgba(255,59,92,0.1);
            border-top: 1px solid rgba(255,59,92,0.2);
            text-align: center;
            color: var(--accent-red);
            font-size: 13px;
            display: none;
        }
        .blocked-bar button {
            margin-left: 15px;
            padding: 4px 12px;
            border-radius: 8px;
            border: 1px solid var(--accent-green);
            background: rgba(0,255,157,0.1);
            color: var(--accent-green);
            cursor: pointer;
            font-size: 12px;
        }

        /* ===== –ó–ê–ì–†–£–ó–ö–ê –ê–í–ê–¢–ê–†–ê v5.2 ===== */
        .av-upload-wrap {
            margin-top: 16px;
            padding: 18px;
            background: rgba(102,126,234,0.07);
            border: 1.5px dashed rgba(102,126,234,0.4);
            border-radius: 16px;
            text-align: center;
        }
        /* –ö—Ä—É–≥–ª–æ–µ –ø—Ä–µ–≤—å—é –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö */
        .av-preview-circle {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            margin: 0 auto 12px;
            border: 3px solid var(--accent-color);
            box-shadow: 0 0 18px rgba(0,212,255,0.35);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 34px;
            background: var(--gradient-primary);
            overflow: hidden;          /* ‚Üê –Ω–µ –¥–∞—ë—Ç img –≤—ã–ª–µ–∑—Ç–∏ */
            position: relative;        /* ‚Üê img –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä—É–µ—Ç—Å—è –≤–Ω—É—Ç—Ä–∏ */
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            flex-shrink: 0;
        }
        .av-preview-circle:hover {
            transform: scale(1.06);
            box-shadow: 0 0 28px rgba(0,212,255,0.6);
        }
        /* –ö–∞—Ä—Ç–∏–Ω–∫–∞ –≤–Ω—É—Ç—Ä–∏ –ø—Ä–µ–≤—å—é –Ω–∞—Å—Ç—Ä–æ–µ–∫ */
        .av-preview-circle img {
            position: absolute;
            inset: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
            display: block;
        }
        .av-hint-text {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 12px;
        }
        .av-btn-row {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }
        .av-upload-btn {
            display: inline-flex;
            align-items: center;
            gap: 7px;
            padding: 10px 18px;
            background: var(--gradient-primary);
            border: none;
            border-radius: 11px;
            color: #fff;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 14px rgba(102,126,234,0.4);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .av-upload-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 7px 22px rgba(102,126,234,0.55);
        }
        .av-remove-btn {
            display: none;
            align-items: center;
            gap: 6px;
            padding: 9px 15px;
            background: rgba(255,59,92,0.12);
            border: 1px solid var(--accent-red);
            border-radius: 10px;
            color: var(--accent-red);
            font-size: 12px;
            cursor: pointer;
            transition: background 0.2s;
        }
        .av-remove-btn:hover { background: rgba(255,59,92,0.28); }
        .av-formats-hint {
            font-size: 10px;
            color: var(--text-secondary);
            opacity: 0.6;
            margin-top: 9px;
        }

        /* ===== –£–ü–†–ê–í–õ–ï–ù–ò–ï –£–ß–ê–°–¢–ù–ò–ö–ê–ú–ò v4.3 ===== */
        .member-manage-card {
            display: flex; align-items: center; gap: 12px;
            padding: 13px 14px;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 14px; margin-bottom: 10px;
            transition: border-color 0.2s, background 0.2s;
        }
        .member-manage-card.owner-card { border-color: rgba(255,215,0,0.45); background: rgba(255,215,0,0.05); }
        .member-manage-card.admin-card  { border-color: rgba(102,126,234,0.45); background: rgba(102,126,234,0.06); }
        .member-manage-avatar { width:42px; height:42px; min-width:42px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:700; font-size:16px; color:white; }
        .member-manage-info { flex:1; min-width:0; }
        .member-manage-name { color:var(--text-primary); font-size:14px; font-weight:600; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
        .member-manage-id   { color:var(--text-secondary); font-size:11px; font-family:monospace; margin-top:2px; }
        .member-badge { display:inline-flex; align-items:center; gap:4px; padding:2px 8px; border-radius:8px; font-size:10px; font-weight:700; margin-left:5px; }
        .badge-owner { background:var(--accent-yellow); color:#000; }
        .badge-admin { background:rgba(102,126,234,0.3); color:#a78bfa; border:1px solid #a78bfa; }
        .badge-me    { background:rgba(0,212,255,0.2); color:var(--accent-color); border:1px solid var(--accent-color); }
        .member-manage-actions { display:flex; gap:6px; }
        .mmbtn { width:34px; height:34px; border-radius:50%; border:1px solid; cursor:pointer; display:flex; align-items:center; justify-content:center; font-size:13px; transition:all 0.2s; background:transparent; }
        .mmbtn-admin-on  { border-color:#a78bfa; color:#a78bfa; }
        .mmbtn-admin-on:hover  { background:#a78bfa; color:white; }
        .mmbtn-admin-off { border-color:rgba(167,139,250,0.35); color:rgba(167,139,250,0.5); }
        .mmbtn-admin-off:hover { border-color:#a78bfa; color:#a78bfa; }
        .mmbtn-kick  { border-color:var(--accent-red); color:var(--accent-red); }
        .mmbtn-kick:hover  { background:var(--accent-red); color:white; }
        .members-manage-header { display:flex; align-items:center; justify-content:space-between; margin-bottom:16px; }
        .members-manage-count { background:rgba(102,126,234,0.2); color:var(--primary-color); padding:3px 12px; border-radius:12px; font-size:12px; font-weight:600; }

        /* ===== –ù–û–í–´–ï –°–¢–ò–õ–ò –î–õ–Ø –ö–ê–ú–ï–†–´ v5.4 ===== */
        
        /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –≤—ã–±–æ—Ä–∞ –∏—Å—Ç–æ—á–Ω–∏–∫–∞ */
        .media-source-modal {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.93);
            backdrop-filter: blur(12px);
            z-index: 10003;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease;
        }

        .media-source-modal.active {
            display: flex;
        }

        .media-source-content {
            background: var(--background-darker);
            border: 1px solid var(--glass-border);
            border-radius: 22px;
            padding: 32px;
            max-width: 460px;
            width: 92%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.6);
            animation: slideInModal 0.35s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        @keyframes slideInModal {
            from { opacity: 0; transform: scale(0.88) translateY(25px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }

        .media-source-content h2 {
            font-size: 26px;
            font-weight: 700;
            margin-bottom: 28px;
            color: var(--text-primary);
            text-align: center;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .media-source-options {
            display: flex;
            flex-direction: column;
            gap: 13px;
        }

        .media-option {
            padding: 19px 22px;
            border: 2px solid var(--glass-border);
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            display: flex;
            align-items: center;
            gap: 16px;
            font-size: 16px;
            color: var(--text-primary);
            background: var(--glass-bg);
        }

        .media-option:hover {
            border-color: var(--primary-color);
            background: var(--hover-color);
            transform: translateX(10px) scale(1.02);
            box-shadow: 0 6px 25px rgba(102, 126, 234, 0.35);
        }

        .media-option:active {
            transform: translateX(8px) scale(0.98);
        }

        .media-option-icon {
            font-size: 30px;
            width: 44px;
            text-align: center;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
        }

        .media-option-text {
            flex: 1;
            font-weight: 650;
            letter-spacing: 0.3px;
        }

        .media-option-arrow {
            font-size: 22px;
            color: var(--text-secondary);
            transition: transform 0.3s;
        }

        .media-option:hover .media-option-arrow {
            transform: translateX(5px);
            color: var(--primary-color);
        }

        /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∫–∞–º–µ—Ä—ã */
        .camera-modal {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.98);
            z-index: 10004;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease;
        }

        .camera-modal.active {
            display: flex;
        }

        .camera-container {
            position: relative;
            max-width: 92%;
            max-height: 76%;
            border-radius: 22px;
            overflow: hidden;
            box-shadow: 0 0 55px rgba(102, 126, 234, 0.55), 0 0 110px rgba(118, 75, 162, 0.35);
            border: 2px solid var(--glass-border);
        }

        #cameraPreview {
            width: 100%;
            height: auto;
            display: block;
            border-radius: 20px;
        }

        .camera-recording-indicator {
            position: absolute;
            top: 22px;
            left: 22px;
            background: var(--accent-red);
            color: white;
            padding: 11px 22px;
            border-radius: 28px;
            font-weight: 750;
            display: none;
            align-items: center;
            gap: 11px;
            font-size: 15px;
            animation: pulse-recording 1.55s infinite;
            box-shadow: 0 4px 18px rgba(255, 59, 92, 0.5);
        }

        .camera-recording-indicator.active {
            display: flex;
        }

        @keyframes pulse-recording {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.75; transform: scale(1.05); }
        }

        .camera-recording-dot {
            width: 13px;
            height: 13px;
            border-radius: 50%;
            background: white;
            animation: blink-dot 1.1s infinite;
        }

        @keyframes blink-dot {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.25; }
        }

        .camera-controls {
            display: flex;
            gap: 16px;
            margin-top: 34px;
            justify-content: center;
            flex-wrap: wrap;
            padding: 0 22px;
        }

        .camera-btn {
            padding: 17px 34px;
            border: none;
            border-radius: 17px;
            font-size: 16px;
            font-weight: 730;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            display: flex;
            align-items: center;
            gap: 11px;
            box-shadow: 0 5px 18px rgba(0, 0, 0, 0.35);
            letter-spacing: 0.5px;
        }

        .camera-btn:hover {
            transform: translateY(-4px) scale(1.04);
            box-shadow: 0 8px 28px rgba(0, 0, 0, 0.45);
        }

        .camera-btn:active {
            transform: translateY(-2px) scale(1.01);
        }

        .camera-btn-capture {
            background: linear-gradient(135deg, #00ff9d 0%, #00cc7a 100%);
            color: var(--background-darker);
        }

        .camera-btn-capture:hover {
            box-shadow: 0 8px 28px rgba(0, 255, 157, 0.55);
        }

        .camera-btn-record {
            background: linear-gradient(135deg, #ff3b5c 0%, #e02545 100%);
            color: white;
        }

        .camera-btn-record:hover {
            box-shadow: 0 8px 28px rgba(255, 59, 92, 0.55);
        }

        .camera-btn-stop {
            background: linear-gradient(135deg, #ffd700 0%, #f0c800 100%);
            color: var(--background-darker);
        }

        .camera-btn-stop:hover {
            box-shadow: 0 8px 28px rgba(255, 215, 0, 0.55);
        }

        .camera-btn-switch {
            background: linear-gradient(135deg, #00f7ff 0%, #00d4e0 100%);
            color: white;
        }

        .camera-btn-switch:hover {
            box-shadow: 0 8px 28px rgba(0, 247, 255, 0.55);
        }

        .camera-btn-close {
            background: var(--glass-bg);
            border: 2px solid var(--glass-border);
            color: var(--text-primary);
        }

        .camera-btn-close:hover {
            background: var(--hover-color);
            border-color: var(--primary-color);
            box-shadow: 0 8px 28px rgba(102, 126, 234, 0.35);
        }

        /* Hidden file input –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤ */
        #cameraFileInput {
            display: none;
        }

        /* –ú–æ–±–∏–ª—å–Ω–∞—è –∞–¥–∞–ø—Ç–∞—Ü–∏—è –¥–ª—è –∫–∞–º–µ—Ä—ã */
        @media (max-width: 768px) {
            .media-source-content {
                max-width: 96%;
                padding: 26px;
            }

            .media-option {
                padding: 17px 19px;
                font-size: 15px;
            }

            .media-option-icon {
                font-size: 27px;
                width: 40px;
            }

            .camera-container {
                max-width: 96%;
                max-height: 72%;
            }

            .camera-controls {
                gap: 11px;
                margin-top: 24px;
            }

            .camera-btn {
                padding: 15px 26px;
                font-size: 15px;
            }
        }

        /* ===== ENHANCED MOBILE / iPHONE ===== */
        @media (max-width: 768px) {
            /* Safe area padding for notched iPhones */
            body {
                padding-top: env(safe-area-inset-top);
                padding-bottom: env(safe-area-inset-bottom);
                padding-left: env(safe-area-inset-left);
                padding-right: env(safe-area-inset-right);
            }
            /* Minimum touch targets */
            .profile-btn, .chat-header-btn, .back-btn, .close-modal,
            .settings-tab, .btn-emoji, .btn-send, .btn-media {
                min-width: 44px;
                min-height: 44px;
            }
            .chat-header {
                padding: 10px 12px;
                margin: 0;
                border-radius: 0;
            }
            .messages {
                margin: 0;
                padding: 15px 10px;
                border-radius: 0;
            }
            .input-area {
                margin: 0;
                border-radius: 0;
                padding: 8px 10px;
            }
            .chat-area {
                border-radius: 0;
            }
            /* Sidebar overlay background */
            .sidebar-overlay {
                display: none;
                position: fixed;
                inset: 0;
                background: rgba(0,0,0,0.5);
                z-index: 99;
            }
            .sidebar-overlay.active { display: block; }
            /* Video call local wrapper smaller on mobile */
            .local-video-wrapper {
                width: 100px !important;
                height: 140px !important;
            }
            /* Context menu fit screen */
            .context-menu {
                max-width: calc(100vw - 20px);
            }
            /* Modal improvements */
            .modal-content {
                max-width: 96vw;
                max-height: 90vh;
                margin: 10px;
                border-radius: 16px;
            }
            .auth-container {
                padding: 28px 20px;
                max-width: 96vw;
            }
        }

        /* ===== –ú–ï–î–ò–ê-–ì–ê–õ–ï–†–ï–Ø ===== */
        .media-gallery-modal {
            display: none;
            position: fixed; inset: 0;
            background: rgba(0,0,0,0.85);
            z-index: 5000;
            align-items: center;
            justify-content: center;
        }
        .media-gallery-modal.active { display: flex; }
        .media-gallery-container {
            background: rgba(12,10,30,0.97);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            width: 90vw;
            max-width: 700px;
            max-height: 85vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 0 40px rgba(102,126,234,0.3);
        }
        .media-gallery-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 18px 22px;
            border-bottom: 1px solid var(--glass-border);
            flex-shrink: 0;
        }
        .media-gallery-title {
            font-size: 18px;
            font-weight: 700;
            background: linear-gradient(45deg, #fff, var(--accent-color));
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }
        .media-gallery-tabs {
            display: flex;
            gap: 8px;
            padding: 10px 22px 0;
            border-bottom: 1px solid var(--glass-border);
            flex-shrink: 0;
        }
        .media-gallery-tab {
            padding: 8px 18px;
            border-radius: 10px 10px 0 0;
            border: 1px solid transparent;
            background: transparent;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
        }
        .media-gallery-tab.active {
            background: var(--hover-color);
            border-color: var(--glass-border);
            color: var(--accent-color);
            border-bottom-color: rgba(12,10,30,0.97);
        }
        .media-gallery-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 10px;
            padding: 16px 22px;
            overflow-y: auto;
            flex: 1;
        }
        .media-gallery-item {
            aspect-ratio: 1;
            border-radius: 12px;
            overflow: hidden;
            cursor: pointer;
            position: relative;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .media-gallery-item:hover {
            transform: scale(1.04);
            box-shadow: 0 0 15px rgba(102,126,234,0.4);
        }
        .media-gallery-item img {
            width: 100%; height: 100%;
            object-fit: cover;
        }
        .media-gallery-item .media-type-badge {
            position: absolute;
            bottom: 6px; left: 6px;
            background: rgba(0,0,0,0.7);
            border-radius: 6px;
            padding: 2px 7px;
            font-size: 11px;
            color: #fff;
        }
        .media-gallery-item .media-date {
            position: absolute;
            bottom: 6px; right: 6px;
            background: rgba(0,0,0,0.7);
            border-radius: 6px;
            padding: 2px 6px;
            font-size: 10px;
            color: var(--text-secondary);
        }
        .media-gallery-video-thumb {
            width: 100%; height: 100%;
            display: flex; align-items: center; justify-content: center;
            background: linear-gradient(135deg, rgba(102,126,234,0.2), rgba(118,75,162,0.2));
            font-size: 40px;
        }
        .media-gallery-empty {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px 20px;
            color: var(--text-secondary);
            font-size: 14px;
            gap: 12px;
        }
        .media-gallery-empty i {
            font-size: 48px;
            opacity: 0.3;
        }
        .media-gallery-count {
            padding: 8px 22px;
            font-size: 12px;
            color: var(--text-secondary);
            border-top: 1px solid var(--glass-border);
            flex-shrink: 0;
        }
        /* –ü–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä –º–µ–¥–∏–∞ */
        .media-fullscreen {
            display: none;
            position: fixed; inset: 0;
            background: rgba(0,0,0,0.95);
            z-index: 6000;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }
        .media-fullscreen.active { display: flex; }
        .media-fullscreen img {
            max-width: 90vw;
            max-height: 80vh;
            border-radius: 12px;
            object-fit: contain;
        }
        .media-fullscreen-close {
            position: absolute; top: 20px; right: 20px;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 50%;
            width: 40px; height: 40px;
            color: white;
            cursor: pointer;
            font-size: 18px;
            display: flex; align-items: center; justify-content: center;
            transition: all 0.2s;
        }
        .media-fullscreen-close:hover { background: var(--hover-color); }
    </style>
</head>
<body>

    <!-- Auth Overlay -->
    <div id="authOverlay" class="hidden">
        <div class="auth-container">
            <div class="auth-logo">
                <span class="atom-icon">‚öõÔ∏è</span>
                <h2>QUANTUM MESSENGER</h2>
                <p>–ë–µ–∑–æ–ø–∞—Å–Ω–∞—è —Å–≤—è–∑—å –±—É–¥—É—â–µ–≥–æ</p>
            </div>
            <div class="auth-tabs">
                <button class="auth-tab active" onclick="switchAuthTab('login')">–í—Ö–æ–¥</button>
                <button class="auth-tab" onclick="switchAuthTab('register')">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
            </div>
            <!-- Login Form -->
            <div class="auth-form active" id="loginForm">
                <div class="auth-field">
                    <label>Email</label>
                    <input type="email" id="loginEmail" placeholder="user@example.com" autocomplete="email">
                </div>
                <div class="auth-field">
                    <label>–ü–∞—Ä–æ–ª—å</label>
                    <input type="password" id="loginPassword" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å" autocomplete="current-password">
                </div>
                <div class="auth-error" id="loginError"></div>
                <button class="auth-submit" onclick="doLogin()">
                    <i class="fas fa-sign-in-alt"></i> –í–æ–π—Ç–∏
                </button>
                <div id="savedAccountsList"></div>
            </div>
            <!-- Register Form -->
            <div class="auth-form" id="registerForm">
                <div class="auth-field">
                    <label>–ò–º—è (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
                    <input type="text" id="regName" placeholder="–í–∞—à–µ –∏–º—è" maxlength="50" autocomplete="name">
                </div>
                <div class="auth-field">
                    <label>Email</label>
                    <input type="email" id="regEmail" placeholder="user@example.com" autocomplete="email">
                </div>
                <div class="auth-field">
                    <label>–ü–∞—Ä–æ–ª—å</label>
                    <input type="password" id="regPassword" placeholder="–ú–∏–Ω–∏–º—É–º 4 —Å–∏–º–≤–æ–ª–∞" autocomplete="new-password">
                </div>
                <div class="auth-field">
                    <label>–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å</label>
                    <input type="password" id="regPasswordConfirm" placeholder="–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–∞—Ä–æ–ª—å" autocomplete="new-password">
                </div>
                <div class="auth-error" id="regError"></div>
                <button class="auth-submit" onclick="doRegister()">
                    <i class="fas fa-user-plus"></i> –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è
                </button>
            </div>
        </div>
    </div>

    <!-- –õ–æ–∞–¥–µ—Ä -->
    <div id="loader">
        <!-- Grid & particles background -->
        <div class="loader-hex-bg"></div>
        <div class="loader-particles" id="loaderParticles"></div>

        <!-- Animated atom logo -->
        <div class="loader-logo-wrap">
            <div class="loader-ring loader-ring-1"></div>
            <div class="loader-ring loader-ring-2"></div>
            <div class="loader-ring loader-ring-3"></div>
            <div class="loader-atom">
                <div class="loader-orbit loader-orbit-1"><div class="loader-electron"></div></div>
                <div class="loader-orbit loader-orbit-2"><div class="loader-electron"></div></div>
                <div class="loader-orbit loader-orbit-3"><div class="loader-electron"></div></div>
                <div class="loader-atom-core"></div>
            </div>
        </div>

        <div class="loader-title">QUANTUM</div>
        <div class="loader-subtitle">SECURE MESSENGER</div>

        <div class="loader-progress-wrap">
            <div class="loader-progress-bar" id="loaderBar"></div>
        </div>
        <div class="loader-step-text" id="loaderStep">–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...</div>
    </div>

    <!-- –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ -->
    <div id="app" class="container">
        <!-- –ú–æ–±–∏–ª—å–Ω–æ–µ –º–µ–Ω—é -->
        <button class="mobile-menu-btn" onclick="toggleSidebar()">‚ò∞</button>

        <!-- –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å -->
        <div class="sidebar" id="sidebar">
            <!-- –ü—Ä–æ—Ñ–∏–ª—å -->
            <div class="profile">
                <div class="user-avatar avatar-pulse" id="userAvatar" onclick="toggleProfileMenu()">üë§</div>
                <div class="profile-info">
                    <h3 id="userName">–ö–≤–∞–Ω—Ç–æ–≤—ã–π –ü—É—Ç–Ω–∏–∫ <span class="security-status security-high">–ë–µ–∑–æ–ø–∞—Å–Ω–æ</span></h3>
                    <p id="userStatus">‚ö° –í —Å–µ—Ç–∏</p>
                    <div class="id-badge" onclick="copyUserId()" id="userIdBadge">ID: QCEO35</div>
                </div>
                <div class="profile-actions">
                    <button class="profile-btn" onclick="openSettings()" title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏" id="settingsBtn">
                        ‚öôÔ∏è
                    </button>
                </div>
            </div>

            <!-- –ü–æ–∏—Å–∫ -->
            <div class="search-box">
                <div class="search-icon">üîç</div>
                <input type="text" class="search-input" id="searchChats" placeholder="–ü–æ–∏—Å–∫ –≤ –∫–≤–∞–Ω—Ç–æ–≤–æ–º –ø–æ–ª–µ..." 
                       oninput="searchContactsAndChats(this.value)">
                <div class="search-results" id="searchResults"></div>
            </div>

            <!-- –ó–∞–∫—Ä–µ–ø–ª—ë–Ω–Ω—ã–µ –∫–æ–Ω—Ç–∞–∫—Ç—ã -->
            <div id="pinnedContactsSection" style="display:none; padding: 0 15px 5px 15px;">
                <div style="font-size:11px; font-weight:700; color:var(--accent-color); letter-spacing:1.5px; text-transform:uppercase; padding: 8px 4px 6px 4px; display:flex; align-items:center; gap:6px;">
                    <i class="fas fa-thumbtack" style="font-size:10px;"></i> –ó–∞–∫—Ä–µ–ø–ª—ë–Ω–Ω—ã–µ
                </div>
                <div id="pinnedContactsList"></div>
            </div>

            <!-- –°–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤ -->
            <div class="chats" id="chatsList">
                <!-- –ß–∞—Ç—ã –∑–∞–≥—Ä—É–∑—è—Ç—Å—è —á–µ—Ä–µ–∑ JS -->
            </div>

            <!-- –ö–Ω–æ–ø–∫–∞ –Ω–æ–≤–æ–≥–æ —á–∞—Ç–∞ -->
            <div style="padding: 20px; margin: 15px; background: var(--glass-bg); border-radius: 15px; border: 1px solid var(--glass-border);">
                <button onclick="openNewChatModal()" class="action-btn action-btn-primary" style="width: 100%;">
                    <i class="fas fa-plus"></i> –ù–æ–≤—ã–π –∫–≤–∞–Ω—Ç–æ–≤—ã–π –∫–∞–Ω–∞–ª
                </button>
            </div>
        </div>
        <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>

        <!-- –û–±–ª–∞—Å—Ç—å —á–∞—Ç–∞ -->
        <div class="chat-area" id="chatAreaBg">
            <!-- –°–ª–æ–π –ø–µ—Ä–µ–ª–∏–≤–∞—é—â–µ–≥–æ—Å—è –ø–∞—Ç—Ç–µ—Ä–Ω–∞ (–¥–ª—è –ø—Ä–µ—Å–µ—Ç–æ–≤) -->
            <div id="chatPatternLayer"></div>
            <!-- –ó–∞—Ç–µ–º–Ω—è—é—â–∏–π –æ–≤–µ—Ä–ª–µ–π (–¥–ª—è —Ñ–æ—Ç–æ-—Ñ–æ–Ω–∞) -->
            <div id="chatDimOverlay"></div>
            <!-- –®–∞–ø–∫–∞ —á–∞—Ç–∞ -->
            <div class="chat-header">
                <button class="back-btn" onclick="backToChats()" id="backButton">‚Üê</button>
                <div class="chat-header-info">
                    <h2 id="chatTitle">
                        <span class="chat-title-wrap" onclick="startInlineRename()" title="–ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å">
                            <span id="chatTitleText">–ö–≤–∞–Ω—Ç–æ–≤–æ–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ</span>
                            <span class="rename-hint">‚úèÔ∏è –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å</span>
                        </span>
                        <span id="chatTitleBadge"></span>
                    </h2>
                    <p id="chatStatus">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞–Ω–∞–ª –¥–ª—è —Å–≤—è–∑–∏</p>
                </div>
                <div class="chat-header-actions">
                    <button class="chat-header-btn" onclick="startVideoCall()" title="–í–∏–¥–µ–æ–∑–≤–æ–Ω–æ–∫">
                        <i class="fas fa-video"></i>
                    </button>
                    <button class="chat-header-btn" onclick="startVoiceCall()" title="–ì–æ–ª–æ—Å–æ–≤–æ–π –≤—ã–∑–æ–≤">
                        <i class="fas fa-phone"></i>
                    </button>
                    <button class="chat-header-btn" onclick="openMediaGallery()" title="–ú–µ–¥–∏–∞—Ñ–∞–π–ª—ã" id="mediaGalleryBtn" style="color:var(--accent-cyan);">
                        <i class="fas fa-photo-video"></i>
                    </button>
                    <button class="chat-header-btn" onclick="showChatInfo()" title="–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è">
                        <i class="fas fa-info-circle"></i>
                    </button>
                    <button class="chat-header-btn" id="blockUserBtn" onclick="toggleBlockCurrentChat()" title="–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å/–†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å" style="color:var(--accent-red);">
                        <i class="fas fa-ban"></i>
                    </button>
                    <button class="chat-header-btn" onclick="showChatOptionsMenu(event)" title="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ" style="color:var(--accent-yellow);">
                        <i class="fas fa-ellipsis-v"></i>
                    </button>
                </div>
            </div>

            <!-- –ó–∞–∫—Ä–µ–ø–ª—ë–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ -->
            <div id="pinnedMsgBar">
                <div class="pin-label">üìå –ó–∞–∫—Ä–µ–ø–ª—ë–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ</div>
                <div class="pin-text" id="pinnedMsgText"></div>
                <button class="pin-close" onclick="unpinMessage()" title="–û—Ç–∫—Ä–µ–ø–∏—Ç—å">‚úï</button>
            </div>

            <!-- –°–æ–æ–±—â–µ–Ω–∏—è -->
            <div class="messages" id="messagesArea">
                <div style="text-align: center; padding: 80px 20px; color: var(--text-secondary);">
                    <div style="font-size: 80px; margin-bottom: 20px; filter: drop-shadow(0 0 20px rgba(102, 126, 234, 0.5));">‚öõ</div>
                    <h2 style="margin-bottom: 15px; background: linear-gradient(45deg, #fff, var(--accent-color)); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">Quantum Secure Messenger</h2>
                    <p style="margin-bottom: 30px; font-size: 16px;">–ó–∞—â–∏—â–µ–Ω–Ω–∞—è —Å–≤—è–∑—å –±—É–¥—É—â–µ–≥–æ</p>
                    <button onclick="openNewChatModal()" class="action-btn action-btn-primary" style="padding: 15px 30px;">
                        <i class="fas fa-plus"></i> –°–æ–∑–¥–∞—Ç—å –∫–≤–∞–Ω—Ç–æ–≤—ã–π –∫–∞–Ω–∞–ª
                    </button>
                </div>
            </div>

            <!-- –í–≤–æ–¥ —Å–æ–æ–±—â–µ–Ω–∏—è -->
            <div class="input-area" id="inputArea" style="display: none;">
                <!-- Reply Bar -->
                <div id="replyBar">
                    <div class="reply-to-name" id="replyToName"></div>
                    <div style="color: var(--text-secondary); font-size: 13px; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; max-width: 90%;" id="replyToText"></div>
                    <button class="cancel-reply" onclick="cancelReply()">‚úï</button>
                </div>

                <!-- –≠–º–æ–¥–∑–∏ –ø–∞–Ω–µ–ª—å -->
                <div class="emoji-picker" id="emojiPicker">
                    <div class="emoji-grid" id="emojiGrid">
                        <!-- –≠–º–æ–¥–∑–∏ –∑–∞–≥—Ä—É–∑—è—Ç—Å—è —á–µ—Ä–µ–∑ JS -->
                    </div>
                </div>

                <div class="input-row">
                    <div class="input-actions">
                        <button class="input-btn" onclick="toggleEmojiPicker()" title="–≠–º–æ–¥–∑–∏">
                            üòä
                        </button>
                        <button class="input-btn" onclick="attachFile()" title="–§–∞–π–ª">
                            üìé
                        </button>
                        <button class="input-btn" onclick="attachImage()" title="–§–æ—Ç–æ">
                            üì∑
                        </button>
                        <button class="input-btn" onclick="openMediaSourceModal()" title="–ö–∞–º–µ—Ä–∞/–≠–∫—Ä–∞–Ω">
                            üì∏
                        </button>
                        <input type="file" id="cameraFileInput" accept="image/*,video/*" capture="environment" style="display:none" onchange="handleFileUpload(event)">
                        <input type="file" id="cameraFileInputSelfie" accept="image/*" capture="user" style="display:none" onchange="handleFileUpload(event)">
                        <input type="file" id="cameraFileInputGallery" accept="image/*,video/*" style="display:none" onchange="handleFileUpload(event)">
                        <button class="input-btn" id="voiceBtn" onclick="toggleVoiceRecord()" title="–ì–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ">
                            üéôÔ∏è
                        </button>
                    </div>
                    <textarea id="messageInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–≤–∞–Ω—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." rows="1"></textarea>
                    <button class="btn-send" onclick="sendMessage()" title="–û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ –∫–≤–∞–Ω—Ç–æ–≤–æ–µ –ø–æ–ª–µ">
                        ‚û§
                    </button>
                </div>
                <div class="blocked-bar" id="blockedBar">
                    üö´ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω
                    <button onclick="unblockCurrentChat()">–†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å</button>
                </div>
            </div>
        </div>
    </div>

    <!-- –≠–ö–†–ê–ù –ó–í–û–ù–ö–ê -->
    <div id="callScreen" class="call-screen" style="display: none;">
        <div class="call-container">
            <div class="call-avatar" id="callAvatar">üë§</div>
            <h2 id="callContactName">–ö–≤–∞–Ω—Ç–æ–≤—ã–π –ò–Ω–∂–µ–Ω–µ—Ä</h2>
            <p id="callStatus">–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞—â–∏—â–µ–Ω–Ω–æ–≥–æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è...</p>
            <div class="call-buttons">
                <button class="call-btn accept-call" onclick="acceptCall()" id="acceptBtn" style="display: none;">üìû</button>
                <button class="call-btn reject-call" onclick="endCall()" id="rejectBtn">‚úñ</button>
                <button class="call-btn end-call" onclick="endCall()" id="endBtn" style="display: none;">üìû</button>
            </div>
        </div>
    </div>

    <!-- –í–∏–¥–µ–æ–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –≤–∏–¥–µ–æ–∑–≤–æ–Ω–∫–∞ (—É–ª—É—á—à–µ–Ω–Ω—ã–π v5.8) -->
    <div id="videoContainer" class="video-container" style="display: none;">
        <div class="video-wrapper" style="position:relative;width:100%;height:100%;">

            <!-- –£–¥–∞–ª—ë–Ω–Ω–æ–µ –≤–∏–¥–µ–æ / —Ñ–æ–Ω –±–µ–∑ –∫–∞–º–µ—Ä—ã -->
            <div id="remoteVideoArea" style="width:100%;height:100%;background:#07071a;display:flex;align-items:center;justify-content:center;overflow:hidden;" onclick="handleRemoteAreaClick()">
                <div class="nocam-bg"></div>
                <div class="video-no-cam" id="remoteNoCam">
                    <div class="video-no-cam-avatar" id="remoteAvatar">üë§</div>
                    <div id="remoteVideoName" style="font-size:22px;color:white;font-weight:600;margin-top:8px;"></div>
                    <div style="color:var(--text-secondary);font-size:13px;">–û–∂–∏–¥–∞–Ω–∏–µ –≤–∏–¥–µ–æ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞...</div>
                </div>
                <video id="remoteVideo" class="remote-video" autoplay playsinline style="display:none;"></video>
            </div>

            <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∑–≤–æ–Ω–∫–µ -->
            <div class="video-call-info">
                <div class="video-call-name" id="videoCallName"></div>
                <div class="video-call-timer" id="videoCallTimer">00:00</div>
                <div class="video-source-badge vsb-camera" id="videoSourceBadge">üì∑ –ö–ê–ú–ï–†–ê</div>
            </div>

            <!-- –õ–æ–∫–∞–ª—å–Ω–æ–µ –≤–∏–¥–µ–æ (–ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–µ–º–æ–µ) -->
            <div class="local-video-wrapper" id="localVideoWrapper">
                <button class="swap-btn" onclick="swapVideos(event)" title="–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å –Ω–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω">
                    <i class="fas fa-expand-arrows-alt"></i>
                </button>
                <div class="cam-placeholder" id="localNoCam">
                    <i class="fas fa-video-slash" style="font-size:26px;"></i>
                    <span>–ë–ï–ó –í–ò–î–ï–û</span>
                </div>
                <video id="localVideo" autoplay playsinline muted style="display:none;"></video>
            </div>

            <!-- –ü–∞–Ω–µ–ª—å –≤—ã–±–æ—Ä–∞ –∏—Å—Ç–æ—á–Ω–∏–∫–∞ –≤–∏–¥–µ–æ -->
            <div class="video-source-picker" id="videoSourcePicker">
                <div class="vsp-title">–í—ã–±–µ—Ä–∏—Ç–µ –∏—Å—Ç–æ—á–Ω–∏–∫ –≤–∏–¥–µ–æ</div>
                <div class="vsp-options">
                    <div class="vsp-option green active" id="vsp-camera" onclick="setVideoSource('camera')">
                        <i class="fas fa-video" style="color:var(--accent-green);"></i>
                        <span>–ö–∞–º–µ—Ä–∞</span>
                    </div>
                    <div class="vsp-option" id="vsp-front" onclick="setVideoSource('front')">
                        <i class="fas fa-user-circle" style="color:var(--accent-color);"></i>
                        <span>–§—Ä–æ–Ω—Ç. –∫–∞–º–µ—Ä–∞</span>
                    </div>
                    <div class="vsp-option" id="vsp-screen" onclick="setVideoSource('screen')">
                        <i class="fas fa-desktop" style="color:var(--accent-color);"></i>
                        <span>–≠–∫—Ä–∞–Ω</span>
                    </div>
                    <div class="vsp-option" id="vsp-none" onclick="setVideoSource('none')">
                        <i class="fas fa-video-slash" style="color:#888;"></i>
                        <span>–ë–µ–∑ –≤–∏–¥–µ–æ</span>
                    </div>
                </div>
            </div>

            <!-- –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
            <div class="video-controls">
                <button class="video-control-btn toggle-mic" id="micBtn" onclick="toggleMic()" title="–ú–∏–∫—Ä–æ—Ñ–æ–Ω">
                    <i class="fas fa-microphone"></i>
                    <span class="vbtn-label">–ú–∏–∫—Ä–æ—Ñ–æ–Ω</span>
                </button>
                <button class="video-control-btn toggle-camera" id="camBtn" onclick="toggleCamera()" title="–ö–∞–º–µ—Ä–∞">
                    <i class="fas fa-video"></i>
                    <span class="vbtn-label">–ö–∞–º–µ—Ä–∞</span>
                </button>
                <button class="video-control-btn" id="srcBtn" style="background:rgba(255,255,255,0.1);" onclick="toggleSourcePicker()" title="–ò—Å—Ç–æ—á–Ω–∏–∫ –≤–∏–¥–µ–æ">
                    <i class="fas fa-sliders-h"></i>
                    <span class="vbtn-label">–ò—Å—Ç–æ—á–Ω–∏–∫</span>
                </button>
                <button class="video-control-btn" id="flipBtn" style="background:rgba(255,255,255,0.1);" onclick="flipVideoCallCamera()" title="–ü–µ—Ä–µ–≤–µ—Ä–Ω—É—Ç—å –∫–∞–º–µ—Ä—É">
                    <i class="fas fa-sync-alt"></i>
                    <span class="vbtn-label">–ü–µ—Ä–µ–≤–µ—Ä–Ω—É—Ç—å</span>
                </button>
                <button class="video-control-btn end-call" onclick="endVideoCall()" title="–ó–∞–≤–µ—Ä—à–∏—Ç—å –∑–≤–æ–Ω–æ–∫">
                    <i class="fas fa-phone-slash"></i>
                    <span class="vbtn-label">–ó–∞–≤–µ—Ä—à–∏—Ç—å</span>
                </button>
            </div>

        </div>
    </div>
    
    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∫–∞–º–µ—Ä—ã -->
    <!-- ===== –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û: –í–´–ë–û–† –ò–°–¢–û–ß–ù–ò–ö–ê –ú–ï–î–ò–ê v5.4 ===== -->
    <div id="mediaSourceModal" class="media-source-modal">
        <div class="media-source-content">
            <h2>üì∑ –í—ã–±–µ—Ä–∏—Ç–µ –∏—Å—Ç–æ—á–Ω–∏–∫</h2>
            <div class="media-source-options">
                <div class="media-option" onclick="openRealCamera('user')">
                    <span class="media-option-icon">ü§≥</span>
                    <span class="media-option-text">–§—Ä–æ–Ω—Ç–∞–ª—å–Ω–∞—è –∫–∞–º–µ—Ä–∞</span>
                    <span class="media-option-arrow">‚Üí</span>
                </div>
                <div class="media-option" onclick="openRealCamera('environment')">
                    <span class="media-option-icon">üìπ</span>
                    <span class="media-option-text">–û—Å–Ω–æ–≤–Ω–∞—è –∫–∞–º–µ—Ä–∞</span>
                    <span class="media-option-arrow">‚Üí</span>
                </div>
                <div class="media-option" onclick="openScreenCapture()">
                    <span class="media-option-icon">üñ•Ô∏è</span>
                    <span class="media-option-text">–ó–∞—Ö–≤–∞—Ç —ç–∫—Ä–∞–Ω–∞</span>
                    <span class="media-option-arrow">‚Üí</span>
                </div>
                <div class="media-option" onclick="openFileUpload()">
                    <span class="media-option-icon">üìÅ</span>
                    <span class="media-option-text">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª</span>
                    <span class="media-option-arrow">‚Üí</span>
                </div>
                <div class="media-option" onclick="closeMediaSourceModal()">
                    <span class="media-option-icon">‚ùå</span>
                    <span class="media-option-text">–û—Ç–º–µ–Ω–∞</span>
                    <span class="media-option-arrow"></span>
                </div>
            </div>
        </div>
    </div>

    <!-- ===== –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û: –†–ï–ê–õ–¨–ù–ê–Ø –ö–ê–ú–ï–†–ê v5.4 ===== -->
    <div id="realCameraModal" class="camera-modal">
        <div class="camera-recording-indicator" id="cameraRecordingIndicator">
            <div class="camera-recording-dot"></div>
            <span>–ó–ê–ü–ò–°–¨</span>
        </div>
        <div class="camera-container">
            <video id="cameraPreview" autoplay playsinline muted></video>
        </div>
        <div class="camera-controls">
            <button class="camera-btn camera-btn-capture" onclick="capturePhotoReal()">
                <i class="fas fa-camera"></i> –°–¥–µ–ª–∞—Ç—å —Ñ–æ—Ç–æ
            </button>
            <button class="camera-btn camera-btn-record" id="cameraRecordBtn" onclick="startVideoRecordingReal()">
                <i class="fas fa-video"></i> –ù–∞—á–∞—Ç—å –∑–∞–ø–∏—Å—å
            </button>
            <button class="camera-btn camera-btn-stop" id="cameraStopBtn" onclick="stopVideoRecordingReal()" style="display: none;">
                <i class="fas fa-stop"></i> –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å
            </button>
            <button class="camera-btn camera-btn-switch" id="cameraSwitchBtn" onclick="switchCameraReal()">
                <i class="fas fa-sync-alt"></i> –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å
            </button>
            <button class="camera-btn camera-btn-close" onclick="closeCameraReal()">
                <i class="fas fa-times"></i> –ó–∞–∫—Ä—ã—Ç—å
            </button>
        </div>
    </div>

    <div id="cameraModal" class="modal">
        <div class="modal-content camera-modal">
            <div class="modal-header">
                <div class="modal-title">–ö–≤–∞–Ω—Ç–æ–≤–∞—è –∫–∞–º–µ—Ä–∞</div>
                <button class="close-modal" onclick="closeCameraModal()">√ó</button>
            </div>
            <div class="camera-preview">
                <video id="cameraVideo" autoplay playsinline></video>
                <div class="camera-overlay">
                    <div class="camera-timer" id="cameraTimer">00:00</div>
                </div>
                <div class="camera-countdown" id="cameraCountdown">3</div>
            </div>
            <div class="camera-controls">
                <button class="camera-btn flip-btn" onclick="flipCamera()" title="–ü–µ—Ä–µ–≤–µ—Ä–Ω—É—Ç—å –∫–∞–º–µ—Ä—É">
                    üîÑ
                </button>
                <button class="camera-btn capture-btn" onclick="capturePhoto()" title="–°–¥–µ–ª–∞—Ç—å —Ñ–æ—Ç–æ">
                    üì∏
                </button>
                <button class="camera-btn flip-btn" onclick="startVideoRecording()" title="–ó–∞–ø–∏—Å–∞—Ç—å –≤–∏–¥–µ–æ" id="recordBtn">
                    ‚è∫Ô∏è
                </button>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ -->

    <!-- –ù–æ–≤—ã–π —á–∞—Ç -->
    <div id="newChatModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">–ù–æ–≤—ã–π –∫–≤–∞–Ω—Ç–æ–≤—ã–π –∫–∞–Ω–∞–ª</div>
                <button class="close-modal" onclick="closeModal('newChatModal')">√ó</button>
            </div>
            <div style="margin-bottom: 25px;">
                <button onclick="openContactsModal()" class="action-btn action-btn-primary" style="width: 100%; margin-bottom: 15px;">
                    <i class="fas fa-user-plus"></i> –í—ã–±—Ä–∞—Ç—å –∏–∑ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤
                </button>
                <button onclick="openGroupChatModal()" class="action-btn action-btn-secondary" style="width: 100%; margin-bottom: 15px;">
                    <i class="fas fa-users"></i> –°–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø–æ–≤–æ–π –∫–∞–Ω–∞–ª
                </button>
                <button onclick="openAddFriendModal()" class="action-btn action-btn-secondary" style="width: 100%;">
                    <i class="fas fa-id-card"></i> –î–æ–±–∞–≤–∏—Ç—å –¥—Ä—É–≥–∞ –ø–æ ID
                </button>
            </div>
        </div>
    </div>

    <!-- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –¥—Ä—É–≥–∞ –ø–æ ID -->
    <div id="addFriendModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">–î–æ–±–∞–≤–∏—Ç—å –¥—Ä—É–≥–∞ –ø–æ ID</div>
                <button class="close-modal" onclick="closeModal('addFriendModal')">√ó</button>
            </div>
            <div class="add-friend-form">
                <input type="text" id="friendIdInput" placeholder="–í–≤–µ–¥–∏—Ç–µ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–Ω–∞–ø—Ä–∏–º–µ—Ä: Q115002)" maxlength="20">
                <button class="action-btn action-btn-primary" onclick="addFriendById()" style="width: 100%;">
                    <i class="fas fa-user-plus"></i> –î–æ–±–∞–≤–∏—Ç—å –≤ –¥—Ä—É–∑—å—è
                </button>
            </div>
            <div class="friends-list">
                <h3 style="color: var(--text-primary); margin-bottom: 15px;">–í–∞—à–∏ –¥—Ä—É–∑—å—è</h3>
                <div id="friendsContainer">
                    <!-- –î—Ä—É–∑—å—è –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è –∑–¥–µ—Å—å –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                </div>
            </div>
        </div>
    </div>

    <!-- –ö–æ–Ω—Ç–∞–∫—Ç—ã -->
    <div id="contactsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">–ö–≤–∞–Ω—Ç–æ–≤—ã–µ –∫–æ–Ω—Ç–∞–∫—Ç—ã</div>
                <button class="close-modal" onclick="closeModal('contactsModal')">√ó</button>
            </div>
            <div class="contacts-list" id="contactsList">
                <!-- –ö–æ–Ω—Ç–∞–∫—Ç—ã –∑–∞–≥—Ä—É–∑—è—Ç—Å—è —á–µ—Ä–µ–∑ JS -->
            </div>
        </div>
    </div>

    <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –¥–ª—è –∫–æ–Ω—Ç–∞–∫—Ç–∞ -->
    <div id="contactNotificationModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π</div>
                <button class="close-modal" onclick="closeModal('contactNotificationModal')">√ó</button>
            </div>
            <div class="notification-settings" id="contactNotificationSettings">
                <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
            </div>
            <div class="action-buttons">
                <button class="action-btn action-btn-primary" onclick="saveNotificationSettings()">
                    <i class="fas fa-save"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                </button>
            </div>
        </div>
    </div>

    <!-- –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Ç–∞–∫—Ç–∞ -->
    <div id="renameContactModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">–ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç</div>
                <button class="close-modal" onclick="closeModal('renameContactModal')">√ó</button>
            </div>
            <div style="padding: 20px;">
                <input type="text" id="newContactName" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –∏–º—è" maxlength="50"
                       style="width: 100%; padding: 12px; background: rgba(0,0,0,0.2); border: 1px solid var(--glass-border); border-radius: 10px; color: var(--text-primary);">
                <div class="action-buttons" style="margin-top: 20px; display:flex; gap:10px; flex-wrap:wrap;">
                    <button class="action-btn action-btn-secondary" onclick="closeModal('renameContactModal')" style="flex:1;">
                        <i class="fas fa-times"></i> –û—Ç–º–µ–Ω–∞
                    </button>
                    <button id="pinContactModalBtn" class="action-btn" onclick="pinContactFromModal()"
                        style="flex:1; background: linear-gradient(135deg, rgba(0,212,255,0.2), rgba(102,126,234,0.2)); border: 1px solid var(--accent-color); color: var(--accent-color);">
                        <i class="fas fa-thumbtack"></i> <span id="pinContactModalLabel">–ó–∞–∫—Ä–µ–ø–∏—Ç—å</span>
                    </button>
                    <button class="action-btn action-btn-primary" onclick="saveRenamedContact()" style="flex:1;">
                        <i class="fas fa-check"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- –ì—Ä—É–ø–ø–æ–≤–æ–π —á–∞—Ç -->
    <div id="groupChatModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">–°–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø–æ–≤–æ–π —á–∞—Ç</div>
                <button class="close-modal" onclick="closeModal('groupChatModal')">√ó</button>
            </div>
            <div style="padding: 20px;">
                <input type="text" id="groupNameInput" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã" maxlength="100"
                       style="width: 100%; padding: 12px; margin-bottom: 20px; background: rgba(0,0,0,0.2); border: 1px solid var(--glass-border); border-radius: 10px; color: var(--text-primary);">
                <h3 style="color: var(--text-primary); margin-bottom: 15px;">–í—ã–±–µ—Ä–∏—Ç–µ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</h3>
                <div id="groupMembersList" style="max-height: 300px; overflow-y: auto;">
                    <!-- –°–ø–∏—Å–æ–∫ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ –¥–ª—è –≤—ã–±–æ—Ä–∞ -->
                </div>
                <div class="action-buttons" style="margin-top: 30px;">
                    <button class="action-btn action-btn-secondary" onclick="closeModal('groupChatModal')">
                        <i class="fas fa-times"></i> –û—Ç–º–µ–Ω–∞
                    </button>
                    <button class="action-btn action-btn-primary" onclick="createGroupChat()">
                        <i class="fas fa-check"></i> –°–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ -->
    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="i18n_settings_title">–ö–≤–∞–Ω—Ç–æ–≤—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</div>
                <button class="close-modal" onclick="closeModal('settingsModal')">√ó</button>
            </div>
            
            <div class="settings-tabs">
                <button class="settings-tab active" onclick="switchSettingsTab('profile')" title="–ü—Ä–æ—Ñ–∏–ª—å"><i class="fas fa-user"></i></button>
                <button class="settings-tab" onclick="switchSettingsTab('appearance')" title="–í–Ω–µ—à–Ω–∏–π –≤–∏–¥"><i class="fas fa-palette"></i></button>
                <button class="settings-tab" onclick="switchSettingsTab('security')" title="–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å"><i class="fas fa-shield-alt"></i></button>
                <button class="settings-tab" onclick="switchSettingsTab('notifications')" title="–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è"><i class="fas fa-bell"></i></button>
                <button class="settings-tab" onclick="switchSettingsTab('friends')" title="–î—Ä—É–∑—å—è"><i class="fas fa-users"></i></button>
                <button class="settings-tab" onclick="switchSettingsTab('language')" title="–Ø–∑—ã–∫"><i class="fas fa-language"></i></button>
                <button class="settings-tab" onclick="switchSettingsTab('contactNotifications')" title="–ö–æ–Ω—Ç–∞–∫—Ç—ã"><i class="fas fa-volume-mute"></i></button>
                <button class="settings-tab" onclick="switchSettingsTab('blacklist')" title="–ß—ë—Ä–Ω—ã–π —Å–ø–∏—Å–æ–∫"><i class="fas fa-ban"></i></button>
            </div>
            
            <div class="settings-content">
                <!-- –í–∫–ª–∞–¥–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è -->
                <div id="profileTab" class="settings-tab-content">
                    <div class="settings-section">
                        <h3><i class="fas fa-id-card"></i> <span id="i18n_profile_section">–ö–≤–∞–Ω—Ç–æ–≤—ã–π –ø—Ä–æ—Ñ–∏–ª—å</span></h3>
                        <div class="setting-item">
                            <div class="setting-label">
                                <h4 id="i18n_your_id">–í–∞—à ID</h4>
                                <p id="i18n_your_id_desc">–ü–æ–¥–µ–ª–∏—Ç–µ—Å—å —ç—Ç–∏–º ID, —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å –≤–∞—Å –≤ –¥—Ä—É–∑—å—è</p>
                            </div>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <span id="currentUserId" style="background: rgba(0,0,0,0.3); padding: 8px 12px; border-radius: 8px; border: 1px solid var(--glass-border);">QCEO35</span>
                                <button onclick="copyUserId()" class="action-btn" style="padding: 8px 12px;"><i class="fas fa-copy"></i></button>
                            </div>
                        </div>
                        <div class="setting-item">
                            <div class="setting-label">
                                <h4 id="i18n_username">–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h4>
                                <p id="i18n_username_desc">–í–∞—à–µ –∏–º—è –≤ –∫–≤–∞–Ω—Ç–æ–≤–æ–π —Å–µ—Ç–∏</p>
                            </div>
                            <input type="text" id="userNameInput" maxlength="50" style="padding: 12px; background: rgba(0, 0, 0, 0.2); border: 1px solid var(--glass-border); border-radius: 10px; color: var(--text-primary); width: 200px;">
                        </div>
                    </div>
                    <div class="settings-section">
                        <h3><i class="fas fa-user-astronaut"></i> <span id="i18n_avatar_section">–ö–≤–∞–Ω—Ç–æ–≤—ã–π –∞–≤–∞—Ç–∞—Ä</span></h3>
                        <div class="avatar-grid" id="avatarGrid"></div>

                        <!-- –ó–ê–ì–†–£–ó–ö–ê –°–í–û–ï–ì–û –§–û–¢–û -->
                        <div class="av-upload-wrap">
                            <div class="av-preview-circle" id="avPreviewCircle" onclick="avTrigger()" title="–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏">
                                <span id="avEmojiSpan">üì∑</span>
                            </div>
                            <div class="av-hint-text">–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Å–≤–æ—ë —Ñ–æ—Ç–æ –∫–∞–∫ –∞–≤–∞—Ç–∞—Ä</div>
                            <input type="file" id="avFileInput" accept="image/jpeg,image/png,image/gif,image/webp" style="display:none" onchange="avHandleFile(event)">
                            <div class="av-btn-row">
                                <button class="av-upload-btn" onclick="avTrigger()">
                                    <i class="fas fa-upload"></i> –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ
                                </button>
                                <button class="av-remove-btn" id="avRemoveBtn" onclick="avRemove()">
                                    <i class="fas fa-trash"></i> –£–¥–∞–ª–∏—Ç—å
                                </button>
                            </div>
                            <div class="av-formats-hint">JPG ¬∑ PNG ¬∑ GIF ¬∑ WebP ¬∑ –¥–æ 5 –ú–ë</div>
                        </div>
                    </div>
                    <div class="settings-section">
                        <h3><i class="fas fa-satellite"></i> <span id="i18n_status_section">–°—Ç–∞—Ç—É—Å</span></h3>
                        <select id="statusSelect" style="width: 100%; padding: 15px; background: rgba(0, 0, 0, 0.2); border: 1px solid var(--glass-border); border-radius: 12px; color: var(--text-primary);">
                            <option value="online" id="i18n_status_online">‚ö° –í —Å–µ—Ç–∏</option>
                            <option value="away"    id="i18n_status_away">üåô –û—Ç–æ—à–µ–ª</option>
                            <option value="busy"    id="i18n_status_busy">üî¥ –ó–∞–Ω—è—Ç</option>
                            <option value="invisible" id="i18n_status_invisible">üëª –ù–µ–≤–∏–¥–∏–º–∫–∞</option>
                        </select>
                    </div>

                    <div class="settings-section">
                        <h3><i class="fas fa-sign-out-alt"></i> –ê–∫–∫–∞—É–Ω—Ç</h3>
                        <p style="color: var(--text-secondary); font-size: 13px; margin-bottom: 12px;" id="loggedInAsLabel">–í—ã –≤–æ—à–ª–∏ –∫–∞–∫: ‚Äî</p>
                        <button class="logout-btn" onclick="doLogout()">
                            <i class="fas fa-sign-out-alt"></i> –í—ã–π—Ç–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞
                        </button>
                    </div>
                </div>
                
                <!-- –í–∫–ª–∞–¥–∫–∞ –≤–Ω–µ—à–Ω–µ–≥–æ –≤–∏–¥–∞ -->
                <div id="appearanceTab" class="settings-tab-content" style="display: none;">

                    <!-- –¢–ï–ú–´ -->
                    <div class="settings-section">
                        <h3><i class="fas fa-paint-brush"></i> –¢–µ–º–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è</h3>
                        <div class="theme-grid" id="themeGrid">
                            <!-- –ó–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è JS -->
                        </div>
                    </div>

                    <!-- –ù–ï–û–ù -->
                    <div class="settings-section">
                        <h3><i class="fas fa-bolt"></i> –≠—Ñ—Ñ–µ–∫—Ç—ã</h3>
                        <div class="setting-item">
                            <div class="setting-label">
                                <h4>–ù–µ–æ–Ω–æ–≤–æ–µ —Å–≤–µ—á–µ–Ω–∏–µ</h4>
                                <p>–ü–æ–¥—Å–≤–µ—Ç–∫–∞ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞</p>
                            </div>
                            <label class="switch"><input type="checkbox" id="neonEffects" checked><span class="slider"></span></label>
                        </div>
                    </div>

                    <!-- –§–û–ù –ß–ê–¢–ê -->
                    <div class="settings-section">
                        <h3><i class="fas fa-image"></i> –§–æ–Ω –æ–±–ª–∞—Å—Ç–∏ —á–∞—Ç–∞</h3>
                        <p style="font-size:13px;color:var(--text-secondary);margin-bottom:14px;">–ó–∞–≥—Ä—É–∑–∏ —Å–≤–æ—ë —Ñ–æ—Ç–æ ‚Äî –æ–Ω–æ —Å—Ç–∞–Ω–µ—Ç —Ñ–æ–Ω–æ–º –ø–µ—Ä–µ–ø–∏—Å–∫–∏</p>

                        <!-- –ü—Ä–µ–≤—å—é —Ç–µ–∫—É—â–µ–≥–æ —Ñ–æ–Ω–∞ -->
                        <div class="chat-bg-preview" id="chatBgPreview">
                            <div class="chat-bg-preview-label" id="chatBgPreviewLabel">–§–æ–Ω –Ω–µ –≤—ã–±—Ä–∞–Ω</div>
                        </div>

                        <!-- –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ñ–æ–Ω–æ–º -->
                        <div class="chat-bg-actions">
                            <button class="chat-bg-btn" onclick="triggerChatBgUpload()">
                                <i class="fas fa-upload"></i> –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ
                            </button>
                            <button class="chat-bg-btn chat-bg-btn-clear" id="chatBgClearBtn" onclick="clearChatBg()" style="display:none;">
                                <i class="fas fa-trash"></i> –£–±—Ä–∞—Ç—å —Ñ–æ–Ω
                            </button>
                        </div>
                        <input type="file" id="chatBgFileInput" accept="image/*" style="display:none;" onchange="handleChatBgUpload(event)">

                        <!-- –ë—ã—Å—Ç—Ä—ã–µ –ø—Ä–µ—Å–µ—Ç—ã —Ñ–æ–Ω–∞ -->
                        <div style="margin-top:16px;">
                            <div style="font-size:12px;color:var(--text-secondary);margin-bottom:10px;letter-spacing:0.5px;text-transform:uppercase;">–ì–æ—Ç–æ–≤—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã</div>
                            <div class="chat-bg-presets" id="chatBgPresets">
                                <!-- –ó–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è JS -->
                            </div>
                        </div>

                        <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç–∏ –æ–≤–µ—Ä–ª–µ—è -->
                        <div class="setting-item" style="margin-top:16px;" id="chatBgOpacityRow">
                            <div class="setting-label">
                                <h4>–ó–∞—Ç–µ–º–Ω–µ–Ω–∏–µ —Ñ–æ–Ω–∞</h4>
                                <p>–ù–∞—Å–∫–æ–ª—å–∫–æ —Ç—ë–º–Ω—ã–π –æ–≤–µ—Ä–ª–µ–π –ø–æ–≤–µ—Ä—Ö —Ñ–æ—Ç–æ</p>
                            </div>
                            <div style="display:flex;align-items:center;gap:10px;">
                                <input type="range" id="chatBgOpacity" min="0" max="90" value="40" style="width:100px;" oninput="applyChatBgOpacity(this.value)">
                                <span id="chatBgOpacityVal" style="color:var(--accent-color);font-size:13px;min-width:32px;">40%</span>
                            </div>
                        </div>
                    </div>

                </div>
                
                <!-- –í–∫–ª–∞–¥–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ -->
                <div id="securityTab" class="settings-tab-content" style="display: none;">
                    <div class="settings-section">
                        <h3><i class="fas fa-shield-alt"></i> <span id="i18n_security_section">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏</span></h3>
                        <div class="setting-item">
                            <div class="setting-label">
                                <h4 id="i18n_xss">–ó–∞—â–∏—Ç–∞ –æ—Ç XSS</h4>
                                <p id="i18n_xss_desc">–≠–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ HTML –≤ —Å–æ–æ–±—â–µ–Ω–∏—è—Ö</p>
                            </div>
                            <label class="switch"><input type="checkbox" id="xssProtection" checked disabled><span class="slider"></span></label>
                        </div>
                        <div class="setting-item">
                            <div class="setting-label">
                                <h4 id="i18n_file_check">–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∞–π–ª–æ–≤</h4>
                                <p id="i18n_file_check_desc">–ü—Ä–æ–≤–µ—Ä—è—Ç—å —Ç–∏–ø –∏ —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–æ–≤</p>
                            </div>
                            <label class="switch"><input type="checkbox" id="fileValidation" checked><span class="slider"></span></label>
                        </div>
                        <div class="setting-item">
                            <div class="setting-label">
                                <h4 id="i18n_data_valid">–í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö</h4>
                                <p id="i18n_data_valid_desc">–ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–≤–æ–¥–∏–º—ã—Ö –¥–∞–Ω–Ω—ã—Ö</p>
                            </div>
                            <label class="switch"><input type="checkbox" id="dataValidation" checked><span class="slider"></span></label>
                        </div>
                        <div class="setting-item">
                            <div class="setting-label">
                                <h4 id="i18n_injection">–ó–∞—â–∏—Ç–∞ –æ—Ç –∏–Ω—ä–µ–∫—Ü–∏–π</h4>
                                <p id="i18n_injection_desc">–≠–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ SQL –∏ JS –∏–Ω—ä–µ–∫—Ü–∏–π</p>
                            </div>
                            <label class="switch"><input type="checkbox" id="injectionProtection" checked><span class="slider"></span></label>
                        </div>
                    </div>
                    <div class="settings-section">
                        <h3><i class="fas fa-history"></i> <span id="i18n_sec_history">–ò—Å—Ç–æ—Ä–∏—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏</span></h3>
                        <div style="background: rgba(0,0,0,0.2); border-radius: 10px; padding: 15px; max-height: 200px; overflow-y: auto;">
                            <div id="securityLogs"></div>
                        </div>
                    </div>
                    <div class="settings-section">
                        <h3><i class="fas fa-trash-alt"></i> <span id="i18n_clear_data_section">–û—á–∏—Å—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö</span></h3>
                        <div class="action-buttons">
                            <button class="action-btn action-btn-secondary" onclick="clearLocalStorage()">
                                <i class="fas fa-trash"></i> <span id="i18n_clear_cache">–û—á–∏—Å—Ç–∏—Ç—å –∫—ç—à</span>
                            </button>
                            <button class="action-btn action-btn-secondary" onclick="exportData()">
                                <i class="fas fa-download"></i> <span id="i18n_export_data">–≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö</span>
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- –í–∫–ª–∞–¥–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π -->
                <div id="notificationsTab" class="settings-tab-content" style="display: none;">
                    <div class="settings-section">
                        <h3><i class="fas fa-broadcast-tower"></i> <span id="i18n_notif_section">–ö–≤–∞–Ω—Ç–æ–≤—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</span></h3>
                        <div class="setting-item">
                            <div class="setting-label">
                                <h4 id="i18n_sound_notif">–ó–≤—É–∫–æ–≤—ã–µ —Å–∏–≥–Ω–∞–ª—ã</h4>
                                <p id="i18n_sound_notif_desc">–ó–≤—É–∫ –ø—Ä–∏ –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏—è—Ö</p>
                            </div>
                            <label class="switch"><input type="checkbox" id="soundNotifications" checked><span class="slider"></span></label>
                        </div>
                        <div class="setting-item">
                            <div class="setting-label">
                                <h4 id="i18n_visual_notif">–í–∏–∑—É–∞–ª—å–Ω—ã–µ –æ–ø–æ–≤–µ—â–µ–Ω–∏—è</h4>
                                <p id="i18n_visual_notif_desc">–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ –±—Ä–∞—É–∑–µ—Ä–µ</p>
                            </div>
                            <label class="switch"><input type="checkbox" id="showNotifications" checked><span class="slider"></span></label>
                        </div>
                    </div>
                </div>

                <!-- –í–∫–ª–∞–¥–∫–∞ –¥—Ä—É–∑–µ–π -->
                <div id="friendsTab" class="settings-tab-content" style="display: none;">
                    <div class="settings-section">
                        <h3><i class="fas fa-user-friends"></i> <span id="i18n_friends_section">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥—Ä—É–∑—å—è–º–∏</span></h3>
                        <div class="add-friend-form">
                            <input type="text" id="addFriendInput" placeholder="–í–≤–µ–¥–∏—Ç–µ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è" maxlength="20">
                            <button class="action-btn action-btn-primary" onclick="addFriendFromSettings()" style="width: 100%;">
                                <i class="fas fa-user-plus"></i> <span id="i18n_add_friend_btn">–î–æ–±–∞–≤–∏—Ç—å –¥—Ä—É–≥–∞</span>
                            </button>
                        </div>
                    </div>
                    <div class="settings-section">
                        <h3><i class="fas fa-users"></i> <span id="i18n_friends_list_section">–°–ø–∏—Å–æ–∫ –¥—Ä—É–∑–µ–π</span></h3>
                        <div id="settingsFriendsList"></div>
                    </div>
                </div>
                
                <!-- –í–∫–ª–∞–¥–∫–∞ —è–∑—ã–∫–∞ -->
                <div id="languageTab" class="settings-tab-content" style="display: none;">
                    <div class="settings-section">
                        <h3><i class="fas fa-globe"></i> <span id="i18n_lang_section">–Ø–∑—ã–∫ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞</span></h3>
                        <div class="language-selector">
                            <div class="language-option active" data-lang="ru" onclick="selectLanguage('ru')">üá∑üá∫ –†—É—Å—Å–∫–∏–π</div>
                            <div class="language-option" data-lang="en" onclick="selectLanguage('en')">üá∫üá∏ English</div>
                            <div class="language-option" data-lang="es" onclick="selectLanguage('es')">üá™üá∏ Espa√±ol</div>
                        </div>
                    </div>
                    <div class="settings-section">
                        <h3><i class="fas fa-language"></i> <span id="i18n_lang_settings_section">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —è–∑—ã–∫–∞</span></h3>
                        <div class="setting-item">
                            <div class="setting-label">
                                <h4 id="i18n_t9">T9 –ü–æ–¥—Å–∫–∞–∑–∫–∏</h4>
                                <p id="i18n_t9_desc">–í–∫–ª—é—á–∏—Ç—å –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã–π –≤–≤–æ–¥ —Ç–µ–∫—Å—Ç–∞</p>
                            </div>
                            <label class="switch"><input type="checkbox" id="t9Enabled" checked><span class="slider"></span></label>
                        </div>
                        <div class="setting-item">
                            <div class="setting-label">
                                <h4 id="i18n_autodetect">–ê–≤—Ç–æ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —è–∑—ã–∫–∞</h4>
                                <p id="i18n_autodetect_desc">–û–ø—Ä–µ–¥–µ–ª—è—Ç—å —è–∑—ã–∫ –≤–≤–æ–¥–∏–º–æ–≥–æ —Ç–µ–∫—Å—Ç–∞</p>
                            </div>
                            <label class="switch"><input type="checkbox" id="autoDetectLanguage" checked><span class="slider"></span></label>
                        </div>
                    </div>
                </div>
                
                <!-- –í–∫–ª–∞–¥–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –¥–ª—è –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ -->
                <div id="contactNotificationsTab" class="settings-tab-content" style="display: none;">
                    <div class="settings-section">
                        <h3><i class="fas fa-volume-mute"></i> <span id="i18n_contact_notif_section">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ –∫–æ–Ω—Ç–∞–∫—Ç–∞–º</span></h3>
                        <p id="i18n_contact_notif_desc" style="color: var(--text-secondary); margin-bottom: 20px;">
                            –ù–∞—Å—Ç—Ä–æ–π—Ç–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∫–æ–Ω—Ç–∞–∫—Ç–∞ –æ—Ç–¥–µ–ª—å–Ω–æ
                        </p>
                        <div id="contactNotificationList"></div>
                    </div>
                </div>

                <!-- –í–∫–ª–∞–¥–∫–∞ —á—ë—Ä–Ω–æ–≥–æ —Å–ø–∏—Å–∫–∞ -->
                <div id="blacklistTab" class="settings-tab-content" style="display: none;">
                    <div class="settings-section">
                        <h3><i class="fas fa-ban"></i> <span id="i18n_blacklist_section">–ß—ë—Ä–Ω—ã–π —Å–ø–∏—Å–æ–∫</span></h3>
                        <p id="i18n_blacklist_desc" style="color:var(--text-secondary);font-size:13px;margin-bottom:15px;">–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –º–æ–≥—É—Ç –≤–∞–º –ø–∏—Å–∞—Ç—å.</p>
                        <div id="settingsBlacklistContainer"></div>
                        <div style="margin-top:20px;padding:15px;background:rgba(0,0,0,0.2);border-radius:10px;border:1px solid var(--glass-border);">
                            <p id="i18n_block_by_id_label" style="color:var(--text-secondary);font-size:12px;margin-bottom:10px;">–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ ID:</p>
                            <div style="display:flex;gap:10px;">
                                <input type="text" id="blockByIdInput" placeholder="ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (Q115XXX)" maxlength="20"
                                    style="flex:1;padding:10px;background:rgba(0,0,0,0.2);border:1px solid var(--glass-border);border-radius:8px;color:var(--text-primary);font-size:13px;">
                                <button onclick="blockUserById()" class="action-btn action-btn-primary" style="padding:10px 15px;margin-top:0;flex:none;">
                                    <i class="fas fa-ban"></i> <span id="i18n_block_btn">–ë–ª–æ–∫</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="action-buttons">
                <button class="action-btn action-btn-secondary" onclick="closeModal('settingsModal')">
                    <i class="fas fa-times"></i> <span id="i18n_cancel_btn">–û—Ç–º–µ–Ω–∞</span>
                </button>
                <button class="action-btn action-btn-primary" onclick="saveSettings()">
                    <i class="fas fa-save"></i> <span id="i18n_save_btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</span>
                </button>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª: –ø–µ—Ä–µ—Å—ã–ª–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è -->
    <div class="modal" id="forwardModal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="modal-title">üì§ –ü–µ—Ä–µ—Å–ª–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ</span>
                <button class="close-modal" onclick="closeModal('forwardModal')">‚úï</button>
            </div>
            <div style="overflow-y:auto; max-height:50vh;" id="forwardChatList"></div>
            <div class="action-buttons" style="margin-top:15px;">
                <button class="action-btn action-btn-secondary" onclick="closeModal('forwardModal')">–û—Ç–º–µ–Ω–∞</button>
                <button class="action-btn action-btn-primary" onclick="confirmForward()">–ü–µ—Ä–µ—Å–ª–∞—Ç—å</button>
            </div>
        </div>
    </div>

    <!-- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ -->
    <div id="notification" class="notification">
        <strong id="notifTitle">–ö–≤–∞–Ω—Ç–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ</strong>
        <p id="notifMessage" style="margin-top: 10px;"></p>
    </div>

    <!-- –°–∫—Ä–∏–ø—Ç—ã -->

    <script>
    // ==================== AUTH & USER ISOLATION SYSTEM ====================
    // Simple hash function for password storage (not cryptographically secure, but non-reversible for demo)
    function qHash(str) {
        let h = 0;
        for (let i = 0; i < str.length; i++) {
            const ch = str.charCodeAt(i);
            h = ((h << 5) - h) + ch;
            h |= 0;
        }
        // Convert to positive hex + salt suffix
        return 'qh_' + (h >>> 0).toString(16) + '_' + btoa(str.slice(0, 2)).replace(/=/g, '');
    }

    // Get all registered users
    function getUsers() {
        try { return JSON.parse(localStorage.getItem('quantum_users') || '[]'); }
        catch(e) { return []; }
    }
    function saveUsers(users) {
        localStorage.setItem('quantum_users', JSON.stringify(users));
    }

    // Get current logged-in user email
    function getCurrentUserEmail() {
        return localStorage.getItem('quantum_current_user') || null;
    }
    function setCurrentUserEmail(email) {
        if (email) localStorage.setItem('quantum_current_user', email);
        else localStorage.removeItem('quantum_current_user');
    }

    // User-specific storage key helper
    function userKey(key) {
        const email = getCurrentUserEmail();
        if (!email) return key; // fallback
        return key + '__' + email;
    }

    // Switch auth tabs
    function switchAuthTab(tab) {
        document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.auth-form').forEach(f => f.classList.remove('active'));
        if (tab === 'login') {
            document.querySelectorAll('.auth-tab')[0].classList.add('active');
            document.getElementById('loginForm').classList.add('active');
        } else {
            document.querySelectorAll('.auth-tab')[1].classList.add('active');
            document.getElementById('registerForm').classList.add('active');
        }
        // Clear errors
        document.querySelectorAll('.auth-error').forEach(e => { e.textContent = ''; e.classList.remove('visible'); });
    }

    function showAuthError(id, msg) {
        const el = document.getElementById(id);
        el.textContent = msg;
        el.classList.add('visible');
    }

    function doRegister() {
        const name = document.getElementById('regName').value.trim() || 'User';
        const email = document.getElementById('regEmail').value.trim().toLowerCase();
        const pass = document.getElementById('regPassword').value;
        const pass2 = document.getElementById('regPasswordConfirm').value;

        if (!email || !email.includes('@')) return showAuthError('regError', '–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π email');
        if (pass.length < 4) return showAuthError('regError', '–ü–∞—Ä–æ–ª—å –º–∏–Ω–∏–º—É–º 4 —Å–∏–º–≤–æ–ª–∞');
        if (pass !== pass2) return showAuthError('regError', '–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç');

        let users = getUsers();
        if (users.find(u => u.email === email)) return showAuthError('regError', '–≠—Ç–æ—Ç email —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω');

        const newUser = {
            email: email,
            name: name,
            passwordHash: qHash(pass),
            createdAt: Date.now()
        };
        users.push(newUser);
        saveUsers(users);
        setCurrentUserEmail(email);

        // Migrate existing non-prefixed data to this user if this is the first user
        if (users.length === 1) {
            migrateExistingData(email);
        }

        hideAuthOverlay();
        initAppAfterAuth(name);
    }

    function doLogin() {
        const email = document.getElementById('loginEmail').value.trim().toLowerCase();
        const pass = document.getElementById('loginPassword').value;

        if (!email) return showAuthError('loginError', '–í–≤–µ–¥–∏—Ç–µ email');
        if (!pass) return showAuthError('loginError', '–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å');

        const users = getUsers();
        const user = users.find(u => u.email === email);
        if (!user) return showAuthError('loginError', '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω');
        if (user.passwordHash !== qHash(pass)) return showAuthError('loginError', '–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å');

        setCurrentUserEmail(email);
        hideAuthOverlay();
        initAppAfterAuth(user.name);
    }

    function quickLogin(email) {
        setCurrentUserEmail(email);
        const users = getUsers();
        const user = users.find(u => u.email === email);
        hideAuthOverlay();
        initAppAfterAuth(user ? user.name : 'User');
    }

    function deleteAccount(email, event) {
        event.stopPropagation();
        if (!confirm('–£–¥–∞–ª–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç ' + email + '? –í—Å–µ –¥–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –ø–æ—Ç–µ—Ä—è–Ω—ã.')) return;
        
        let users = getUsers();
        users = users.filter(u => u.email !== email);
        saveUsers(users);
        
        // Remove all user-specific data
        const prefix = '__' + email;
        const keysToRemove = [];
        for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if (key && key.endsWith(prefix)) keysToRemove.push(key);
        }
        keysToRemove.forEach(k => localStorage.removeItem(k));
        
        if (getCurrentUserEmail() === email) {
            setCurrentUserEmail(null);
        }
        
        renderSavedAccounts();
    }

    function renderSavedAccounts() {
        const container = document.getElementById('savedAccountsList');
        const users = getUsers();
        if (users.length === 0) { container.innerHTML = ''; return; }

        let html = '<div class="auth-accounts"><div class="auth-accounts-title">–°–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –∞–∫–∫–∞—É–Ω—Ç—ã</div>';
        users.forEach(u => {
            html += '<div class="auth-account-item" onclick="quickLogin(\''+u.email.replace(/'/g,"\\'")+'\')">';
            html += '<div class="acc-avatar">'+u.name.charAt(0).toUpperCase()+'</div>';
            html += '<div class="acc-info"><div class="acc-name">'+u.name+'</div><div class="acc-email">'+u.email+'</div></div>';
            html += '<button class="auth-account-delete" onclick="deleteAccount(\''+u.email.replace(/'/g,"\\'")+'\'  , event)" title="–£–¥–∞–ª–∏—Ç—å"><i class="fas fa-trash"></i></button>';
            html += '</div>';
        });
        html += '</div>';
        container.innerHTML = html;
    }

    function showAuthOverlay() {
        document.getElementById('authOverlay').classList.remove('hidden');
        renderSavedAccounts();
    }

    function hideAuthOverlay() {
        document.getElementById('authOverlay').classList.add('hidden');
    }

    function doLogout() {
        setCurrentUserEmail(null);
        location.reload();
    }

    // Migrate existing (non-prefixed) localStorage data to first user
    function migrateExistingData(email) {
        const keysToMigrate = [
            'quantum_user', 'quantum_contacts', 'quantum_chats',
            'quantum_custom_avatar', 'quantum_blacklist', 'quantum_pinned_chats',
            'quantum_theme', 'neonEnabled', 'quantum_csrf_token',
            'quantum_security_logs', 'quantum_chat_bg_photo',
            'quantum_chat_bg_preset', 'quantum_chat_bg_opacity'
        ];

        keysToMigrate.forEach(key => {
            const val = localStorage.getItem(key);
            if (val !== null) {
                localStorage.setItem(key + '__' + email, val);
            }
        });

        // Migrate quantum_messages_* and quantum_media_*
        for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if (key && (key.startsWith('quantum_messages_') || key.startsWith('quantum_media_')) && !key.includes('__')) {
                const val = localStorage.getItem(key);
                if (val !== null) {
                    localStorage.setItem(key + '__' + email, val);
                }
            }
        }
    }

    function initAppAfterAuth(displayName) {
        // Initialize the app after successful auth
        // Now localStorage is scoped to the user
        try {
            if (!localStorage.getItem('quantum_csrf_token')) {
                localStorage.setItem('quantum_csrf_token', generateCSRFToken());
            }

            // If first time for this user, set display name
            var savedUser = localStorage.getItem('quantum_user');
            if (!savedUser && displayName) {
                // Will be set when loadFromLocalStorage runs with defaults
            }

            loadFromLocalStorage();

            // Set the display name from registration if user data is default
            if (displayName && displayName !== 'User' && currentUser.name === '–ö–≤–∞–Ω—Ç–æ–≤—ã–π –ü—É—Ç–Ω–∏–∫') {
                currentUser.name = displayName;
                saveToLocalStorage();
            }

            initEmojiPicker();
            initAvatarGrid();
            initT9();
            initializeSecurity();

            var loggedLabel = document.getElementById('loggedInAsLabel');
            if (loggedLabel) loggedLabel.textContent = '–í—ã –≤–æ—à–ª–∏ –∫–∞–∫: ' + getCurrentUserEmail();

            showApp();
        } catch(e) {
            console.error('Error initializing app after auth:', e);
        }
    }

    // Handle Enter key in auth fields
    document.addEventListener('keydown', function(e) {
        if (document.getElementById('authOverlay').classList.contains('hidden')) return;
        if (e.key === 'Enter') {
            if (document.getElementById('loginForm').classList.contains('active')) doLogin();
            else doRegister();
        }
    });
    </script>

    <script>
        // ==================== IndexedDB –î–õ–Ø –ú–ï–î–ò–ê–§–ê–ô–õ–û–í (v5.6) ====================
        const MEDIA_DB_NAME = 'QuantumMediaDB';
        const MEDIA_DB_VERSION = 1;
        const MEDIA_STORE = 'mediaFiles';
        let mediaDB = null;

        function openMediaDB() {
            return new Promise((resolve, reject) => {
                if (mediaDB) { resolve(mediaDB); return; }
                const req = indexedDB.open(MEDIA_DB_NAME, MEDIA_DB_VERSION);
                req.onupgradeneeded = e => {
                    const db = e.target.result;
                    if (!db.objectStoreNames.contains(MEDIA_STORE)) {
                        db.createObjectStore(MEDIA_STORE, { keyPath: 'id' });
                    }
                };
                req.onsuccess = e => { mediaDB = e.target.result; resolve(mediaDB); };
                req.onerror = e => reject(e.target.error);
            });
        }

        async function saveMediaToIDB(id, base64data, type, chatId) {
            const db = await openMediaDB();
            return new Promise((resolve, reject) => {
                const tx = db.transaction(MEDIA_STORE, 'readwrite');
                tx.objectStore(MEDIA_STORE).put({ id: String(id), data: base64data, type, chatId: String(chatId) });
                tx.oncomplete = () => resolve();
                tx.onerror = e => reject(e.target.error);
            });
        }

        async function getMediaFromIDB(id) {
            const db = await openMediaDB();
            return new Promise((resolve, reject) => {
                const tx = db.transaction(MEDIA_STORE, 'readonly');
                const req = tx.objectStore(MEDIA_STORE).get(String(id));
                req.onsuccess = e => resolve(e.target.result ? e.target.result.data : null);
                req.onerror = e => reject(e.target.error);
            });
        }

        async function getAllMediaFromIDB(chatId) {
            const db = await openMediaDB();
            return new Promise((resolve, reject) => {
                const tx = db.transaction(MEDIA_STORE, 'readonly');
                const req = tx.objectStore(MEDIA_STORE).getAll();
                req.onsuccess = e => {
                    const all = e.target.result || [];
                    resolve(all.filter(m => String(m.chatId) === String(chatId)));
                };
                req.onerror = e => reject(e.target.error);
            });
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ë–î —Å—Ä–∞–∑—É –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        openMediaDB().catch(e => console.warn('IndexedDB –Ω–µ –¥–æ—Å—Ç—É–ø–Ω–∞:', e));

        // ==================== USER-SCOPED STORAGE ====================
        // Override localStorage for user-specific data isolation
        (function() {
            const _origGetItem = localStorage.getItem.bind(localStorage);
            const _origSetItem = localStorage.setItem.bind(localStorage);
            const _origRemoveItem = localStorage.removeItem.bind(localStorage);

            const SCOPED_PREFIXES = [
                'quantum_user', 'quantum_contacts', 'quantum_chats',
                'quantum_custom_avatar', 'quantum_blacklist', 'quantum_pinned_chats',
                'quantum_theme', 'neonEnabled', 'quantum_csrf_token',
                'quantum_security_logs', 'quantum_chat_bg_photo',
                'quantum_chat_bg_preset', 'quantum_chat_bg_opacity',
                'quantum_messages_', 'quantum_media_'
            ];

            function shouldScope(key) {
                if (!key) return false;
                // Don't scope the user registry or current user marker
                if (key === 'quantum_users' || key === 'quantum_current_user') return false;
                for (const prefix of SCOPED_PREFIXES) {
                    if (key === prefix || key.startsWith(prefix)) return true;
                }
                return false;
            }

            function scopedKey(key) {
                const email = _origGetItem('quantum_current_user');
                if (!email || !shouldScope(key)) return key;
                // Avoid double-scoping
                if (key.includes('__')) return key;
                return key + '__' + email;
            }

            localStorage.getItem = function(key) {
                return _origGetItem(scopedKey(key));
            };
            localStorage.setItem = function(key, value) {
                return _origSetItem(scopedKey(key), value);
            };
            localStorage.removeItem = function(key) {
                return _origRemoveItem(scopedKey(key));
            };
        })();


        // ==================== –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ====================
        // ==================== –ò–î–ï–ù–¢–ò–§–ò–ö–ê–¢–û–† –í–õ–ê–î–ï–õ–¨–¶–ê ====================
        // –ü–æ—Å—Ç–æ—è–Ω–Ω—ã–π ID –≤–ª–∞–¥–µ–ª—å—Ü–∞ ‚Äî –Ω–µ –∏–∑–º–µ–Ω—è–µ—Ç—Å—è –Ω–∏–∫–æ–≥–¥–∞
        const OWNER_ID = 'QCEO35';

        let currentUser = {
            id: OWNER_ID,
            name: '–ö–≤–∞–Ω—Ç–æ–≤—ã–π –ü—É—Ç–Ω–∏–∫',
            avatar: 'üë§',
            status: 'online',
            language: 'ru',
            friends: ['Q115002', 'Q115003', 'Q115005'],
            notificationSettings: {},
            security: {
                xssProtection: true,
                fileValidation: true,
                dataValidation: true,
                injectionProtection: true,
                lastSecurityScan: Date.now()
            },
            settings: {
                neonEffects: localStorage.getItem('neonEnabled') === 'true',
                darkTheme: true,
                soundNotifications: true,
                showNotifications: true,
                accentColor: '#667eea',
                t9Enabled: true,
                autoDetectLanguage: true
            }
        };

        let contacts = [
            {id: 'Q115002', name: '–ö–≤–∞–Ω—Ç–æ–≤—ã–π –ò–Ω–∂–µ–Ω–µ—Ä', avatar: 'üë®‚Äçüíª', status: 'online', isFriend: true, notificationSetting: 'normal'},
            {id: 'Q115003', name: '–ö–æ—Å–º–∏—á–µ—Å–∫–∞—è –ò—Å—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å', avatar: 'üë©‚ÄçüöÄ', status: 'away', isFriend: true, notificationSetting: 'silent'},
            {id: 'Q115004', name: '–ù–µ–π—Ä–æ–Ω–Ω—ã–π –°–µ—Ç—å', avatar: 'ü§ñ', status: 'online', isFriend: false, notificationSetting: 'normal'},
            {id: 'Q115005', name: '–í–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π –ê—Å—Å–∏—Å—Ç–µ–Ω—Ç', avatar: 'üë©‚Äçüî¨', status: 'busy', isFriend: true, notificationSetting: 'muted'},
            {id: 'Q115006', name: '–¶–∏—Ñ—Ä–æ–≤–æ–π –•—É–¥–æ–∂–Ω–∏–∫', avatar: 'üë®‚Äçüé®', status: 'online', isFriend: false, notificationSetting: 'normal'},
            {id: 'Q115007', name: '–ê–ª–µ–∫—Å–∞–Ω–¥—Ä –ö–≤–∞–Ω—Ç–æ–≤', avatar: 'üë®‚Äçüî¨', status: 'online', isFriend: false, notificationSetting: 'normal'},
            {id: 'Q115008', name: '–ö–∏—Ä–∏–ª–ª –¢–µ—Ö–Ω–æ', avatar: 'üë®‚Äçüíº', status: 'online', isFriend: true, notificationSetting: 'normal'},
            {id: 'Q115009', name: '–ö–∞—Ä–∏–Ω–∞ –ó–≤–µ–∑–¥–Ω–∞—è', avatar: 'üë©‚Äçüé§', status: 'away', isFriend: false, notificationSetting: 'normal'},
            {id: 'Q115010', name: '–ö–æ–Ω—Å—Ç–∞–Ω—Ç–∏–Ω –ò–ò', avatar: 'ü§µ', status: 'online', isFriend: true, notificationSetting: 'normal'}
        ];

        let chats = [];
        let mediaChats = []; // –í—Ä–µ–º–µ–Ω–Ω—ã–µ —á–∞—Ç—ã —Ç–æ–ª—å–∫–æ –¥–ª—è –º–µ–¥–∏–∞ (–Ω–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è)
        let messages = {};
        let currentChat = null;
        let isMediaChatMode = false; // –§–ª–∞–≥ —Ä–µ–∂–∏–º–∞ –º–µ–¥–∏–∞-—á–∞—Ç–∞
        let selectedGroupMembers = [];
        let currentEditingContactId = null;
        let currentRenamingContactId = null;
        let callData = {
            currentCall: null,
            callTimer: null,
            callDuration: 0,
            isCallActive: false,
            callDirection: null,
            localStream: null,
            remoteStream: null,
            isVideoCall: false,
            isCameraEnabled: true,
            isMicEnabled: true,
            isFrontCamera: true
        };

        const emojiList = ["üòÄ", "üòÇ", "üòä", "üòç", "ü§î", "üòé", "üëç", "‚ù§Ô∏è", "üî•", "üéâ", "üôè", "üíØ", "‚ú®", "ü•≥", "ü§©", "üòá", "ü§ó", "üòú", "üòò", "ü•∞", "üò≠", "üò°", "ü§Ø", "ü•∫", "ü§™", "üò¥", "ü§Æ", "ü§ß", "üò∑", "ü§†", "ü•¥", "ü§ì", "üßê", "üòà", "üëª", "üí©", "ü§ñ", "üëã", "‚úåÔ∏è", "ü§û", "ü§ü", "üëå", "ü§ô", "üëè", "üôå", "ü§ù", "üí™", "üëÄ", "üß†", "üë®‚Äçüíª", "üë©‚Äçüíª", "üöÄ", "‚ö°", "‚öõÔ∏è", "üí¨", "üì±", "üíª", "üéµ", "üéÆ", "üèÜ", "‚≠ê", "üåà", "üåç", "üé®", "üîí", "üîë", "üîî", "üí°", "üí∞", "üéÅ", "üìå", "üìç", "üì∏", "üîç", "üõ†Ô∏è", "‚öôÔ∏è", "üîß", "üß∞", "üéØ", "üîÆ", "üíé", "üíä", "üß™", "üî¨", "üíâ", "üß¨", "ü¶†", "üß´", "üß≤", "‚öóÔ∏è"];


        // ===== –ß–Å–†–ù–´–ô –°–ü–ò–°–û–ö - –æ–±—ä—è–≤–ª—è–µ–º –≤ —Å–∞–º–æ–º –Ω–∞—á–∞–ª–µ =====
        let blacklist = JSON.parse(localStorage.getItem('quantum_blacklist') || '[]');
        function saveBlacklist() { localStorage.setItem('quantum_blacklist', JSON.stringify(blacklist)); }
        function isBlocked(contactId) { return blacklist.some(function(b){ return b.id === contactId; }); }
        
        // ===== –ì–û–õ–û–°–û–í–´–ï / –í–ò–î–ï–û - –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ =====
        var voiceRecorder = null, voiceRecording = false, voiceChunks = [], voiceSeconds = 0, voiceTimerInterval = null, currentPlayingAudio = null;
        var videoCallTimer = null, videoCallSeconds = 0, videoCameraEnabled = true, videoMicEnabled = true, videoFrontCamera = true, videoLocalStream = null;

        // ==================== –§–£–ù–ö–¶–ò–ò –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–ò ====================
        
        // –≠–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ HTML –¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç XSS
        function escapeHtml(text) {
            if (!text) return '';
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.toString().replace(/[&<>"']/g, function(m) { return map[m]; });
        }

        // –í–∞–ª–∏–¥–∞—Ü–∏—è ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        function validateUserId(userId) {
            if (userId === OWNER_ID) return true; // ID –≤–ª–∞–¥–µ–ª—å—Ü–∞ –≤—Å–µ–≥–¥–∞ –≤–∞–ª–∏–¥–µ–Ω
            const pattern = /^Q[0-9]{6}$/;
            return pattern.test(userId);
        }

        // –í–∞–ª–∏–¥–∞—Ü–∏—è –∏–º–µ–Ω–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        function validateUserName(name) {
            if (!name || name.trim().length === 0) return false;
            if (name.length > 50) return false;
            const dangerousPatterns = /[<>"'`;]/;
            return !dangerousPatterns.test(name);
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ —Ñ–∞–π–ª–∞
        function validateFile(file) {
            const MAX_FILE_SIZE = 1024 * 1024 * 1024; // 1GB
            const ALLOWED_TYPES = [
                'image/jpeg', 'image/png', 'image/gif', 'image/webp',
                'video/mp4', 'video/webm', 'video/ogg',
                'application/pdf', 'text/plain',
                'application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document'
            ];

            if (file.size > MAX_FILE_SIZE) {
                return { valid: false, error: '–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π (–º–∞–∫—Å. 1GB)' };
            }

            if (!ALLOWED_TYPES.includes(file.type) && !file.name.match(/\.(jpg|jpeg|png|gif|webp|mp4|webm|ogg|pdf|txt|doc|docx)$/i)) {
                return { valid: false, error: '–¢–∏–ø —Ñ–∞–π–ª–∞ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è' };
            }

            return { valid: true, error: null };
        }

        // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è CSRF —Ç–æ–∫–µ–Ω–∞
        function generateCSRFToken() {
            return 'csrf_' + Math.random().toString(36).substr(2) + Date.now().toString(36);
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ CSRF —Ç–æ–∫–µ–Ω–∞
        function validateCSRFToken(token) {
            const savedToken = localStorage.getItem('quantum_csrf_token');
            return token === savedToken;
        }

        // –ü—Ä–æ—Å—Ç–æ–µ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
        function simpleEncrypt(data, key) {
            if (!data) return '';
            let result = '';
            for (let i = 0; i < data.length; i++) {
                result += String.fromCharCode(data.charCodeAt(i) ^ key.charCodeAt(i % key.length));
            }
            return btoa(result);
        }

        // –ü—Ä–æ—Å—Ç–æ–µ –¥–µ—à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
        function simpleDecrypt(encryptedData, key) {
            if (!encryptedData) return '';
            try {
                const data = atob(encryptedData);
                let result = '';
                for (let i = 0; i < data.length; i++) {
                    result += String.fromCharCode(data.charCodeAt(i) ^ key.charCodeAt(i % key.length));
                }
                return result;
            } catch (e) {
                console.error('–û—à–∏–±–∫–∞ –¥–µ—à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è:', e);
                return '';
            }
        }

        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ª–æ–≥–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
        function logSecurityEvent(event, level = 'info') {
            const logEntry = {
                timestamp: new Date().toISOString(),
                event: event,
                level: level,
                user: currentUser.id
            };

            let securityLogs = JSON.parse(localStorage.getItem('quantum_security_logs') || '[]');
            securityLogs.unshift(logEntry);
            if (securityLogs.length > 100) {
                securityLogs = securityLogs.slice(0, 100);
            }
            localStorage.setItem('quantum_security_logs', JSON.stringify(securityLogs));

            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI –µ—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç–∞ –≤–∫–ª–∞–¥–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
            if (document.getElementById('securityLogs')) {
                updateSecurityLogs();
            }
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ª–æ–≥–æ–≤ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
        function updateSecurityLogs() {
            const logsContainer = document.getElementById('securityLogs');
            if (!logsContainer) return;

            let securityLogs = JSON.parse(localStorage.getItem('quantum_security_logs') || '[]');
            logsContainer.innerHTML = '';

            if (securityLogs.length === 0) {
                logsContainer.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--text-secondary);">–ù–µ—Ç —Å–æ–±—ã—Ç–∏–π –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏</div>';
                return;
            }

            securityLogs.forEach(log => {
                const logElement = document.createElement('div');
                logElement.style.padding = '8px';
                logElement.style.borderBottom = '1px solid rgba(255,255,255,0.1)';
                logElement.style.fontSize = '12px';

                const time = new Date(log.timestamp).toLocaleTimeString();
                let levelColor = 'var(--accent-color)';
                if (log.level === 'warning') levelColor = 'var(--security-yellow)';
                if (log.level === 'critical') levelColor = 'var(--security-red)';

                logElement.innerHTML = `
                    <span style="color: var(--text-secondary);">${time}</span>
                    <span style="color: ${levelColor}; margin: 0 10px;">${log.level.toUpperCase()}</span>
                    <span style="color: var(--text-primary);">${escapeHtml(log.event)}</span>
                `;
                logsContainer.appendChild(logElement);
            });
        }

        // –û—Ç–∫—Ä—ã—Ç–∏–µ –ø–∞–Ω–µ–ª–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
        function openSecurityPanel() {
            const panel = document.getElementById('securityPanel');
            panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
        }

        // ==================== –§–£–ù–ö–¶–ò–ò –ö–ê–ú–ï–†–´ ====================
        let cameraStream = null;
        let cameraTimer = null;
        let cameraSeconds = 0;
        let isFrontCamera = true;
        let isRecording = false;
        let mediaRecorder = null;
        let recordedChunks = [];

        function openCameraModal() {
            document.getElementById('cameraModal').style.display = 'flex';
            startCamera();
        }

        function closeCameraModal() {
            document.getElementById('cameraModal').style.display = 'none';
            stopCamera();
            resetCameraTimer();
        }

        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –¥–ª—è –∞–¥–∞–ø—Ç–∏–≤–Ω—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∫–∞–º–µ—Ä—ã
        function isMobileDevice() {
            return /Android|iPhone|iPad|iPod|Mobile/i.test(navigator.userAgent) ||
                   (navigator.maxTouchPoints > 1 && window.innerWidth < 1024);
        }

        function getCameraConstraints(facingModeVal, forCall = false) {
            const mobile = isMobileDevice();
            return {
                video: {
                    facingMode: facingModeVal,
                    width:  mobile ? { ideal: 1280 } : { ideal: 1280, max: 1920 },
                    height: mobile ? { ideal: 720  } : { ideal: 720,  max: 1080 },
                    frameRate: { ideal: 30, max: 30 },
                    resizeMode: 'crop-and-scale'
                },
                audio: forCall
            };
        }

        async function startCamera() {
            try {
                const constraints = getCameraConstraints(isFrontCamera ? "user" : "environment", false);

                cameraStream = await navigator.mediaDevices.getUserMedia(constraints);
                const videoElement = document.getElementById('cameraVideo');
                videoElement.srcObject = cameraStream;
                
                startCameraTimer();
                showNotification('–ö–∞–º–µ—Ä–∞ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞', 'success');
                logSecurityEvent('–ö–∞–º–µ—Ä–∞ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞', 'info');
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ:', error);
                showNotification('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–µ–º–æ-—Ä–µ–∂–∏–º.', 'warning');
                logSecurityEvent('–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ', 'warning');
                
                // –î–µ–º–æ-—Ä–µ–∂–∏–º
                const videoElement = document.getElementById('cameraVideo');
                const canvas = document.createElement('canvas');
                canvas.width = 640;
                canvas.height = 480;
                const ctx = canvas.getContext('2d');
                
                function drawDemoFrame() {
                    ctx.fillStyle = '#0a0a0f';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                    
                    ctx.fillStyle = '#667eea';
                    ctx.font = 'bold 30px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText('–î–ï–ú–û-–†–ï–ñ–ò–ú –ö–ê–ú–ï–†–´', canvas.width/2, canvas.height/2 - 30);
                    ctx.font = '20px Arial';
                    ctx.fillStyle = '#ffffff';
                    ctx.fillText('–ù–∞–∂–º–∏—Ç–µ üì∏ –¥–ª—è –¥–µ–º–æ-—Ñ–æ—Ç–æ', canvas.width/2, canvas.height/2 + 30);
                    
                    ctx.beginPath();
                    ctx.arc(canvas.width/2, canvas.height/2 - 100, 60, 0, Math.PI * 2);
                    ctx.strokeStyle = '#00d4ff';
                    ctx.lineWidth = 5;
                    ctx.stroke();
                    
                    const stream = canvas.captureStream(30);
                    videoElement.srcObject = stream;
                    cameraStream = stream;
                    
                    requestAnimationFrame(drawDemoFrame);
                }
                
                drawDemoFrame();
                startCameraTimer();
            }
        }

        function stopCamera() {
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
            }
            
            if (mediaRecorder && isRecording) {
                mediaRecorder.stop();
                isRecording = false;
                document.getElementById('recordBtn').innerHTML = '‚è∫Ô∏è';
            }
            
            resetCameraTimer();
        }

        function startCameraTimer() {
            cameraSeconds = 0;
            updateCameraTimer();
            cameraTimer = setInterval(() => {
                cameraSeconds++;
                updateCameraTimer();
            }, 1000);
        }

        function resetCameraTimer() {
            if (cameraTimer) {
                clearInterval(cameraTimer);
                cameraTimer = null;
            }
            document.getElementById('cameraTimer').textContent = '00:00';
        }

        function updateCameraTimer() {
            const minutes = Math.floor(cameraSeconds / 60);
            const seconds = cameraSeconds % 60;
            document.getElementById('cameraTimer').textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        function flipCamera() {
            isFrontCamera = !isFrontCamera;
            stopCamera();
            setTimeout(() => startCamera(), 300);
            showNotification(`–ö–∞–º–µ—Ä–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∞ –Ω–∞ ${isFrontCamera ? '–ø–µ—Ä–µ–¥–Ω—é—é' : '–∑–∞–¥–Ω—é—é'}`, 'info');
        }

        function capturePhoto() {
            const countdownElement = document.getElementById('cameraCountdown');
            countdownElement.style.display = 'block';
            
            let count = 3;
            countdownElement.textContent = count;
            
            const countdownInterval = setInterval(() => {
                count--;
                if (count > 0) {
                    countdownElement.textContent = count;
                } else {
                    clearInterval(countdownInterval);
                    countdownElement.textContent = 'üì∏';
                    
                    setTimeout(() => {
                        countdownElement.style.display = 'none';
                        takePhoto();
                    }, 300);
                }
            }, 1000);
        }

        function takePhoto() {
            const video = document.getElementById('cameraVideo');
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth || 640;
            canvas.height = video.videoHeight || 480;
            
            const context = canvas.getContext('2d');
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            // –î–æ–±–∞–≤–ª—è–µ–º –∫–≤–∞–Ω—Ç–æ–≤—ã–π —ç—Ñ—Ñ–µ–∫—Ç
            context.fillStyle = 'rgba(102, 126, 234, 0.3)';
            context.fillRect(0, 0, canvas.width, canvas.height);
            
            context.font = '20px Arial';
            context.fillStyle = '#ffffff';
            context.textAlign = 'center';
            context.fillText('QUANTUM PHOTO', canvas.width/2, 40);
            
            const date = new Date();
            context.font = '14px Arial';
            context.fillText(date.toLocaleDateString() + ' ' + date.toLocaleTimeString(), canvas.width/2, canvas.height - 20);
            
            canvas.toBlob(function(blob) {
                const fileName = `quantum_photo_${Date.now()}.jpg`;
                const file = new File([blob], fileName, { type: 'image/jpeg' });
                sendImageFromCamera(file);
                closeCameraModal();
                showNotification('–ö–≤–∞–Ω—Ç–æ–≤–æ–µ —Ñ–æ—Ç–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ!', 'success');
                logSecurityEvent('–§–æ—Ç–æ —Å–¥–µ–ª–∞–Ω–æ –∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ', 'info');
            }, 'image/jpeg', 0.9);
        }

        function startVideoRecording() {
            if (!isRecording) {
                if (cameraStream) {
                    recordedChunks = [];
                    mediaRecorder = new MediaRecorder(cameraStream);
                    
                    mediaRecorder.ondataavailable = function(event) {
                        if (event.data.size > 0) {
                            recordedChunks.push(event.data);
                        }
                    };
                    
                    mediaRecorder.onstop = function() {
                        const blob = new Blob(recordedChunks, { type: 'video/webm' });
                        const fileName = `quantum_video_${Date.now()}.webm`;
                        const file = new File([blob], fileName, { type: 'video/webm' });
                        sendVideoFromCamera(file);
                        showNotification('–ö–≤–∞–Ω—Ç–æ–≤–æ–µ –≤–∏–¥–µ–æ –∑–∞–ø–∏—Å–∞–Ω–æ!', 'success');
                        logSecurityEvent('–í–∏–¥–µ–æ –∑–∞–ø–∏—Å–∞–Ω–æ –∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ', 'info');
                    };
                    
                    mediaRecorder.start();
                    isRecording = true;
                    document.getElementById('recordBtn').innerHTML = '‚èπÔ∏è';
                    showNotification('–ù–∞—á–∞—Ç–∞ –∑–∞–ø–∏—Å—å –≤–∏–¥–µ–æ', 'info');
                }
            } else {
                if (mediaRecorder) {
                    mediaRecorder.stop();
                    isRecording = false;
                    document.getElementById('recordBtn').innerHTML = '‚è∫Ô∏è';
                }
            }
        }

        function sendVideoFromCamera(file) {
            if (!currentChat) {
                showNotification('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç', 'error');
                return;
            }
            // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ base64 —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å blob:null –æ—à–∏–±–∫–∏
            const reader = new FileReader();
            reader.onloadend = function() {
                const base64data = reader.result;
                const fileSize = formatFileSize(file.size);
                sendMediaMessageDirect(base64data, 'video', fileSize);
                showNotification('üé• –í–∏–¥–µ–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ', 'success');
            };
            reader.readAsDataURL(file);
        }

        function sendImageFromCamera(file) {
            if (!currentChat) {
                showNotification('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç', 'error');
                return;
            }
            // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ base64 —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å blob:null –æ—à–∏–±–∫–∏
            const reader = new FileReader();
            reader.onloadend = function() {
                const base64data = reader.result;
                const fileSize = formatFileSize(file.size);
                sendMediaMessageDirect(base64data, 'photo', fileSize);
                showNotification('üì∏ –§–æ—Ç–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ', 'success');
            };
            reader.readAsDataURL(file);
        }

        // ==================== –§–£–ù–ö–¶–ò–ò –í–ò–î–ï–û–ó–í–û–ù–ö–ê –° –ü–ï–†–ï–í–û–†–û–¢–û–ú –ö–ê–ú–ï–†–´ ====================
        async function startVideoCall() {
            if (!currentChat) {
                showNotification('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –∫–≤–∞–Ω—Ç–æ–≤—ã–π –∫–∞–Ω–∞–ª', 'warning');
                return;
            }
            
            // üîä –†–∏–Ω–≥—Ç–æ–Ω –∏—Å—Ö–æ–¥—è—â–µ–≥–æ –≤–∏–¥–µ–æ–∑–≤–æ–Ω–∫–∞
            if (typeof soundOutgoingRingtone === 'function') soundOutgoingRingtone();
            
            try {
                callData.localStream = await navigator.mediaDevices.getUserMedia(
                    getCameraConstraints(callData.isFrontCamera ? "user" : "environment", true)
                );
                
                document.getElementById('localVideo').srcObject = callData.localStream;
                
                callData.currentCall = {
                    type: 'video',
                    contact: currentChat,
                    status: 'calling',
                    direction: 'outgoing'
                };
                
                showVideoCallScreen();
                showNotification(`–ù–∞—á–∏–Ω–∞–µ–º –≤–∏–¥–µ–æ–∑–≤–æ–Ω–æ–∫ —Å ${currentChat.name}`, 'info');
                logSecurityEvent(`–ù–∞—á–∞—Ç –≤–∏–¥–µ–æ–∑–≤–æ–Ω–æ–∫ —Å ${currentChat.name}`, 'info');
                
                setTimeout(() => {
                    if (callData.currentCall && callData.currentCall.status === 'calling') {
                        callData.currentCall.status = 'connected';
                        startCallTimer();
                        callData.isCallActive = true;
                        callData.isVideoCall = true;
                        showNotification(`–í–∏–¥–µ–æ—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å ${currentChat.name} —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ`, 'success');
                        
                        simulateRemoteVideo();
                    }
                }, 3000);
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ:', error);
                showNotification('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ', 'error');
                logSecurityEvent('–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ –ø—Ä–∏ –∑–≤–æ–Ω–∫–µ', 'warning');
                startVoiceCall();
            }
        }

        function showVideoCallScreen() {
            document.getElementById('videoContainer').style.display = 'flex';
            document.getElementById('callScreen').style.display = 'none';
            
            callData.isCameraEnabled = true;
            callData.isMicEnabled = true;
            
            startCallTimer();
        }

        // –§—É–Ω–∫—Ü–∏—è –ø–µ—Ä–µ–≤–æ—Ä–æ—Ç–∞ –∫–∞–º–µ—Ä—ã –≤ –≤–∏–¥–µ–æ–∑–≤–æ–Ω–∫–µ
        async function flipVideoCallCamera() {
            if (!callData.localStream) return;
            
            // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—É—â–∏–µ —Ç—Ä–µ–∫–∏
            callData.localStream.getTracks().forEach(track => track.stop());
            
            // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º –∫–∞–º–µ—Ä—É
            callData.isFrontCamera = !callData.isFrontCamera;
            
            try {
                // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –Ω–æ–≤—ã–π –ø–æ—Ç–æ–∫ —Å –ø–µ—Ä–µ–≤–µ—Ä–Ω—É—Ç–æ–π –∫–∞–º–µ—Ä–æ–π
                callData.localStream = await navigator.mediaDevices.getUserMedia(
                    getCameraConstraints(callData.isFrontCamera ? "user" : "environment", true)
                );
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –≤–∏–¥–µ–æ
                document.getElementById('localVideo').srcObject = callData.localStream;
                
                showNotification(`–ö–∞–º–µ—Ä–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∞ –Ω–∞ ${callData.isFrontCamera ? '–ø–µ—Ä–µ–¥–Ω—é—é' : '–∑–∞–¥–Ω—é—é'}`, 'info');
                logSecurityEvent(`–ö–∞–º–µ—Ä–∞ –≤–∏–¥–µ–æ–∑–≤–æ–Ω–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∞ –Ω–∞ ${callData.isFrontCamera ? '–ø–µ—Ä–µ–¥–Ω—é—é' : '–∑–∞–¥–Ω—é—é'}`, 'info');
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –∫–∞–º–µ—Ä—ã:', error);
                showNotification('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –∫–∞–º–µ—Ä—É', 'error');
                logSecurityEvent('–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –∫–∞–º–µ—Ä—ã –≤ –≤–∏–¥–µ–æ–∑–≤–æ–Ω–∫–µ', 'warning');
            }
        }

        function simulateRemoteVideo() {
            const remoteVideo = document.getElementById('remoteVideo');
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = 640;
            canvas.height = 480;
            
            function drawFrame() {
                if (!callData.isCallActive || !callData.isVideoCall) return;
                
                ctx.fillStyle = '#0a0a0f';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                ctx.fillStyle = '#667eea';
                ctx.font = 'bold 48px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(currentChat.avatar, canvas.width/2, canvas.height/2);
                
                ctx.font = 'bold 24px Arial';
                ctx.fillStyle = '#ffffff';
                ctx.fillText(currentChat.name, canvas.width/2, canvas.height/2 + 60);
                
                ctx.fillStyle = '#00ff9d';
                ctx.beginPath();
                ctx.arc(canvas.width - 50, 50, 20, 0, Math.PI * 2);
                ctx.fill();
                
                const stream = canvas.captureStream(30);
                remoteVideo.srcObject = stream;
                
                requestAnimationFrame(drawFrame);
            }
            
            drawFrame();
        }

        function toggleCamera() {
            if (!callData.localStream) return;
            
            callData.isCameraEnabled = !callData.isCameraEnabled;
            const videoTracks = callData.localStream.getVideoTracks();
            videoTracks.forEach(track => {
                track.enabled = callData.isCameraEnabled;
            });
            
            const btn = document.querySelector('.toggle-camera');
            btn.innerHTML = callData.isCameraEnabled ? 'üìπ' : 'üö´';
            btn.style.background = callData.isCameraEnabled ? 'var(--accent-green)' : 'var(--accent-red)';
            
            showNotification(callData.isCameraEnabled ? '–ö–∞–º–µ—Ä–∞ –≤–∫–ª—é—á–µ–Ω–∞' : '–ö–∞–º–µ—Ä–∞ –≤—ã–∫–ª—é—á–µ–Ω–∞', 'info');
        }

        function toggleMic() {
            if (!callData.localStream) return;
            
            callData.isMicEnabled = !callData.isMicEnabled;
            const audioTracks = callData.localStream.getAudioTracks();
            audioTracks.forEach(track => {
                track.enabled = callData.isMicEnabled;
            });
            
            const btn = document.querySelector('.toggle-mic');
            btn.innerHTML = callData.isMicEnabled ? 'üé§' : 'üö´';
            btn.style.background = callData.isMicEnabled ? 'var(--accent-color)' : 'var(--accent-red)';
            
            showNotification(callData.isMicEnabled ? '–ú–∏–∫—Ä–æ—Ñ–æ–Ω –≤–∫–ª—é—á–µ–Ω' : '–ú–∏–∫—Ä–æ—Ñ–æ–Ω –≤—ã–∫–ª—é—á–µ–Ω', 'info');
        }

        function endVideoCall() {
            document.getElementById('videoContainer').style.display = 'none';
            
            // üîä –°—Ç–æ–ø —Ä–∏–Ω–≥—Ç–æ–Ω –∏ –∑–≤—É–∫ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
            if (typeof soundStopRingtone === 'function') soundStopRingtone();
            if (typeof soundCallEnd === 'function') soundCallEnd();
            
            if (callData.localStream) {
                callData.localStream.getTracks().forEach(track => track.stop());
                callData.localStream = null;
            }
            
            if (callData.remoteStream) {
                callData.remoteStream.getTracks().forEach(track => track.stop());
                callData.remoteStream = null;
            }
            
            document.getElementById('localVideo').srcObject = null;
            document.getElementById('remoteVideo').srcObject = null;
            
            if (callData.callTimer) {
                clearInterval(callData.callTimer);
                callData.callTimer = null;
            }
            
            if (callData.isCallActive) {
                const minutes = Math.floor(callData.callDuration / 60);
                const seconds = callData.callDuration % 60;
                showNotification(`–í–∏–¥–µ–æ–∑–≤–æ–Ω–æ–∫ –∑–∞–≤–µ—Ä—à–µ–Ω. –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: ${minutes}:${seconds < 10 ? '0' : ''}${seconds}`, 'info');
                logSecurityEvent(`–í–∏–¥–µ–æ–∑–≤–æ–Ω–æ–∫ –∑–∞–≤–µ—Ä—à–µ–Ω. –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: ${minutes}:${seconds < 10 ? '0' : ''}${seconds}`, 'info');
            }
            
            callData.currentCall = null;
            callData.callDuration = 0;
            callData.isCallActive = false;
            callData.isVideoCall = false;
        }

        // ==================== –§–£–ù–ö–¶–ò–ò –ó–í–û–ù–ö–û–í ====================
        function startVoiceCall() {
            if (!currentChat) {
                showNotification('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –∫–≤–∞–Ω—Ç–æ–≤—ã–π –∫–∞–Ω–∞–ª', 'warning');
                return;
            }
            
            callData.currentCall = {
                type: 'voice',
                contact: currentChat,
                status: 'calling',
                direction: 'outgoing'
            };
            
            // üîä –†–∏–Ω–≥—Ç–æ–Ω –∏—Å—Ö–æ–¥—è—â–µ–≥–æ –∑–≤–æ–Ω–∫–∞
            if (typeof soundOutgoingRingtone === 'function') soundOutgoingRingtone();
            
            showCallScreen('–ì–æ–ª–æ—Å–æ–≤–æ–π –∑–≤–æ–Ω–æ–∫', currentChat.name, currentChat.avatar, 'outgoing');
            showNotification(`–ù–∞—á–∏–Ω–∞–µ–º –≥–æ–ª–æ—Å–æ–≤–æ–π –∑–≤–æ–Ω–æ–∫ —Å ${currentChat.name}`, 'info');
            logSecurityEvent(`–ù–∞—á–∞—Ç –≥–æ–ª–æ—Å–æ–≤–æ–π –∑–≤–æ–Ω–æ–∫ —Å ${currentChat.name}`, 'info');
            
            setTimeout(() => {
                if (callData.currentCall && callData.currentCall.status === 'calling') {
                    callData.currentCall.status = 'connected';
                    // üîä –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–∏–Ω–≥—Ç–æ–Ω ‚Äî —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ
                    if (typeof soundStopRingtone === 'function') soundStopRingtone();
                    document.getElementById('callStatus').textContent = '–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ';
                    document.getElementById('acceptBtn').style.display = 'none';
                    document.getElementById('rejectBtn').style.display = 'none';
                    document.getElementById('endBtn').style.display = 'block';
                    startCallTimer();
                    callData.isCallActive = true;
                    showNotification(`–ì–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å ${currentChat.name} —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ`, 'success');
                }
            }, 2000);
        }

        function showCallScreen(type, name, avatar, direction) {
            const callScreen = document.getElementById('callScreen');
            callScreen.style.display = 'flex';
            document.getElementById('callAvatar').textContent = avatar;
            document.getElementById('callContactName').textContent = name;
            
            if (direction === 'outgoing') {
                document.getElementById('callStatus').textContent = type === 'video' ? '–ù–∞—á–∏–Ω–∞–µ–º –≤–∏–¥–µ–æ–∑–≤–æ–Ω–æ–∫...' : '–ó–≤–æ–Ω–∏–º...';
                document.getElementById('acceptBtn').style.display = 'none';
                document.getElementById('rejectBtn').style.display = 'block';
                document.getElementById('rejectBtn').innerHTML = '‚úñ';
                document.getElementById('endBtn').style.display = 'none';
            } else if (direction === 'incoming') {
                document.getElementById('callStatus').textContent = type === 'video' ? '–í—Ö–æ–¥—è—â–∏–π –≤–∏–¥–µ–æ–∑–≤–æ–Ω–æ–∫...' : '–í—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫...';
                document.getElementById('acceptBtn').style.display = 'block';
                document.getElementById('rejectBtn').style.display = 'block';
                document.getElementById('rejectBtn').innerHTML = '‚úñ';
                document.getElementById('endBtn').style.display = 'none';
            }
            
            callData.callDuration = 0;
            if (callData.callTimer) {
                clearInterval(callData.callTimer);
                callData.callTimer = null;
            }
        }

        function acceptCall() {
            if (!callData.currentCall) return;
            
            // üîä –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–∏–Ω–≥—Ç–æ–Ω
            if (typeof soundStopRingtone === 'function') soundStopRingtone();
            
            callData.currentCall.status = 'connected';
            document.getElementById('callStatus').textContent = '–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ';
            document.getElementById('acceptBtn').style.display = 'none';
            document.getElementById('rejectBtn').style.display = 'none';
            document.getElementById('endBtn').style.display = 'block';
            
            startCallTimer();
            callData.isCallActive = true;
            showNotification('–ó–≤–æ–Ω–æ–∫ –ø—Ä–∏–Ω—è—Ç', 'success');
            logSecurityEvent('–í—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫ –ø—Ä–∏–Ω—è—Ç', 'info');
        }

        function endCall() {
            const callScreen = document.getElementById('callScreen');
            callScreen.style.display = 'none';
            
            // üîä –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–∏–Ω–≥—Ç–æ–Ω –∏ –∏–≥—Ä–∞–µ–º –∑–≤—É–∫ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
            if (typeof soundStopRingtone === 'function') soundStopRingtone();
            if (typeof soundCallEnd === 'function') soundCallEnd();
            
            if (callData.callTimer) {
                clearInterval(callData.callTimer);
                callData.callTimer = null;
            }
            
            if (callData.isCallActive) {
                const minutes = Math.floor(callData.callDuration / 60);
                const seconds = callData.callDuration % 60;
                showNotification(`–ó–≤–æ–Ω–æ–∫ –∑–∞–≤–µ—Ä—à–µ–Ω. –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: ${minutes}:${seconds < 10 ? '0' : ''}${seconds}`, 'info');
                logSecurityEvent(`–ó–≤–æ–Ω–æ–∫ –∑–∞–≤–µ—Ä—à–µ–Ω. –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: ${minutes}:${seconds < 10 ? '0' : ''}${seconds}`, 'info');
            } else {
                if (callData.currentCall && callData.currentCall.direction === 'outgoing') {
                    showNotification('–ó–≤–æ–Ω–æ–∫ –æ—Ç–º–µ–Ω–µ–Ω', 'info');
                    logSecurityEvent('–ò—Å—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫ –æ—Ç–º–µ–Ω–µ–Ω', 'info');
                } else if (callData.currentCall && callData.currentCall.direction === 'incoming') {
                    showNotification('–ó–≤–æ–Ω–æ–∫ –æ—Ç–∫–ª–æ–Ω–µ–Ω', 'info');
                    logSecurityEvent('–í—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫ –æ—Ç–∫–ª–æ–Ω–µ–Ω', 'info');
                }
            }
            
            callData.currentCall = null;
            callData.callDuration = 0;
            callData.isCallActive = false;
        }

        function startCallTimer() {
            callData.callTimer = setInterval(() => {
                callData.callDuration++;
                const minutes = Math.floor(callData.callDuration / 60);
                const seconds = callData.callDuration % 60;
                document.getElementById('callStatus').textContent = 
                    `–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: ${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
            }, 1000);
        }

        function simulateIncomingCall() {
            if (callData.currentCall) {
                showNotification('–£–∂–µ –µ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–π –∑–≤–æ–Ω–æ–∫', 'warning');
                return;
            }
            
            const randomContact = contacts[Math.floor(Math.random() * contacts.length)];
            const callType = Math.random() > 0.5 ? 'video' : 'voice';
            
            callData.currentCall = {
                type: callType,
                contact: randomContact,
                status: 'calling',
                direction: 'incoming'
            };
            
            showCallScreen(callType === 'video' ? '–í–∏–¥–µ–æ–∑–≤–æ–Ω–æ–∫' : '–ì–æ–ª–æ—Å–æ–≤–æ–π –∑–≤–æ–Ω–æ–∫', 
                          randomContact.name, 
                          randomContact.avatar, 
                          'incoming');
            
            // üîä –†–∏–Ω–≥—Ç–æ–Ω –≤—Ö–æ–¥—è—â–µ–≥–æ –∑–≤–æ–Ω–∫–∞
            if (typeof soundIncomingRingtone === 'function') soundIncomingRingtone();
            
            showNotification(`–í—Ö–æ–¥—è—â–∏–π ${callType === 'video' ? '–≤–∏–¥–µ–æ' : '–≥–æ–ª–æ—Å–æ–≤–æ–π'} –∑–≤–æ–Ω–æ–∫ –æ—Ç ${randomContact.name}`, 'info');
            logSecurityEvent(`–í—Ö–æ–¥—è—â–∏–π ${callType === 'video' ? '–≤–∏–¥–µ–æ' : '–≥–æ–ª–æ—Å–æ–≤–æ–π'} –∑–≤–æ–Ω–æ–∫ –æ—Ç ${randomContact.name}`, 'info');
            
            setTimeout(() => {
                if (callData.currentCall && callData.currentCall.status === 'calling' && callData.currentCall.direction === 'incoming') {
                    // üîä –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–∏–Ω–≥—Ç–æ–Ω ‚Äî –ø—Ä–æ–ø—É—â–µ–Ω
                    if (typeof soundStopRingtone === 'function') soundStopRingtone();
                    endCall();
                    showNotification(`–ü—Ä–æ–ø—É—â–µ–Ω–Ω—ã–π –∑–≤–æ–Ω–æ–∫ –æ—Ç ${randomContact.name}`, 'info');
                }
            }, 30000);
        }

        // ==================== –§–£–ù–ö–¶–ò–ò –ü–ï–†–ï–ò–ú–ï–ù–û–í–ê–ù–ò–Ø –ö–û–ù–¢–ê–ö–¢–û–í ====================
        function openRenameContactModal(contactId) {
            currentRenamingContactId = contactId;
            const contact = contacts.find(c => c.id === contactId);
            if (!contact) return;
            
            document.getElementById('newContactName').value = contact.name;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–∏—è
            const chat = chats.find(c => c.contactId === contactId);
            const chatId = chat ? chat.id : null;
            const pinned = chatId && isPinned(chatId);
            const pinLabel = document.getElementById('pinContactModalLabel');
            const pinBtn = document.getElementById('pinContactModalBtn');
            if (pinLabel) pinLabel.textContent = pinned ? '–û—Ç–∫—Ä–µ–ø–∏—Ç—å' : '–ó–∞–∫—Ä–µ–ø–∏—Ç—å';
            if (pinBtn) {
                pinBtn.style.background = pinned 
                    ? 'linear-gradient(135deg, rgba(0,212,255,0.35), rgba(102,126,234,0.35))'
                    : 'linear-gradient(135deg, rgba(0,212,255,0.2), rgba(102,126,234,0.2))';
            }
            
            document.getElementById('renameContactModal').style.display = 'flex';
        }

        function pinContactFromModal() {
            if (!currentRenamingContactId) return;
            const chat = chats.find(c => c.contactId === currentRenamingContactId);
            if (!chat) {
                showNotification('–°–Ω–∞—á–∞–ª–∞ –æ—Ç–∫—Ä–æ–π—Ç–µ —á–∞—Ç —Å —ç—Ç–∏–º –∫–æ–Ω—Ç–∞–∫—Ç–æ–º', 'warning');
                return;
            }
            togglePinChat(chat.id);
            // –û–±–Ω–æ–≤–∏—Ç—å –ª–µ–π–±–ª
            const pinned = isPinned(chat.id);
            const pinLabel = document.getElementById('pinContactModalLabel');
            const pinBtn = document.getElementById('pinContactModalBtn');
            if (pinLabel) pinLabel.textContent = pinned ? '–û—Ç–∫—Ä–µ–ø–∏—Ç—å' : '–ó–∞–∫—Ä–µ–ø–∏—Ç—å';
            if (pinBtn) {
                pinBtn.style.background = pinned 
                    ? 'linear-gradient(135deg, rgba(0,212,255,0.35), rgba(102,126,234,0.35))'
                    : 'linear-gradient(135deg, rgba(0,212,255,0.2), rgba(102,126,234,0.2))';
            }
        }

        function saveRenamedContact() {
            if (!currentRenamingContactId) return;
            
            const newNameInput = document.getElementById('newContactName');
            const newName = newNameInput.value.trim();
            
            if (!newName) {
                showNotification('–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –∏–º—è', 'error');
                return;
            }
            
            if (!validateUserName(newName)) {
                showNotification('–ù–µ–¥–æ–ø—É—Å—Ç–∏–º–æ–µ –∏–º—è. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–æ–ª—å–∫–æ –±–µ–∑–æ–ø–∞—Å–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã.', 'error');
                return;
            }
            
            const contact = contacts.find(c => c.id === currentRenamingContactId);
            if (contact) {
                contact.name = newName;
                
                chats.forEach(chat => {
                    if (chat.contactId === currentRenamingContactId) {
                        chat.name = newName;
                    }
                });
                
                saveToLocalStorage();
                updateUI();
                renderFriendsList();
                renderFriendsListInSettings();
                renderContactNotificationList();
                
                if (currentChat && currentChat.contactId === currentRenamingContactId) {
                    document.getElementById('chatTitleText').textContent = newName;
                }
                
                showNotification('–ö–æ–Ω—Ç–∞–∫—Ç –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω', 'success');
                logSecurityEvent(`–ö–æ–Ω—Ç–∞–∫—Ç ${currentRenamingContactId} –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω –≤ ${newName}`, 'info');
                closeModal('renameContactModal');
            }
        }

        // ==================== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ====================
        // ---- Loader particles spawn ----
        function spawnLoaderParticles() {
            const wrap = document.getElementById('loaderParticles');
            if (!wrap) return;
            for (let i = 0; i < 22; i++) {
                const p = document.createElement('div');
                p.className = 'lp';
                const sz = 40 + Math.random() * 120;
                p.style.cssText = [
                    'width:' + sz + 'px',
                    'height:' + sz + 'px',
                    'left:' + (Math.random() * 100) + '%',
                    'animation-duration:' + (4 + Math.random() * 8) + 's',
                    'animation-delay:' + (Math.random() * 6) + 's',
                    'opacity:' + (0.1 + Math.random() * 0.4)
                ].join(';');
                // Vary colors
                const colors = [
                    'radial-gradient(circle,rgba(102,126,234,0.5),transparent 70%)',
                    'radial-gradient(circle,rgba(0,212,255,0.4),transparent 70%)',
                    'radial-gradient(circle,rgba(118,75,162,0.5),transparent 70%)',
                    'radial-gradient(circle,rgba(167,139,250,0.3),transparent 70%)',
                ];
                p.style.background = colors[Math.floor(Math.random() * colors.length)];
                wrap.appendChild(p);
            }
        }

        // ---- Animated loader progress ----
        function runLoaderProgress(onComplete) {
            const bar = document.getElementById('loaderBar');
            const stepEl = document.getElementById('loaderStep');
            const steps = [
                { pct: 15,  text: 'üîê –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏...' },
                { pct: 35,  text: 'üì° –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ—Ç–æ–∫–æ–ª–æ–≤...' },
                { pct: 55,  text: 'üîë –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è...' },
                { pct: 72,  text: 'üë• –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤...' },
                { pct: 88,  text: 'üí¨ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —á–∞—Ç–æ–≤...' },
                { pct: 100, text: '‚úÖ –ì–æ—Ç–æ–≤–æ!' },
            ];
            let i = 0;
            function nextStep() {
                if (i >= steps.length) {
                    setTimeout(onComplete, 400);
                    return;
                }
                const s = steps[i++];
                if (bar) bar.style.width = s.pct + '%';
                if (stepEl) { stepEl.style.animation = 'none'; stepEl.offsetHeight; stepEl.style.animation = ''; stepEl.textContent = s.text; }
                setTimeout(nextStep, i === steps.length ? 500 : 280 + Math.random() * 200);
            }
            nextStep();
        }

        function hideLoaderAndShow(showFn) {
            var loader = document.getElementById('loader');
            if (loader) {
                loader.style.transition = 'opacity 0.4s';
                loader.style.opacity = '0';
                setTimeout(function() {
                    loader.style.display = 'none';
                    if (showFn) showFn();
                }, 400);
            } else {
                if (showFn) showFn();
            }
        }

        window.onload = function() {
            // –ü—Ä–æ–±—É–µ–º –∞–Ω–∏–º–∞—Ü–∏—é —á–∞—Å—Ç–∏—Ü –Ω–æ –Ω–µ –ø–∞–¥–∞–µ–º –µ—Å–ª–∏ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
            try { spawnLoaderParticles(); } catch(e) {}

            var currentEmail = localStorage.getItem('quantum_current_user');

            if (!currentEmail) {
                // –ù–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É –≤—Ö–æ–¥–∞
                setTimeout(function() {
                    hideLoaderAndShow(function() {
                        showAuthOverlay();
                    });
                }, 800);
                return;
            }

            // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–ª–æ–≥–∏–Ω–µ–Ω ‚Äî –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
            try {
                if (!localStorage.getItem('quantum_csrf_token')) {
                    localStorage.setItem('quantum_csrf_token', generateCSRFToken());
                }
                loadFromLocalStorage();
                initEmojiPicker();
                initAvatarGrid();
                initT9();
                initializeSecurity();

                var loggedLabel = document.getElementById('loggedInAsLabel');
                if (loggedLabel) loggedLabel.textContent = '–í—ã –≤–æ—à–ª–∏ –∫–∞–∫: ' + currentEmail;
            } catch(e) {
                console.warn('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:', e);
            }

            // –°–∫—Ä—ã–≤–∞–µ–º loader –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ ‚Äî –º–∞–∫—Å–∏–º—É–º —á–µ—Ä–µ–∑ 1.5 —Å–µ–∫
            setTimeout(function() {
                hideLoaderAndShow(function() {
                    try { showApp(); } catch(e) {
                        console.warn('–û—à–∏–±–∫–∞ showApp:', e);
                        showAuthOverlay();
                    }
                });
            }, 1200);
        };

        function initializeSecurity() {
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ HTTPS
            if (window.location.protocol !== 'https:' && window.location.hostname !== 'localhost' && window.location.hostname !== '127.0.0.1') {
                showNotification('–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å HTTPS –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏', 'warning');
                logSecurityEvent('–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–ø—É—â–µ–Ω–æ –±–µ–∑ HTTPS', 'warning');
            }
            
            // –õ–æ–≥ –∑–∞–ø—É—Å–∫–∞
            logSecurityEvent('–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–ø—É—â–µ–Ω–æ', 'info');
        }

        function loadFromLocalStorage() {
            const savedUser = localStorage.getItem('quantum_user');
            if (savedUser) {
                try {
                    const parsedUser = JSON.parse(savedUser);
                    currentUser = {...currentUser, ...parsedUser};
                    // üîí ID –≤–ª–∞–¥–µ–ª—å—Ü–∞ –≤—Å–µ–≥–¥–∞ QCEO35 ‚Äî –Ω–µ–∏–∑–º–µ–Ω—è–µ–º–æ
                    currentUser.id = OWNER_ID;
                } catch (e) {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', e);
                    logSecurityEvent('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ localStorage', 'critical');
                }
            }
            // –ö–∞—Å—Ç–æ–º–Ω—ã–π –∞–≤–∞—Ç–∞—Ä —Ö—Ä–∞–Ω–∏—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ (data URL –±–æ–ª—å—à–æ–π)
            var _savedAv = localStorage.getItem('quantum_custom_avatar');
            if (_savedAv) currentUser.customAvatar = _savedAv;

            const savedContacts = localStorage.getItem('quantum_contacts');
            if (savedContacts) {
                try {
                    contacts = JSON.parse(savedContacts);
                } catch (e) {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤:', e);
                    logSecurityEvent('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ –∏–∑ localStorage', 'critical');
                }
            }

            const savedChats = localStorage.getItem('quantum_chats');
            if (savedChats) {
                try {
                    chats = JSON.parse(savedChats);
                } catch (e) {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —á–∞—Ç–æ–≤:', e);
                    logSecurityEvent('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —á–∞—Ç–æ–≤ –∏–∑ localStorage', 'critical');
                }
            }

            if (currentUser.settings.neonEffects) {
                document.body.classList.add('neon-active');
            }
        }

        function saveToLocalStorage() {
            try {
                // customAvatar ‚Äî –±–æ–ª—å—à–æ–π data URL, —Ö—Ä–∞–Ω–∏—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ
                var u = Object.assign({}, currentUser);
                delete u.customAvatar;
                // üîí –í—Å–µ–≥–¥–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ–º ID –≤–ª–∞–¥–µ–ª—å—Ü–∞
                u.id = OWNER_ID;
                localStorage.setItem('quantum_user', JSON.stringify(u));
                localStorage.setItem('quantum_contacts', JSON.stringify(contacts));
                
                // –ö–ª–æ–Ω–∏—Ä—É–µ–º —á–∞—Ç—ã ‚Äî –º–µ–¥–∏–∞—Ñ–∞–π–ª—ã —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ IndexedDB, –ø–æ—ç—Ç–æ–º—É
                // –∏–∑ —Å–æ–æ–±—â–µ–Ω–∏–π —É–¥–∞–ª—è–µ–º fileData, –æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ mediaId
                var chatsToSave = JSON.parse(JSON.stringify(chats));
                chatsToSave.forEach(chat => {
                    if (chat.messages) {
                        chat.messages.forEach(msg => {
                            // –ú–µ–¥–∏–∞—Ñ–∞–π–ª—ã —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ IndexedDB –ø–æ msg.mediaId
                            // –í localStorage —Ö—Ä–∞–Ω–∏–º —Ç–æ–ª—å–∫–æ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
                            if ((msg.type === 'image' || msg.type === 'video') && msg.fileData) {
                                msg.fileData = null; // –Ω–µ –¥—É–±–ª–∏—Ä—É–µ–º –≤ localStorage
                            }
                        });
                    }
                });
                
                localStorage.setItem('quantum_chats', JSON.stringify(chatsToSave));
            } catch (e) {
                console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ localStorage:', e);
                if (e.name === 'QuotaExceededError') {
                    try {
                        var limitedChats = chats.slice(-10);
                        limitedChats.forEach(chat => {
                            if (chat.messages) {
                                chat.messages = chat.messages.slice(-100);
                                chat.messages.forEach(msg => {
                                    if (msg.type === 'image' || msg.type === 'video') {
                                        msg.fileData = null;
                                    }
                                });
                            }
                        });
                        localStorage.setItem('quantum_chats', JSON.stringify(limitedChats));
                        showNotification('‚ö†Ô∏è –ü–∞–º—è—Ç—å localStorage –∑–∞–ø–æ–ª–Ω–µ–Ω–∞. –î–∞–Ω–Ω—ã–µ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω—ã.', 'warning');
                    } catch (e2) {
                        console.error('–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', e2);
                        showNotification('‚ùå –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ', 'error');
                    }
                } else {
                    showNotification('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö', 'error');
                }
                logSecurityEvent('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –≤ localStorage', 'warning');
            }
        }

        function showApp() {
            document.getElementById('app').style.display = 'flex';
            updateUserDisplay();
            loadChats();
            updateUI();
            renderPinnedContacts();
            initEventListeners();
            checkMobile();
            updateSecurityLogs();
            updateInterfaceLanguage(); // –ø—Ä–∏–º–µ–Ω—è–µ–º —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–π —è–∑—ã–∫ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
            loadSavedAppearance();    // –ø—Ä–∏–º–µ–Ω—è–µ–º —Ç–µ–º—É –∏ —Ñ–æ–Ω —á–∞—Ç–∞
            
            document.getElementById('userIdBadge').textContent = `ID: ${currentUser.id}`;
            document.getElementById('currentUserId').textContent = currentUser.id;
            
            setTimeout(() => {
                if (Math.random() > 0.7) {
                    simulateIncomingCall();
                }
            }, 10000);
        }

        function updateUserDisplay() {
            document.getElementById('userName').textContent = currentUser.name;
            avSetSidebar(currentUser.customAvatar || null);
            document.getElementById('userStatus').textContent = getStatusText(currentUser.status);
            document.getElementById('userStatus').style.color = getStatusColor(currentUser.status);
            document.getElementById('userNameInput').value = currentUser.name;
            document.getElementById('statusSelect').value = currentUser.status;
            document.getElementById('neonEffects').checked = currentUser.settings.neonEffects;
            document.getElementById('t9Enabled').checked = currentUser.settings.t9Enabled;
            document.getElementById('autoDetectLanguage').checked = currentUser.settings.autoDetectLanguage;
            document.getElementById('xssProtection').checked = currentUser.security.xssProtection;
            document.getElementById('fileValidation').checked = currentUser.security.fileValidation;
            document.getElementById('dataValidation').checked = currentUser.security.dataValidation;
            document.getElementById('injectionProtection').checked = currentUser.security.injectionProtection;
        }

        function getStatusText(status) {
            const statusMap = {
                'online': '‚ö° –í —Å–µ—Ç–∏',
                'away': 'üåô –û—Ç–æ—à–µ–ª',
                'busy': 'üî¥ –ó–∞–Ω—è—Ç',
                'invisible': 'üëª –ù–µ–≤–∏–¥–∏–º–∫–∞'
            };
            return statusMap[status] || '‚ö° –í —Å–µ—Ç–∏';
        }

        function getStatusColor(status) {
            const colorMap = {
                'online': '#00ff9d',
                'away': '#ffd700',
                'busy': '#ff3b5c',
                'invisible': '#667eea'
            };
            return colorMap[status] || '#00ff9d';
        }

        function initT9() {
            const input = document.getElementById('messageInput');
            const suggestionsContainer = document.createElement('div');
            suggestionsContainer.className = 't9-suggestions';
            suggestionsContainer.id = 't9Suggestions';
            input.parentNode.appendChild(suggestionsContainer);
            
            const debouncedT9 = debounce(function(e) {
                if (!currentUser.settings.t9Enabled) return;
                
                const text = this.value;
                const words = text.split(' ');
                const lastWord = words[words.length - 1].toLowerCase();
                
                if (lastWord.length >= 2) {
                    const dict = t9Dictionary[currentUser.language] || t9Dictionary.ru;
                    let t9Suggestions = [];
                    
                    for (const [prefix, suggestions] of Object.entries(dict)) {
                        if (lastWord.startsWith(prefix)) {
                            t9Suggestions = suggestions;
                            break;
                        }
                    }
                    
                    showT9Suggestions(t9Suggestions, lastWord);
                } else {
                    hideT9Suggestions();
                }
            }, 150);
            input.addEventListener('input', debouncedT9);

        }

        function showT9Suggestions(suggestions, lastWord) {
            const container = document.getElementById('t9Suggestions');
            if (!container) return;
            
            if (suggestions.length === 0) {
                container.style.display = 'none';
                return;
            }
            
            container.innerHTML = '';
            suggestions.slice(0, 5).forEach((suggestion, index) => {
                const item = document.createElement('div');
                item.className = 't9-suggestion-item';
                item.innerHTML = `
                    <span>${escapeHtml(suggestion)}</span>
                    <span class="shortcut">Tab</span>
                `;
                item.onclick = () => applyT9Suggestion(suggestion);
                container.appendChild(item);
            });
            
            container.style.display = 'flex';
        }

        function hideT9Suggestions() {
            const container = document.getElementById('t9Suggestions');
            if (container) {
                container.style.display = 'none';
            }
        }

        function applyT9Suggestion(suggestion) {
            const input = document.getElementById('messageInput');
            const text = input.value;
            const words = text.split(' ');
            words[words.length - 1] = suggestion;
            input.value = words.join(' ') + ' ';
            input.focus();
            hideT9Suggestions();
        }

        const t9Dictionary = {
            ru: {
                '–ø—Ä': ['–ø—Ä–∏–≤–µ—Ç', '–ø—Ä–∏–≤–µ—Ç—Å—Ç–≤—É—é', '–ø—Ä–∏–≤–µ—Ç–∏–∫'],
                '–∫–∞–∫': ['–∫–∞–∫ –¥–µ–ª–∞', '–∫–∞–∫ –∂–∏–∑–Ω—å', '–∫–∞–∫ —Ç—ã'],
                '—Å–ø': ['—Å–ø–∞—Å–∏–±–æ', '—Å–ø–∞—Å–∏–±–∫–∏', '—Å–ø—Å'],
                '—Ö–æ—Ä': ['—Ö–æ—Ä–æ—à–æ', '—Ö–æ—Ä–æ—à–∏–π', '—Ö–æ—Ä–æ—à–∞—è'],
                '–ø–ª': ['–ø–æ–∂–∞–ª—É–π—Å—Ç–∞', '–ø–æ–∂–∞–ª—É–π'],
                '—á—Ç': ['—á—Ç–æ', '—á—Ç–æ —Ç—ã', '—á—Ç–æ –¥–µ–ª–∞–µ—à—å'],
                '—Å–µ–≥': ['—Å–µ–≥–æ–¥–Ω—è', '—Å–µ–≥–æ–¥–Ω—è—à–Ω–∏–π'],
                '–∑–∞–≤': ['–∑–∞–≤—Ç—Ä–∞', '–∑–∞–≤—Ç—Ä–∞—à–Ω–∏–π'],
                '–≤—Å—Ç—Ä': ['–≤—Å—Ç—Ä–µ—Ç–∏–º—Å—è', '–≤—Å—Ç—Ä–µ—á–∞', '–≤—Å—Ç—Ä–µ—Ç–∏—Ç—å']
            },
            en: {
                'hi': ['hi', 'hello', 'hey'],
                'how': ['how are you', 'how is it going', 'how do you do'],
                'th': ['thanks', 'thank you', 'thank'],
                'go': ['good', 'good morning', 'good night'],
                'pl': ['please', 'pleasure'],
                'wh': ['what', 'whats up', 'what are you doing'],
                'tod': ['today', 'todays'],
                'tom': ['tomorrow', 'tomorrows'],
                'me': ['meet', 'meeting', 'meet you']
            },
            es: {
                'ho': ['hola', 'hola amigo'],
                'c√≥m': ['c√≥mo est√°s', 'c√≥mo te va'],
                'gra': ['gracias', 'gracias amigo'],
                'bu': ['bueno', 'buenas', 'buenos d√≠as'],
                'por': ['por favor', 'por supuesto'],
                'qu√©': ['qu√© tal', 'qu√© haces'],
                'hoy': ['hoy', 'hoy d√≠a'],
                'ma√±': ['ma√±ana', '–º–∞√±ana temprano'],
                'enc': ['encuentro', 'encantado']
            }
        };

        function detectTextLanguage(text) {
            const ruRegex = /[–∞-—è–ê-–Ø—ë–Å]/;
            const enRegex = /[a-zA-Z]/;
            const esRegex = /[√°√©√≠√≥√∫√Å√â√ç√ì√ö√±√ë]/;
            
            if (ruRegex.test(text)) return 'ru';
            if (esRegex.test(text)) return 'es';
            if (enRegex.test(text)) return 'en';
            return currentUser.language;
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            sidebar.classList.toggle('active');
            if (overlay) overlay.classList.toggle('active', sidebar.classList.contains('active'));
        }

        function backToChats() {
            document.getElementById('backButton').style.display = 'none';
            document.getElementById('sidebar').classList.add('active');
            var overlay = document.getElementById('sidebarOverlay');
            if (overlay) overlay.classList.add('active');
            document.getElementById('inputArea').style.display = 'none';
            document.getElementById('messagesArea').innerHTML = `
                <div style="text-align: center; padding: 80px 20px; color: var(--text-secondary);">
                    <div style="font-size: 80px; margin-bottom: 20px; filter: drop-shadow(0 0 20px rgba(102, 126, 234, 0.5));">‚öõ</div>
                    <h2 style="margin-bottom: 15px; background: linear-gradient(45deg, #fff, var(--accent-color)); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">Quantum Secure Messenger</h2>
                    <p style="margin-bottom: 30px; font-size: 16px;">–ó–∞—â–∏—â–µ–Ω–Ω–∞—è —Å–≤—è–∑—å –±—É–¥—É—â–µ–≥–æ</p>
                    <button onclick="openNewChatModal()" class="action-btn action-btn-primary" style="padding: 15px 30px;">
                        <i class="fas fa-plus"></i> –°–æ–∑–¥–∞—Ç—å –∫–≤–∞–Ω—Ç–æ–≤—ã–π –∫–∞–Ω–∞–ª
                    </button>
                </div>
            `;
            currentChat = null;
        }

        function closeModal(modalId) {
            const el = document.getElementById(modalId);
            if (el) el.style.display = 'none';
        }

        function openModal(modalId) {
            const el = document.getElementById(modalId);
            if (el) el.style.display = 'flex';
        }

        // –ê–ª–∏–∞—Å—ã ‚Äî –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –≤ –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –±–ª–æ–∫–∞—Ö –∫–æ–¥–∞
        function saveChats()    { saveToLocalStorage(); }
        function saveMessages() { /* —Å–æ–æ–±—â–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è —á–µ—Ä–µ–∑ localStorage –Ω–∞–ø—Ä—è–º—É—é */ }
        function renderChats()  { updateUI(); }

        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            const colors = {
                info: 'var(--accent-color)', 
                success: '#00ff9d', 
                error: '#ff3b5c', 
                warning: '#ffd700'
            };
            
            notification.style.borderLeftColor = colors[type] || 'var(--accent-color)';
            document.getElementById('notifTitle').textContent = 
                type === 'info' ? '–ö–≤–∞–Ω—Ç–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ' : 
                type === 'success' ? '‚ö° –£—Å–ø–µ—Ö!' : 
                type === 'error' ? '‚ö†Ô∏è –û—à–∏–±–∫–∞!' : '‚ö†Ô∏è –í–Ω–∏–º–∞–Ω–∏–µ!';
            
            document.getElementById('notifMessage').textContent = escapeHtml(message);
            notification.style.display = 'block';
            
            setTimeout(() => notification.style.display = 'none', 3000);
        }

        function initEmojiPicker() {
            const emojiGrid = document.getElementById('emojiGrid');
            emojiGrid.innerHTML = '';
            
            emojiList.forEach(emoji => {
                const div = document.createElement('div');
                div.className = 'emoji-item';
                div.textContent = emoji;
                div.onclick = () => insertEmoji(emoji);
                emojiGrid.appendChild(div);
            });
        }

        function toggleEmojiPicker() {
            const picker = document.getElementById('emojiPicker');
            picker.style.display = picker.style.display === 'block' ? 'none' : 'block';
        }

        function insertEmoji(emoji) {
            const input = document.getElementById('messageInput');
            const start = input.selectionStart;
            const end = input.selectionEnd;
            const text = input.value;
            
            input.value = text.substring(0, start) + emoji + text.substring(end);
            input.focus();
            input.selectionStart = input.selectionEnd = start + emoji.length;
            document.getElementById('emojiPicker').style.display = 'none';
        }

        function checkMobile() {
            if (window.innerWidth <= 768) {
                document.getElementById('sidebar').classList.remove('active');
                document.querySelector('.mobile-menu-btn').style.display = 'block';
                
                if (currentChat) {
                    document.getElementById('backButton').style.display = 'block';
                }
            } else {
                document.getElementById('sidebar').classList.add('active');
                document.querySelector('.mobile-menu-btn').style.display = 'none';
                document.getElementById('backButton').style.display = 'none';
            }
        }

        function initEventListeners() {
            document.getElementById('messageInput').addEventListener('keypress', e => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            
            document.getElementById('messageInput').addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 120) + 'px';
            });
            
            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', e => {
                    if (e.target === modal) modal.style.display = 'none';
                });
            });
            
            document.addEventListener('click', e => {
                const emojiPicker = document.getElementById('emojiPicker');
                if (emojiPicker.style.display === 'block' && !e.target.closest('.emoji-picker') && !e.target.closest('.input-btn')) {
                    emojiPicker.style.display = 'none';
                }
                
                const searchResults = document.getElementById('searchResults');
                if (searchResults.style.display === 'block' && !e.target.closest('.search-box')) {
                    searchResults.style.display = 'none';
                }
            });
            
            window.addEventListener('resize', checkMobile);
            
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.t9-suggestions') && !e.target.closest('#messageInput')) {
                    hideT9Suggestions();
                }
            });
        }

        function showChatInfo() {
            if (!currentChat) return;
            showNotification(`–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–∞–Ω–∞–ª–µ "${currentChat.name}"`, 'info');
        }

        function openGroupChatModal() {
            loadContactsForGroupChat();
            document.getElementById('groupChatModal').style.display = 'flex';
        }

        function loadContactsForGroupChat() {
            const container = document.getElementById('groupMembersList');
            container.innerHTML = '';
            
            contacts.forEach(contact => {
                if (!contact.isFriend) return;
                
                const div = document.createElement('div');
                div.className = 'contact-item';
                div.style.padding = '10px';
                div.innerHTML = `
                    <input type="checkbox" id="group_member_${contact.id}" value="${contact.id}" 
                           style="margin-right: 10px;" onchange="toggleGroupMember('${contact.id}')">
                    <label for="group_member_${contact.id}" style="display: flex; align-items: center; flex: 1; cursor: pointer;">
                        <div class="contact-avatar">${contact.avatar}</div>
                        <div style="margin-left: 10px;">
                            <div style="color: var(--text-primary); font-weight: 500;">${escapeHtml(contact.name)}</div>
                            <div style="font-size: 12px; color: var(--text-secondary);">${escapeHtml(contact.id)}</div>
                        </div>
                    </label>
                `;
                container.appendChild(div);
            });
        }

        function toggleGroupMember(contactId) {
            const checkbox = document.getElementById(`group_member_${contactId}`);
            if (checkbox.checked) {
                if (!selectedGroupMembers.includes(contactId)) {
                    selectedGroupMembers.push(contactId);
                }
            } else {
                selectedGroupMembers = selectedGroupMembers.filter(id => id !== contactId);
            }
        }

        function createGroupChat() {
            const groupNameInput = document.getElementById('groupNameInput');
            const groupName = groupNameInput.value.trim();
            
            if (!groupName) {
                showNotification('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã', 'error');
                return;
            }
            
            if (!validateUserName(groupName)) {
                showNotification('–ù–µ–¥–æ–ø—É—Å—Ç–∏–º–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–æ–ª—å–∫–æ –±–µ–∑–æ–ø–∞—Å–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã.', 'error');
                return;
            }
            
            if (selectedGroupMembers.length < 2) {
                showNotification('–í—ã–±–µ—Ä–∏—Ç–µ –º–∏–Ω–∏–º—É–º 2 —É—á–∞—Å—Ç–Ω–∏–∫–∞', 'error');
                return;
            }
            
            const groupMembers = contacts.filter(contact => selectedGroupMembers.includes(contact.id));
            const allMemberIds = [currentUser.id, ...selectedGroupMembers];
            
            const newChat = {
                id: Date.now(),
                name: groupName,
                avatar: 'üë•',
                lastMessage: '–ì—Ä—É–ø–ø–æ–≤–æ–π —á–∞—Ç —Å–æ–∑–¥–∞–Ω',
                time: '–¢–æ–ª—å–∫–æ —á—Ç–æ',
                unread: 0,
                online: allMemberIds.length,
                type: 'group',
                members: allMemberIds,
                memberIds: allMemberIds,
                owner: currentUser.id,
                admins: [],
                created: new Date().toLocaleDateString('ru-RU', {day:'2-digit', month:'2-digit', year:'numeric'})
            };
            
            chats.unshift(newChat);
            saveToLocalStorage();
            updateUI();
            openChat(newChat);
            closeModal('groupChatModal');
            showNotification(`–ì—Ä—É–ø–ø–æ–≤–æ–π —á–∞—Ç "${groupName}" —Å–æ–∑–¥–∞–Ω`, 'success');
            logSecurityEvent(`–°–æ–∑–¥–∞–Ω –≥—Ä—É–ø–ø–æ–≤–æ–π —á–∞—Ç "${groupName}"`, 'info');
            
            groupNameInput.value = '';
            selectedGroupMembers = [];
            document.querySelectorAll('#groupMembersList input[type="checkbox"]').forEach(cb => cb.checked = false);
        }

        function attachImage() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = e => {
                const file = e.target.files[0];
                if (!file) return;
                
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ —Ñ–∞–π–ª–∞
                if (currentUser.security.fileValidation) {
                    const validation = validateFile(file);
                    if (!validation.valid) {
                        showNotification(validation.error, 'error');
                        logSecurityEvent(`–ü–æ–ø—ã—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–µ–¥–æ–ø—É—Å—Ç–∏–º–æ–≥–æ —Ñ–∞–π–ª–∞: ${validation.error}`, 'warning');
                        return;
                    }
                }
                
                sendImageFromCamera(file);
            };
            input.click();
        }

        function sendImageFromCamera(file) {
            if (!currentChat) {
                showNotification('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç', 'error');
                return;
            }
            // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ base64 —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å blob:null –æ—à–∏–±–∫–∏
            const _reader = new FileReader();
            _reader.onloadend = function() {
                const base64data = _reader.result;
                const fileSize = formatFileSize(file.size);
                sendMediaMessageDirect(base64data, 'photo', fileSize);
                logSecurityEvent(`–§–æ—Ç–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ —á–∞—Ç ${currentChat ? currentChat.name : ''}`, 'info');
            };
            _reader.readAsDataURL(file);
        }

        function toggleProfileMenu() {
            openSettings();
        }

        // ================================================================
        // –ê–í–ê–¢–ê–† v5.2 ‚Äî –∑–∞–≥—Ä—É–∑–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ —Ñ–æ—Ç–æ
        // –ü—Ä–∏–Ω—Ü–∏–ø: img –≤—Å–µ–≥–¥–∞ absolute inset:0, overflow:hidden –Ω–∞ —Ä–æ–¥–∏—Ç–µ–ª–µ
        // ================================================================

        function avTrigger() {
            document.getElementById('avFileInput').click();
        }

        function avHandleFile(event) {
            var file = event.target.files[0];
            event.target.value = '';   // —Å–±—Ä–æ—Å ‚Äî –∏–Ω–∞—á–µ –Ω–µ–ª—å–∑—è –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ç–æ—Ç –∂–µ —Ñ–∞–π–ª
            if (!file) return;

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–∞
            var ok = ['image/jpeg','image/png','image/gif','image/webp'];
            if (ok.indexOf(file.type) < 0) {
                showNotification('–ù—É–∂–µ–Ω JPG, PNG, GIF –∏–ª–∏ WebP', 'error');
                return;
            }
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—Ä–∞
            if (file.size > 5 * 1024 * 1024) {
                showNotification('–ú–∞–∫—Å–∏–º—É–º 5 –ú–ë', 'error');
                return;
            }

            var reader = new FileReader();
            reader.onload = function(e) {
                // –°–∂–∏–º–∞–µ–º —á–µ—Ä–µ–∑ canvas, –ø–æ—Ç–æ–º –ø—Ä–∏–º–µ–Ω—è–µ–º
                avCompress(e.target.result, function(compressed) {
                    avApply(compressed);
                    showNotification('‚úÖ –ê–≤–∞—Ç–∞—Ä –æ–±–Ω–æ–≤–ª—ë–Ω!', 'success');
                    logSecurityEvent('–ê–≤–∞—Ç–∞—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ–±–Ω–æ–≤–ª—ë–Ω', 'info');
                });
            };
            reader.onerror = function() {
                showNotification('–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å —Ñ–∞–π–ª', 'error');
            };
            reader.readAsDataURL(file);
        }

        // –ö—Ä–æ–ø –ø–æ —Ü–µ–Ω—Ç—Ä—É + —Å–∂–∞—Ç–∏–µ –¥–æ 160√ó160
        function avCompress(src, cb) {
            var img = new Image();
            img.onload = function() {
                var c   = document.createElement('canvas');
                c.width = c.height = 160;
                var ctx = c.getContext('2d');
                var s   = Math.min(img.naturalWidth, img.naturalHeight);
                var ox  = (img.naturalWidth  - s) / 2;
                var oy  = (img.naturalHeight - s) / 2;
                ctx.drawImage(img, ox, oy, s, s, 0, 0, 160, 160);
                cb(c.toDataURL('image/jpeg', 0.88));
            };
            img.onerror = function() { cb(src); };  // –µ—Å–ª–∏ —á—Ç–æ ‚Äî –±–µ—Ä—ë–º –∫–∞–∫ –µ—Å—Ç—å
            img.src = src;
        }

        // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å + –æ–±–Ω–æ–≤–∏—Ç—å –æ–±–∞ –º–µ—Å—Ç–∞
        function avApply(dataUrl) {
            currentUser.customAvatar = dataUrl;
            try { localStorage.setItem('quantum_custom_avatar', dataUrl); }
            catch(e) { showNotification('–ú–∞–ª–æ –º–µ—Å—Ç–∞ –≤ localStorage', 'warning'); }
            avSetSidebar(dataUrl);
            avSetPreview(dataUrl);
            document.querySelectorAll('.avatar-option').forEach(function(o){
                o.classList.remove('selected');
            });
        }

        // –£–¥–∞–ª–∏—Ç—å –∫–∞—Å—Ç–æ–º–Ω—ã–π –∞–≤–∞—Ç–∞—Ä
        function avRemove() {
            currentUser.customAvatar = null;
            currentUser.avatar = 'üë§';
            localStorage.removeItem('quantum_custom_avatar');
            saveToLocalStorage();
            avSetSidebar(null);
            avSetPreview(null);
            showNotification('–ê–≤–∞—Ç–∞—Ä —É–¥–∞–ª—ë–Ω', 'info');
        }

        // --- –°–ê–ô–î–ë–ê–† ---
        // –ú–µ–Ω—è–µ–º —Ç–æ–ª—å–∫–æ img –≤–Ω—É—Ç—Ä–∏ #userAvatar. –¢–µ–∫—Å—Ç-—ç–º–æ–¥–∑–∏ –∫–ª–∞–¥—ë–º –≤ data-attr.
        function avSetSidebar(dataUrl) {
            var wrap = document.getElementById('userAvatar');
            if (!wrap) return;
            // –£–±–∏—Ä–∞–µ–º —Å—Ç–∞—Ä—É—é –∫–∞—Ä—Ç–∏–Ω–∫—É –µ—Å–ª–∏ –µ—Å—Ç—å
            var old = wrap.querySelector('img.av-photo');
            if (old) wrap.removeChild(old);

            if (dataUrl) {
                var img = document.createElement('img');
                img.src       = dataUrl;
                img.className = 'av-photo';
                img.alt       = 'avatar';
                // position:absolute + inset:0 ‚Äî –∑–∞–¥–∞–Ω–æ –≤ CSS (.user-avatar img)
                wrap.appendChild(img);
                // –ü—Ä—è—á–µ–º —Ç–µ–∫—Å—Ç (—ç–º–æ–¥–∑–∏) ‚Äî –æ–Ω –ø–æ–¥ img, –Ω–æ –µ–≥–æ –≤–∏–¥–Ω–æ –µ—Å–ª–∏ img –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª—Å—è
                wrap.dataset.emoji = wrap.childNodes[0] && wrap.childNodes[0].nodeType === 3
                    ? wrap.childNodes[0].textContent : '';
                // –£–±–∏—Ä–∞–µ–º —Ç–µ–∫—Å—Ç–æ–≤—ã–π —É–∑–µ–ª
                if (wrap.childNodes[0] && wrap.childNodes[0].nodeType === 3) {
                    wrap.childNodes[0].textContent = '';
                }
            } else {
                // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —ç–º–æ–¥–∑–∏
                var emoji = wrap.dataset.emoji || currentUser.avatar || 'üë§';
                if (wrap.childNodes[0] && wrap.childNodes[0].nodeType === 3) {
                    wrap.childNodes[0].textContent = emoji;
                } else {
                    wrap.insertBefore(document.createTextNode(emoji), wrap.firstChild);
                }
            }
        }

        // --- –ü–†–ï–í–¨–Æ –í –ù–ê–°–¢–†–û–ô–ö–ê–• ---
        function avSetPreview(dataUrl) {
            var circle = document.getElementById('avPreviewCircle');
            var span   = document.getElementById('avEmojiSpan');
            var rmBtn  = document.getElementById('avRemoveBtn');
            if (!circle) return;

            // –£–±—Ä–∞—Ç—å —Å—Ç–∞—Ä–æ–µ —Ñ–æ—Ç–æ
            var old = circle.querySelector('img.av-photo');
            if (old) circle.removeChild(old);

            if (dataUrl) {
                var img = document.createElement('img');
                img.src       = dataUrl;
                img.className = 'av-photo';
                img.alt       = 'avatar';
                circle.appendChild(img);
                if (span)  span.style.display  = 'none';
                if (rmBtn) rmBtn.style.display  = 'inline-flex';
            } else {
                if (span)  span.style.display  = '';
                if (rmBtn) rmBtn.style.display  = 'none';
            }
        }

        // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è UI –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫
        function avRefresh() {
            avSetPreview(currentUser.customAvatar || null);
        }
        // ================================================================

        function openNewChatModal() {
            closeModal('newChatModal');
            document.getElementById('newChatModal').style.display = 'flex';
        }

        function openContactsModal() {
            renderContactsList();
            closeModal('newChatModal');
            document.getElementById('contactsModal').style.display = 'flex';
        }

        // ==================== –ò–ù–õ–ê–ô–ù –ü–ï–†–ï–ò–ú–ï–ù–û–í–ê–ù–ò–ï –í –ó–ê–ì–û–õ–û–í–ö–ï ====================
        function startInlineRename() {
            if (!currentChat) return;
            if (document.getElementById('chatTitleInput')) return; // —É–∂–µ –æ—Ç–∫—Ä—ã—Ç

            const titleText = document.getElementById('chatTitleText');
            const currentName = currentChat.name || titleText.textContent.trim();

            // –°–∫—Ä—ã–≤–∞–µ–º span —Å –∏–º–µ–Ω–µ–º, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º input
            titleText.style.display = 'none';

            const input = document.createElement('input');
            input.id = 'chatTitleInput';
            input.type = 'text';
            input.className = 'chat-title-input';
            input.value = currentName;
            input.maxLength = 50;

            // –í—Å—Ç–∞–≤–ª—è–µ–º –ø–æ—Å–ª–µ titleText –≤–Ω—É—Ç—Ä–∏ wrap
            titleText.parentNode.insertBefore(input, titleText.nextSibling);
            input.focus();
            input.select();

            let done = false;

            function finish(save) {
                if (done) return;
                done = true;
                const el = document.getElementById('chatTitleInput');
                const val = el ? el.value.trim() : '';
                if (el) el.remove();
                titleText.style.display = '';

                if (save && val && validateUserName(val)) {
                    titleText.textContent = val;
                    currentChat.name = val;
                    if (currentChat.contactId) {
                        const c = contacts.find(x => x.id === currentChat.contactId);
                        if (c) c.name = val;
                    }
                    saveToLocalStorage();
                    renderPinnedContacts();
                    // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º —Å–ø–∏—Å–æ–∫ –±–µ–∑ –≤—ã–∑–æ–≤–∞ openChat (—á—Ç–æ–±—ã –Ω–µ –∑–∞—Ç–µ—Ä–µ—Ç—å –∑–∞–≥–æ–ª–æ–≤–æ–∫)
                    const chatsList = document.getElementById('chatsList');
                    if (chatsList) updateUI();
                    showNotification(`–ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–æ: ${val}`, 'success');
                } else if (save && !val) {
                    showNotification('–ò–º—è –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º', 'error');
                }
            }

            input.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') { e.preventDefault(); finish(true); }
                if (e.key === 'Escape') { finish(false); }
            });
            input.addEventListener('blur', function() {
                setTimeout(() => finish(true), 100);
            });
        }

        // ==================== –ó–ê–ö–†–ï–ü–õ–Å–ù–ù–´–ï –ö–û–ù–¢–ê–ö–¢–´ ====================
        // –•—Ä–∞–Ω–∏–º –∑–∞–∫—Ä–µ–ø–ª—ë–Ω–Ω—ã–µ –∫–∞–∫ –º–∞—Å—Å–∏–≤ chatId
        let pinnedChats = JSON.parse(localStorage.getItem('quantum_pinned_chats') || '[]');

        function savePinnedChats() {
            localStorage.setItem('quantum_pinned_chats', JSON.stringify(pinnedChats));
        }

        function isPinned(chatId) {
            return pinnedChats.includes(String(chatId));
        }

        function togglePinChat(chatId) {
            chatId = String(chatId);
            if (isPinned(chatId)) {
                pinnedChats = pinnedChats.filter(id => id !== chatId);
                showNotification('–ö–æ–Ω—Ç–∞–∫—Ç –æ—Ç–∫—Ä–µ–ø–ª—ë–Ω', 'info');
            } else {
                pinnedChats.unshift(chatId);
                showNotification('–ö–æ–Ω—Ç–∞–∫—Ç –∑–∞–∫—Ä–µ–ø–ª—ë–Ω üìå', 'success');
            }
            savePinnedChats();
            renderPinnedContacts();
            updateUI();
        }

        function renderPinnedContacts() {
            const section = document.getElementById('pinnedContactsSection');
            const list = document.getElementById('pinnedContactsList');
            if (!list) return;

            const pinned = chats.filter(c => isPinned(c.id));
            if (pinned.length === 0) {
                section.style.display = 'none';
                return;
            }
            section.style.display = 'block';
            list.innerHTML = '';

            pinned.forEach(chat => {
                const onlineDot = (chat.type === 'private' && chat.online)
                    ? '<div style="position:absolute;bottom:0;right:0;width:9px;height:9px;background:var(--accent-green);border-radius:50%;border:2px solid var(--background-dark);"></div>' : '';
                const div = document.createElement('div');
                div.className = 'pinned-chat-item';
                div.innerHTML = `
                    <div class="pinned-chat-avatar">
                        ${chat.avatar}
                        ${onlineDot}
                    </div>
                    <span class="pinned-chat-name">${escapeHtml(chat.name)}</span>
                    <button class="unpin-btn" title="–û—Ç–∫—Ä–µ–ø–∏—Ç—å" onclick="event.stopPropagation(); togglePinChat('${chat.id}')">
                        <i class="fas fa-thumbtack" style="transform:rotate(45deg);"></i>
                    </button>
                `;
                div.onclick = () => { isMediaChatMode = chat.isMediaChat || false; openChat(chat); };
                list.appendChild(div);
            });
        }

        function renderContactsList() {
            const contactsList = document.getElementById('contactsList');
            contactsList.innerHTML = '';
            
            contacts.forEach(contact => {
                const div = document.createElement('div');
                div.className = 'contact-item';
                div.style.display = 'flex';
                div.style.alignItems = 'center';
                div.style.justifyContent = 'space-between';
                
                const statusDot = contact.status === 'online' ? 'status-online' : 
                                 contact.status === 'away' ? 'status-away' : 
                                 contact.status === 'busy' ? 'status-away' : 'status-offline';
                
                div.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 15px; flex: 1; cursor: pointer;" onclick="createChatFromContact(contacts.find(c => c.id === '${contact.id}'))">
                        <div class="contact-avatar">${contact.avatar}</div>
                        <div class="contact-info">
                            <div class="contact-name">${escapeHtml(contact.name)}</div>
                            <div class="contact-status">
                                <span class="status-dot ${statusDot}"></span>
                                ${getStatusText(contact.status)}
                                ${contact.isFriend ? '<span style="color: var(--accent-green); margin-left: 10px;">‚òÖ</span>' : ''}
                            </div>
                        </div>
                    </div>
                    <button 
                        onclick="event.stopPropagation(); createMediaChat(contacts.find(c => c.id === '${contact.id}'))" 
                        style="
                            background: linear-gradient(135deg, #00ff9d 0%, #00cc7a 100%);
                            border: none;
                            border-radius: 12px;
                            padding: 10px 15px;
                            color: #0a0a0f;
                            font-weight: 700;
                            font-size: 13px;
                            cursor: pointer;
                            transition: all 0.3s;
                            box-shadow: 0 3px 10px rgba(0, 255, 157, 0.3);
                            display: flex;
                            align-items: center;
                            gap: 6px;
                        "
                        onmouseover="this.style.transform='scale(1.05)'"
                        onmouseout="this.style.transform='scale(1)'"
                        title="–í—Ä–µ–º–µ–Ω–Ω—ã–π –º–µ–¥–∏–∞-—á–∞—Ç (—Ç–æ–ª—å–∫–æ –¥–ª—è —Ç–µ–∫—É—â–µ–π —Å–µ—Å—Å–∏–∏)">
                        üì∏ –ú–µ–¥–∏–∞
                    </button>
                `;
                
                contactsList.appendChild(div);
            });
        }

        function createChatFromContact(contact) {
            const existingChat = chats.find(chat => chat.contactId === contact.id);
            
            if (existingChat) {
                isMediaChatMode = false;
                openChat(existingChat);
                closeModal('contactsModal');
                showNotification(`–û—Ç–∫—Ä—ã—Ç –∫–∞–Ω–∞–ª —Å ${contact.name}`, 'info');
                return;
            }
            
            const newChat = {
                id: Date.now(),
                name: contact.name,
                avatar: contact.avatar,
                lastMessage: '–ö–≤–∞–Ω—Ç–æ–≤—ã–π –∫–∞–Ω–∞–ª —Å–æ–∑–¥–∞–Ω',
                time: '–¢–æ–ª—å–∫–æ —á—Ç–æ',
                unread: 0,
                online: contact.status === 'online',
                type: 'private',
                contactId: contact.id
            };
            
            chats.unshift(newChat);
            saveToLocalStorage();
            updateUI();
            isMediaChatMode = false;
            openChat(newChat);
            closeModal('contactsModal');
            showNotification(`–ö–≤–∞–Ω—Ç–æ–≤—ã–π –∫–∞–Ω–∞–ª —Å ${contact.name} —Å–æ–∑–¥–∞–Ω`, 'success');
            logSecurityEvent(`–°–æ–∑–¥–∞–Ω —á–∞—Ç —Å ${contact.name}`, 'info');
        }

        function createMediaChat(contact) {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ –º–µ–¥–∏–∞-—á–∞—Ç —Å —ç—Ç–∏–º –∫–æ–Ω—Ç–∞–∫—Ç–æ–º
            const existingMediaChat = mediaChats.find(chat => chat.contactId === contact.id);
            
            if (existingMediaChat) {
                isMediaChatMode = true;
                openChat(existingMediaChat);
                closeModal('contactsModal');
                showNotification(`üì∏ –ú–µ–¥–∏–∞-—á–∞—Ç —Å ${contact.name} –æ—Ç–∫—Ä—ã—Ç`, 'info');
                return;
            }
            
            // –°–æ–∑–¥–∞—ë–º –Ω–æ–≤—ã–π –º–µ–¥–∏–∞-—á–∞—Ç
            const newMediaChat = {
                id: 'media_' + Date.now(),
                name: contact.name + ' üì∏',
                avatar: contact.avatar,
                lastMessage: '–ú–µ–¥–∏–∞-—á–∞—Ç —Å–æ–∑–¥–∞–Ω (—Ç–æ–ª—å–∫–æ —Ç–µ–∫—É—â–∞—è —Å–µ—Å—Å–∏—è)',
                time: '–¢–æ–ª—å–∫–æ —á—Ç–æ',
                unread: 0,
                online: contact.status === 'online',
                type: 'media',
                contactId: contact.id,
                messages: [],
                isMediaChat: true
            };
            
            mediaChats.unshift(newMediaChat);
            // –ú–µ–¥–∏–∞-—á–∞—Ç—ã –ù–ï —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ localStorage!
            updateUI();
            isMediaChatMode = true;
            openChat(newMediaChat);
            closeModal('contactsModal');
            showNotification(`üì∏ –ú–µ–¥–∏–∞-—á–∞—Ç —Å ${contact.name} —Å–æ–∑–¥–∞–Ω (–≤—Ä–µ–º–µ–Ω–Ω—ã–π)`, 'success');
            logSecurityEvent(`–°–æ–∑–¥–∞–Ω –º–µ–¥–∏–∞-—á–∞—Ç —Å ${contact.name}`, 'info');
        }

        function loadChats() {
            if (chats.length === 0) {
                chats = [
                    {id: 1, name: '–ö–≤–∞–Ω—Ç–æ–≤—ã–π –ò–Ω–∂–µ–Ω–µ—Ä', avatar: 'üë®‚Äçüíª', lastMessage: '–ü—Ä–∏–≤–µ—Ç! –ö–∞–∫ –∫–≤–∞–Ω—Ç–æ–≤—ã–µ –¥–µ–ª–∞?', time: '10:30', unread: 2, online: true, type: 'private', contactId: 'Q115002'},
                    {id: 2, name: '–ö–æ—Å–º–∏—á–µ—Å–∫–∞—è –ò—Å—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å', avatar: 'üë©‚ÄçüöÄ', lastMessage: '–û—Ç–ø—Ä–∞–≤–ª—è—é –¥–∞–Ω–Ω—ã–µ —Å –ú–∞—Ä—Å–∞', time: '–í—á–µ—Ä–∞', unread: 0, online: false, type: 'private', contactId: 'Q115003'},
                    {id: 3, name: '–ö–≤–∞–Ω—Ç–æ–≤–∞—è –õ–∞–±–æ—Ä–∞—Ç–æ—Ä–∏—è', avatar: 'üë•', lastMessage: '–ö—Ç–æ —Å–¥–µ–ª–∞–ª –î–ó –ø–æ –∫–≤–∞–Ω—Ç–æ–≤–æ–π —Ñ–∏–∑–∏–∫–µ?', time: '15:45', unread: 5, online: 8, type: 'group', members: [currentUser.id, 'Q115002', 'Q115003', 'Q115005'], memberIds: [currentUser.id, 'Q115002', 'Q115003', 'Q115005'], owner: currentUser.id, admins: ['Q115002'], created: new Date().toLocaleDateString('ru-RU')},
                    {id: 4, name: '–ö–∏—Ä–∏–ª–ª –¢–µ—Ö–Ω–æ', avatar: 'üë®‚Äçüíº', lastMessage: '–ü—Ä–∏–≤–µ—Ç, –∫–∞–∫ –¥–µ–ª–∞?', time: '12:00', unread: 1, online: true, type: 'private', contactId: 'Q115008'},
                    {id: 5, name: '–ö–æ–Ω—Å—Ç–∞–Ω—Ç–∏–Ω –ò–ò', avatar: 'ü§µ', lastMessage: '–ì–æ—Ç–æ–≤ –∫ –æ–±—Å—É–∂–¥–µ–Ω–∏—é –ø—Ä–æ–µ–∫—Ç–∞', time: '11:30', unread: 0, online: true, type: 'private', contactId: 'Q115010'}
                ];
                saveToLocalStorage();
            }
            updateUI();
        }

        function updateUI() {
            const chatsList = document.getElementById('chatsList');
            chatsList.innerHTML = '';
            
            // –û–±—ä–µ–¥–∏–Ω—è–µ–º –æ–±—ã—á–Ω—ã–µ —á–∞—Ç—ã –∏ –º–µ–¥–∏–∞-—á–∞—Ç—ã
            const allChats = [...mediaChats, ...chats];
            
            if (allChats.length === 0) {
                chatsList.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--text-secondary);">–ù–µ—Ç –∫–≤–∞–Ω—Ç–æ–≤—ã—Ö –∫–∞–Ω–∞–ª–æ–≤</div>';
                return;
            }
            
            allChats.forEach(chat => {
                const div = document.createElement('div');
                div.className = 'chat-item' + (currentChat && currentChat.id === chat.id ? ' active' : '');
                // –ù–ï –≤–µ—à–∞–µ–º onclick –Ω–∞ –≤–µ—Å—å div ‚Äî —Ç–æ–ª—å–∫–æ –Ω–∞ –∫–æ–Ω—Ç–µ–Ω—Ç
                
                const onlineIndicator = chat.type === 'private' && chat.online ? 
                    '<div style="position: absolute; bottom: 0; right: 0; width: 12px; height: 12px; background: var(--accent-green); border-radius: 50%; border: 2px solid var(--background-dark); box-shadow: 0 0 10px var(--accent-green);"></div>' : '';
                
                // –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –º–µ–¥–∏–∞-—á–∞—Ç–∞
                const mediaBadge = chat.isMediaChat ? 
                    '<div style="position: absolute; top: -5px; right: -5px; background: linear-gradient(135deg, #00ff9d 0%, #00cc7a 100%); width: 22px; height: 22px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; border: 2px solid var(--background-dark); box-shadow: 0 0 10px rgba(0, 255, 157, 0.5);">üì∏</div>' : '';
                
                const alreadyPinned = isPinned(chat.id);
                const pinnedIndicator = alreadyPinned ? '<div style="position:absolute;top:-4px;left:-4px;font-size:10px;color:var(--accent-color);">üìå</div>' : '';
                const pinLabel = alreadyPinned ? '–û—Ç–∫—Ä–µ–ø–∏—Ç—å' : '–ó–∞–∫—Ä–µ–ø–∏—Ç—å';
                const pinIcon = alreadyPinned ? '' : 'style="transform:rotate(45deg)"';
                
                div.innerHTML = `
                    <div class="chat-content-shift">
                        <div style="position: relative; flex-shrink:0;">
                            <div class="chat-avatar">${chat.avatar}</div>
                            ${onlineIndicator}
                            ${mediaBadge}
                            ${pinnedIndicator}
                        </div>
                        <div class="chat-info">
                            <div class="chat-name">${escapeHtml(chat.name)}</div>
                            <div class="chat-last-message">${escapeHtml(chat.lastMessage)}</div>
                        </div>
                        <div class="chat-meta">
                            <div class="chat-time">${escapeHtml(chat.time)}</div>
                            ${chat.unread > 0 ? `<div class="chat-unread">${chat.unread}</div>` : ''}
                        </div>
                    </div>
                    <div class="chat-pin-panel">
                        <i class="fas fa-thumbtack" ${pinIcon}></i>
                        <span>${pinLabel}</span>
                    </div>
                    <div class="chat-pin-trigger"></div>
                `;

                // –û—Ç–∫—Ä—ã—Ç–∏–µ —á–∞—Ç–∞ ‚Äî —Ç–æ–ª—å–∫–æ –ø–æ –∫–ª–∏–∫—É –Ω–∞ –∫–æ–Ω—Ç–µ–Ω—Ç
                const contentShift = div.querySelector('.chat-content-shift');
                contentShift.style.cursor = 'pointer';
                contentShift.addEventListener('click', () => {
                    isMediaChatMode = chat.isMediaChat || false;
                    openChat(chat);
                });

                // –ü–∞–Ω–µ–ª—å –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–∏—è ‚Äî –Ω–µ–∑–∞–≤–∏—Å–∏–º—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫
                const panel = div.querySelector('.chat-pin-panel');
                panel.addEventListener('click', (e) => {
                    e.stopPropagation();
                    togglePinChat(chat.id);
                });

                // –¢—Ä–∏–≥–≥–µ—Ä-–∑–æ–Ω–∞ —Å–ø—Ä–∞–≤–∞ ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª—å
                const trigger = div.querySelector('.chat-pin-trigger');
                trigger.addEventListener('mouseenter', () => div.classList.add('pin-reveal'));
                trigger.addEventListener('mouseleave', () => {
                    if (!panel.matches(':hover')) div.classList.remove('pin-reveal');
                });
                panel.addEventListener('mouseenter', () => div.classList.add('pin-reveal'));
                panel.addEventListener('mouseleave', () => div.classList.remove('pin-reveal'));
                
                chatsList.appendChild(div);
            });

            renderPinnedContacts();
        }

        function openChat(chat) {
            currentChat = chat;
            
            // –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –º–µ–¥–∏–∞-—á–∞—Ç–∞ –≤ –∑–∞–≥–æ–ª–æ–≤–æ–∫
            const mediaBadge = chat.isMediaChat ? '<span style="background: linear-gradient(135deg, #00ff9d 0%, #00cc7a 100%); padding: 4px 10px; border-radius: 10px; font-size: 11px; font-weight: 700; color: #0a0a0f;">üì∏ –ú–ï–î–ò–ê</span>' : '';
            document.getElementById('chatTitleText').textContent = chat.name;
            document.getElementById('chatTitleBadge').innerHTML = mediaBadge;
            
            const statusText = chat.type === 'group' ? 
                `${chat.members} —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤` : 
                (chat.online === true ? getStatusText('online') : 
                 chat.online === false ? '–ë—ã–ª(–∞) –Ω–µ–¥–∞–≤–Ω–æ' : 
                 `${chat.online} –æ–Ω–ª–∞–π–Ω`);
            
            // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–¥—Å–∫–∞–∑–∫—É –¥–ª—è –º–µ–¥–∏–∞-—á–∞—Ç–æ–≤
            if (chat.isMediaChat) {
                document.getElementById('chatStatus').innerHTML = statusText + ' <span style="color: #00ff9d; font-size: 11px;">‚Ä¢ –í—Ä–µ–º–µ–Ω–Ω—ã–π —á–∞—Ç</span>';
            } else {
                document.getElementById('chatStatus').textContent = statusText;
            }
            
            document.getElementById('inputArea').style.display = 'flex';
            loadMessages(chat.id);
            updateUI();
            
            chat.unread = 0;
            
            // –ú–µ–¥–∏–∞-—á–∞—Ç—ã –ù–ï —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è
            if (!chat.isMediaChat) {
                saveToLocalStorage();
            }


            // –ü–æ–∫–∞–∑–∞—Ç—å –∑–∞–∫—Ä–µ–ø–ª—ë–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
            if (chat.pinnedMsg && chat.pinnedMsg.text) {
                showPinnedBar(chat.pinnedMsg.text);
            } else {
                document.getElementById('pinnedMsgBar').style.display = 'none';
            }
            
            if (window.innerWidth <= 768) {
                document.getElementById('sidebar').classList.remove('active');
                document.getElementById('backButton').style.display = 'block';
            }
            
            logSecurityEvent(`–û—Ç–∫—Ä—ã—Ç —á–∞—Ç —Å ${chat.name}`, 'info');
            if (typeof updateBlockedUI === 'function') setTimeout(updateBlockedUI, 30);
        }

        function loadMessages(chatId) {
            const messagesArea = document.getElementById('messagesArea');
            let messages = localStorage.getItem(`quantum_messages_${chatId}`);
            
            if (!messages) {
                messages = [
                    {id: 1, sender: 'other', text: '–ü—Ä–∏–≤–µ—Ç! –ö–∞–∫ –∫–≤–∞–Ω—Ç–æ–≤—ã–µ –¥–µ–ª–∞?', time: '10:30', type: 'text', timestamp: Date.now(), language: 'ru'},
                    {id: 2, sender: 'me', text: '–ü—Ä–∏–≤–µ—Ç! –í—Å—ë –æ—Ç–ª–∏—á–Ω–æ! ‚öõ', time: '10:31', type: 'text', timestamp: Date.now() + 1000, language: 'ru'},
                    {id: 3, sender: 'other', text: 'What do you think about quantum physics?', time: '10:32', type: 'text', timestamp: Date.now() + 2000, language: 'en'}
                ];
                localStorage.setItem(`quantum_messages_${chatId}`, JSON.stringify(messages));
            } else {
                try {
                    messages = JSON.parse(messages);
                } catch (e) {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π:', e);
                    messages = [];
                    logSecurityEvent(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è —á–∞—Ç–∞ ${chatId}`, 'critical');
                }
            }
            
            // –î–ª—è –º–µ–¥–∏–∞ –∏ –≥–æ–ª–æ—Å–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ–¥–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ IndexedDB
            const mediaMsgs = messages.filter(m =>
                ((m.type === 'image' || m.type === 'video') && m.mediaId && !m.fileData) ||
                (m.type === 'voice' && m.mediaId && !m.audioData)
            );
            if (mediaMsgs.length === 0) {
                renderMessages(messages);
                return;
            }

            Promise.all(mediaMsgs.map(async msg => {
                try {
                    const data = await getMediaFromIDB(msg.mediaId);
                    if (data) {
                        if (msg.type === 'voice') msg.audioData = data;
                        else msg.fileData = data;
                    }
                } catch(e) { /* –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ */ }
            })).then(() => renderMessages(messages));
        }

        function renderMessages(messages) {
            const messagesArea = document.getElementById('messagesArea');
            messagesArea.innerHTML = '';
            
            if (messages.length === 0) {
                messagesArea.innerHTML = '<div style="text-align: center; padding: 80px 20px; color: var(--text-secondary);">–ù–µ—Ç –∫–≤–∞–Ω—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π</div>';
                return;
            }
            
            const langNames = { ru: 'RU', en: 'EN', es: 'ES' };

            messages.forEach(msg => {
                const div = document.createElement('div');
                div.className = msg.sender === 'me' ? 'message my-message' : 'message their-message';
                const isMine = msg.sender === 'me';

                // Reply –ø—Ä–µ–≤—å—é
                let replyHtml = '';
                if (msg.replyTo) {
                    replyHtml = `<div class="reply-preview">
                        <div class="reply-name">${escapeHtml(msg.replyTo.sender || '')}</div>
                        <div class="reply-text">${escapeHtml((msg.replyTo.text || '').slice(0, 80))}</div>
                    </div>`;
                }

                // –ú–µ—Ç–∫–∞ ¬´–ü–µ—Ä–µ—Å–ª–∞–Ω–æ –æ—Ç ...¬ª
                let fwdHtml = '';
                if (msg.forwardedFrom) {
                    fwdHtml = `<div class="fwd-label"><i class="fas fa-share"></i> –ü–µ—Ä–µ—Å–ª–∞–Ω–æ –æ—Ç: <strong>${escapeHtml(msg.forwardedFrom)}</strong></div>`;
                }

                // –†–µ–∞–∫—Ü–∏–∏
                let reactionsHtml = '';
                if (msg.reactions && Object.keys(msg.reactions).length > 0) {
                    reactionsHtml = '<div class="reactions-bar">';
                    for (const [emoji, data] of Object.entries(msg.reactions)) {
                        const isMineReaction = data.users && data.users.includes('me');
                        reactionsHtml += `<span class="reaction-pill${isMineReaction ? ' mine' : ''}" onclick="addReaction(${msg.id}, '${emoji}')">
                            ${emoji} <span style="font-size:11px;">${data.count}</span>
                        </span>`;
                    }
                    reactionsHtml += '</div>';
                }

                // –°—Ç–∞—Ç—É—Å –ø—Ä–æ—á—Ç–µ–Ω–∏—è
                const statusHtml = isMine ? `<span class="msg-status read">‚úì‚úì</span>` : '';

                if (msg.type === 'file') {
                    let fileType = 'txt';
                    if ((msg.fileName || '').match(/\.(jpg|jpeg|png)$/i)) fileType = 'image';
                    else if ((msg.fileName || '').includes('.pdf')) fileType = 'pdf';
                    
                    div.innerHTML = `
                        ${fwdHtml}
                        ${replyHtml}
                        <div class="document-message">
                            <a href="javascript:void(0)" class="document-content" onclick="downloadFile('${escapeHtml(msg.fileName)}', '${escapeHtml(msg.fileSize)}', '${escapeHtml(fileType)}')">
                                <div class="document-icon">${fileType === 'image' ? 'üñºÔ∏è' : fileType === 'pdf' ? 'üìï' : 'üìé'}</div>
                                <div class="document-info">
                                    <div class="document-name">${escapeHtml(msg.fileName)}</div>
                                    <div class="document-size">${escapeHtml(msg.fileSize)}</div>
                                </div>
                                <div class="download-btn">–°–∫–∞—á–∞—Ç—å</div>
                            </a>
                            <div class="download-progress"><div class="download-progress-bar"></div></div>
                            <div class="download-complete">‚úì –°–∫–∞—á–∞–Ω–æ</div>
                        </div>
                        ${reactionsHtml}
                        <div class="message-time">${escapeHtml(msg.time)} ${statusHtml}</div>
                    `;
                } else if (msg.type === 'image') {
                    div.innerHTML = `
                        ${fwdHtml}
                        ${replyHtml}
                        <div class="document-message">
                            <div class="document-content media-msg-thumb" data-msgid="${msg.id}" data-mediatype="image" style="cursor: pointer;">
                                ${msg.fileData && msg.fileData.startsWith('data:') ? `<img src="${msg.fileData}" style="max-width:180px;max-height:120px;border-radius:8px;display:block;margin-bottom:6px;" loading="lazy">` : (msg.mediaId ? '<div class="document-icon" style="font-size:40px;">üñºÔ∏è</div>' : '<div class="document-icon">üñºÔ∏è</div>')}
                                <div class="document-info">
                                    <div class="document-name">${escapeHtml(msg.fileName || '—Ñ–æ—Ç–æ')}</div>
                                    <div class="document-size">${escapeHtml(msg.fileSize || '')}</div>
                                </div>
                                <div class="download-btn">üîç –ü—Ä–æ—Å–º–æ—Ç—Ä</div>
                            </div>
                        </div>
                        ${reactionsHtml}
                        <div class="message-time">${escapeHtml(msg.time)} ${statusHtml}</div>
                    `;
                    // –•—Ä–∞–Ω–∏–º –¥–∞–Ω–Ω—ã–µ –≤ –∑–∞–º—ã–∫–∞–Ω–∏–∏, –Ω–µ –≤ –∞—Ç—Ä–∏–±—É—Ç–µ
                    const thumb = div.querySelector('.media-msg-thumb');
                    if (thumb) {
                        const fileData = msg.fileData;
                        const mediaId = msg.mediaId;
                        thumb.addEventListener('click', async function() {
                            if (fileData) {
                                viewImage(fileData);
                            } else if (mediaId) {
                                thumb.querySelector('.download-btn').textContent = '‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞...';
                                try {
                                    const data = await getMediaFromIDB(mediaId);
                                    thumb.querySelector('.download-btn').textContent = 'üîç –ü—Ä–æ—Å–º–æ—Ç—Ä';
                                    if (data) {
                                        msg.fileData = data;
                                        // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–µ–≤—å—é
                                        const imgEl = thumb.querySelector('img');
                                        if (imgEl) { imgEl.src = data; } else {
                                            const iconEl = thumb.querySelector('.document-icon');
                                            if (iconEl) { const ni = document.createElement('img'); ni.src = data; ni.style.cssText = 'max-width:180px;max-height:120px;border-radius:8px;display:block;margin-bottom:6px;'; thumb.insertBefore(ni, iconEl); iconEl.remove(); }
                                        }
                                        viewImage(data);
                                    } else {
                                        showNotification('‚ö†Ô∏è –§–æ—Ç–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –≤ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ', 'warning');
                                    }
                                } catch(e) {
                                    thumb.querySelector('.download-btn').textContent = 'üîç –ü—Ä–æ—Å–º–æ—Ç—Ä';
                                    showNotification('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ', 'error');
                                }
                            } else {
                                showNotification('‚ö†Ô∏è –§–æ—Ç–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ', 'warning');
                            }
                        });
                    }
                } else if (msg.type === 'video') {
                    div.innerHTML = `
                        ${fwdHtml}
                        ${replyHtml}
                        <div class="document-message">
                            <div class="document-content media-msg-thumb-video" data-msgid="${msg.id}" data-mediatype="video" style="cursor: pointer;">
                                <div class="document-icon">üé•</div>
                                <div class="document-info">
                                    <div class="document-name">${escapeHtml(msg.fileName || '–≤–∏–¥–µ–æ')}</div>
                                    <div class="document-size">${escapeHtml(msg.fileSize || '')}</div>
                                </div>
                                <div class="download-btn">‚ñ∂ –ü—Ä–æ—Å–º–æ—Ç—Ä</div>
                            </div>
                        </div>
                        ${reactionsHtml}
                        <div class="message-time">${escapeHtml(msg.time)} ${statusHtml}</div>
                    `;
                    const vthumb = div.querySelector('.media-msg-thumb-video');
                    if (vthumb) {
                        const fileData = msg.fileData;
                        const mediaId = msg.mediaId;
                        vthumb.addEventListener('click', async function() {
                            if (fileData) {
                                viewVideo(fileData);
                            } else if (mediaId) {
                                vthumb.querySelector('.download-btn').textContent = '‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞...';
                                try {
                                    const data = await getMediaFromIDB(mediaId);
                                    vthumb.querySelector('.download-btn').textContent = '‚ñ∂ –ü—Ä–æ—Å–º–æ—Ç—Ä';
                                    if (data) {
                                        msg.fileData = data; // –∫–µ—à–∏—Ä—É–µ–º –≤ –ø–∞–º—è—Ç–∏
                                        viewVideo(data);
                                    } else {
                                        showNotification('‚ö†Ô∏è –í–∏–¥–µ–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –≤ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ', 'warning');
                                    }
                                } catch(e) {
                                    vthumb.querySelector('.download-btn').textContent = '‚ñ∂ –ü—Ä–æ—Å–º–æ—Ç—Ä';
                                    showNotification('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤–∏–¥–µ–æ', 'error');
                                }
                            } else {
                                showNotification('‚ö†Ô∏è –í–∏–¥–µ–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ', 'warning');
                            }
                        });
                    }
                } else if (msg.type === 'voice') {
                    const dur = msg.duration || 1;
                    const waveId = 'vwv_' + msg.id;
                    const btnId = 'vpb_' + msg.id;
                    const durId = 'vdur_' + msg.id;
                    const count = Math.min(40, Math.max(20, dur * 3));
                    let waveBars = '';
                    for(let bi=0;bi<count;bi++){const h=6+Math.floor(Math.random()*22);waveBars+=`<div class="voice-bar" style="height:${h}px;"></div>`;}
                    div.innerHTML = `
                        ${fwdHtml}
                        ${replyHtml}
                        <div class="voice-message-bubble">
                            <button class="voice-play-btn" id="${btnId}" onclick="playVoiceMessage(${msg.id})" data-media-id="${msg.mediaId || ''}">
                                <i class="fas fa-play"></i>
                            </button>
                            <div class="voice-waveform" id="${waveId}">${waveBars}</div>
                            <span class="voice-duration" id="${durId}">${Math.floor(dur/60)}:${(dur%60).toString().padStart(2,'0')}</span>
                        </div>
                        ${reactionsHtml}
                        <div class="message-time">${escapeHtml(msg.time)} ${statusHtml}</div>
                    `;
                    // –ö—ç—à–∏—Ä—É–µ–º audioData –µ—Å–ª–∏ —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω
                    if (msg.audioData) {
                        setTimeout(() => {
                            const b = document.getElementById(btnId);
                            if (b) b._audioData = msg.audioData;
                        }, 0);
                    }
                    div.dataset.msgId = msg.id;
                } else {
                    const msgLanguage = msg.language || detectTextLanguage(msg.text || '');
                    div.innerHTML = `
                        ${fwdHtml}
                        ${replyHtml}
                        <div class="message-content">
                            ${msg.sender === 'other' ? `<span class="message-language">${langNames[msgLanguage] || ''}</span>` : ''}
                            <div style="white-space: pre-wrap;">${escapeHtml(msg.text)}</div>
                        </div>
                        ${reactionsHtml}
                        <div class="message-time">${escapeHtml(msg.time)} ${statusHtml}</div>
                    `;
                }

                // –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é –ø–æ –ü–ö–ú
                div.addEventListener('contextmenu', (e) => {
                    if (typeof showMsgContextMenu === 'function') {
                        showMsgContextMenu(e, msg.id, msg.text || '', isMine, msg);
                    }
                });
                // –î–æ–ª–≥–æ–µ –Ω–∞–∂–∞—Ç–∏–µ (–º–æ–±–∞–π–ª)
                let _lp;
                div.addEventListener('touchstart', () => {
                    _lp = setTimeout(() => {
                        if (typeof showMsgContextMenu === 'function')
                            showMsgContextMenu({ preventDefault(){}, clientX: 80, clientY: 200 }, msg.id, msg.text || '', isMine, msg);
                    }, 500);
                });
                div.addEventListener('touchend', () => clearTimeout(_lp));
                div.addEventListener('touchmove', () => clearTimeout(_lp));
                
                messagesArea.appendChild(div);
            });
            
            requestAnimationFrame(() => { messagesArea.scrollTop = messagesArea.scrollHeight; });
        }

        function viewVideo(videoUrl) {
            if (!videoUrl) {
                showNotification('‚ö†Ô∏è –í–∏–¥–µ–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ', 'warning');
                return;
            }
            const modal = document.createElement('div');
            modal.style.position = 'fixed';
            modal.style.top = '0';
            modal.style.left = '0';
            modal.style.width = '100%';
            modal.style.height = '100%';
            modal.style.backgroundColor = 'rgba(0,0,0,0.9)';
            modal.style.display = 'flex';
            modal.style.alignItems = 'center';
            modal.style.justifyContent = 'center';
            modal.style.zIndex = '10000';
            modal.style.backdropFilter = 'blur(10px)';

            const wrapper = document.createElement('div');
            wrapper.style.cssText = 'position:relative;max-width:90%;max-height:90%;text-align:center;';

            const video = document.createElement('video');
            video.controls = true;
            video.autoplay = true;
            video.style.cssText = 'max-width:100%;max-height:80vh;border-radius:10px;display:block;';

            const closeBtn = document.createElement('button');
            closeBtn.textContent = '‚úï';
            closeBtn.style.cssText = 'position:absolute;top:-40px;right:0;background:var(--gradient-primary);color:white;border:none;padding:10px;border-radius:50%;cursor:pointer;font-size:16px;';
            closeBtn.onclick = () => { video.pause(); if (video._blobUrl) URL.revokeObjectURL(video._blobUrl); modal.remove(); };

            let useBlobUrl = false;
            if (videoUrl.startsWith('data:')) {
                // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º base64 ‚Üí Blob ‚Üí BlobURL –¥–ª—è –Ω–∞–¥—ë–∂–Ω–æ–≥–æ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è
                try {
                    const parts = videoUrl.split(',');
                    const mime = parts[0].match(/:(.*?);/)[1];
                    const bstr = atob(parts[1]);
                    const arr = new Uint8Array(bstr.length);
                    for (let i = 0; i < bstr.length; i++) arr[i] = bstr.charCodeAt(i);
                    const blob = new Blob([arr], { type: mime });
                    const blobUrl = URL.createObjectURL(blob);
                    video._blobUrl = blobUrl;
                    video.src = blobUrl;
                    useBlobUrl = true;
                } catch(e) {
                    video.src = videoUrl;
                }
            } else {
                video.src = videoUrl;
            }

            const dlLink = document.createElement('a');
            dlLink.textContent = '‚¨á –°–∫–∞—á–∞—Ç—å –≤–∏–¥–µ–æ';
            dlLink.style.cssText = 'display:inline-block;margin-top:10px;color:var(--accent-color);text-decoration:none;font-size:14px;';
            dlLink.href = video._blobUrl || videoUrl;
            dlLink.download = 'quantum_video.webm';

            wrapper.appendChild(closeBtn);
            wrapper.appendChild(video);
            wrapper.appendChild(dlLink);
            modal.appendChild(wrapper);
            document.body.appendChild(modal);

            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    video.pause();
                    if (video._blobUrl) URL.revokeObjectURL(video._blobUrl);
                    modal.remove();
                }
            });

            logSecurityEvent('–ü—Ä–æ—Å–º–æ—Ç—Ä –≤–∏–¥–µ–æ', 'info');
        }

        function sendMessage() {
            if (!currentChat) return showNotification('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –∫–≤–∞–Ω—Ç–æ–≤—ã–π –∫–∞–Ω–∞–ª', 'warning');
            if (isBlocked(currentChat.id)) return showNotification('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω', 'error');
            
            const input = document.getElementById('messageInput');
            const text = input.value.trim();
            if (!text) return;
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –∏–Ω—ä–µ–∫—Ü–∏–∏
            if (currentUser.security.injectionProtection) {
                const injectionPatterns = /(\b(SELECT|INSERT|UPDATE|DELETE|DROP|UNION|SCRIPT|JAVASCRIPT|ONLOAD|ONERROR)\b)|[<>]/i;
                if (injectionPatterns.test(text)) {
                    showNotification('–°–æ–æ–±—â–µ–Ω–∏–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã', 'error');
                    logSecurityEvent('–û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ –ø–æ–ø—ã—Ç–∫–∞ –∏–Ω—ä–µ–∫—Ü–∏–∏ –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏', 'critical');
                    return;
                }
            }
            
            const messageLanguage = currentUser.settings.autoDetectLanguage ? 
                detectTextLanguage(text) : currentUser.language;
            
            const message = {
                id: Date.now(),
                sender: 'me',
                text: text,
                time: new Date().toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'}),
                type: 'text',
                timestamp: Date.now(),
                language: messageLanguage,
                replyTo: (typeof replyToMsg !== 'undefined' && replyToMsg) ? { id: replyToMsg.id, text: replyToMsg.text, sender: replyToMsg.sender } : null
            };
            
            saveMessage(message);
            currentChat.lastMessage = text.length > 25 ? text.substring(0, 25) + '...' : text;
            currentChat.time = '–¢–æ–ª—å–∫–æ —á—Ç–æ';
            saveToLocalStorage();
            
            loadMessages(currentChat.id);
            updateUI();
            input.value = '';
            input.style.height = 'auto';
            hideT9Suggestions();
            if (typeof cancelReply === 'function') cancelReply();
            
            // üîä –ó–≤—É–∫ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è
            if (document.getElementById('soundNotifications')?.checked !== false) {
                if (typeof soundSendMessage === 'function') soundSendMessage();
            }
            
            logSecurityEvent(`–°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ —á–∞—Ç ${currentChat.name}`, 'info');
            
            setTimeout(sendAutoReply, 1000 + Math.random() * 2000);
        }

        function saveMessage(message) {
            if (!currentChat) return;
            const saved = localStorage.getItem(`quantum_messages_${currentChat.id}`);
            let messages = saved ? JSON.parse(saved) : [];
            messages.push(message);
            localStorage.setItem(`quantum_messages_${currentChat.id}`, JSON.stringify(messages));
        }

        function sendAutoReply() {
            if (!currentChat) return;
            
            const replies = {
                ru: ['–ü—Ä–∏–≤–µ—Ç!', '–ö–∞–∫ –∫–≤–∞–Ω—Ç–æ–≤—ã–µ –¥–µ–ª–∞?', '–ò–Ω—Ç–µ—Ä–µ—Å–Ω–æ!', '–°–æ–≥–ª–∞—Å–µ–Ω!', '–ö–≤–∞–Ω—Ç–æ–≤–∞—è –∏–¥–µ—è!'],
                en: ['Hello!', 'How are you?', 'Interesting!', 'I agree!', 'Quantum idea!'],
                es: ['¬°Hola!', '¬øC√≥mo est√°s?', '¬°Interesante!', '¬°Estoy de acuerdo!', '¬°Idea cu√°ntica!']
            };
            
            const savedMessages = localStorage.getItem(`quantum_messages_${currentChat.id}`);
            let lastMessageLanguage = 'ru';
            if (savedMessages) {
                try {
                    const messages = JSON.parse(savedMessages);
                    const lastMsg = messages[messages.length - 1];
                    if (lastMsg && lastMsg.language) {
                        lastMessageLanguage = lastMsg.language;
                    }
                } catch (e) {
                    console.error('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ —Å–æ–æ–±—â–µ–Ω–∏–π:', e);
                }
            }
            
            const langReplies = replies[lastMessageLanguage] || replies.ru;
            const reply = langReplies[Math.floor(Math.random() * langReplies.length)];
            
            const message = {
                id: Date.now(),
                sender: 'other',
                text: reply,
                time: new Date().toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'}),
                type: 'text',
                timestamp: Date.now(),
                language: lastMessageLanguage
            };
            
            saveMessage(message);
            currentChat.unread = (currentChat.unread || 0) + 1;
            currentChat.lastMessage = reply.length > 25 ? reply.substring(0, 25) + '...' : reply;
            currentChat.time = '–¢–æ–ª—å–∫–æ —á—Ç–æ';
            saveToLocalStorage();
            
            loadMessages(currentChat.id);
            updateUI();
            
            // üîä –ó–≤—É–∫ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è
            if (document.getElementById('soundNotifications')?.checked !== false) {
                if (typeof soundReceiveMessage === 'function') soundReceiveMessage();
            }
            
            showNotification(`–ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç ${currentChat.name}`, 'success');
        }

        function copyUserId() {
            navigator.clipboard.writeText(currentUser.id).then(() => {
                showNotification('ID —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞', 'success');
                logSecurityEvent('ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞', 'info');
            }).catch(err => {
                console.error('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è:', err);
                showNotification('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è', 'error');
            });
        }

        function viewImage(imageUrl) {
            const modal = document.createElement('div');
            modal.style.position = 'fixed';
            modal.style.top = '0';
            modal.style.left = '0';
            modal.style.width = '100%';
            modal.style.height = '100%';
            modal.style.backgroundColor = 'rgba(0,0,0,0.9)';
            modal.style.display = 'flex';
            modal.style.alignItems = 'center';
            modal.style.justifyContent = 'center';
            modal.style.zIndex = '10000';
            modal.style.backdropFilter = 'blur(10px)';
            
            // –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ URL
            const safeUrl = imageUrl.replace(/[<>"']/g, '');
            
            modal.innerHTML = `
                <div style="position: relative; max-width: 90%; max-height: 90%;">
                    <img src="${safeUrl}" style="max-width: 100%; max-height: 80vh; border-radius: 10px;">
                    <button onclick="this.parentElement.parentElement.remove()" style="position: absolute; top: -40px; right: 0; background: var(--gradient-primary); color: white; border: none; padding: 10px; border-radius: 50%; cursor: pointer;">‚úï</button>
                    <div style="text-align: center; margin-top: 10px; color: white;">
                        <a href="${safeUrl}" download="quantum_image.jpg" style="color: var(--accent-color); text-decoration: none;">–°–∫–∞—á–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</a>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
            
            logSecurityEvent('–ü—Ä–æ—Å–º–æ—Ç—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è', 'info');
        }

        function attachFile() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.txt,.pdf,.jpg,.jpeg,.png,.doc,.docx,.webm,.mp4';
            input.onchange = e => {
                const file = e.target.files[0];
                if (!file) return;
                
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ —Ñ–∞–π–ª–∞
                if (currentUser.security.fileValidation) {
                    const validation = validateFile(file);
                    if (!validation.valid) {
                        showNotification(validation.error, 'error');
                        logSecurityEvent(`–ü–æ–ø—ã—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–µ–¥–æ–ø—É—Å—Ç–∏–º–æ–≥–æ —Ñ–∞–π–ª–∞: ${file.name} - ${validation.error}`, 'warning');
                        return;
                    }
                }
                
                const message = {
                    id: Date.now(),
                    sender: 'me',
                    type: file.type.startsWith('video') ? 'video' : 'file',
                    fileName: file.name,
                    fileSize: formatFileSize(file.size),
                    time: new Date().toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'}),
                    timestamp: Date.now()
                };
                
                saveMessage(message);
                if (currentChat) {
                    currentChat.lastMessage = `üìé ${file.name}`;
                    currentChat.time = '–¢–æ–ª—å–∫–æ —á—Ç–æ';
                    saveToLocalStorage();
                }
                
                loadMessages(currentChat?.id);
                updateUI();
                
                showNotification(`–§–∞–π–ª "${file.name}" –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω`, 'success');
                logSecurityEvent(`–§–∞–π–ª "${file.name}" –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ —á–∞—Ç ${currentChat?.name}`, 'info');
            };
            input.click();
        }

        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' –ë';
            else if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' –ö–ë';
            else if (bytes < 1024 * 1024 * 1024) return (bytes / (1024 * 1024)).toFixed(1) + ' –ú–ë';
            else return (bytes / (1024 * 1024 * 1024)).toFixed(2) + ' –ì–ë';
        }

        function downloadFile(fileName, size, fileType = 'txt') {
            showNotification(`–ù–∞—á–∏–Ω–∞–µ–º —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ: ${fileName}`, 'info');
            logSecurityEvent(`–ù–∞—á–∞—Ç–æ —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞: ${fileName}`, 'info');
            
            const messageElement = event.target.closest('.document-message');
            if (messageElement) {
                const progressContainer = messageElement.querySelector('.download-progress');
                const progressBar = messageElement.querySelector('.download-progress-bar');
                const completeText = messageElement.querySelector('.download-complete');
                
                if (progressBar && progressContainer) {
                    progressContainer.style.display = 'block';
                    progressBar.style.width = '0%';
                    
                    let progress = 0;
                    const interval = setInterval(() => {
                        progress += Math.random() * 20;
                        progressBar.style.width = Math.min(progress, 100) + '%';
                        
                        if (progress >= 100) {
                            clearInterval(interval);
                            
                            setTimeout(() => {
                                let content, mimeType, extension;
                                
                                if (fileName.includes('.jpg') || fileName.includes('.jpeg') || fileName.includes('.png')) {
                                    content = `<svg width="200" height="200" xmlns="http://www.w3.org/2000/svg">
                                        <rect width="200" height="200" fill="#667eea"/>
                                        <text x="100" y="100" text-anchor="middle" fill="white" font-family="Arial" font-size="20">
                                            Quantum Image
                                        </text>
                                    </svg>`;
                                    mimeType = 'image/svg+xml';
                                    extension = '.svg';
                                } else if (fileName.includes('.pdf')) {
                                    content = 'JVBERi0xLjMKJcTl8uXrp/Og0MTGCjQgMCBvYmoKPDwvTGluZWFyaXplZCAxL0wgMTAwMDAvSCBbIDUwMCAxMDAwXS9PIDYvRSAxMDAwMC9OIDEvVCA5NzQ1Pj4KZW5kb2JqCg==';
                                    mimeType = 'application/pdf';
                                    extension = '.pdf';
                                } else if (fileName.includes('.webm') || fileName.includes('.mp4')) {
                                    content = 'Quantum Video Demo';
                                    mimeType = 'video/webm';
                                    extension = '.webm';
                                } else {
                                    content = `Quantum Messenger - –î–µ–º–æ —Ñ–∞–π–ª\n\n–ò–º—è —Ñ–∞–π–ª–∞: ${fileName}\n–†–∞–∑–º–µ—Ä: ${size}\n–°–æ–∑–¥–∞–Ω–æ: ${new Date().toLocaleString()}\n\n–≠—Ç–æ –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π —Ñ–∞–π–ª —Å–æ–∑–¥–∞–Ω–Ω—ã–π –≤ Quantum Messenger.`;
                                    mimeType = 'text/plain';
                                    extension = '.txt';
                                }
                                
                                const blob = new Blob([content], { type: mimeType });
                                const url = URL.createObjectURL(blob);
                                const a = document.createElement('a');
                                a.href = url;
                                
                                let downloadName = fileName;
                                if (!fileName.includes('.')) {
                                    downloadName += extension;
                                }
                                a.download = downloadName;
                                
                                document.body.appendChild(a);
                                a.click();
                                document.body.removeChild(a);
                                URL.revokeObjectURL(url);
                                
                                progressContainer.style.display = 'none';
                                if (completeText) {
                                    completeText.style.display = 'block';
                                    setTimeout(() => completeText.style.display = 'none', 3000);
                                }
                                
                                showNotification(`–§–∞–π–ª ${downloadName} —É—Å–ø–µ—à–Ω–æ —Å–∫–∞—á–∞–Ω`, 'success');
                                logSecurityEvent(`–§–∞–π–ª ${downloadName} —É—Å–ø–µ—à–Ω–æ —Å–∫–∞—á–∞–Ω`, 'info');
                            }, 500);
                        }
                    }, 100);
                }
            }
        }

        function openSettings() {
            updateUserDisplay();
            document.getElementById('neonEffects').checked = currentUser.settings.neonEffects;
            // accentColor —Ç–µ–ø–µ—Ä—å —É–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —á–µ—Ä–µ–∑ —Å–∏—Å—Ç–µ–º—É —Ç–µ–º
            document.getElementById('t9Enabled').checked = currentUser.settings.t9Enabled;
            document.getElementById('autoDetectLanguage').checked = currentUser.settings.autoDetectLanguage;
            
            document.querySelectorAll('.language-option').forEach(option => {
                option.classList.remove('active');
                if (option.dataset.lang === currentUser.language) {
                    option.classList.add('active');
                }
            });
            
            document.querySelectorAll('.avatar-option').forEach(option => {
                option.classList.remove('selected');
                if (option.textContent === currentUser.avatar) {
                    option.classList.add('selected');
                }
            });
            
            renderFriendsListInSettings();
            renderContactNotificationList();
            updateSecurityLogs();
            avRefresh();
            
            switchSettingsTab('profile');
            document.getElementById('settingsModal').style.display = 'flex';
        }

        function switchSettingsTab(tabName) {
            document.querySelectorAll('.settings-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.querySelectorAll('.settings-tab-content').forEach(content => {
                content.style.display = 'none';
            });
            
            const activeTab = document.querySelector(`.settings-tab[onclick="switchSettingsTab('${tabName}')"]`);
            if (activeTab) {
                activeTab.classList.add('active');
            }
            
            const activeContent = document.getElementById(`${tabName}Tab`);
            if (activeContent) {
                activeContent.style.display = 'block';
            }
            
            logSecurityEvent(`–ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∞ –≤–∫–ª–∞–¥–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫: ${tabName}`, 'info');
            if (tabName === 'blacklist' && typeof renderBlacklistSettings === 'function') renderBlacklistSettings();
            if (tabName === 'friends' && typeof loadFriendsInSettings === 'function') loadFriendsInSettings();
            if (tabName === 'appearance') {
                initThemeGrid();
                initChatBgPresets();
                // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–µ–≤—å—é –∏ —Å–ª–∞–π–¥–µ—Ä
                const savedPhoto = localStorage.getItem('quantum_chat_bg_photo');
                const savedPreset = localStorage.getItem('quantum_chat_bg_preset') || 'none';
                const slider = document.getElementById('chatBgOpacity');
                const valEl = document.getElementById('chatBgOpacityVal');
                if (slider) slider.value = currentChatBgOpacity;
                if (valEl) valEl.textContent = currentChatBgOpacity + '%';
                if (savedPhoto) {
                    const prev = document.getElementById('chatBgPreview');
                    if (prev) { prev.style.backgroundImage = `url(${savedPhoto})`; prev.style.backgroundSize = 'cover'; prev.style.backgroundPosition = 'center'; }
                    const lbl = document.getElementById('chatBgPreviewLabel');
                    if (lbl) lbl.style.display = 'none';
                    document.getElementById('chatBgClearBtn').style.display = 'flex';
                    document.getElementById('chatBgOpacityRow').style.display = 'flex';
                } else if (savedPreset !== 'none') {
                    const p = CHAT_BG_PRESETS.find(x => x.id === savedPreset);
                    if (p) {
                        const prev = document.getElementById('chatBgPreview');
                        if (prev) { prev.style.backgroundImage = p.css; prev.style.backgroundSize = p.size || 'auto'; }
                        const lbl = document.getElementById('chatBgPreviewLabel');
                        if (lbl) lbl.textContent = '–ü–∞—Ç—Ç–µ—Ä–Ω: ' + savedPreset;
                    }
                    document.getElementById('chatBgClearBtn').style.display = 'flex';
                    document.getElementById('chatBgOpacityRow').style.display = 'none';
                }
            }
        }

        function selectLanguage(lang) {
            currentUser.language = lang;
            document.querySelectorAll('.language-option').forEach(option => {
                option.classList.remove('active');
                if (option.dataset.lang === lang) {
                    option.classList.add('active');
                }
            });
            
            updateInterfaceLanguage();
            saveToLocalStorage();
            showNotification(`–Ø–∑—ã–∫ –∏–∑–º–µ–Ω–µ–Ω –Ω–∞ ${getLanguageName(lang)}`, 'success');
            logSecurityEvent(`–Ø–∑—ã–∫ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –∏–∑–º–µ–Ω–µ–Ω –Ω–∞ ${lang}`, 'info');
        }

        function getLanguageName(code) {
            const languages = {
                'ru': '–†—É—Å—Å–∫–∏–π',
                'en': 'English',
                'es': 'Espa√±ol'
            };
            return languages[code] || code;
        }

        function updateInterfaceLanguage() {
            const T = {
                ru: {
                    // –ü–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä—ã
                    chatPlaceholder:       '–í–≤–µ–¥–∏—Ç–µ –∫–≤–∞–Ω—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ...',
                    searchPlaceholder:     '–ü–æ–∏—Å–∫ –≤ –∫–≤–∞–Ω—Ç–æ–≤–æ–º –ø–æ–ª–µ...',
                    addFriendPlaceholder:  '–í–≤–µ–¥–∏—Ç–µ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è',
                    blockIdPlaceholder:    'ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (Q115XXX)',
                    // –ö–Ω–æ–ø–∫–∏ –≤ —Å–∞–π–¥–±–∞—Ä–µ
                    newChat:               '–ù–æ–≤—ã–π –∫–≤–∞–Ω—Ç–æ–≤—ã–π –∫–∞–Ω–∞–ª',
                    // –ó–∞–≥–æ–ª–æ–≤–æ–∫ –Ω–∞—Å—Ç—Ä–æ–µ–∫
                    settings_title:        '–ö–≤–∞–Ω—Ç–æ–≤—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏',
                    // –ü—Ä–æ—Ñ–∏–ª—å
                    profile_section:       '–ö–≤–∞–Ω—Ç–æ–≤—ã–π –ø—Ä–æ—Ñ–∏–ª—å',
                    your_id:               '–í–∞—à ID',
                    your_id_desc:          '–ü–æ–¥–µ–ª–∏—Ç–µ—Å—å —ç—Ç–∏–º ID, —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å –≤–∞—Å –≤ –¥—Ä—É–∑—å—è',
                    username:              '–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è',
                    username_desc:         '–í–∞—à–µ –∏–º—è –≤ –∫–≤–∞–Ω—Ç–æ–≤–æ–π —Å–µ—Ç–∏',
                    avatar_section:        '–ö–≤–∞–Ω—Ç–æ–≤—ã–π –∞–≤–∞—Ç–∞—Ä',
                    status_section:        '–°—Ç–∞—Ç—É—Å',
                    status_online:         '‚ö° –í —Å–µ—Ç–∏',
                    status_away:           'üåô –û—Ç–æ—à–µ–ª',
                    status_busy:           'üî¥ –ó–∞–Ω—è—Ç',
                    status_invisible:      'üëª –ù–µ–≤–∏–¥–∏–º–∫–∞',
                    // –í–Ω–µ—à–Ω–∏–π –≤–∏–¥
                    appearance_section:    '–¢–µ–º–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è',
                    dark_theme:            '–¢–µ–º–Ω–∞—è —Ç–µ–º–∞',
                    dark_theme_desc:       '–ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π –∫–≤–∞–Ω—Ç–æ–≤—ã–π —Å—Ç–∏–ª—å',
                    neon:                  '–ù–µ–æ–Ω–æ–≤—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã',
                    neon_desc:             '–í–∫–ª—é—á–∏—Ç—å —Å–≤–µ—á–µ–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–æ–≤',
                    color_scheme:          '–¶–≤–µ—Ç–æ–≤–∞—è —Å—Ö–µ–º–∞',
                    color_scheme_desc:     '–í—ã–±–µ—Ä–∏—Ç–µ —Å–≤–æ–π –∫–≤–∞–Ω—Ç–æ–≤—ã–π —Ü–≤–µ—Ç',
                    color_purple:          '–§–∏–æ–ª–µ—Ç–æ–≤–∞—è –≤–æ–ª–Ω–∞',
                    color_blue:            '–ö–≤–∞–Ω—Ç–æ–≤—ã–π —Å–∏–Ω–∏–π',
                    color_green:           '–ó–µ–ª–µ–Ω–∞—è —ç–Ω–µ—Ä–≥–∏—è',
                    color_red:             '–ö—Ä–∞—Å–Ω—ã–π –≤–∑—Ä—ã–≤',
                    color_gold:            '–ó–æ–ª–æ—Ç–æ–µ —Å–∏—è–Ω–∏–µ',
                    // –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
                    security_section:      '–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏',
                    xss:                   '–ó–∞—â–∏—Ç–∞ –æ—Ç XSS',
                    xss_desc:              '–≠–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ HTML –≤ —Å–æ–æ–±—â–µ–Ω–∏—è—Ö',
                    file_check:            '–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∞–π–ª–æ–≤',
                    file_check_desc:       '–ü—Ä–æ–≤–µ—Ä—è—Ç—å —Ç–∏–ø –∏ —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–æ–≤',
                    data_valid:            '–í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö',
                    data_valid_desc:       '–ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–≤–æ–¥–∏–º—ã—Ö –¥–∞–Ω–Ω—ã—Ö',
                    injection:             '–ó–∞—â–∏—Ç–∞ –æ—Ç –∏–Ω—ä–µ–∫—Ü–∏–π',
                    injection_desc:        '–≠–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ SQL –∏ JS –∏–Ω—ä–µ–∫—Ü–∏–π',
                    sec_history:           '–ò—Å—Ç–æ—Ä–∏—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏',
                    clear_data_section:    '–û—á–∏—Å—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö',
                    clear_cache:           '–û—á–∏—Å—Ç–∏—Ç—å –∫—ç—à',
                    export_data:           '–≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö',
                    // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
                    notif_section:         '–ö–≤–∞–Ω—Ç–æ–≤—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è',
                    sound_notif:           '–ó–≤—É–∫–æ–≤—ã–µ —Å–∏–≥–Ω–∞–ª—ã',
                    sound_notif_desc:      '–ó–≤—É–∫ –ø—Ä–∏ –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏—è—Ö',
                    visual_notif:          '–í–∏–∑—É–∞–ª—å–Ω—ã–µ –æ–ø–æ–≤–µ—â–µ–Ω–∏—è',
                    visual_notif_desc:     '–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ –±—Ä–∞—É–∑–µ—Ä–µ',
                    // –î—Ä—É–∑—å—è
                    friends_section:       '–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥—Ä—É–∑—å—è–º–∏',
                    add_friend_btn:        '–î–æ–±–∞–≤–∏—Ç—å –¥—Ä—É–≥–∞',
                    friends_list_section:  '–°–ø–∏—Å–æ–∫ –¥—Ä—É–∑–µ–π',
                    // –Ø–∑—ã–∫
                    lang_section:          '–Ø–∑—ã–∫ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞',
                    lang_settings_section: '–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —è–∑—ã–∫–∞',
                    t9:                    'T9 –ü–æ–¥—Å–∫–∞–∑–∫–∏',
                    t9_desc:               '–í–∫–ª—é—á–∏—Ç—å –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã–π –≤–≤–æ–¥ —Ç–µ–∫—Å—Ç–∞',
                    autodetect:            '–ê–≤—Ç–æ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —è–∑—ã–∫–∞',
                    autodetect_desc:       '–û–ø—Ä–µ–¥–µ–ª—è—Ç—å —è–∑—ã–∫ –≤–≤–æ–¥–∏–º–æ–≥–æ —Ç–µ–∫—Å—Ç–∞',
                    // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤
                    contact_notif_section: '–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ –∫–æ–Ω—Ç–∞–∫—Ç–∞–º',
                    contact_notif_desc:    '–ù–∞—Å—Ç—Ä–æ–π—Ç–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∫–æ–Ω—Ç–∞–∫—Ç–∞ –æ—Ç–¥–µ–ª—å–Ω–æ',
                    // –ß—ë—Ä–Ω—ã–π —Å–ø–∏—Å–æ–∫
                    blacklist_section:     '–ß—ë—Ä–Ω—ã–π —Å–ø–∏—Å–æ–∫',
                    blacklist_desc:        '–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –º–æ–≥—É—Ç –≤–∞–º –ø–∏—Å–∞—Ç—å.',
                    block_by_id_label:     '–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ ID:',
                    block_btn:             '–ë–ª–æ–∫',
                    // –ö–Ω–æ–ø–∫–∏ –º–æ–¥–∞–ª–∞
                    cancel_btn:            '–û—Ç–º–µ–Ω–∞',
                    save_btn:              '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å',
                    // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ —Å–º–µ–Ω–µ —è–∑—ã–∫–∞
                    lang_changed:          '–Ø–∑—ã–∫ –∏–∑–º–µ–Ω—ë–Ω: –†—É—Å—Å–∫–∏–π'
                },
                en: {
                    chatPlaceholder:       'Type a quantum message...',
                    searchPlaceholder:     'Search in quantum field...',
                    addFriendPlaceholder:  'Enter user ID',
                    blockIdPlaceholder:    'User ID (Q115XXX)',
                    newChat:               'New quantum channel',
                    settings_title:        'Quantum Settings',
                    profile_section:       'Quantum Profile',
                    your_id:               'Your ID',
                    your_id_desc:          'Share this ID so others can add you as a friend',
                    username:              'Username',
                    username_desc:         'Your name in the quantum network',
                    avatar_section:        'Quantum Avatar',
                    status_section:        'Status',
                    status_online:         '‚ö° Online',
                    status_away:           'üåô Away',
                    status_busy:           'üî¥ Busy',
                    status_invisible:      'üëª Invisible',
                    appearance_section:    'Theme',
                    dark_theme:            'Dark theme',
                    dark_theme_desc:       'Classic quantum style',
                    neon:                  'Neon effects',
                    neon_desc:             'Enable element glow',
                    color_scheme:          'Color scheme',
                    color_scheme_desc:     'Choose your quantum color',
                    color_purple:          'Purple wave',
                    color_blue:            'Quantum blue',
                    color_green:           'Green energy',
                    color_red:             'Red blast',
                    color_gold:            'Golden glow',
                    security_section:      'Security settings',
                    xss:                   'XSS protection',
                    xss_desc:              'Escape HTML in messages',
                    file_check:            'File validation',
                    file_check_desc:       'Check file type and size',
                    data_valid:            'Data validation',
                    data_valid_desc:       'Validate user input',
                    injection:             'Injection protection',
                    injection_desc:        'Escape SQL and JS injections',
                    sec_history:           'Security history',
                    clear_data_section:    'Clear data',
                    clear_cache:           'Clear cache',
                    export_data:           'Export data',
                    notif_section:         'Quantum notifications',
                    sound_notif:           'Sound alerts',
                    sound_notif_desc:      'Sound on new messages',
                    visual_notif:          'Visual alerts',
                    visual_notif_desc:     'Show browser notifications',
                    friends_section:       'Manage friends',
                    add_friend_btn:        'Add friend',
                    friends_list_section:  'Friends list',
                    lang_section:          'Interface language',
                    lang_settings_section: 'Language settings',
                    t9:                    'T9 hints',
                    t9_desc:               'Enable smart text input',
                    autodetect:            'Auto-detect language',
                    autodetect_desc:       'Detect language of typed text',
                    contact_notif_section: 'Contact notifications',
                    contact_notif_desc:    'Configure notifications for each contact separately',
                    blacklist_section:     'Blacklist',
                    blacklist_desc:        'Blocked users cannot send you messages.',
                    block_by_id_label:     'Block user by ID:',
                    block_btn:             'Block',
                    cancel_btn:            'Cancel',
                    save_btn:              'Save',
                    lang_changed:          'Language changed: English'
                },
                es: {
                    chatPlaceholder:       'Escribe un mensaje cu√°ntico...',
                    searchPlaceholder:     'Buscar en el campo cu√°ntico...',
                    addFriendPlaceholder:  'Ingresa ID de usuario',
                    blockIdPlaceholder:    'ID de usuario (Q115XXX)',
                    newChat:               'Nuevo canal cu√°ntico',
                    settings_title:        'Ajustes Cu√°nticos',
                    profile_section:       'Perfil Cu√°ntico',
                    your_id:               'Tu ID',
                    your_id_desc:          'Comparte este ID para que te a√±adan como amigo',
                    username:              'Nombre de usuario',
                    username_desc:         'Tu nombre en la red cu√°ntica',
                    avatar_section:        'Avatar Cu√°ntico',
                    status_section:        'Estado',
                    status_online:         '‚ö° En l√≠nea',
                    status_away:           'üåô Ausente',
                    status_busy:           'üî¥ Ocupado',
                    status_invisible:      'üëª Invisible',
                    appearance_section:    'Tema',
                    dark_theme:            'Tema oscuro',
                    dark_theme_desc:       'Estilo cu√°ntico cl√°sico',
                    neon:                  'Efectos ne√≥n',
                    neon_desc:             'Activar brillo de elementos',
                    color_scheme:          'Esquema de color',
                    color_scheme_desc:     'Elige tu color cu√°ntico',
                    color_purple:          'Onda violeta',
                    color_blue:            'Azul cu√°ntico',
                    color_green:           'Energ√≠a verde',
                    color_red:             'Explosi√≥n roja',
                    color_gold:            'Brillo dorado',
                    security_section:      'Ajustes de seguridad',
                    xss:                   'Protecci√≥n XSS',
                    xss_desc:              'Escapar HTML en mensajes',
                    file_check:            'Validaci√≥n de archivos',
                    file_check_desc:       'Verificar tipo y tama√±o de archivos',
                    data_valid:            'Validaci√≥n de datos',
                    data_valid_desc:       'Validar entrada del usuario',
                    injection:             'Protecci√≥n de inyecciones',
                    injection_desc:        'Escapar inyecciones SQL y JS',
                    sec_history:           'Historial de seguridad',
                    clear_data_section:    'Limpiar datos',
                    clear_cache:           'Limpiar cach√©',
                    export_data:           'Exportar datos',
                    notif_section:         'Notificaciones cu√°nticas',
                    sound_notif:           'Alertas sonoras',
                    sound_notif_desc:      'Sonido en nuevos mensajes',
                    visual_notif:          'Alertas visuales',
                    visual_notif_desc:     'Mostrar notificaciones del navegador',
                    friends_section:       'Gestionar amigos',
                    add_friend_btn:        'A√±adir amigo',
                    friends_list_section:  'Lista de amigos',
                    lang_section:          'Idioma de interfaz',
                    lang_settings_section: 'Ajustes de idioma',
                    t9:                    'Sugerencias T9',
                    t9_desc:               'Activar entrada de texto inteligente',
                    autodetect:            'Detecci√≥n autom√°tica de idioma',
                    autodetect_desc:       'Detectar idioma del texto escrito',
                    contact_notif_section: 'Notificaciones de contactos',
                    contact_notif_desc:    'Configura notificaciones para cada contacto por separado',
                    blacklist_section:     'Lista negra',
                    blacklist_desc:        'Los usuarios bloqueados no pueden enviarte mensajes.',
                    block_by_id_label:     'Bloquear usuario por ID:',
                    block_btn:             'Bloquear',
                    cancel_btn:            'Cancelar',
                    save_btn:              'Guardar',
                    lang_changed:          'Idioma cambiado: Espa√±ol'
                }
            };

            const lang = currentUser.language || 'ru';
            const t = T[lang] || T.ru;

            // ‚îÄ‚îÄ –ü–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä—ã ‚îÄ‚îÄ
            const msgInput = document.getElementById('messageInput');
            if (msgInput) msgInput.placeholder = t.chatPlaceholder;
            const searchEl = document.getElementById('searchChats');
            if (searchEl) searchEl.placeholder = t.searchPlaceholder;
            const addFriendEl = document.getElementById('addFriendInput');
            if (addFriendEl) addFriendEl.placeholder = t.addFriendPlaceholder;
            const blockIdEl = document.getElementById('blockByIdInput');
            if (blockIdEl) blockIdEl.placeholder = t.blockIdPlaceholder;

            // ‚îÄ‚îÄ –ö–Ω–æ–ø–∫–∞ ¬´–ù–æ–≤—ã–π –∫–∞–Ω–∞–ª¬ª ‚îÄ‚îÄ
            document.querySelectorAll('.action-btn-primary').forEach(function(btn) {
                if (btn.textContent.match(/–ù–æ–≤—ã–π|New|Nuevo/)) {
                    btn.innerHTML = '<i class="fas fa-plus"></i> ' + t.newChat;
                }
            });

            // ‚îÄ‚îÄ –ó–∞–≥–æ–ª–æ–≤–æ–∫ –Ω–∞—Å—Ç—Ä–æ–µ–∫ ‚îÄ‚îÄ
            var el;
            function set(id, text) { el = document.getElementById(id); if (el) el.textContent = text; }

            set('i18n_settings_title',        t.settings_title);
            // –ü—Ä–æ—Ñ–∏–ª—å
            set('i18n_profile_section',       t.profile_section);
            set('i18n_your_id',               t.your_id);
            set('i18n_your_id_desc',          t.your_id_desc);
            set('i18n_username',              t.username);
            set('i18n_username_desc',         t.username_desc);
            set('i18n_avatar_section',        t.avatar_section);
            set('i18n_status_section',        t.status_section);
            set('i18n_status_online',         t.status_online);
            set('i18n_status_away',           t.status_away);
            set('i18n_status_busy',           t.status_busy);
            set('i18n_status_invisible',      t.status_invisible);
            // –í–Ω–µ—à–Ω–∏–π –≤–∏–¥
            set('i18n_appearance_section',    t.appearance_section);
            set('i18n_dark_theme',            t.dark_theme);
            set('i18n_dark_theme_desc',       t.dark_theme_desc);
            set('i18n_neon',                  t.neon);
            set('i18n_neon_desc',             t.neon_desc);
            set('i18n_color_scheme',          t.color_scheme);
            set('i18n_color_scheme_desc',     t.color_scheme_desc);
            set('i18n_color_purple',          t.color_purple);
            set('i18n_color_blue',            t.color_blue);
            set('i18n_color_green',           t.color_green);
            set('i18n_color_red',             t.color_red);
            set('i18n_color_gold',            t.color_gold);
            // –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
            set('i18n_security_section',      t.security_section);
            set('i18n_xss',                   t.xss);
            set('i18n_xss_desc',              t.xss_desc);
            set('i18n_file_check',            t.file_check);
            set('i18n_file_check_desc',       t.file_check_desc);
            set('i18n_data_valid',            t.data_valid);
            set('i18n_data_valid_desc',       t.data_valid_desc);
            set('i18n_injection',             t.injection);
            set('i18n_injection_desc',        t.injection_desc);
            set('i18n_sec_history',           t.sec_history);
            set('i18n_clear_data_section',    t.clear_data_section);
            set('i18n_clear_cache',           t.clear_cache);
            set('i18n_export_data',           t.export_data);
            // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
            set('i18n_notif_section',         t.notif_section);
            set('i18n_sound_notif',           t.sound_notif);
            set('i18n_sound_notif_desc',      t.sound_notif_desc);
            set('i18n_visual_notif',          t.visual_notif);
            set('i18n_visual_notif_desc',     t.visual_notif_desc);
            // –î—Ä—É–∑—å—è
            set('i18n_friends_section',       t.friends_section);
            set('i18n_add_friend_btn',        t.add_friend_btn);
            set('i18n_friends_list_section',  t.friends_list_section);
            // –Ø–∑—ã–∫
            set('i18n_lang_section',          t.lang_section);
            set('i18n_lang_settings_section', t.lang_settings_section);
            set('i18n_t9',                    t.t9);
            set('i18n_t9_desc',               t.t9_desc);
            set('i18n_autodetect',            t.autodetect);
            set('i18n_autodetect_desc',       t.autodetect_desc);
            // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤
            set('i18n_contact_notif_section', t.contact_notif_section);
            set('i18n_contact_notif_desc',    t.contact_notif_desc);
            // –ß—ë—Ä–Ω—ã–π —Å–ø–∏—Å–æ–∫
            set('i18n_blacklist_section',     t.blacklist_section);
            set('i18n_blacklist_desc',        t.blacklist_desc);
            set('i18n_block_by_id_label',     t.block_by_id_label);
            set('i18n_block_btn',             t.block_btn);
            // –ö–Ω–æ–ø–∫–∏
            set('i18n_cancel_btn',            t.cancel_btn);
            set('i18n_save_btn',              t.save_btn);
        }

        // ==================== –°–ò–°–¢–ï–ú–ê –¢–ï–ú v5.9 ====================
        const THEMES = [
            {
                id: 'quantum',
                name: 'Quantum Dark',
                bg: 'linear-gradient(135deg, #0f0c29, #302b63, #24243e)',
                primary: '#667eea', secondary: '#764ba2', accent: '#00d4ff',
                bar1: '#667eea', bar2: 'rgba(255,255,255,0.3)',
                cardBg: 'linear-gradient(135deg,#0f0c29,#302b63)',
                textColor: '#0f0c29'
            },
            {
                id: 'midnight',
                name: 'Midnight Blue',
                bg: 'linear-gradient(135deg, #0a0a1a, #0d1b3e, #1a2a6c)',
                primary: '#00d4ff', secondary: '#0099ff', accent: '#00ff9d',
                bar1: '#00d4ff', bar2: 'rgba(255,255,255,0.25)',
                cardBg: 'linear-gradient(135deg,#0a0a1a,#1a2a6c)',
                textColor: '#0a0a1a'
            },
            {
                id: 'forest',
                name: 'Forest Night',
                bg: 'linear-gradient(135deg, #0a1f0a, #1a3a1a, #0d2b1a)',
                primary: '#00ff9d', secondary: '#00cc7a', accent: '#a8ff78',
                bar1: '#00ff9d', bar2: 'rgba(255,255,255,0.25)',
                cardBg: 'linear-gradient(135deg,#0a1f0a,#1a3a1a)',
                textColor: '#0a1f0a'
            },
            {
                id: 'sunset',
                name: 'Sunset Fire',
                bg: 'linear-gradient(135deg, #1a0a0a, #3d1a0a, #2d0a1a)',
                primary: '#ff6b35', secondary: '#ff3b5c', accent: '#ffd700',
                bar1: '#ff6b35', bar2: 'rgba(255,215,0,0.4)',
                cardBg: 'linear-gradient(135deg,#1a0a0a,#3d1a0a)',
                textColor: '#1a0a0a'
            },
            {
                id: 'aurora',
                name: 'Aurora',
                bg: 'linear-gradient(135deg, #0a1a1a, #003333, #001a33)',
                primary: '#00ffcc', secondary: '#00ccff', accent: '#ff00aa',
                bar1: '#00ffcc', bar2: '#ff00aa',
                cardBg: 'linear-gradient(135deg,#0a1a1a,#003333)',
                textColor: '#0a1a1a'
            },
            {
                id: 'galaxy',
                name: 'Galaxy',
                bg: 'linear-gradient(135deg, #07071a, #1a0733, #0d0620)',
                primary: '#a855f7', secondary: '#ec4899', accent: '#f59e0b',
                bar1: '#a855f7', bar2: '#ec4899',
                cardBg: 'linear-gradient(135deg,#07071a,#1a0733)',
                textColor: '#07071a'
            },
            {
                id: 'ocean',
                name: 'Deep Ocean',
                bg: 'linear-gradient(135deg, #000d1a, #001a33, #003366)',
                primary: '#0077ff', secondary: '#00aaff', accent: '#00ffee',
                bar1: '#0077ff', bar2: '#00ffee',
                cardBg: 'linear-gradient(135deg,#000d1a,#003366)',
                textColor: '#000d1a'
            },
            {
                id: 'light',
                name: 'Clean Light',
                bg: 'linear-gradient(135deg, #f0f4ff, #e8f0ff, #f5f0ff)',
                primary: '#667eea', secondary: '#764ba2', accent: '#00d4ff',
                bar1: '#667eea', bar2: 'rgba(0,0,0,0.15)',
                cardBg: 'linear-gradient(135deg,#f0f4ff,#e8f0ff)',
                textColor: '#667eea',
                light: true
            },
            {
                id: 'rose',
                name: 'Rose Garden',
                bg: 'linear-gradient(135deg, #1a0010, #330020, #1a001a)',
                primary: '#ff6b9d', secondary: '#ff3b5c', accent: '#ffb3c6',
                bar1: '#ff6b9d', bar2: '#ffb3c6',
                cardBg: 'linear-gradient(135deg,#1a0010,#330020)',
                textColor: '#1a0010'
            },
            {
                id: 'carbon',
                name: 'Carbon Black',
                bg: 'linear-gradient(135deg, #0a0a0a, #111111, #1a1a1a)',
                primary: '#888', secondary: '#aaa', accent: '#ffffff',
                bar1: '#aaa', bar2: 'rgba(255,255,255,0.2)',
                cardBg: 'linear-gradient(135deg,#0a0a0a,#1a1a1a)',
                textColor: '#0a0a0a'
            },
        ];

        // ===== –ü–†–ï–°–ï–¢–´ –§–û–ù–ê ‚Äî –ü–ï–†–ï–õ–ò–í–ê–Æ–©–ò–ï–°–Ø –ì–†–ê–î–ò–ï–ù–¢–´ =====
        const CHAT_BG_PRESETS = [
            { id: 'none', label: 'üö´', name: '–ë–µ–∑ —Ñ–æ–Ω–∞' },
            {
                id: 'aurora',
                name: '–ê–≤—Ä–æ—Ä–∞',
                // CSS –¥–ª—è –ø—Ä–µ–≤—å—é (—Å—Ç–∞—Ç–∏—á–Ω—ã–π)
                preview: 'linear-gradient(135deg, rgba(0,255,200,0.18) 0%, rgba(102,126,234,0.18) 50%, rgba(255,0,170,0.12) 100%)',
                // –ü–µ—Ä–µ–ª–∏–≤–∞—é—â–∏–π—Å—è –≤–∞—Ä–∏–∞–Ω—Ç (–∞–Ω–∏–º–∏—Ä—É–µ—Ç—Å—è —á–µ—Ä–µ–∑ background-size + keyframes)
                animated: `linear-gradient(135deg,
                    rgba(0,255,200,0.22) 0%,
                    rgba(102,126,234,0.2) 30%,
                    rgba(118,75,162,0.18) 55%,
                    rgba(255,0,170,0.15) 80%,
                    rgba(0,212,255,0.2) 100%)`,
                animClass: 'pattern-animated',
            },
            {
                id: 'sunset',
                name: '–ó–∞–∫–∞—Ç',
                preview: 'linear-gradient(135deg, rgba(255,107,53,0.2) 0%, rgba(255,59,92,0.18) 50%, rgba(255,215,0,0.15) 100%)',
                animated: `linear-gradient(135deg,
                    rgba(255,107,53,0.25) 0%,
                    rgba(255,59,92,0.2) 35%,
                    rgba(255,140,0,0.18) 65%,
                    rgba(255,215,0,0.2) 100%)`,
                animClass: 'pattern-animated',
            },
            {
                id: 'ocean',
                name: '–û–∫–µ–∞–Ω',
                preview: 'linear-gradient(135deg, rgba(0,30,80,0.4) 0%, rgba(0,100,200,0.25) 50%, rgba(0,212,255,0.2) 100%)',
                animated: `linear-gradient(135deg,
                    rgba(0,30,80,0.4) 0%,
                    rgba(0,120,200,0.3) 30%,
                    rgba(0,200,255,0.22) 60%,
                    rgba(0,255,200,0.18) 100%)`,
                animClass: 'pattern-animated',
            },
            {
                id: 'galaxy',
                name: '–ì–∞–ª–∞–∫—Ç–∏–∫–∞',
                preview: 'linear-gradient(135deg, rgba(30,0,60,0.5) 0%, rgba(100,0,180,0.25) 50%, rgba(200,100,255,0.15) 100%)',
                animated: `linear-gradient(135deg,
                    rgba(30,0,60,0.5) 0%,
                    rgba(80,0,160,0.3) 25%,
                    rgba(150,0,200,0.22) 55%,
                    rgba(200,100,255,0.18) 80%,
                    rgba(255,150,200,0.12) 100%)`,
                animClass: 'pattern-animated',
            },
            {
                id: 'forest',
                name: '–õ–µ—Å',
                preview: 'linear-gradient(135deg, rgba(0,40,0,0.5) 0%, rgba(0,120,60,0.25) 50%, rgba(100,200,100,0.15) 100%)',
                animated: `linear-gradient(135deg,
                    rgba(0,40,0,0.5) 0%,
                    rgba(0,100,40,0.3) 30%,
                    rgba(0,180,80,0.22) 60%,
                    rgba(100,220,120,0.15) 100%)`,
                animClass: 'pattern-animated',
            },
            {
                id: 'fire',
                name: '–û–≥–æ–Ω—å',
                preview: 'linear-gradient(135deg, rgba(80,0,0,0.5) 0%, rgba(200,50,0,0.3) 50%, rgba(255,180,0,0.2) 100%)',
                animated: `linear-gradient(135deg,
                    rgba(80,0,0,0.5) 0%,
                    rgba(200,30,0,0.35) 30%,
                    rgba(255,100,0,0.28) 60%,
                    rgba(255,200,0,0.2) 100%)`,
                animClass: 'pattern-animated-fast',
            },
            {
                id: 'ice',
                name: '–õ—ë–¥',
                preview: 'linear-gradient(135deg, rgba(180,220,255,0.2) 0%, rgba(100,180,255,0.18) 50%, rgba(200,240,255,0.15) 100%)',
                animated: `linear-gradient(135deg,
                    rgba(200,235,255,0.22) 0%,
                    rgba(100,180,255,0.18) 35%,
                    rgba(150,220,255,0.15) 65%,
                    rgba(210,245,255,0.2) 100%)`,
                animClass: 'pattern-animated',
            },
            {
                id: 'dots',
                name: '–¢–æ—á–∫–∏',
                preview: 'radial-gradient(circle, rgba(102,126,234,0.25) 1.5px, transparent 1.5px)',
                previewSize: '22px 22px',
                // –ü–∞—Ç—Ç–µ—Ä–Ω –Ω–µ –∞–Ω–∏–º–∏—Ä—É–µ—Ç—Å—è –∫–∞–∫ –≥—Ä–∞–¥–∏–µ–Ω—Ç, –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø—É–ª—å—Å–∞—Ü–∏—é —á–µ—Ä–µ–∑ opacity
                animated: 'radial-gradient(circle, rgba(102,126,234,0.3) 1.5px, transparent 1.5px)',
                animSize: '22px 22px',
                animClass: 'pattern-pulse-only',
            },
            {
                id: 'grid',
                name: '–°–µ—Ç–∫–∞',
                preview: 'linear-gradient(rgba(102,126,234,0.12) 1px, transparent 1px), linear-gradient(90deg, rgba(102,126,234,0.12) 1px, transparent 1px)',
                previewSize: '30px 30px',
                animated: 'linear-gradient(rgba(102,126,234,0.18) 1px, transparent 1px), linear-gradient(90deg, rgba(102,126,234,0.18) 1px, transparent 1px)',
                animSize: '30px 30px',
                animClass: 'pattern-pulse-only',
            },
        ];

        // CSS –¥–ª—è pattern-pulse-only (—Ç–æ–ª—å–∫–æ –ø—É–ª—å—Å–∞—Ü–∏—è –Ω–µ–ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç–∏)
        const EXTRA_PATTERN_CSS = `
        @keyframes patternPulseOnly {
            0%, 100% { opacity: 0.6; }
            50%       { opacity: 1; }
        }
        .pattern-pulse-only { animation: patternPulseOnly 4s ease-in-out infinite; }
        `;
        if (!document.getElementById('patternExtraCSS')) {
            const sty = document.createElement('style');
            sty.id = 'patternExtraCSS';
            sty.textContent = EXTRA_PATTERN_CSS;
            document.head.appendChild(sty);
        }

        let currentThemeId = localStorage.getItem('quantum_theme') || 'quantum';
        let currentChatBg = '';
        let currentChatBgPreset = localStorage.getItem('quantum_chat_bg_preset') || 'none';
        let currentChatBgOpacity = parseInt(localStorage.getItem('quantum_chat_bg_opacity') || '40');

        function initThemeGrid() {
            const grid = document.getElementById('themeGrid');
            if (!grid) return;
            grid.innerHTML = '';
            THEMES.forEach(theme => {
                const card = document.createElement('div');
                card.className = 'theme-card' + (theme.id === currentThemeId ? ' selected' : '');
                card.onclick = () => selectTheme(theme.id);
                card.innerHTML = `
                    <div class="theme-card-preview" style="background:${theme.cardBg};">
                        <div class="theme-card-bar" style="background:${theme.bar1};width:100%;"></div>
                        <div class="theme-card-bar" style="background:${theme.bar2};width:75%;"></div>
                        <div class="theme-card-bar" style="background:${theme.bar2};width:55%;"></div>
                    </div>
                    <div class="theme-card-name" style="background:${theme.cardBg};color:${theme.primary};">${theme.name}</div>
                `;
                grid.appendChild(card);
            });
        }

        function selectTheme(themeId) {
            currentThemeId = themeId;
            localStorage.setItem('quantum_theme', themeId);
            applyTheme(themeId);
            document.querySelectorAll('.theme-card').forEach((c, i) => {
                c.classList.toggle('selected', THEMES[i]?.id === themeId);
            });
            showNotification('üé® –¢–µ–º–∞ –ø—Ä–∏–º–µ–Ω–µ–Ω–∞', 'success');
        }

        function applyTheme(themeId) {
            const theme = THEMES.find(t => t.id === themeId) || THEMES[0];
            const root = document.documentElement;
            root.style.setProperty('--primary-color', theme.primary);
            root.style.setProperty('--secondary-color', theme.secondary);
            root.style.setProperty('--accent-color', theme.accent);
            root.style.setProperty('--gradient-primary', `linear-gradient(135deg, ${theme.primary} 0%, ${theme.secondary} 100%)`);
            root.style.setProperty('--gradient-dark', theme.bg);
            document.body.style.background = theme.bg;

            if (theme.light) {
                root.style.setProperty('--text-primary', '#1a1a2e');
                root.style.setProperty('--text-secondary', '#4a4a6a');
                root.style.setProperty('--glass-bg', 'rgba(0,0,0,0.05)');
                root.style.setProperty('--glass-border', 'rgba(0,0,0,0.1)');
                root.style.setProperty('--background-dark', '#f0f4ff');
                root.style.setProperty('--hover-color', 'rgba(102,126,234,0.08)');
            } else {
                root.style.setProperty('--text-primary', '#ffffff');
                root.style.setProperty('--text-secondary', '#b0b0d0');
                root.style.setProperty('--glass-bg', 'rgba(255,255,255,0.05)');
                root.style.setProperty('--glass-border', 'rgba(255,255,255,0.1)');
                root.style.setProperty('--background-dark', '#0a0a0f');
                root.style.setProperty('--hover-color', 'rgba(102,126,234,0.15)');
            }
        }

        // ===== –§–û–ù –ß–ê–¢–ê ‚Äî –í–°–Å –ù–ê chatAreaBg, –ù–ï –ù–ê messagesArea =====
        function initChatBgPresets() {
            const grid = document.getElementById('chatBgPresets');
            if (!grid) return;
            grid.innerHTML = '';
            CHAT_BG_PRESETS.forEach(p => {
                const el = document.createElement('div');
                const isActive = (p.id === currentChatBgPreset) && !currentChatBg;
                el.className = 'chat-bg-preset' + (isActive ? ' selected' : '');
                if (p.id === 'none') {
                    el.classList.add('chat-bg-preset-none');
                    el.title = '–ë–µ–∑ —Ñ–æ–Ω–∞';
                    el.innerHTML = '<i class="fas fa-ban" style="font-size:20px;"></i>';
                } else {
                    el.style.background = p.preview;
                    if (p.previewSize) el.style.backgroundSize = p.previewSize;
                    el.title = p.name;
                    // –ú–∞–ª–µ–Ω—å–∫–∞—è –ø–æ–¥–ø–∏—Å—å
                    el.innerHTML = `<span style="position:absolute;bottom:3px;left:50%;transform:translateX(-50%);font-size:9px;color:rgba(255,255,255,0.7);white-space:nowrap;text-shadow:0 1px 3px rgba(0,0,0,0.8);">${p.name}</span>`;
                    el.style.position = 'relative';
                    el.style.overflow = 'hidden';
                }
                el.onclick = () => applyPresetBg(p.id);
                grid.appendChild(el);
            });
        }

        function applyChatBg(base64, preset) {
            const chatArea = document.getElementById('chatAreaBg');
            const patternLayer = document.getElementById('chatPatternLayer');
            const dimOverlay = document.getElementById('chatDimOverlay');
            if (!chatArea) return;

            if (base64) {
                // === –§–û–¢–û: —Å—Ç–∞—Ç–∏—á–Ω—ã–π —Ñ–æ–Ω –Ω–∞ chatAreaBg, –ù–ï –Ω–∞ messagesArea ===
                chatArea.style.backgroundImage = `url(${base64})`;
                chatArea.style.backgroundSize = 'cover';
                chatArea.style.backgroundPosition = 'center center';
                chatArea.style.backgroundRepeat = 'no-repeat';
                chatArea.style.backgroundAttachment = 'local';

                // –ü–∞—Ç—Ç–µ—Ä–Ω —Å–∫—Ä—ã–≤–∞–µ–º
                if (patternLayer) { patternLayer.classList.remove('active'); patternLayer.style.background = ''; patternLayer.className = ''; patternLayer.id = 'chatPatternLayer'; }

                // –ó–∞—Ç–µ–º–Ω—è—é—â–∏–π –æ–≤–µ—Ä–ª–µ–π
                const op = currentChatBgOpacity / 100;
                if (dimOverlay) dimOverlay.style.background = `rgba(0,0,0,${op})`;

                // –ü—Ä–µ–≤—å—é
                updateBgPreview(base64, null);
                document.getElementById('chatBgClearBtn').style.display = 'flex';
                document.getElementById('chatBgOpacityRow').style.display = 'flex';

            } else if (preset && preset !== 'none') {
                const p = CHAT_BG_PRESETS.find(x => x.id === preset);
                if (!p) return;

                // –£–±–∏—Ä–∞–µ–º —Ñ–æ—Ç–æ-—Ñ–æ–Ω —Å chatArea
                chatArea.style.backgroundImage = '';
                chatArea.style.backgroundSize = '';
                chatArea.style.backgroundPosition = '';
                chatArea.style.backgroundAttachment = '';

                // –£–±–∏—Ä–∞–µ–º –∑–∞—Ç–µ–º–Ω–µ–Ω–∏–µ
                if (dimOverlay) dimOverlay.style.background = 'transparent';

                // –í–∫–ª—é—á–∞–µ–º –ø–∞—Ç—Ç–µ—Ä–Ω-—Å–ª–æ–π —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π
                if (patternLayer) {
                    patternLayer.style.backgroundImage = p.animated;
                    patternLayer.style.backgroundSize = p.animSize || '400% 400%';
                    patternLayer.style.backgroundRepeat = p.animSize ? 'repeat' : 'no-repeat';
                    // –°–±—Ä–æ—Å–∏—Ç—å –∫–ª–∞—Å—Å—ã
                    patternLayer.className = '';
                    patternLayer.id = 'chatPatternLayer';
                    void patternLayer.offsetWidth; // force reflow –¥–ª—è —Ä–µ—Å—Ç–∞—Ä—Ç–∞ –∞–Ω–∏–º–∞—Ü–∏–∏
                    patternLayer.classList.add('active', p.animClass || 'pattern-animated');
                }

                updateBgPreview(null, p);
                document.getElementById('chatBgClearBtn').style.display = 'flex';
                document.getElementById('chatBgOpacityRow').style.display = 'none';

            } else {
                // –°–±—Ä–æ—Å –≤—Å–µ–≥–æ
                chatArea.style.backgroundImage = '';
                chatArea.style.backgroundSize = '';
                chatArea.style.backgroundPosition = '';
                chatArea.style.backgroundAttachment = '';
                if (patternLayer) { patternLayer.className = ''; patternLayer.id = 'chatPatternLayer'; patternLayer.style.backgroundImage = ''; }
                if (dimOverlay) dimOverlay.style.background = 'transparent';

                updateBgPreview(null, null);
                document.getElementById('chatBgClearBtn').style.display = 'none';
                document.getElementById('chatBgOpacityRow').style.display = 'none';
            }

            // –û–±–Ω–æ–≤–∏—Ç—å –≤—ã–¥–µ–ª–µ–Ω–∏–µ –ø—Ä–µ—Å–µ—Ç–æ–≤
            document.querySelectorAll('.chat-bg-preset').forEach((el, i) => {
                el.classList.toggle('selected', !base64 && CHAT_BG_PRESETS[i]?.id === preset);
            });
        }

        function updateBgPreview(base64, preset) {
            const prev = document.getElementById('chatBgPreview');
            const lbl  = document.getElementById('chatBgPreviewLabel');
            if (!prev) return;
            if (base64) {
                prev.style.backgroundImage = `url(${base64})`;
                prev.style.backgroundSize = 'cover';
                prev.style.backgroundPosition = 'center';
                prev.style.backgroundRepeat = 'no-repeat';
                if (lbl) lbl.style.display = 'none';
            } else if (preset) {
                prev.style.backgroundImage = preset.preview;
                prev.style.backgroundSize = preset.previewSize || 'cover';
                prev.style.backgroundPosition = '';
                if (lbl) { lbl.style.display = ''; lbl.textContent = preset.name; }
            } else {
                prev.style.backgroundImage = '';
                prev.style.backgroundSize = '';
                if (lbl) { lbl.style.display = ''; lbl.textContent = '–§–æ–Ω –Ω–µ –≤—ã–±—Ä–∞–Ω'; }
            }
        }

        function applyPresetBg(presetId) {
            currentChatBgPreset = presetId;
            currentChatBg = '';
            localStorage.setItem('quantum_chat_bg_preset', presetId);
            localStorage.removeItem('quantum_chat_bg_photo');
            applyChatBg('', presetId);
            if (presetId !== 'none') showNotification('‚ú® –û–±–æ–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã', 'success');
            else showNotification('üóëÔ∏è –§–æ–Ω —É–±—Ä–∞–Ω', 'info');
        }

        function triggerChatBgUpload() {
            document.getElementById('chatBgFileInput').click();
        }

        function handleChatBgUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            if (!file.type.startsWith('image/')) { showNotification('‚ùå –¢–æ–ª—å–∫–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è', 'error'); return; }
            if (file.size > 10 * 1024 * 1024) { showNotification('‚ùå –§–∞–π–ª –±–æ–ª—å—à–µ 10 –ú–ë', 'error'); return; }

            const reader = new FileReader();
            reader.onload = e => {
                currentChatBg = e.target.result;
                currentChatBgPreset = 'none';
                try { localStorage.setItem('quantum_chat_bg_photo', currentChatBg); } catch(err) {
                    showNotification('‚ö†Ô∏è –§–æ—Ç–æ –±–æ–ª—å—à–æ–µ ‚Äî —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ –≤ —Å–µ—Å—Å–∏–∏', 'warning');
                }
                localStorage.setItem('quantum_chat_bg_preset', 'none');
                applyChatBg(currentChatBg, '');
                showNotification('üñºÔ∏è –§–æ–Ω —á–∞—Ç–∞ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!', 'success');
            };
            reader.readAsDataURL(file);
            event.target.value = '';
        }

        function clearChatBg() {
            currentChatBg = '';
            currentChatBgPreset = 'none';
            localStorage.removeItem('quantum_chat_bg_photo');
            localStorage.setItem('quantum_chat_bg_preset', 'none');
            applyChatBg('', 'none');
            showNotification('üóëÔ∏è –§–æ–Ω —É–±—Ä–∞–Ω', 'info');
        }

        function applyChatBgOpacity(val) {
            currentChatBgOpacity = parseInt(val);
            localStorage.setItem('quantum_chat_bg_opacity', val);
            document.getElementById('chatBgOpacityVal').textContent = val + '%';
            const dimOverlay = document.getElementById('chatDimOverlay');
            if (dimOverlay && currentChatBg) {
                dimOverlay.style.background = `rgba(0,0,0,${val/100})`;
            }
        }

        function loadSavedAppearance() {
            applyTheme(currentThemeId);
            const savedPhoto = localStorage.getItem('quantum_chat_bg_photo');
            const savedPreset = localStorage.getItem('quantum_chat_bg_preset') || 'none';
            currentChatBgOpacity = parseInt(localStorage.getItem('quantum_chat_bg_opacity') || '40');
            if (savedPhoto) {
                currentChatBg = savedPhoto;
                currentChatBgPreset = 'none';
                applyChatBg(savedPhoto, '');
            } else if (savedPreset && savedPreset !== 'none') {
                currentChatBgPreset = savedPreset;
                applyChatBg('', savedPreset);
            }
            const slider = document.getElementById('chatBgOpacity');
            if (slider) slider.value = currentChatBgOpacity;
            const val = document.getElementById('chatBgOpacityVal');
            if (val) val.textContent = currentChatBgOpacity + '%';
        }

        function saveSettings() {
            const userNameInput = document.getElementById('userNameInput');
            const newName = userNameInput.value.trim();
            
            if (newName && !validateUserName(newName)) {
                showNotification('–ù–µ–¥–æ–ø—É—Å—Ç–∏–º–æ–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–æ–ª—å–∫–æ –±–µ–∑–æ–ø–∞—Å–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã.', 'error');
                return;
            }
            
            if (newName) {
                currentUser.name = newName;
            }
            
            currentUser.status = document.getElementById('statusSelect').value;
            currentUser.settings.neonEffects = document.getElementById('neonEffects').checked;
            // accentColor —Ç–µ–ø–µ—Ä—å —É–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —á–µ—Ä–µ–∑ —Å–∏—Å—Ç–µ–º—É —Ç–µ–º (selectTheme)
            currentUser.settings.t9Enabled = document.getElementById('t9Enabled').checked;
            currentUser.settings.autoDetectLanguage = document.getElementById('autoDetectLanguage').checked;
            
            currentUser.security.fileValidation = document.getElementById('fileValidation').checked;
            currentUser.security.dataValidation = document.getElementById('dataValidation').checked;
            currentUser.security.injectionProtection = document.getElementById('injectionProtection').checked;
            
            saveToLocalStorage();
            
            if (currentUser.settings.neonEffects) {
                document.body.classList.add('neon-active');
                localStorage.setItem('neonEnabled', 'true');
            } else {
                document.body.classList.remove('neon-active');
                localStorage.setItem('neonEnabled', 'false');
            }
            
            updateUserDisplay();
            updateCSSVariables();
            closeModal('settingsModal');
            showNotification('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã', 'success');
            logSecurityEvent('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã', 'info');
        }

        function updateCSSVariables() {
            // –¢–µ–ø–µ—Ä—å —É–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —á–µ—Ä–µ–∑ applyTheme()
            applyTheme(currentThemeId);
            if (currentUser.settings.neonEffects) {
                document.body.classList.add('neon-active');
            } else {
                document.body.classList.remove('neon-active');
            }
        }

        function initAvatarGrid() {
            const avatars = ['üë§', 'üë®‚Äçüíª', 'üë©‚ÄçüöÄ', 'ü§ñ', 'üë©‚Äçüî¨', 'üë®‚Äçüé®', 'üéÆ', 'üë®‚Äç‚öïÔ∏è', 'üß≠', 'üëΩ', 'ü¶∏', 'üßô', 'üßö', 'üßõ', 'üßú', 'üßù'];
            const grid = document.getElementById('avatarGrid');
            grid.innerHTML = '';
            
            avatars.forEach(avatar => {
                const div = document.createElement('div');
                div.className = 'avatar-option';
                div.textContent = avatar;
                div.onclick = () => {
                    document.querySelectorAll('.avatar-option').forEach(opt => opt.classList.remove('selected'));
                    div.classList.add('selected');
                    currentUser.avatar = avatar;
                    // –£–±—Ä–∞—Ç—å –∫–∞—Å—Ç–æ–º–Ω–æ–µ —Ñ–æ—Ç–æ –ø—Ä–∏ –≤—ã–±–æ—Ä–µ —ç–º–æ–¥–∑–∏
                    currentUser.customAvatar = null;
                    localStorage.removeItem('quantum_custom_avatar');
                    avSetSidebar(null);
                    avSetPreview(null);
                    saveToLocalStorage();
                };
                grid.appendChild(div);
            });
        }

        function renderFriendsListInSettings() {
            const friendsList = document.getElementById('settingsFriendsList');
            friendsList.innerHTML = '';
            
            const friends = contacts.filter(contact => contact.isFriend);
            
            if (friends.length === 0) {
                friendsList.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--text-secondary);">–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –¥—Ä—É–∑–µ–π</div>';
                return;
            }
            
            friends.forEach(friend => {
                const friendItem = document.createElement('div');
                friendItem.className = 'friend-item';
                
                friendItem.innerHTML = `
                    <div class="friend-info">
                        <div class="contact-avatar">${friend.avatar}</div>
                        <div>
                            <div style="color: var(--text-primary); font-weight: 500;">${escapeHtml(friend.name)}</div>
                            <div class="friend-id">${escapeHtml(friend.id)}</div>
                        </div>
                    </div>
                    <div class="friend-actions">
                        <button onclick="openChatWithFriend('${escapeHtml(friend.id)}')" class="action-small-btn">
                            <i class="fas fa-comment"></i>
                        </button>
                        <button onclick="openContactNotificationSettings('${escapeHtml(friend.id)}')" class="action-small-btn">
                            <i class="fas fa-bell"></i>
                        </button>
                        <button onclick="openRenameContactModal('${escapeHtml(friend.id)}')" class="action-small-btn">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="removeFriend('${escapeHtml(friend.id)}')" class="action-small-btn delete">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                
                friendsList.appendChild(friendItem);
            });
        }

        function openChatWithFriend(friendId) {
            const friend = contacts.find(c => c.id === friendId);
            if (friend) {
                createChatFromContact(friend);
                closeModal('settingsModal');
            }
        }

        function removeFriend(friendId) {
            if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ–≥–æ –¥—Ä—É–≥–∞?')) {
                return;
            }
            
            contacts = contacts.filter(c => c.id !== friendId);
            
            const friendIndex = currentUser.friends.indexOf(friendId);
            if (friendIndex > -1) {
                currentUser.friends.splice(friendIndex, 1);
            }
            
            chats = chats.filter(chat => chat.contactId !== friendId);
            
            saveToLocalStorage();
            
            renderFriendsList();
            renderFriendsListInSettings();
            renderContactNotificationList();
            updateUI();
            
            showNotification('–î—Ä—É–≥ —É–¥–∞–ª–µ–Ω', 'info');
            logSecurityEvent(`–î—Ä—É–≥ ${friendId} —É–¥–∞–ª–µ–Ω`, 'info');
        }

        function openAddFriendModal() {
            closeModal('newChatModal');
            renderFriendsList();
            document.getElementById('addFriendModal').style.display = 'flex';
        }

        function addFriendById() {
            const friendIdInput = document.getElementById('friendIdInput');
            const friendId = friendIdInput.value.trim().toUpperCase();
            
            if (!friendId) {
                showNotification('–í–≤–µ–¥–∏—Ç–µ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è', 'error');
                return;
            }

            if (!validateUserId(friendId)) {
                showNotification('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç ID. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ñ–æ—Ä–º–∞—Ç: Q123456', 'error');
                return;
            }

            if (friendId === currentUser.id) {
                showNotification('–ù–µ–ª—å–∑—è –¥–æ–±–∞–≤–∏—Ç—å —Å–µ–±—è –≤ –¥—Ä—É–∑—å—è', 'error');
                return;
            }

            const existingContact = contacts.find(c => c.id === friendId);
            if (existingContact) {
                if (existingContact.isFriend) {
                    showNotification('–≠—Ç–æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ —É –≤–∞—Å –≤ –¥—Ä—É–∑—å—è—Ö', 'warning');
                } else {
                    existingContact.isFriend = true;
                    saveToLocalStorage();
                    showNotification(`${existingContact.name} –¥–æ–±–∞–≤–ª–µ–Ω –≤ –¥—Ä—É–∑—å—è`, 'success');
                    renderFriendsList();
                }
                friendIdInput.value = '';
                return;
            }

            const avatars = ['üë§', 'üë®‚Äçüíª', 'üë©‚ÄçüöÄ', 'ü§ñ', 'üë©‚Äçüî¨', 'üë®‚Äçüé®', 'üéÆ', 'üë®‚Äç‚öïÔ∏è', 'üß≠', 'üëΩ'];
            const names = ['–ö–≤–∞–Ω—Ç–æ–≤—ã–π –ü—É—Ç–µ—à–µ—Å—Ç–≤–µ–Ω–Ω–∏–∫', '–ó–≤–µ–∑–¥–Ω—ã–π –ò—Å—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å', '–¶–∏—Ñ—Ä–æ–≤–æ–π –ù–æ–º–∞–¥', '–í–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π –ü–∏–æ–Ω–µ—Ä', '–ö–∏–±–µ—Ä–Ω–µ—Ç–∏–∫'];
            
            const newContact = {
                id: friendId,
                name: `${names[Math.floor(Math.random() * names.length)]} ${friendId}`,
                avatar: avatars[Math.floor(Math.random() * avatars.length)],
                status: 'online',
                isFriend: true,
                notificationSetting: 'normal'
            };

            contacts.push(newContact);
            currentUser.friends.push(friendId);
            saveToLocalStorage();
            
            showNotification(`–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${friendId} –¥–æ–±–∞–≤–ª–µ–Ω –≤ –¥—Ä—É–∑—å—è`, 'success');
            logSecurityEvent(`–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${friendId} –¥–æ–±–∞–≤–ª–µ–Ω –≤ –¥—Ä—É–∑—å—è`, 'info');
            friendIdInput.value = '';
            renderFriendsList();
        }

        function addFriendFromSettings() {
            const friendIdInput = document.getElementById('addFriendInput');
            const friendId = friendIdInput.value.trim().toUpperCase();
            
            if (!friendId) {
                showNotification('–í–≤–µ–¥–∏—Ç–µ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è', 'error');
                return;
            }

            if (!validateUserId(friendId)) {
                showNotification('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç ID. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ñ–æ—Ä–º–∞—Ç: Q123456', 'error');
                return;
            }

            if (friendId === currentUser.id) {
                showNotification('–ù–µ–ª—å–∑—è –¥–æ–±–∞–≤–∏—Ç—å —Å–µ–±—è –≤ –¥—Ä—É–∑—å—è', 'error');
                return;
            }

            const existingContact = contacts.find(c => c.id === friendId);
            if (existingContact) {
                if (existingContact.isFriend) {
                    showNotification('–≠—Ç–æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ —É –≤–∞—Å –≤ –¥—Ä—É–∑—å—è—Ö', 'warning');
                } else {
                    existingContact.isFriend = true;
                    saveToLocalStorage();
                    showNotification(`${existingContact.name} –¥–æ–±–∞–≤–ª–µ–Ω –≤ –¥—Ä—É–∑—å—è`, 'success');
                    renderFriendsListInSettings();
                }
                friendIdInput.value = '';
                return;
            }

            const avatars = ['üë§', 'üë®‚Äçüíª', 'üë©‚ÄçüöÄ', 'ü§ñ', 'üë©‚Äçüî¨', 'üë®‚Äçüé®', 'üéÆ', 'üë®‚Äç‚öïÔ∏è', 'üß≠', 'üëΩ'];
            const names = ['–ö–≤–∞–Ω—Ç–æ–≤—ã–π –ü—É—Ç–µ—à–µ—Å—Ç–≤–µ–Ω–Ω–∏–∫', '–ó–≤–µ–∑–¥–Ω—ã–π –ò—Å—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å', '–¶–∏—Ñ—Ä–æ–≤–æ–π –ù–æ–º–∞–¥', '–í–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π –ü–∏–æ–Ω–µ—Ä', '–ö–∏–±–µ—Ä–Ω–µ—Ç–∏–∫'];
            
            const newContact = {
                id: friendId,
                name: `${names[Math.floor(Math.random() * names.length)]} ${friendId}`,
                avatar: avatars[Math.floor(Math.random() * avatars.length)],
                status: 'online',
                isFriend: true,
                notificationSetting: 'normal'
            };

            contacts.push(newContact);
            currentUser.friends.push(friendId);
            saveToLocalStorage();
            
            showNotification(`–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${friendId} –¥–æ–±–∞–≤–ª–µ–Ω –≤ –¥—Ä—É–∑—å—è`, 'success');
            logSecurityEvent(`–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${friendId} –¥–æ–±–∞–≤–ª–µ–Ω –≤ –¥—Ä—É–∑—å—è`, 'info');
            friendIdInput.value = '';
            renderFriendsListInSettings();
        }

        function renderFriendsList() {
            const friendsContainer = document.getElementById('friendsContainer');
            friendsContainer.innerHTML = '';
            
            const friends = contacts.filter(contact => contact.isFriend);
            
            if (friends.length === 0) {
                friendsContainer.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--text-secondary);">–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –¥—Ä—É–∑–µ–π</div>';
                return;
            }
            
            friends.forEach(friend => {
                const friendItem = document.createElement('div');
                friendItem.className = 'friend-item';
                
                friendItem.innerHTML = `
                    <div class="friend-info">
                        <div class="contact-avatar">${friend.avatar}</div>
                        <div>
                            <div style="color: var(--text-primary); font-weight: 500;">${escapeHtml(friend.name)}</div>
                            <div class="friend-id">${escapeHtml(friend.id)}</div>
                        </div>
                    </div>
                    <div class="friend-actions">
                        <button onclick="createChatFromContact(${JSON.stringify(friend).replace(/"/g, '&quot;')})" class="action-small-btn">
                            <i class="fas fa-comment"></i>
                        </button>
                        <button onclick="openRenameContactModal('${escapeHtml(friend.id)}')" class="action-small-btn">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="removeFriend('${escapeHtml(friend.id)}')" class="action-small-btn delete">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                
                friendsContainer.appendChild(friendItem);
            });
        }

        function openContactNotificationSettings(contactId) {
            currentEditingContactId = contactId;
            const contact = contacts.find(c => c.id === contactId);
            if (!contact) return;
            
            const settingsContainer = document.getElementById('contactNotificationSettings');
            settingsContainer.innerHTML = '';
            
            const settings = [
                {value: 'normal', text: '–û–±—ã—á–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è', desc: '–û–±—ã—á–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —Å–æ –∑–≤—É–∫–æ–º'},
                {value: 'silent', text: '–ë–µ–∑ –∑–≤—É–∫–∞', desc: '–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –±–µ–∑ –∑–≤—É–∫–∞'},
                {value: 'muted', text: '–ë–µ–∑ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π', desc: '–ü–æ–ª–Ω–æ—Å—Ç—å—é –æ—Ç–∫–ª—é—á–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è'}
            ];
            
            settings.forEach(setting => {
                const div = document.createElement('div');
                div.className = 'notification-setting-item';
                div.innerHTML = `
                    <div class="notification-setting-info">
                        <input type="radio" name="notificationSetting" value="${setting.value}" 
                               id="notif_${setting.value}" ${contact.notificationSetting === setting.value ? 'checked' : ''}>
                        <label for="notif_${setting.value}" style="flex: 1; cursor: pointer;">
                            <div style="font-weight: 500; color: var(--text-primary);">${escapeHtml(setting.text)}</div>
                            <div style="font-size: 12px; color: var(--text-secondary);">${escapeHtml(setting.desc)}</div>
                        </label>
                    </div>
                    ${setting.value !== 'normal' ? `<div class="notification-badge ${setting.value}">${setting.value === 'silent' ? 'üîá' : 'üö´'}</div>` : ''}
                `;
                settingsContainer.appendChild(div);
            });
            
            document.getElementById('contactNotificationModal').style.display = 'flex';
        }

        function saveNotificationSettings() {
            if (!currentEditingContactId) return;
            
            const selected = document.querySelector('input[name="notificationSetting"]:checked');
            if (!selected) return;
            
            const contact = contacts.find(c => c.id === currentEditingContactId);
            if (contact) {
                contact.notificationSetting = selected.value;
                saveToLocalStorage();
                showNotification('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã', 'success');
                logSecurityEvent(`–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –¥–ª—è ${contact.id} –∏–∑–º–µ–Ω–µ–Ω—ã –Ω–∞ ${selected.value}`, 'info');
                closeModal('contactNotificationModal');
                renderContactNotificationList();
            }
        }

        function renderContactNotificationList() {
            const container = document.getElementById('contactNotificationList');
            container.innerHTML = '';
            
            const friends = contacts.filter(contact => contact.isFriend);
            
            if (friends.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--text-secondary);">–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –¥—Ä—É–∑–µ–π</div>';
                return;
            }
            
            friends.forEach(friend => {
                const settingItem = document.createElement('div');
                settingItem.className = 'notification-setting-item';
                
                let badge = '';
                if (friend.notificationSetting === 'silent') {
                    badge = '<div class="notification-badge silent">üîá –ë–µ–∑ –∑–≤—É–∫–∞</div>';
                } else if (friend.notificationSetting === 'muted') {
                    badge = '<div class="notification-badge muted">üö´ –ë–µ–∑ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π</div>';
                }
                
                settingItem.innerHTML = `
                    <div class="notification-setting-info">
                        <div class="contact-avatar">${friend.avatar}</div>
                        <div>
                            <div style="font-weight: 500; color: var(--text-primary);">${escapeHtml(friend.name)}</div>
                            <div class="friend-id">${escapeHtml(friend.id)}</div>
                        </div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        ${badge}
                        <button onclick="openContactNotificationSettings('${escapeHtml(friend.id)}')" class="action-small-btn">
                            <i class="fas fa-cog"></i> –ù–∞—Å—Ç—Ä–æ–∏—Ç—å
                        </button>
                        <button onclick="openRenameContactModal('${escapeHtml(friend.id)}')" class="action-small-btn">
                            <i class="fas fa-edit"></i> –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å
                        </button>
                    </div>
                `;
                
                container.appendChild(settingItem);
            });
        }

        // ==================== –§–£–ù–ö–¶–ò–ò –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–ò - –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï ====================
        
        function clearLocalStorage() {
            if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.')) {
                return;
            }
            
            const keepUser = confirm('–•–æ—Ç–∏—Ç–µ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–ø—Ä–æ—Ñ–∏–ª—å, –Ω–∞—Å—Ç—Ä–æ–π–∫–∏)?');
            
            if (!keepUser) {
                localStorage.clear();
                location.reload();
            } else {
                const userData = localStorage.getItem('quantum_user');
                const csrfToken = localStorage.getItem('quantum_csrf_token');
                
                localStorage.clear();
                
                if (userData) {
                    localStorage.setItem('quantum_user', userData);
                }
                if (csrfToken) {
                    localStorage.setItem('quantum_csrf_token', csrfToken);
                }
                
                contacts = [];
                chats = [];
                currentChat = null;
                
                showNotification('–î–∞–Ω–Ω—ã–µ –æ—á–∏—â–µ–Ω—ã', 'success');
                logSecurityEvent('–î–∞–Ω–Ω—ã–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –æ—á–∏—â–µ–Ω—ã', 'info');
                updateUI();
                loadChats();
            }
        }

        function exportData() {
            const data = {
                user: currentUser,
                contacts: contacts,
                chats: chats,
                exportDate: new Date().toISOString(),
                version: '1.0'
            };
            
            const dataStr = JSON.stringify(data, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = `quantum_messenger_export_${Date.now()}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
            
            showNotification('–î–∞–Ω–Ω—ã–µ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã', 'success');
            logSecurityEvent('–î–∞–Ω–Ω—ã–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã', 'info');
        }

        // ==================== –ü–û–ò–°–ö –ö–ê–ö –í TELEGRAM ====================
        function searchContactsAndChats(searchTerm) {
            const resultsContainer = document.getElementById('searchResults');
            resultsContainer.innerHTML = '';
            
            if (!searchTerm || searchTerm.trim() === '') {
                resultsContainer.style.display = 'none';
                return;
            }
            
            const searchLower = searchTerm.toLowerCase().trim();
            
            const chatResults = chats.filter(chat => {
                return chat.name.toLowerCase().startsWith(searchLower);
            });
            
            const contactResults = contacts.filter(contact => {
                return contact.name.toLowerCase().startsWith(searchLower);
            });
            
            const allResultsMap = new Map();
            
            chatResults.forEach(result => {
                allResultsMap.set(result.id, result);
            });
            
            contactResults.forEach(result => {
                const existingChat = chats.find(chat => chat.contactId === result.id);
                if (!existingChat) {
                    allResultsMap.set(result.id, result);
                }
            });
            
            const allResults = Array.from(allResultsMap.values());
            
            if (allResults.length === 0) {
                resultsContainer.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--text-secondary);">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>';
                resultsContainer.style.display = 'block';
                return;
            }
            
            allResults.forEach(result => {
                const div = document.createElement('div');
                div.className = 'search-result-item';
                div.onclick = () => {
                    if (result.type === 'group' || result.id) {
                        const chat = chats.find(c => c.id === result.id);
                        if (chat) openChat(chat);
                    } else {
                        createChatFromContact(result);
                    }
                    resultsContainer.style.display = 'none';
                    document.getElementById('searchChats').value = '';
                };
                
                const isContact = !result.type && !result.lastMessage;
                
                div.innerHTML = `
                    <div class="contact-avatar">${result.avatar}</div>
                    <div class="contact-info">
                        <div class="contact-name">${escapeHtml(result.name)}</div>
                        <div class="contact-status">${isContact ? getStatusText(result.status) : result.type === 'group' ? '–ì—Ä—É–ø–ø–∞' : '–ß–∞—Ç'}</div>
                    </div>
                    <div style="color: var(--accent-color); font-size: 20px;">
                        ${isContact ? 'üë§' : result.type === 'group' ? 'üë•' : 'üí¨'}
                    </div>
                `;
                
                resultsContainer.appendChild(div);
            });
            
            resultsContainer.style.display = 'block';
            
            logSecurityEvent(`–í—ã–ø–æ–ª–Ω–µ–Ω –ø–æ–∏—Å–∫: ${searchTerm}`, 'info');
        }

        // ==================== TELEGRAM-–§–£–ù–ö–¶–ò–ò ====================

        // --- –†–µ–∞–∫—Ü–∏–∏ ---
        const QUICK_REACTIONS = [
            'üëç','‚ù§Ô∏è','üòÇ','üòÆ','üò¢','üî•',
            'üëè','üéâ','üòç','ü§î','üò°','üíØ',
            'ü•∞','üòé','ü§©','üò≠','üíÄ','üôè',
            '‚ö°','üíé','üöÄ','‚ú®','ü§Ø','üëÄ',
            'üòè','ü§ù','üí™','ü´°','‚ùÑÔ∏è','üéØ'
        ];
        let replyToMsg = null;   // —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –æ—Ç–≤–µ—Ç–∞
        let forwardMsgData = null; // —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –ø–µ—Ä–µ—Å—ã–ª–∫–∏
        let selectedForwardChats = [];

        

        function addReaction(msgId, emoji) {
            if (!currentChat) return;
            const key = `quantum_messages_${currentChat.id}`;
            let messages = JSON.parse(localStorage.getItem(key) || '[]');
            const msg = messages.find(m => m.id == msgId);
            if (!msg) return;

            if (!msg.reactions) msg.reactions = {};
            if (msg.reactions[emoji]) {
                // –£–±—Ä–∞—Ç—å –µ—Å–ª–∏ —É–∂–µ –µ—Å—Ç—å –º–æ—è
                const idx = msg.reactions[emoji].users.indexOf('me');
                if (idx !== -1) {
                    msg.reactions[emoji].users.splice(idx, 1);
                    msg.reactions[emoji].count--;
                    if (msg.reactions[emoji].count <= 0) delete msg.reactions[emoji];
                } else {
                    msg.reactions[emoji].users.push('me');
                    msg.reactions[emoji].count++;
                }
            } else {
                msg.reactions[emoji] = { count: 1, users: ['me'] };
            }

            localStorage.setItem(key, JSON.stringify(messages));
            loadMessages(currentChat.id);
            closeContextMenu();
        }

        function showReactionPicker(msgId, x, y) {
            closeContextMenu();
            const picker = document.createElement('div');
            picker.className = 'reaction-picker';
            picker.id = 'reactionPicker';
            // –ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä—É–µ–º —á—Ç–æ–±—ã –Ω–µ –≤—ã–ª–µ–∑–∞–ª–æ –∑–∞ —ç–∫—Ä–∞–Ω
            const pw = 290, ph = 100;
            const left = Math.min(x, window.innerWidth  - pw - 10);
            const top  = Math.max(10, Math.min(y - ph - 10, window.innerHeight - ph - 10));
            picker.style.left = left + 'px';
            picker.style.top  = top + 'px';

            QUICK_REACTIONS.forEach(emoji => {
                const span = document.createElement('span');
                span.textContent = emoji;
                span.title = emoji;
                span.onclick = (e) => { e.stopPropagation(); addReaction(msgId, emoji); picker.remove(); };
                picker.appendChild(span);
            });

            document.body.appendChild(picker);
            setTimeout(() => document.addEventListener('click', function _r() {
                picker.remove(); document.removeEventListener('click', _r);
            }), 100);
        }

        // --- –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é ---
        function showMsgContextMenu(e, msgId, msgText, isMine, msgObj) {
            e.preventDefault();
            closeContextMenu();

            const menu = document.createElement('div');
            menu.className = 'msg-context-menu';
            menu.id = 'msgContextMenu';

            const x = Math.min(e.clientX, window.innerWidth - 200);
            const y = Math.min(e.clientY, window.innerHeight - 280);
            menu.style.left = x + 'px';
            menu.style.top = y + 'px';

            menu.innerHTML = `
                <div class="ctx-item" onclick="showReactionPicker(${msgId}, ${e.clientX}, ${e.clientY})">
                    <i class="fas fa-smile"></i> –†–µ–∞–∫—Ü–∏—è
                </div>
                <div class="ctx-item" onclick="replyToMessage(${msgId}, '${escapeHtml(msgText || '').replace(/'/g, '&#39;')}', '${isMine ? '–í—ã' : (currentChat ? escapeHtml(currentChat.name).replace(/'/g, '&#39;') : '–°–æ–±–µ—Å–µ–¥–Ω–∏–∫')}')">
                    <i class="fas fa-reply"></i> –û—Ç–≤–µ—Ç–∏—Ç—å
                </div>
                <div class="ctx-item" onclick="copyMsgText('${escapeHtml(msgText || '').replace(/'/g, '&#39;')}')">
                    <i class="fas fa-copy"></i> –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
                </div>
                <div class="ctx-item" onclick="forwardMessage(${msgId})">
                    <i class="fas fa-share"></i> –ü–µ—Ä–µ—Å–ª–∞—Ç—å
                </div>
                <div class="ctx-item" onclick="pinMessage(${msgId}, '${escapeHtml(msgText || '').replace(/'/g, '&#39;')}')">
                    <i class="fas fa-thumbtack"></i> –ó–∞–∫—Ä–µ–ø–∏—Ç—å
                </div>
                <div class="ctx-separator"></div>
                ${isMine ? `<div class="ctx-item danger" onclick="deleteMessage(${msgId})"><i class="fas fa-trash"></i> –£–¥–∞–ª–∏—Ç—å</div>` : ''}
            `;

            document.body.appendChild(menu);
            setTimeout(() => document.addEventListener('click', function _c(ev) {
                if (!menu.contains(ev.target)) { menu.remove(); document.removeEventListener('click', _c); }
            }), 50);
        }

        function closeContextMenu() {
            const m = document.getElementById('msgContextMenu');
            const p = document.getElementById('reactionPicker');
            if (m) m.remove();
            if (p) p.remove();
        }

        // --- –û—Ç–≤–µ—Ç–∏—Ç—å ---
        function replyToMessage(msgId, msgText, senderName) {
            replyToMsg = { id: msgId, text: msgText, sender: senderName };
            document.getElementById('replyBar').style.display = 'block';
            document.getElementById('replyToName').textContent = senderName;
            document.getElementById('replyToText').textContent = msgText.length > 60 ? msgText.slice(0, 60) + '...' : msgText;
            document.getElementById('messageInput').focus();
            closeContextMenu();
        }

        function cancelReply() {
            replyToMsg = null;
            document.getElementById('replyBar').style.display = 'none';
        }

        // --- –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å ---
        function copyMsgText(text) {
            navigator.clipboard.writeText(text).then(() => {
                showNotification('–¢–µ–∫—Å—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω', 'success');
            }).catch(() => {
                const ta = document.createElement('textarea');
                ta.value = text; document.body.appendChild(ta);
                ta.select(); document.execCommand('copy');
                document.body.removeChild(ta);
                showNotification('–¢–µ–∫—Å—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω', 'success');
            });
            closeContextMenu();
        }

        // --- –£–¥–∞–ª–∏—Ç—å ---
        function deleteMessage(msgId) {
            if (!currentChat) return;
            const key = `quantum_messages_${currentChat.id}`;
            let messages = JSON.parse(localStorage.getItem(key) || '[]');
            messages = messages.filter(m => m.id != msgId);
            localStorage.setItem(key, JSON.stringify(messages));
            if (messages.length > 0) {
                const last = messages[messages.length - 1];
                currentChat.lastMessage = (last.text || 'üìé –§–∞–π–ª').slice(0, 25);
            } else {
                currentChat.lastMessage = '';
            }
            saveToLocalStorage();
            loadMessages(currentChat.id);
            updateUI();
            showNotification('–°–æ–æ–±—â–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ', 'success');
            closeContextMenu();
        }

        // --- –ó–∞–∫—Ä–µ–ø–∏—Ç—å ---
        function pinMessage(msgId, msgText) {
            if (!currentChat) return;
            currentChat.pinnedMsg = { id: msgId, text: msgText };
            saveToLocalStorage();
            showPinnedBar(msgText);
            showNotification('–°–æ–æ–±—â–µ–Ω–∏–µ –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–æ', 'success');
            closeContextMenu();
        }

        function unpinMessage() {
            if (!currentChat) return;
            currentChat.pinnedMsg = null;
            saveToLocalStorage();
            document.getElementById('pinnedMsgBar').style.display = 'none';
        }

        function showPinnedBar(text) {
            const bar = document.getElementById('pinnedMsgBar');
            document.getElementById('pinnedMsgText').textContent = text;
            bar.style.display = 'block';
        }

        // --- –ü–µ—Ä–µ—Å–ª–∞—Ç—å ---
        function forwardMessage(msgId) {
            // –ù–∞—Ö–æ–¥–∏–º –ø–æ–ª–Ω—ã–π –æ–±—ä–µ–∫—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –∏–∑ localStorage
            if (!currentChat) return;
            const key = `quantum_messages_${currentChat.id}`;
            const messages = JSON.parse(localStorage.getItem(key) || '[]');
            const msg = messages.find(m => m.id == msgId);
            if (!msg) return;

            // –ò–º—è –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è –æ—Ä–∏–≥–∏–Ω–∞–ª–∞
            const senderName = msg.sender === 'me'
                ? (currentUser.name || '–í—ã')
                : (currentChat ? currentChat.name : '–°–æ–±–µ—Å–µ–¥–Ω–∏–∫');

            forwardMsgData = { ...msg, _forwardedFrom: senderName };
            selectedForwardChats = [];

            const list = document.getElementById('forwardChatList');
            list.innerHTML = '';

            chats.forEach(chat => {
                const item = document.createElement('div');
                item.className = 'forward-contact-item';
                item.innerHTML = `
                    <input type="checkbox" id="fwd_${chat.id}" value="${chat.id}" onchange="toggleForwardChat(${chat.id})">
                    <label for="fwd_${chat.id}" style="display:flex;align-items:center;gap:10px;flex:1;cursor:pointer;">
                        <div class="chat-avatar">${chat.avatar}</div>
                        <div>
                            <div style="color:var(--text-primary);font-weight:500;">${escapeHtml(chat.name)}</div>
                        </div>
                    </label>
                `;
                list.appendChild(item);
            });

            if (chats.length === 0) {
                list.innerHTML = '<div style="padding:20px;text-align:center;color:var(--text-secondary);">–ù–µ—Ç –æ—Ç–∫—Ä—ã—Ç—ã—Ö —á–∞—Ç–æ–≤</div>';
            }

            document.getElementById('forwardModal').style.display = 'flex';
            closeContextMenu();
        }

        function toggleForwardChat(chatId) {
            const idx = selectedForwardChats.indexOf(chatId);
            if (idx !== -1) selectedForwardChats.splice(idx, 1);
            else selectedForwardChats.push(chatId);
        }

        function confirmForward() {
            if (!forwardMsgData || selectedForwardChats.length === 0) {
                showNotification('–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —á–∞—Ç', 'warning');
                return;
            }

            const prevChat = currentChat;
            const fromName = forwardMsgData._forwardedFrom || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';

            selectedForwardChats.forEach(chatId => {
                const targetChat = chats.find(c => c.id == chatId);
                if (!targetChat) return;

                // –ö–æ–ø–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ, –¥–æ–±–∞–≤–ª—è–µ–º –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –ø–µ—Ä–µ—Å—ã–ª–∫–∏
                const fwdMsg = {
                    id: Date.now() + Math.random(),
                    sender: 'me',
                    type:       forwardMsgData.type      || 'text',
                    text:       forwardMsgData.text      || '',
                    fileName:   forwardMsgData.fileName  || '',
                    fileSize:   forwardMsgData.fileSize  || '',
                    fileData:   forwardMsgData.fileData  || '',
                    audioData:  forwardMsgData.audioData || '',
                    duration:   forwardMsgData.duration  || 0,
                    time: new Date().toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'}),
                    timestamp: Date.now(),
                    forwardedFrom: fromName   // ‚Üê –º–µ—Ç–∫–∞ ¬´–æ—Ç –∫–æ–≥–æ¬ª
                };

                const key = `quantum_messages_${chatId}`;
                let msgs = JSON.parse(localStorage.getItem(key) || '[]');
                msgs.push(fwdMsg);
                localStorage.setItem(key, JSON.stringify(msgs));

                // –ü–æ–¥–ø–∏—Å—å –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —á–∞—Ç–µ
                const typeLabel = {
                    text:  forwardMsgData.text ? forwardMsgData.text.slice(0,20) : '...',
                    image: 'üñº –§–æ—Ç–æ',
                    video: 'üé• –í–∏–¥–µ–æ',
                    file:  'üìé –§–∞–π–ª',
                    voice: 'üéô –ì–æ–ª–æ—Å–æ–≤–æ–µ'
                };
                targetChat.lastMessage = `üì§ ${typeLabel[fwdMsg.type] || fwdMsg.text || '–ü–µ—Ä–µ—Å–ª–∞–Ω–æ'}`;
                targetChat.time = '–¢–æ–ª—å–∫–æ —á—Ç–æ';
            });

            saveToLocalStorage();
            if (prevChat) loadMessages(prevChat.id);
            updateUI();
            closeModal('forwardModal');
            showNotification(`–ü–µ—Ä–µ—Å–ª–∞–Ω–æ –≤ ${selectedForwardChats.length} —á–∞—Ç(–æ–≤)`, 'success');
            forwardMsgData = null;
            selectedForwardChats = [];
        }

        // –ó–∞–∫—Ä—ã—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é –ø—Ä–∏ Escape
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') { closeContextMenu(); cancelReply(); }
        });

        // ==================== –ö–û–ù–ï–¶ TELEGRAM-–§–£–ù–ö–¶–ò–ô ====================

        // Throttled UI update timer
        setInterval(() => {
            if (chats.length > 0) {
                requestAnimationFrame(updateUI);
            }
        }, 60000);

        // Debounce helper
        function debounce(fn, delay) {
            let t;
            return function(...args) { clearTimeout(t); t = setTimeout(() => fn.apply(this, args), delay); };
        }


        // ==================== –ù–û–í–´–ï –§–£–ù–ö–¶–ò–ò: –ì–û–õ–û–°–û–í–´–ï –°–û–û–ë–©–ï–ù–ò–Ø ====================
        // Voice vars declared early (above)

        function toggleVoiceRecord() {
            if (!voiceRecording) {
                startVoiceRecord();
            } else {
                stopVoiceRecord();
            }
        }

        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–π –∞—É–¥–∏–æ MIME-—Ç–∏–ø –¥–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
        function getSupportedAudioMimeType() {
            const types = [
                'audio/webm;codecs=opus',
                'audio/webm',
                'audio/ogg;codecs=opus',
                'audio/ogg',
                'audio/mp4;codecs=mp4a.40.2',
                'audio/mp4'
            ];
            for (const t of types) {
                if (MediaRecorder.isTypeSupported(t)) return t;
            }
            return ''; // –±—Ä–∞—É–∑–µ—Ä –≤—ã–±–µ—Ä–µ—Ç —Å–∞–º
        }

        async function startVoiceRecord() {
            if (!currentChat) { showNotification('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç', 'warning'); return; }
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: { echoCancellation: true, noiseSuppression: true, sampleRate: 44100 } });
                voiceChunks = [];
                const mimeType = getSupportedAudioMimeType();
                voiceRecorder = new MediaRecorder(stream, mimeType ? { mimeType } : {});
                voiceRecorder.ondataavailable = e => { if (e.data.size > 0) voiceChunks.push(e.data); };
                voiceRecorder.onstop = () => {
                    stream.getTracks().forEach(t => t.stop());
                    const usedMime = voiceRecorder.mimeType || mimeType || 'audio/webm';
                    const blob = new Blob(voiceChunks, { type: usedMime });
                    const reader = new FileReader();
                    reader.onload = () => sendVoiceMessage(reader.result, voiceSeconds);
                    reader.readAsDataURL(blob);
                };
                voiceRecorder.start(100); // timeslice 100ms –¥–ª—è –ø–ª–∞–≤–Ω–æ—Å—Ç–∏
                voiceRecording = true;
                voiceStartTime = Date.now();
                voiceSeconds = 0;

                const btn = document.getElementById('voiceBtn');
                btn.classList.add('voice-btn-recording');
                btn.textContent = '‚èπÔ∏è';
                btn.title = '–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–ø–∏—Å—å';

                voiceTimerInterval = setInterval(() => {
                    voiceSeconds++;
                    btn.title = `–ó–∞–ø–∏—Å—å: ${voiceSeconds}—Å`;
                    // no max limit on voice recording
                }, 1000);

                showNotification('üéôÔ∏è –ó–∞–ø–∏—Å—å –≥–æ–ª–æ—Å–∞...', 'info');
            } catch(e) {
                showNotification('–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É', 'error');
            }
        }

        function stopVoiceRecord() {
            if (!voiceRecording || !voiceRecorder) return;
            clearInterval(voiceTimerInterval);
            voiceRecorder.stop();
            voiceRecording = false;

            const btn = document.getElementById('voiceBtn');
            btn.classList.remove('voice-btn-recording');
            btn.textContent = 'üéôÔ∏è';
            btn.title = '–ì–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ';
        }

        async function sendVoiceMessage(audioData, durationSec) {
            if (!currentChat) return;
            const msgId = Date.now();
            try {
                await saveMediaToIDB('voice_' + msgId, audioData, 'voice', currentChat.id);
            } catch(e) {
                showNotification('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∞—É–¥–∏–æ', 'error');
                return;
            }
            const msg = {
                id: msgId,
                sender: 'me',
                type: 'voice',
                mediaId: 'voice_' + msgId,
                duration: durationSec || 1,
                time: new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}),
                timestamp: Date.now()
            };
            const key = 'quantum_messages_' + currentChat.id;
            let messages = JSON.parse(localStorage.getItem(key) || '[]');
            messages.push(msg);
            try {
                localStorage.setItem(key, JSON.stringify(messages));
            } catch(e) {
                messages = messages.slice(-50);
                localStorage.setItem(key, JSON.stringify(messages));
            }
            currentChat.lastMessage = 'üéôÔ∏è –ì–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ';
            currentChat.time = '–¢–æ–ª—å–∫–æ —á—Ç–æ';
            saveToLocalStorage();
            loadMessages(currentChat.id);
            updateUI();
            showNotification('–ì–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ', 'success');
        }

        async function playVoiceMessage(msgId) {
            const btn = document.getElementById('vpb_' + msgId);
            const waveEl = document.getElementById('vwv_' + msgId);
            const durEl = document.getElementById('vdur_' + msgId);

            // –ü–æ–ª—É—á–∞–µ–º audioData: —Å–Ω–∞—á–∞–ª–∞ –∏–∑ –∫—ç—à–∞ –∫–Ω–æ–ø–∫–∏, –ø–æ—Ç–æ–º –∏–∑ IDB
            let audioData = btn && btn._audioData ? btn._audioData : null;
            if (!audioData && btn && btn.dataset.mediaId) {
                try {
                    audioData = await getMediaFromIDB(btn.dataset.mediaId);
                    if (btn && audioData) btn._audioData = audioData; // –∫—ç—à–∏—Ä—É–µ–º
                } catch(e) {}
            }
            if (!audioData) {
                showNotification('–ê—É–¥–∏–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ', 'error');
                return;
            }

            if (currentPlayingAudio) {
                currentPlayingAudio.pause();
                currentPlayingAudio = null;
            }
            const audio = new Audio(audioData);
            currentPlayingAudio = audio;

            if (btn) { btn.innerHTML = '<i class="fas fa-pause"></i>'; btn.onclick = () => { audio.pause(); btn.innerHTML = '<i class="fas fa-play"></i>'; btn.onclick = () => playVoiceMessage(msgId); }; }

            audio.ontimeupdate = () => {
                if (durEl) {
                    const remaining = Math.max(0, Math.floor(audio.duration - audio.currentTime));
                    durEl.textContent = formatVoiceDuration(remaining);
                }
                if (waveEl) {
                    const pct = audio.duration ? audio.currentTime / audio.duration : 0;
                    const bars = waveEl.querySelectorAll('.voice-bar');
                    bars.forEach((b, i) => {
                        b.classList.toggle('played', i / bars.length <= pct);
                    });
                }
            };

            audio.onended = () => {
                currentPlayingAudio = null;
                if (btn) { btn.innerHTML = '<i class="fas fa-play"></i>'; btn.onclick = () => playVoiceMessage(msgId); }
                if (waveEl) waveEl.querySelectorAll('.voice-bar').forEach(b => b.classList.remove('played'));
                if (durEl) durEl.textContent = formatVoiceDuration(0);
            };

            audio.play().catch(() => showNotification('–û—à–∏–±–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è', 'error'));
        }

        function formatVoiceDuration(sec) {
            const m = Math.floor(sec / 60), s = sec % 60;
            return m + ':' + s.toString().padStart(2, '0');
        }

        function generateWaveformBars(duration) {
            const count = Math.min(40, Math.max(20, duration * 3));
            let html = '';
            for (let i = 0; i < count; i++) {
                const h = 6 + Math.random() * 22;
                html += `<div class="voice-bar" style="height:${h}px;"></div>`;
            }
            return html;
        }

        // ==================== –ß–Å–†–ù–´–ô –°–ü–ò–°–û–ö ====================

        function blockContact(contactId, contactName, contactAvatar) {
            if (isBlocked(contactId)) { showNotification('–£–∂–µ –≤ —á—ë—Ä–Ω–æ–º —Å–ø–∏—Å–∫–µ', 'warning'); return; }
            blacklist.push({ id: contactId, name: contactName, avatar: contactAvatar || 'üë§', blockedAt: Date.now() });
            saveBlacklist();
            showNotification(`${contactName} –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω`, 'success');
            logSecurityEvent('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω: ' + contactId, 'info');
            updateBlockedUI();
        }

        function unblockContact(contactId) {
            const bl = blacklist.find(b => b.id === contactId);
            blacklist = blacklist.filter(b => b.id !== contactId);
            saveBlacklist();
            showNotification(`${bl ? bl.name : contactId} —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω`, 'success');
            updateBlockedUI();
        }

        function unblockCurrentChat() {
            if (!currentChat) return;
            unblockContact(currentChat.id);
        }

        function toggleBlockCurrentChat() {
            if (!currentChat) return;
            if (isBlocked(currentChat.id)) {
                showConfirmAction(
                    'üîì –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å',
                    `–†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å ${currentChat.name}? –û–Ω —Å–Ω–æ–≤–∞ —Å–º–æ–∂–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –≤–∞–º —Å–æ–æ–±—â–µ–Ω–∏—è.`,
                    () => unblockContact(currentChat.id),
                    'var(--accent-green)',
                    '<i class="fas fa-unlock"></i> –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å'
                );
            } else {
                showConfirmAction(
                    'üö´ –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å',
                    `–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å ${currentChat.name}? –í—ã –Ω–µ –±—É–¥–µ—Ç–µ –ø–æ–ª—É—á–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.`,
                    () => blockContact(currentChat.id, currentChat.name, currentChat.avatar),
                    'var(--accent-red)',
                    '<i class="fas fa-ban"></i> –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å'
                );
            }
        }

        function updateBlockedUI() {
            if (!currentChat) return;
            const blocked = isBlocked(currentChat.id);
            const blockedBar = document.getElementById('blockedBar');
            const inputArea = document.getElementById('inputArea');
            const blockBtn = document.getElementById('blockUserBtn');

            if (blockedBar) blockedBar.style.display = blocked ? 'block' : 'none';
            if (inputArea) {
                const inputRow = inputArea.querySelector('.input-row');
                if (inputRow) inputRow.style.opacity = blocked ? '0.4' : '1';
                if (inputRow) inputRow.style.pointerEvents = blocked ? 'none' : '';
            }
            if (blockBtn) {
                blockBtn.style.color = blocked ? 'var(--accent-green)' : 'var(--accent-red)';
                blockBtn.title = blocked ? '–†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å' : '–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å';
                blockBtn.querySelector('i').className = blocked ? 'fas fa-unlock' : 'fas fa-ban';
            }
        }

        function blockUserById() {
            const input = document.getElementById('blockByIdInput');
            const id = (input.value || '').trim();
            if (!id) { showNotification('–í–≤–µ–¥–∏—Ç–µ ID', 'warning'); return; }
            const contact = contacts.find(c => c.id === id);
            const name = contact ? contact.name : id;
            blockContact(id, name, contact ? contact.avatar : 'üë§');
            input.value = '';
            renderBlacklistSettings();
        }

        function renderBlacklistSettings() {
            const container = document.getElementById('settingsBlacklistContainer');
            if (!container) return;
            if (blacklist.length === 0) {
                container.innerHTML = '<div style="text-align:center;padding:20px;color:var(--text-secondary);font-size:13px;">–ß—ë—Ä–Ω—ã–π —Å–ø–∏—Å–æ–∫ –ø—É—Å—Ç</div>';
                return;
            }
            container.innerHTML = blacklist.map(b => `
                <div class="blacklist-item">
                    <div class="chat-avatar" style="width:40px;height:40px;font-size:18px;">${escapeHtml(b.avatar)}</div>
                    <div class="blacklist-info">
                        <div class="blacklist-name">${escapeHtml(b.name)}</div>
                        <div class="blacklist-id">${escapeHtml(b.id)}</div>
                    </div>
                    <button class="btn-unblock" onclick="unblockContact('${escapeHtml(b.id)}');renderBlacklistSettings();">
                        <i class="fas fa-unlock"></i> –†–∞–∑–±–ª–æ–∫.
                    </button>
                </div>
            `).join('');
        }

        // ==================== –ö–û–ù–¢–ï–ö–°–¢–ù–û–ï –ú–ï–ù–Æ –ß–ê–¢–ê (–¥–æ–ø. –æ–ø—Ü–∏–∏) ====================
        function showChatOptionsMenu(e) {
            e.preventDefault();
            const existing = document.getElementById('chatOptionsMenu');
            if (existing) { existing.remove(); return; }

            const menu = document.createElement('div');
            menu.id = 'chatOptionsMenu';
            menu.className = 'msg-context-menu';
            const rect = e.target.closest('button').getBoundingClientRect();
            menu.style.right = (window.innerWidth - rect.right) + 'px';
            menu.style.top = (rect.bottom + 5) + 'px';
            menu.style.left = 'auto';

            const blocked = currentChat ? isBlocked(currentChat.id) : false;

            menu.innerHTML = `
                <div class="ctx-item" onclick="clearChatHistory()">
                    <i class="fas fa-broom"></i> –û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é
                </div>
                <div class="ctx-item" onclick="deleteChatFromList()">
                    <i class="fas fa-trash-alt"></i> –£–¥–∞–ª–∏—Ç—å —á–∞—Ç
                </div>
                <div class="ctx-separator"></div>
                <div class="ctx-item ${blocked ? '' : 'danger'}" onclick="toggleBlockCurrentChat()">
                    <i class="fas fa-${blocked ? 'unlock' : 'ban'}"></i> ${blocked ? '–†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å' : '–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å'}
                </div>
                <div class="ctx-item danger" onclick="deleteContactAndChat()">
                    <i class="fas fa-user-slash"></i> –£–¥–∞–ª–∏—Ç—å —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞
                </div>
            `;

            document.body.appendChild(menu);
            setTimeout(() => document.addEventListener('click', function _h(ev) {
                if (!menu.contains(ev.target)) { menu.remove(); document.removeEventListener('click', _h); }
            }), 50);
        }

        function clearChatHistory() {
            if (!currentChat) return;
            showConfirmAction(
                'üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é',
                `–£–¥–∞–ª–∏—Ç—å –≤—Å—é –∏—Å—Ç–æ—Ä–∏—é –ø–µ—Ä–µ–ø–∏—Å–∫–∏ —Å "${currentChat.name}"? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ.`,
                () => {
                    localStorage.removeItem('quantum_messages_' + currentChat.id);
                    currentChat.lastMessage = '';
                    saveToLocalStorage();
                    loadMessages(currentChat.id);
                    updateUI();
                    showNotification('–ò—Å—Ç–æ—Ä–∏—è —á–∞—Ç–∞ –æ—á–∏—â–µ–Ω–∞', 'success');
                },
                'var(--accent-red)',
                '<i class="fas fa-trash"></i> –û—á–∏—Å—Ç–∏—Ç—å'
            );
            const m = document.getElementById('chatOptionsMenu');
            if (m) m.remove();
        }

        function deleteChatFromList() {
            if (!currentChat) return;
            showConfirmAction(
                'üóëÔ∏è –£–¥–∞–ª–∏—Ç—å —á–∞—Ç',
                `–£–¥–∞–ª–∏—Ç—å —á–∞—Ç —Å "${currentChat.name}"? –ò—Å—Ç–æ—Ä–∏—è –ø–µ—Ä–µ–ø–∏—Å–∫–∏ –±—É–¥–µ—Ç —Å—Ç—ë—Ä—Ç–∞.`,
                () => {
                    localStorage.removeItem('quantum_messages_' + currentChat.id);
                    chats = chats.filter(c => c.id !== currentChat.id);
                    currentChat = null;
                    saveToLocalStorage();
                    document.getElementById('inputArea').style.display = 'none';
                    document.getElementById('messagesArea').innerHTML = `
                        <div style="text-align:center;padding:80px 20px;color:var(--text-secondary);">
                            <div style="font-size:80px;margin-bottom:20px;">‚öõ</div>
                            <h2 style="background:linear-gradient(45deg,#fff,var(--accent-color));-webkit-background-clip:text;-webkit-text-fill-color:transparent;">Quantum Secure</h2>
                            <p>–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç –∏–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π</p>
                        </div>`;
                    updateUI();
                    showNotification('–ß–∞—Ç —É–¥–∞–ª—ë–Ω', 'success');
                },
                'var(--accent-red)',
                '<i class="fas fa-trash"></i> –£–¥–∞–ª–∏—Ç—å —á–∞—Ç'
            );
            const m = document.getElementById('chatOptionsMenu');
            if (m) m.remove();
        }

        function deleteContactAndChat() {
            if (!currentChat) return;
            showConfirmAction(
                '‚ùå –£–¥–∞–ª–∏—Ç—å —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞',
                `–£–¥–∞–ª–∏—Ç—å "${currentChat.name}" –∏–∑ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤? –ß–∞—Ç –∏ –≤—Å—è –∏—Å—Ç–æ—Ä–∏—è —Ç–∞–∫–∂–µ –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã.`,
                () => {
                    const chatId = currentChat.id;
                    localStorage.removeItem('quantum_messages_' + chatId);
                    chats = chats.filter(c => c.id !== chatId);
                    const idx = contacts.findIndex(c => c.id === chatId);
                    if (idx !== -1) contacts.splice(idx, 1);
                    currentUser.friends = currentUser.friends.filter(f => f !== chatId);
                    currentChat = null;
                    saveToLocalStorage();
                    document.getElementById('inputArea').style.display = 'none';
                    document.getElementById('messagesArea').innerHTML = `
                        <div style="text-align:center;padding:80px 20px;color:var(--text-secondary);">
                            <div style="font-size:80px;margin-bottom:20px;">‚öõ</div>
                            <h2 style="background:linear-gradient(45deg,#fff,var(--accent-color));-webkit-background-clip:text;-webkit-text-fill-color:transparent;">Quantum Secure</h2>
                            <p>–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç –∏–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π</p>
                        </div>`;
                    updateUI();
                    showNotification('–°–æ–±–µ—Å–µ–¥–Ω–∏–∫ —É–¥–∞–ª—ë–Ω', 'success');
                },
                'var(--accent-red)',
                '<i class="fas fa-user-slash"></i> –£–¥–∞–ª–∏—Ç—å'
            );
            const m = document.getElementById('chatOptionsMenu');
            if (m) m.remove();
        }

        // ==================== –ú–û–î–ê–õ –ü–û–î–¢–í–ï–†–ñ–î–ï–ù–ò–Ø ====================
        function showConfirmAction(title, text, callback, color, btnHtml) {
            document.getElementById('confirmActionTitle').textContent = title;
            document.getElementById('confirmActionText').textContent = text;
            const btn = document.getElementById('confirmActionBtn');
            btn.style.background = color || 'var(--accent-red)';
            btn.style.color = 'white';
            btn.innerHTML = btnHtml || '–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å';
            btn.onclick = () => {
                callback();
                closeModal('confirmActionModal');
            };
            document.getElementById('confirmActionModal').style.display = 'flex';
        }

        // ==================== –£–õ–£–ß–®–ï–ù–ù–´–ô –í–ò–î–ï–û–ó–í–û–ù–û–ö ====================
        async function startVideoCallWithCamera() {
            try {
                const constraints = {
                    video: { facingMode: videoFrontCamera ? 'user' : 'environment', width: {ideal: 1280}, height: {ideal: 720} },
                    audio: true
                };
                const stream = await navigator.mediaDevices.getUserMedia(constraints);
                videoLocalStream = stream;
                const localVideo = document.getElementById('localVideo');
                const localNoCam = document.getElementById('localNoCam');
                const wrapper = document.getElementById('localVideoWrapper');
                if (localVideo) {
                    localVideo.srcObject = stream;
                    localVideo.style.display = 'block';
                    localVideo.style.objectFit = 'cover';
                    localVideo.style.height = '120px';
                }
                if (localNoCam) localNoCam.style.display = 'none';
                if (wrapper) {
                    wrapper.classList.remove('source-screen','source-none','source-front');
                    wrapper.classList.add('source-camera');
                }
                callData.localStream = stream;
                callData.isCameraEnabled = true;
                callData.isMicEnabled = true;
                showNotification('–ö–∞–º–µ—Ä–∞ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞ ‚úÖ', 'success');
                logSecurityEvent('–í–∏–¥–µ–æ–∑–≤–æ–Ω–æ–∫: –∫–∞–º–µ—Ä–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∞', 'info');
                return stream;
            } catch(e) {
                showNotification('–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ. –ó–≤–æ–Ω–æ–∫ –±–µ–∑ –≤–∏–¥–µ–æ.', 'warning');
                logSecurityEvent('–í–∏–¥–µ–æ–∑–≤–æ–Ω–æ–∫: –æ—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ', 'warning');
                return null;
            }
        }

        function startVideoCallTimer() {
            videoCallSeconds = 0;
            clearInterval(videoCallTimer);
            videoCallTimer = setInterval(() => {
                videoCallSeconds++;
                const el = document.getElementById('videoCallTimer');
                if (el) {
                    const m = Math.floor(videoCallSeconds / 60), s = videoCallSeconds % 60;
                    el.textContent = m.toString().padStart(2,'0') + ':' + s.toString().padStart(2,'0');
                }
            }, 1000);
        }

        function stopVideoCallTimer() {
            clearInterval(videoCallTimer);
            videoCallSeconds = 0;
        }

        // ===== VIDEO SOURCE MANAGEMENT =====
        // currentVideoSource: 'camera' | 'front' | 'screen' | 'none'
        let currentVideoSource = 'camera';

        function toggleSourcePicker() {
            const picker = document.getElementById('videoSourcePicker');
            const srcBtn = document.getElementById('srcBtn');
            if (!picker) return;
            const open = picker.classList.toggle('open');
            if (srcBtn) srcBtn.style.background = open ? 'rgba(0,212,255,0.25)' : 'rgba(255,255,255,0.1)';
        }

        function closeSourcePicker() {
            const picker = document.getElementById('videoSourcePicker');
            const srcBtn = document.getElementById('srcBtn');
            if (picker) picker.classList.remove('open');
            if (srcBtn) srcBtn.style.background = 'rgba(255,255,255,0.1)';
        }

        // ===== VIDEO SWAP: –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–µ–∂–¥—É –≥–ª–∞–≤–Ω—ã–º/–º–∏–Ω–∏ –≤–∏–¥–µ–æ =====
        let videoSwapped = false; // false = local –º–∏–Ω–∏, remote –ø–æ–ª–Ω—ã–π | true = local –ø–æ–ª–Ω—ã–π, remote –º–∏–Ω–∏

        function swapVideos(e) {
            if (e) e.stopPropagation();
            const localWrapper = document.getElementById('localVideoWrapper');
            const remoteArea   = document.getElementById('remoteVideoArea');
            const swapBtn      = localWrapper?.querySelector('.swap-btn');
            const localVideo   = document.getElementById('localVideo');

            if (!videoSwapped) {
                // –†–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–µ–º –ª–æ–∫–∞–ª—å–Ω–æ–µ –≤–∏–¥–µ–æ –Ω–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω
                localWrapper.classList.add('fullscreen-local');
                remoteArea.classList.add('minimized-remote');
                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø–æ–∑–∏—Ü–∏—é –æ—Ç –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è
                localWrapper.style.cursor = 'default';
                localWrapper.style.left = '';
                localWrapper.style.top = '';
                localWrapper.style.right = '';
                localWrapper.style.bottom = '';
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π object-fit –¥–ª—è fullscreen
                if (localVideo) {
                    localVideo.style.height = '100%';
                    localVideo.style.maxHeight = 'none';
                    // –≠–∫—Ä–∞–Ω ‚Äî contain, –∫–∞–º–µ—Ä–∞ ‚Äî cover
                    const isScreen = currentVideoSource === 'screen';
                    localVideo.style.objectFit = isScreen ? 'contain' : 'cover';
                }
                if (swapBtn) {
                    swapBtn.title = '–í–µ—Ä–Ω—É—Ç—å –æ–±—Ä–∞—Ç–Ω–æ';
                    swapBtn.innerHTML = '<i class="fas fa-compress-arrows-alt"></i>';
                }
                videoSwapped = true;
                showNotification('üìπ –í–∞—à–∞ –∫–∞–º–µ—Ä–∞ –Ω–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω. –ù–∞–∂–º–∏ ‚Üï —á—Ç–æ–±—ã –≤–µ—Ä–Ω—É—Ç—å', 'info');
            } else {
                unswapVideos();
            }
        }

        function unswapVideos() {
            const localWrapper = document.getElementById('localVideoWrapper');
            const remoteArea   = document.getElementById('remoteVideoArea');
            const swapBtn      = localWrapper?.querySelector('.swap-btn');
            const localVideo   = document.getElementById('localVideo');

            localWrapper.classList.remove('fullscreen-local');
            remoteArea.classList.remove('minimized-remote');
            localWrapper.style.cursor = 'move';
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä—ã –º–∏–Ω–∏-–æ–∫–Ω–∞
            if (localVideo) {
                const isScreen = currentVideoSource === 'screen';
                if (isScreen) {
                    localVideo.style.objectFit = 'contain';
                    localVideo.style.height = 'auto';
                    localVideo.style.maxHeight = '200px';
                } else {
                    localVideo.style.objectFit = 'cover';
                    localVideo.style.height = '120px';
                    localVideo.style.maxHeight = '';
                }
            }
            if (swapBtn) {
                swapBtn.title = '–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å –Ω–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω';
                swapBtn.innerHTML = '<i class="fas fa-expand-arrows-alt"></i>';
            }
            videoSwapped = false;
        }

        function handleRemoteAreaClick() {
            // –ö–ª–∏–∫ –ø–æ –º–∏–Ω–∏-–æ–∫–Ω—É remote –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ–±—Ä–∞—Ç–Ω–æ
            if (videoSwapped) unswapVideos();
        }

        async function setVideoSource(source) {
            closeSourcePicker();
            currentVideoSource = source;

            // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—É—â–∏–π —Å—Ç—Ä–∏–º
            const stopStream = (s) => { if (s) s.getTracks().forEach(t => t.stop()); };
            stopStream(videoLocalStream);
            videoLocalStream = null;

            const localVideo = document.getElementById('localVideo');
            const localNoCam = document.getElementById('localNoCam');
            const badge = document.getElementById('videoSourceBadge');
            const wrapper = document.getElementById('localVideoWrapper');
            const camBtn = document.getElementById('camBtn');

            // –°–±—Ä–æ—Å –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å—Ç–∏–ª–µ–π –Ω–∞ –ø–∏–∫–µ—Ä–µ
            ['vsp-camera','vsp-front','vsp-screen','vsp-none'].forEach(id => {
                const el = document.getElementById(id);
                if (el) { el.classList.remove('active', 'green'); }
            });

            if (source === 'camera' || source === 'front') {
                const facing = source === 'front' ? 'user' : 'environment';
                videoFrontCamera = (facing === 'user');
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({
                        video: { facingMode: facing, width: {ideal: 1280}, height: {ideal: 720} },
                        audio: videoMicEnabled
                    });
                    videoLocalStream = stream;
                    callData.localStream = stream;
                    if (localVideo) {
                        localVideo.srcObject = stream;
                        localVideo.style.display = 'block';
                        localVideo.style.objectFit = 'cover'; // –∫–∞–º–µ—Ä–∞ ‚Äî cover
                        localVideo.style.height = '120px';
                    }
                    if (localNoCam) localNoCam.style.display = 'none';
                    if (wrapper) {
                        wrapper.classList.remove('source-screen','source-none','source-camera','source-front');
                        wrapper.classList.add(source === 'front' ? 'source-front' : 'source-camera');
                    }
                    videoCameraEnabled = true;
                    if (camBtn) { camBtn.classList.remove('cam-off'); camBtn.querySelector('i').className = 'fas fa-video'; }
                    if (badge) { badge.className = 'video-source-badge vsb-camera'; badge.textContent = source === 'front' ? 'ü§≥ –§–†–û–ù–¢. –ö–ê–ú–ï–†–ê' : 'üì∑ –ö–ê–ú–ï–†–ê'; }
                    const activeEl = document.getElementById(source === 'front' ? 'vsp-front' : 'vsp-camera');
                    if (activeEl) activeEl.classList.add('active', 'green');
                    showNotification(source === 'front' ? 'ü§≥ –§—Ä–æ–Ω—Ç–∞–ª—å–Ω–∞—è –∫–∞–º–µ—Ä–∞' : 'üì∑ –û—Å–Ω–æ–≤–Ω–∞—è –∫–∞–º–µ—Ä–∞', 'success');
                } catch(e) {
                    showNotification('‚ùå –ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ', 'error');
                    setVideoSource('none');
                }
            } else if (source === 'screen') {
                try {
                    const stream = await navigator.mediaDevices.getDisplayMedia({
                        video: { cursor: 'always', width: { ideal: 1920 }, height: { ideal: 1080 } },
                        audio: false
                    });
                    videoLocalStream = stream;
                    callData.localStream = stream;
                    if (localVideo) {
                        localVideo.srcObject = stream;
                        localVideo.style.display = 'block';
                        localVideo.style.objectFit = 'contain'; // —ç–∫—Ä–∞–Ω ‚Äî contain, –±–µ–∑ –æ–±—Ä–µ–∑–∫–∏
                        localVideo.style.height = 'auto';
                        localVideo.style.maxHeight = '200px';
                    }
                    if (localNoCam) localNoCam.style.display = 'none';
                    if (wrapper) {
                        wrapper.classList.remove('source-none','source-camera','source-front');
                        wrapper.classList.add('source-screen');
                    }
                    videoCameraEnabled = true;
                    if (camBtn) { camBtn.classList.remove('cam-off'); camBtn.querySelector('i').className = 'fas fa-video'; }
                    if (badge) { badge.className = 'video-source-badge vsb-screen'; badge.textContent = 'üñ•Ô∏è –≠–ö–†–ê–ù'; }
                    const activeEl = document.getElementById('vsp-screen');
                    if (activeEl) activeEl.classList.add('active');
                    // –ê–≤—Ç–æ-–≤—ã–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ —ç–∫—Ä–∞–Ω–∞
                    stream.getVideoTracks()[0].onended = () => {
                        showNotification('üñ•Ô∏è –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è —ç–∫—Ä–∞–Ω–∞ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞', 'info');
                        setVideoSource('none');
                    };
                    showNotification('üñ•Ô∏è –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è —ç–∫—Ä–∞–Ω–∞ –∞–∫—Ç–∏–≤–Ω–∞', 'success');
                } catch(e) {
                    if (e.name !== 'NotAllowedError') showNotification('‚ùå –ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —ç–∫—Ä–∞–Ω—É', 'error');
                    else showNotification('–û—Ç–º–µ–Ω–µ–Ω–æ', 'info');
                    currentVideoSource = 'none';
                    setVideoSource('none');
                }
            } else { // 'none'
                if (localVideo) { localVideo.srcObject = null; localVideo.style.display = 'none'; localVideo.style.height = 'auto'; localVideo.style.maxHeight = ''; }
                if (localNoCam) { localNoCam.style.display = 'flex'; }
                if (wrapper) {
                    wrapper.classList.remove('source-screen','source-camera','source-front');
                    wrapper.classList.add('source-none');
                }
                videoCameraEnabled = false;
                if (camBtn) { camBtn.classList.add('cam-off'); camBtn.querySelector('i').className = 'fas fa-video-slash'; }
                if (badge) { badge.className = 'video-source-badge vsb-none'; badge.textContent = 'üö´ –ë–ï–ó –í–ò–î–ï–û'; }
                const activeEl = document.getElementById('vsp-none');
                if (activeEl) activeEl.classList.add('active');
                showNotification('üìµ –í–∏–¥–µ–æ –æ—Ç–∫–ª—é—á–µ–Ω–æ', 'info');
            }
        }

        // Patch startVideoCall to use camera
        const _origStartVideoCall = typeof startVideoCall === 'function' ? startVideoCall : null;

        async function startVideoCall() {
            if (document.getElementById("callNotifications")?.checked) soundCall();
            if (!currentChat) { showNotification('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç', 'warning'); return; }

            const nameEl = document.getElementById('videoCallName');
            const remNameEl = document.getElementById('remoteVideoName');
            const remAvatarEl = document.getElementById('remoteAvatar');
            if (nameEl) nameEl.textContent = currentChat.name;
            if (remNameEl) remNameEl.textContent = currentChat.name;
            if (remAvatarEl) remAvatarEl.textContent = currentChat.avatar || 'üë§';

            const videoContainer = document.getElementById('videoContainer');
            videoContainer.style.display = 'flex';
            document.getElementById('callScreen').style.display = 'none';

            // –°–±—Ä–æ—Å —Å–æ—Å—Ç–æ—è–Ω–∏—è
            currentVideoSource = 'camera';
            videoCameraEnabled = true;
            videoMicEnabled = true;
            videoFrontCamera = true;
            videoSwapped = false;
            closeSourcePicker();

            // –°–±—Ä–æ—Å –∫–Ω–æ–ø–æ–∫
            const camBtn = document.getElementById('camBtn');
            const micBtn = document.getElementById('micBtn');
            if (camBtn) { camBtn.classList.remove('cam-off'); camBtn.querySelector('i').className = 'fas fa-video'; }
            if (micBtn) { micBtn.querySelector('i').className = 'fas fa-microphone'; }

            startVideoCallTimer();
            await startVideoCallWithCamera();

            showNotification('üìπ –í–∏–¥–µ–æ–∑–≤–æ–Ω–æ–∫: ' + currentChat.name, 'info');
            logSecurityEvent('–ù–∞—á–∞—Ç –≤–∏–¥–µ–æ–∑–≤–æ–Ω–æ–∫ —Å ' + currentChat.id, 'info');
        }

        function endVideoCall() {
            stopVideoCallTimer();
            closeSourcePicker();
            if (videoSwapped) unswapVideos(); // —Å–±—Ä–æ—Å swap –ø–µ—Ä–µ–¥ –∑–∞–∫—Ä—ã—Ç–∏–µ–º

            if (videoLocalStream) { videoLocalStream.getTracks().forEach(t => t.stop()); videoLocalStream = null; }
            if (callData.localStream) { callData.localStream.getTracks().forEach(t => t.stop()); callData.localStream = null; }

            const localVideo = document.getElementById('localVideo');
            const localNoCam = document.getElementById('localNoCam');
            const wrapper = document.getElementById('localVideoWrapper');
            if (localVideo) { localVideo.srcObject = null; localVideo.style.display = 'none'; }
            if (localNoCam) localNoCam.style.display = 'flex';
            if (wrapper) { wrapper.classList.remove('source-screen','source-none'); }

            document.getElementById('videoContainer').style.display = 'none';
            videoCallSeconds = 0;
            videoCameraEnabled = true;
            videoMicEnabled = true;
            currentVideoSource = 'camera';

            const timerEl = document.getElementById('videoCallTimer');
            if (timerEl) timerEl.textContent = '00:00';

            showNotification('üìû –í–∏–¥–µ–æ–∑–≤–æ–Ω–æ–∫ –∑–∞–≤–µ—Ä—à—ë–Ω', 'info');
            logSecurityEvent('–í–∏–¥–µ–æ–∑–≤–æ–Ω–æ–∫ –∑–∞–≤–µ—Ä—à—ë–Ω', 'info');
        }

        function toggleCamera() {
            // –ï—Å–ª–∏ –∏—Å—Ç–æ—á–Ω–∏–∫ ‚Äî "none", –ø—Ä–µ–¥–ª–∞–≥–∞–µ–º –≤–∫–ª—é—á–∏—Ç—å –∫–∞–º–µ—Ä—É
            if (!videoCameraEnabled || currentVideoSource === 'none') {
                setVideoSource('camera');
                return;
            }
            // –ò–Ω–∞—á–µ ‚Äî –æ—Ç–∫–ª—é—á–∞–µ–º –≤–∏–¥–µ–æ
            setVideoSource('none');
        }

        function toggleMic() {
            videoMicEnabled = !videoMicEnabled;
            const btn = document.getElementById('micBtn');

            if (videoLocalStream) videoLocalStream.getAudioTracks().forEach(t => { t.enabled = videoMicEnabled; });
            if (callData.localStream) callData.localStream.getAudioTracks().forEach(t => { t.enabled = videoMicEnabled; });

            if (btn) {
                btn.style.background = videoMicEnabled ? '' : 'rgba(255,59,92,0.3)';
                btn.querySelector('i').className = videoMicEnabled ? 'fas fa-microphone' : 'fas fa-microphone-slash';
            }
            showNotification(videoMicEnabled ? 'üé§ –ú–∏–∫—Ä–æ—Ñ–æ–Ω –≤–∫–ª—é—á—ë–Ω' : 'üîá –ú–∏–∫—Ä–æ—Ñ–æ–Ω –≤—ã–∫–ª—é—á–µ–Ω', 'info');
        }

        async function flipVideoCallCamera() {
            if (currentVideoSource === 'screen' || currentVideoSource === 'none') {
                showNotification('–ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ –¥–ª—è –∫–∞–º–µ—Ä—ã', 'warning');
                return;
            }
            videoFrontCamera = !videoFrontCamera;
            await setVideoSource(videoFrontCamera ? 'front' : 'camera');
        }

        // ==================== –†–ï–ù–î–ï–† –ì–û–õ–û–°–û–í–û–ì–û –°–û–û–ë–©–ï–ù–ò–Ø –í loadMessages ====================
        // Patch voice message rendering - call after page loads
        function renderVoiceMsg(msg, isMine) {
            const dur = msg.duration || 1;
            const waveId = 'vwv_' + msg.id;
            const btnId = 'vpb_' + msg.id;
            const durId = 'vdur_' + msg.id;
            return `
                <div class="voice-message-bubble">
                    <button class="voice-play-btn" id="${btnId}" onclick="playVoiceMessage(${msg.id})" data-media-id="${msg.mediaId || ''}">
                        <i class="fas fa-play"></i>
                    </button>
                    <div class="voice-waveform" id="${waveId}">
                        ${generateWaveformBars(dur)}
                    </div>
                    <span class="voice-duration" id="${durId}">${formatVoiceDuration(dur)}</span>
                </div>
            `;
        }

        // Voice messages are rendered inline in loadMessages function

        // openChat and switchSettingsTab patched directly in their original functions

        // Init
        // blacklist loaded at script start

        // Draggable local video
        (function() {
            const wrapper = document.getElementById('localVideoWrapper');
            if (!wrapper) return;
            let dragging = false, ox = 0, oy = 0;
            wrapper.addEventListener('mousedown', e => {
                if (videoSwapped) return; // –Ω–µ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–µ–º –≤ –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω–æ–º —Ä–µ–∂–∏–º–µ
                if (e.target.closest('.swap-btn')) return; // –∫–ª–∏–∫ –ø–æ –∫–Ω–æ–ø–∫–µ ‚Äî –Ω–µ –¥—Ä–∞–≥
                dragging = true;
                ox = e.clientX - wrapper.offsetLeft;
                oy = e.clientY - wrapper.offsetTop;
                wrapper.style.cursor = 'grabbing';
            });
            document.addEventListener('mousemove', e => {
                if (!dragging || videoSwapped) return;
                let nx = e.clientX - ox, ny = e.clientY - oy;
                nx = Math.max(0, Math.min(window.innerWidth - wrapper.offsetWidth, nx));
                ny = Math.max(0, Math.min(window.innerHeight - wrapper.offsetHeight, ny));
                wrapper.style.right = 'auto';
                wrapper.style.bottom = 'auto';
                wrapper.style.left = nx + 'px';
                wrapper.style.top = ny + 'px';
            });
            document.addEventListener('mouseup', () => { dragging = false; if (!videoSwapped) wrapper.style.cursor = 'move'; });
        })();

        // –ó–∞–∫—Ä—ã–≤–∞—Ç—å –ø–∞–Ω–µ–ª—å –∏—Å—Ç–æ—á–Ω–∏–∫–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –Ω–µ—ë
        document.getElementById('videoContainer')?.addEventListener('click', function(e) {
            const picker = document.getElementById('videoSourcePicker');
            const srcBtn = document.getElementById('srcBtn');
            if (picker && picker.classList.contains('open')) {
                if (!picker.contains(e.target) && e.target !== srcBtn && !srcBtn?.contains(e.target)) {
                    closeSourcePicker();
                }
            }
        });


        // ===== –ü–†–û–°–¢–ê–Ø –ó–í–£–ö–û–í–ê–Ø –°–ò–°–¢–ï–ú–ê =====
        function beep(frequency, duration) {
            try {
                const ctx = new (window.AudioContext || window.webkitAudioContext)();
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                
                osc.connect(gain);
                gain.connect(ctx.destination);
                
                osc.frequency.value = frequency;
                osc.type = 'sine';
                
                gain.gain.setValueAtTime(0.3, ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + duration);
                
                osc.start(ctx.currentTime);
                osc.stop(ctx.currentTime + duration);
            } catch (e) {
                console.log('–ó–≤—É–∫ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω');
            }
        }

        // –ó–≤—É–∫ —Å–æ–æ–±—â–µ–Ω–∏—è
        window.soundMessage = function() {
            beep(800, 0.1);
        };

        // –ó–≤—É–∫ –∑–≤–æ–Ω–∫–∞
        window.soundCall = function() {
            beep(400, 0.3);
        };

        // –ó–≤—É–∫ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
        window.soundNotif = function() {
            beep(600, 0.15);
        };


        // ===== –¢–ï–°–¢–û–í–´–ï –§–£–ù–ö–¶–ò–ò =====
        window.testMessageSound = function() {
            soundMessage();
            showNotification('üîî –¢–µ—Å—Ç –∑–≤—É–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è', 'info');
        };

        window.testCallSound = function() {
            soundCall();
            showNotification('üìû –¢–µ—Å—Ç –∑–≤—É–∫–∞ –∑–≤–æ–Ω–∫–∞', 'info');
        };

        window.receiveTestMessage = function() {
            if (!currentChat) {
                showNotification('‚ö†Ô∏è –°–Ω–∞—á–∞–ª–∞ –æ—Ç–∫—Ä–æ–π—Ç–µ —á–∞—Ç', 'warning');
                return;
            }
            
            const msg = {
                id: Date.now(),
                sender: currentChat.id,
                text: '–ü—Ä–∏–≤–µ—Ç! –≠—Ç–æ —Ç–µ—Å—Ç–æ–≤–æ–µ –≤—Ö–æ–¥—è—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ üëã',
                time: new Date().toLocaleTimeString('ru-RU', {hour: '2-digit', minute: '2-digit'}),
                type: 'text'
            };
            
            if (!messages[currentChat.id]) messages[currentChat.id] = [];
            messages[currentChat.id].push(msg);
            saveMessages();
            
            currentChat.lastMessage = msg.text;
            currentChat.time = msg.time;
            currentChat.unread = (currentChat.unread || 0) + 1;
            saveChats();
            
            loadMessages(currentChat.id);
            renderChats();
            
            // –ó–≤—É–∫ –≤—Ö–æ–¥—è—â–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
            if (document.getElementById('soundNotifications')?.checked) {
                soundMessage();
            }
            showNotification('üì® –ü–æ–ª—É—á–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç ' + currentChat.name, 'success');
        };

        window.receiveTestCall = function() {
            if (!currentChat) {
                showNotification('‚ö†Ô∏è –°–Ω–∞—á–∞–ª–∞ –æ—Ç–∫—Ä–æ–π—Ç–µ —á–∞—Ç', 'warning');
                return;
            }
            
            document.getElementById('callScreen').classList.add('active');
            document.getElementById('callAvatar').textContent = currentChat.avatar;
            document.getElementById('callName').textContent = currentChat.name;
            document.getElementById('callStatus').textContent = '–í—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫...';
            document.getElementById('answerBtn').style.display = 'flex';
            document.getElementById('muteBtn').style.display = 'none';
            document.getElementById('callTimer').style.display = 'none';
            
            // –ó–≤—É–∫ –≤—Ö–æ–¥—è—â–µ–≥–æ –∑–≤–æ–Ω–∫–∞
            if (document.getElementById('callNotifications')?.checked) {
                soundCall();
            }
            showNotification('üìû –í—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫ –æ—Ç ' + currentChat.name, 'info');
        };


        // ===== –ò–ù–§–û–†–ú–ê–¶–ò–Ø –û –ß–ê–¢–ï =====
        window.showChatInfo = function() {
            if (!currentChat) return;
            
            const content = document.getElementById('chatInfoContent');
            if (!content) return;
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ messages
            if (typeof messages === 'undefined') {
                window.messages = {};
            }
            
            let html = '';
            
            if (currentChat.type === 'group') {
                html += '<div style="margin-bottom: 20px;">';
                html += '<div style="text-align: center; margin-bottom: 20px;">';
                html += '<div style="width: 80px; height: 80px; margin: 0 auto; background: var(--gradient-primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 32px; color: white; font-weight: 600;">';
                html += currentChat.avatar;
                html += '</div></div>';
                
                html += '<h3 style="color: var(--text-primary); margin-bottom: 20px; text-align: center;">' + currentChat.name + '</h3>';
                
                if (currentChat.description) {
                    html += '<div style="background: var(--glass-bg); padding: 15px; border-radius: 10px; margin-bottom: 15px; border: 1px solid var(--glass-border);">';
                    html += '<div style="color: var(--text-secondary); font-size: 12px; margin-bottom: 5px;">–û–ü–ò–°–ê–ù–ò–ï</div>';
                    html += '<div style="color: var(--text-primary);">' + currentChat.description + '</div>';
                    html += '</div>';
                }
                
                html += '<div style="background: var(--glass-bg); padding: 15px; border-radius: 10px; margin-bottom: 15px; border: 1px solid var(--glass-border);">';
                html += '<div style="color: var(--text-secondary); font-size: 12px; margin-bottom: 5px;">ID –ì–†–£–ü–ü–´</div>';
                html += '<div style="color: var(--text-primary); font-family: monospace; font-size: 13px;">' + currentChat.id + '</div>';
                html += '</div>';
                
                html += '<div style="background: var(--glass-bg); padding: 15px; border-radius: 10px; margin-bottom: 15px; border: 1px solid var(--glass-border);">';
                html += '<div style="color: var(--text-secondary); font-size: 12px; margin-bottom: 5px;">–°–û–ó–î–ê–ù–ê</div>';
                html += '<div style="color: var(--text-primary);">' + (currentChat.created || new Date().toLocaleDateString('ru-RU')) + '</div>';
                html += '</div>';
                
                html += '<div style="background: var(--glass-bg); padding: 15px; border-radius: 10px; margin-bottom: 20px; border: 1px solid var(--glass-border);">';
                html += '<div style="color: var(--text-secondary); font-size: 12px; margin-bottom: 5px;">–£–ß–ê–°–¢–ù–ò–ö–ò</div>';
                html += '<div style="color: var(--text-primary);">' + (currentChat.members ? currentChat.members.length : 0) + ' —á–µ–ª–æ–≤–µ–∫</div>';
                html += '</div>';
                
                if (currentChat.members && currentChat.members.length > 0) {
                    html += '<h4 style="color: var(--text-primary); margin-bottom: 10px;">üë• –°–ø–∏—Å–æ–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤:</h4>';
                    currentChat.members.forEach(function(memberId) {
                        var isOwner = memberId === currentChat.owner;
                        var name = memberId === currentUser.id ? currentUser.name : '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ' + memberId;
                        html += '<div style="display: flex; align-items: center; gap: 10px; padding: 10px; background: var(--glass-bg); border-radius: 8px; margin-bottom: 8px; border: 1px solid var(--glass-border);">';
                        html += '<div style="width: 32px; height: 32px; background: var(--gradient-primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 14px;">';
                        html += name[0].toUpperCase();
                        html += '</div>';
                        html += '<div style="flex: 1;">';
                        html += '<div style="color: var(--text-primary); font-size: 14px; font-weight: 500;">' + name;
                        if (isOwner) {
                            html += ' <span style="background: var(--accent-yellow); color: #000; padding: 2px 6px; border-radius: 6px; font-size: 10px; font-weight: 700; margin-left: 5px;">–í–õ–ê–î–ï–õ–ï–¶</span>';
                        }
                        html += '</div></div></div>';
                    });
                }
                html += '</div>';
                
            } else {
                html += '<div style="margin-bottom: 20px;">';
                html += '<div style="text-align: center; margin-bottom: 20px;">';
                html += '<div style="width: 80px; height: 80px; margin: 0 auto; background: var(--gradient-primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 32px; color: white; font-weight: 600;">';
                html += currentChat.avatar;
                html += '</div></div>';
                
                html += '<h3 style="color: var(--text-primary); margin-bottom: 20px; text-align: center;">' + currentChat.name + '</h3>';
                
                html += '<div style="background: var(--glass-bg); padding: 15px; border-radius: 10px; margin-bottom: 15px; border: 1px solid var(--glass-border);">';
                html += '<div style="color: var(--text-secondary); font-size: 12px; margin-bottom: 5px;">ID –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø</div>';
                html += '<div style="color: var(--text-primary); font-family: monospace; font-size: 13px;">' + currentChat.id + '</div>';
                html += '</div>';
                
                html += '<div style="background: var(--glass-bg); padding: 15px; border-radius: 10px; margin-bottom: 15px; border: 1px solid var(--glass-border);">';
                html += '<div style="color: var(--text-secondary); font-size: 12px; margin-bottom: 5px;">–ß–ê–¢ –°–û–ó–î–ê–ù</div>';
                html += '<div style="color: var(--text-primary);">' + (currentChat.created || new Date().toLocaleDateString('ru-RU')) + '</div>';
                html += '</div>';
                
                html += '<div style="background: var(--glass-bg); padding: 15px; border-radius: 10px; margin-bottom: 15px; border: 1px solid var(--glass-border);">';
                html += '<div style="color: var(--text-secondary); font-size: 12px; margin-bottom: 5px;">–°–¢–ê–¢–£–°</div>';
                var statusColor = currentChat.online ? 'var(--accent-green)' : 'var(--text-secondary)';
                var statusText = currentChat.online ? 'üü¢ –í —Å–µ—Ç–∏' : '‚ö´ –ù–µ –≤ —Å–µ—Ç–∏';
                html += '<div style="color: ' + statusColor + ';">' + statusText + '</div>';
                html += '</div>';
                
                var msgCount = messages[currentChat.id] ? messages[currentChat.id].length : 0;
                html += '<div style="background: var(--glass-bg); padding: 15px; border-radius: 10px; border: 1px solid var(--glass-border);">';
                html += '<div style="color: var(--text-secondary); font-size: 12px; margin-bottom: 5px;">–°–û–û–ë–©–ï–ù–ò–ô</div>';
                html += '<div style="color: var(--text-primary);">' + msgCount + '</div>';
                html += '</div>';
                html += '</div>';
            }
            
            content.innerHTML = html;
            openModal('chatInfoModal');
        };
        window.viewGroupMembers = function() {
            if (!currentChat || currentChat.type !== 'group') return;
            
            const content = document.getElementById('membersListContent');
            if (!content) return;
            
            const isOwner = currentChat.owner === currentUser.id;
            let html = '';
            
            if (currentChat.members && currentChat.members.length > 0) {
                currentChat.members.forEach(memberId => {
                    const isMemberOwner = memberId === currentChat.owner;
                    const name = memberId === currentUser.id ? currentUser.name : '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ' + memberId;
                    
                    html += '<div style="display: flex; align-items: center; gap: 10px; padding: 12px; background: var(--glass-bg); border-radius: 10px; margin-bottom: 10px; border: 1px solid var(--glass-border);">';
                    html += '<div style="width: 36px; height: 36px; background: var(--gradient-primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 16px;">';
                    html += name[0].toUpperCase();
                    html += '</div>';
                    html += '<div style="flex: 1;">';
                    html += '<div style="color: var(--text-primary); font-size: 15px; font-weight: 500;">' + name;
                    if (isMemberOwner) {
                        html += ' <span style="background: var(--accent-yellow); color: #000; padding: 3px 8px; border-radius: 8px; font-size: 10px; font-weight: 700; margin-left: 5px;">–í–õ–ê–î–ï–õ–ï–¶</span>';
                    }
                    html += '</div></div>';
                    
                    if (isOwner && !isMemberOwner) {
                        html += '<button onclick="removeMemberConfirm(\'' + memberId + '\')" style="width: 32px; height: 32px; background: var(--accent-red); color: white; border: none; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center;">';
                        html += '<i class="fas fa-times"></i>';
                        html += '</button>';
                    }
                    html += '</div>';
                });
            } else {
                html = '<div style="text-align: center; padding: 40px; color: var(--text-secondary);">–ù–µ—Ç —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</div>';
            }
            
            content.innerHTML = html;
            openModal('viewMembersModal');
        };

        window.removeMemberConfirm = function(memberId) {
            if (!currentChat || currentChat.owner !== currentUser.id) return;
            
            if (confirm('–£–¥–∞–ª–∏—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–∞ –∏–∑ –≥—Ä—É–ø–ø—ã?')) {
                currentChat.members = currentChat.members.filter(m => m !== memberId);
                saveChats();
                viewGroupMembers();
                showNotification('‚úÖ –£—á–∞—Å—Ç–Ω–∏–∫ —É–¥–∞–ª—ë–Ω –∏–∑ –≥—Ä—É–ø–ø—ã', 'success');
            }
        };


        // ===== –û–ë–ù–û–í–õ–Å–ù–ù–û–ï –ú–ï–ù–Æ –ß–ê–¢–ê =====
        const originalOpenChatMenu = window.openChatMenu;
        window.openChatMenu = function() {
            if (!currentChat) return;
            
            const content = document.getElementById('chatMenuContent');
            if (!content) return;
            
            let html = '';
            
            if (currentChat.type === 'group') {
                const isOwner = currentChat.owner === currentUser.id;
                
                // –ö–Ω–æ–ø–∫–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
                html += '<div style="cursor: pointer; padding: 15px; background: var(--glass-bg); border: 1px solid var(--glass-border); border-radius: 12px; margin-bottom: 12px;" onclick="viewGroupMembers(); closeModal(\'chatMenuModal\');">';
                html += '<div><h4 style="color: var(--text-primary); margin-bottom: 5px;">üë• –£—á–∞—Å—Ç–Ω–∏–∫–∏ –≥—Ä—É–ø–ø—ã</h4>';
                html += '<p style="color: var(--text-secondary); font-size: 13px;">–ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤—Å–µ—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ (' + (currentChat.members ? currentChat.members.length : 0) + ')</p>';
                html += '</div></div>';
                
                // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
                html += '<div style="display: flex; align-items: center; justify-content: space-between; padding: 15px; background: var(--glass-bg); border: 1px solid var(--glass-border); border-radius: 12px; margin-bottom: 12px;">';
                html += '<div><h4 style="color: var(--text-primary); margin-bottom: 5px;">üîî –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</h4>';
                html += '<p style="color: var(--text-secondary); font-size: 13px;">–ü–æ–ª—É—á–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</p></div>';
                html += '<label class="toggle-switch"><input type="checkbox" checked><span class="toggle-slider"></span></label>';
                html += '</div>';
                
                if (isOwner) {
                    // –í–ª–∞–¥–µ–ª–µ—Ü –º–æ–∂–µ—Ç —É–¥–∞–ª–∏—Ç—å –≥—Ä—É–ø–ø—É
                    html += '<div style="cursor: pointer; padding: 15px; background: rgba(255,68,68,0.1); border: 1px solid var(--accent-red); border-radius: 12px;" onclick="confirmDeleteGroup(); closeModal(\'chatMenuModal\');">';
                    html += '<div><h4 style="color: var(--accent-red); margin-bottom: 5px;">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –≥—Ä—É–ø–ø—É</h4>';
                    html += '<p style="color: var(--text-secondary); font-size: 13px;">–¢–æ–ª—å–∫–æ –≤–ª–∞–¥–µ–ª–µ—Ü –º–æ–∂–µ—Ç —É–¥–∞–ª–∏—Ç—å –≥—Ä—É–ø–ø—É</p>';
                    html += '</div></div>';
                } else {
                    // –£—á–∞—Å—Ç–Ω–∏–∫ –º–æ–∂–µ—Ç –ø–æ–∫–∏–Ω—É—Ç—å –≥—Ä—É–ø–ø—É
                    html += '<div style="cursor: pointer; padding: 15px; background: rgba(255,170,0,0.1); border: 1px solid var(--accent-yellow); border-radius: 12px;" onclick="leaveGroup(); closeModal(\'chatMenuModal\');">';
                    html += '<div><h4 style="color: var(--accent-yellow); margin-bottom: 5px;">üëã –ü–æ–∫–∏–Ω—É—Ç—å –≥—Ä—É–ø–ø—É</h4>';
                    html += '<p style="color: var(--text-secondary); font-size: 13px;">–í—ã–π—Ç–∏ –∏–∑ –≥—Ä—É–ø–ø—ã</p>';
                    html += '</div></div>';
                }
            } else {
                // –õ–∏—á–Ω—ã–π —á–∞—Ç
                html += '<div style="display: flex; align-items: center; justify-content: space-between; padding: 15px; background: var(--glass-bg); border: 1px solid var(--glass-border); border-radius: 12px; margin-bottom: 12px;">';
                html += '<div><h4 style="color: var(--text-primary); margin-bottom: 5px;">üîî –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</h4>';
                html += '<p style="color: var(--text-secondary); font-size: 13px;">–ü–æ–ª—É—á–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</p></div>';
                html += '<label class="toggle-switch"><input type="checkbox" checked><span class="toggle-slider"></span></label>';
                html += '</div>';
                
                html += '<div style="cursor: pointer; padding: 15px; background: var(--glass-bg); border: 1px solid var(--glass-border); border-radius: 12px; margin-bottom: 12px;" onclick="blockUser(\'' + currentChat.id + '\'); closeModal(\'chatMenuModal\');">';
                html += '<div><h4 style="color: var(--accent-red); margin-bottom: 5px;">üö´ –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å</h4>';
                html += '<p style="color: var(--text-secondary); font-size: 13px;">–î–æ–±–∞–≤–∏—Ç—å –≤ —á—ë—Ä–Ω—ã–π —Å–ø–∏—Å–æ–∫</p>';
                html += '</div></div>';
                
                html += '<div style="cursor: pointer; padding: 15px; background: rgba(255,68,68,0.1); border: 1px solid var(--accent-red); border-radius: 12px;" onclick="confirmDeleteChat(); closeModal(\'chatMenuModal\');">';
                html += '<div><h4 style="color: var(--accent-red); margin-bottom: 5px;">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å —á–∞—Ç</h4>';
                html += '<p style="color: var(--text-secondary); font-size: 13px;">–£–¥–∞–ª–∏—Ç—å —á–∞—Ç –∏ –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è</p>';
                html += '</div></div>';
            }
            
            content.innerHTML = html;
            openModal('chatMenuModal');
        };


        // ===== –î–ï–ô–°–¢–í–ò–Ø –° –ì–†–£–ü–ü–û–ô =====
        window.confirmDeleteGroup = function() {
            if (!currentChat || currentChat.type !== 'group') return;
            
            if (currentChat.owner !== currentUser.id) {
                showNotification('‚ùå –¢–æ–ª—å–∫–æ –≤–ª–∞–¥–µ–ª–µ—Ü –º–æ–∂–µ—Ç —É–¥–∞–ª–∏—Ç—å –≥—Ä—É–ø–ø—É', 'error');
                return;
            }
            
            if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –≥—Ä—É–ø–ø—É "' + currentChat.name + '"? –í—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –±—É–¥—É—Ç –ø–æ—Ç–µ—Ä—è–Ω—ã.')) {
                const chatId = currentChat.id;
                chats = chats.filter(c => c.id !== chatId);
                delete messages[chatId];
                saveChats();
                saveMessages();
                
                currentChat = null;
                document.getElementById('chatHeader').style.display = 'none';
                document.getElementById('inputContainer').style.display = 'none';
                document.getElementById('messagesContainer').innerHTML = '<div style="text-align: center; color: var(--text-secondary); margin-top: 50px;"><i class="fas fa-comments" style="font-size: 64px; opacity: 0.3;"></i><p style="margin-top: 20px; font-size: 16px;">–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç</p></div>';
                
                renderChats();
                showNotification('‚úÖ –ì—Ä—É–ø–ø–∞ —É–¥–∞–ª–µ–Ω–∞', 'success');
            }
        };

        window.leaveGroup = function() {
            if (!currentChat || currentChat.type !== 'group') return;
            
            if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –ø–æ–∫–∏–Ω—É—Ç—å –≥—Ä—É–ø–ø—É "' + currentChat.name + '"?')) {
                currentChat.members = currentChat.members.filter(m => m !== currentUser.id);
                saveChats();
                
                currentChat = null;
                document.getElementById('chatHeader').style.display = 'none';
                document.getElementById('inputContainer').style.display = 'none';
                
                renderChats();
                showNotification('‚úÖ –í—ã –ø–æ–∫–∏–Ω—É–ª–∏ –≥—Ä—É–ø–ø—É', 'success');
            }
        };

        window.confirmDeleteChat = function() {
            if (!currentChat) return;
            
            if (confirm('–£–¥–∞–ª–∏—Ç—å —á–∞—Ç —Å "' + currentChat.name + '"? –í—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –±—É–¥—É—Ç –ø–æ—Ç–µ—Ä—è–Ω—ã.')) {
                const chatId = currentChat.id;
                chats = chats.filter(c => c.id !== chatId);
                delete messages[chatId];
                saveChats();
                saveMessages();
                
                currentChat = null;
                document.getElementById('chatHeader').style.display = 'none';
                document.getElementById('inputContainer').style.display = 'none';
                document.getElementById('messagesContainer').innerHTML = '<div style="text-align: center; color: var(--text-secondary); margin-top: 50px;"><i class="fas fa-comments" style="font-size: 64px; opacity: 0.3;"></i><p style="margin-top: 20px; font-size: 16px;">–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç</p></div>';
                
                renderChats();
                showNotification('‚úÖ –ß–∞—Ç —É–¥–∞–ª—ë–Ω', 'success');
            }
        };


// ===== –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø –ö–†–ò–¢–ò–ß–ï–°–ö–ò–• –û–®–ò–ë–û–ö =====

// 1. –ì–ª–æ–±–∞–ª—å–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è messages (—É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤—ã—à–µ)

// 2. –§—É–Ω–∫—Ü–∏—è showChatInfo - –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø
window.showChatInfo = function() {
    if (!currentChat) return;
    
    const content = document.getElementById('chatInfoContent');
    if (!content) return;
    
    let html = '';
    
    // –ü–æ–ª—É—á–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –∏–∑ localStorage –Ω–∞–ø—Ä—è–º—É—é
    const chatMessages = localStorage.getItem('quantum_messages_' + currentChat.id);
    let msgCount = 0;
    try {
        if (chatMessages) {
            msgCount = JSON.parse(chatMessages).length;
        }
    } catch(e) {
        msgCount = 0;
    }
    
    if (currentChat.type === 'group') {
        html += '<div style="text-align: center; margin-bottom: 20px;">';
        html += '<div style="width: 80px; height: 80px; margin: 0 auto; background: var(--gradient-primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 32px; color: white;">';
        html += currentChat.avatar || 'üë•';
        html += '</div></div>';
        html += '<h3 style="color: var(--text-primary); text-align: center; margin-bottom: 20px;">' + currentChat.name + '</h3>';
        
        if (currentChat.description) {
            html += '<div style="background: var(--glass-bg); padding: 15px; border-radius: 10px; margin-bottom: 15px; border: 1px solid var(--glass-border);">';
            html += '<div style="color: var(--text-secondary); font-size: 12px;">–û–ü–ò–°–ê–ù–ò–ï</div>';
            html += '<div style="color: var(--text-primary); margin-top: 5px;">' + currentChat.description + '</div>';
            html += '</div>';
        }
        
        html += '<div style="background: var(--glass-bg); padding: 15px; border-radius: 10px; margin-bottom: 15px; border: 1px solid var(--glass-border);">';
        html += '<div style="color: var(--text-secondary); font-size: 12px;">ID –ì–†–£–ü–ü–´</div>';
        html += '<div style="color: var(--text-primary); margin-top: 5px; font-family: monospace;">' + currentChat.id + '</div>';
        html += '</div>';
        
        if (currentChat.members && currentChat.members.length > 0) {
            html += '<div style="background: var(--glass-bg); padding: 15px; border-radius: 10px; margin-bottom: 15px; border: 1px solid var(--glass-border);">';
            html += '<div style="color: var(--text-secondary); font-size: 12px;">–£–ß–ê–°–¢–ù–ò–ö–ò</div>';
            html += '<div style="color: var(--text-primary); margin-top: 5px;">' + currentChat.members.length + ' —á–µ–ª–æ–≤–µ–∫</div>';
            html += '</div>';
            
            html += '<h4 style="color: var(--text-primary); margin: 20px 0 10px;">üë• –°–ø–∏—Å–æ–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤:</h4>';
            currentChat.members.forEach(memberId => {
                const isOwner = memberId === currentChat.owner;
                html += '<div style="display: flex; align-items: center; gap: 10px; padding: 10px; background: var(--glass-bg); border-radius: 8px; margin-bottom: 8px; border: 1px solid var(--glass-border);">';
                html += '<div style="width: 32px; height: 32px; background: var(--gradient-primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 14px;">' + memberId.substring(0,1).toUpperCase() + '</div>';
                html += '<div style="flex: 1; color: var(--text-primary);">' + memberId;
                if (isOwner) html += ' <span style="background: var(--accent-yellow); color: #000; padding: 2px 6px; border-radius: 6px; font-size: 10px; margin-left: 5px;">–í–õ–ê–î–ï–õ–ï–¶</span>';
                html += '</div></div>';
            });
        }
    } else {
        html += '<div style="text-align: center; margin-bottom: 20px;">';
        html += '<div style="width: 80px; height: 80px; margin: 0 auto; background: var(--gradient-primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 32px; color: white;">';
        html += currentChat.avatar || 'üë§';
        html += '</div></div>';
        html += '<h3 style="color: var(--text-primary); text-align: center; margin-bottom: 20px;">' + currentChat.name + '</h3>';
        
        html += '<div style="background: var(--glass-bg); padding: 15px; border-radius: 10px; margin-bottom: 15px; border: 1px solid var(--glass-border);">';
        html += '<div style="color: var(--text-secondary); font-size: 12px;">ID –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø</div>';
        html += '<div style="color: var(--text-primary); margin-top: 5px; font-family: monospace;">' + currentChat.id + '</div>';
        html += '</div>';
        
        html += '<div style="background: var(--glass-bg); padding: 15px; border-radius: 10px; margin-bottom: 15px; border: 1px solid var(--glass-border);">';
        html += '<div style="color: var(--text-secondary); font-size: 12px;">–°–¢–ê–¢–£–°</div>';
        html += '<div style="color: var(--accent-green); margin-top: 5px;">üü¢ –í —Å–µ—Ç–∏</div>';
        html += '</div>';
        
        html += '<div style="background: var(--glass-bg); padding: 15px; border-radius: 10px; border: 1px solid var(--glass-border);">';
        html += '<div style="color: var(--text-secondary); font-size: 12px;">–°–û–û–ë–©–ï–ù–ò–ô</div>';
        html += '<div style="color: var(--text-primary); margin-top: 5px;">' + msgCount + '</div>';
        html += '</div>';
    }
    
    content.innerHTML = html;
    openModal('chatInfoModal');
};

// ============================================================
// üîä QUANTUM SOUND ENGINE v2.0 ‚Äî –ü–æ–ª–Ω–æ—Ü–µ–Ω–Ω–∞—è –∑–≤—É–∫–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞
// ============================================================
(function() {
    let _audioCtx = null;
    let _ringtoneInterval = null;
    let _ringtoneActive = false;

    function getCtx() {
        if (!_audioCtx || _audioCtx.state === 'closed') {
            _audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        }
        if (_audioCtx.state === 'suspended') {
            _audioCtx.resume();
        }
        return _audioCtx;
    }

    // –ë–∞–∑–æ–≤—ã–π —Ç–æ–Ω
    function playTone(freq, duration, type, volume, startTime, ctx) {
        const c = ctx || getCtx();
        const t = startTime !== undefined ? startTime : c.currentTime;
        const osc = c.createOscillator();
        const gain = c.createGain();
        osc.connect(gain);
        gain.connect(c.destination);
        osc.type = type || 'sine';
        osc.frequency.setValueAtTime(freq, t);
        gain.gain.setValueAtTime(volume || 0.3, t);
        gain.gain.exponentialRampToValueAtTime(0.001, t + duration);
        osc.start(t);
        osc.stop(t + duration + 0.01);
    }

    // üîî –ó–≤—É–∫ –û–¢–ü–†–ê–í–ö–ò —Å–æ–æ–±—â–µ–Ω–∏—è ‚Äî –∫–æ—Ä–æ—Ç–∫–∏–π –ø–æ–∑–∏—Ç–∏–≤–Ω—ã–π ¬´–≤–∂–∏–∫¬ª
    window.soundSendMessage = function() {
        try {
            const ctx = getCtx();
            const now = ctx.currentTime;
            playTone(900,  0.06, 'sine',     0.25, now,        ctx);
            playTone(1200, 0.07, 'sine',     0.20, now + 0.06, ctx);
            playTone(1500, 0.05, 'triangle', 0.15, now + 0.12, ctx);
        } catch(e) { console.log('soundSendMessage error', e); }
    };

    // üîî –ó–≤—É–∫ –ü–û–õ–£–ß–ï–ù–ò–Ø —Å–æ–æ–±—â–µ–Ω–∏—è ‚Äî –º—è–≥–∫–∏–π –¥–≤–æ–π–Ω–æ–π ¬´–¥–∏–Ω—å¬ª
    window.soundReceiveMessage = function() {
        try {
            const ctx = getCtx();
            const now = ctx.currentTime;
            playTone(880, 0.10, 'sine',     0.28, now,        ctx);
            playTone(660, 0.12, 'sine',     0.20, now + 0.14, ctx);
        } catch(e) { console.log('soundReceiveMessage error', e); }
    };

    // –û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å ‚Äî soundMessage = receive
    window.soundMessage = window.soundReceiveMessage;

    // üìû –†–∏–Ω–≥—Ç–æ–Ω ‚Äî –∑–∞—Ü–∏–∫–ª–µ–Ω–Ω—ã–π –∫–≤–∞–Ω—Ç–æ–≤—ã–π –∑–≤–æ–Ω–æ–∫ (–∏—Å—Ö–æ–¥—è—â–∏–π)
    function _ringtoneOnce(ctx) {
        const now = ctx.currentTime;
        // –ú–µ–ª–æ–¥–∏—á–Ω–∞—è —Ñ—Ä–∞–∑–∞: do-mi-sol-mi
        const notes = [523, 659, 784, 659];
        notes.forEach((f, i) => {
            playTone(f, 0.13, 'triangle', 0.35, now + i * 0.15, ctx);
        });
        // –ù–µ–±–æ–ª—å—à–æ–π ¬´—Ö–≤–æ—Å—Ç¬ª ‚Äî –Ω–∏–∑–∫–∏–π —Ç–æ–Ω
        playTone(261, 0.18, 'sine', 0.15, now + 0.65, ctx);
    }

    // üìû –†–∏–Ω–≥—Ç–æ–Ω –í–•–û–î–Ø–©–ï–ì–û –∑–≤–æ–Ω–∫–∞ ‚Äî –∑–∞—Ü–∏–∫–ª–µ–Ω–Ω—ã–π
    window.soundIncomingRingtone = function() {
        try {
            _ringtoneActive = true;
            const ctx = getCtx();
            _ringtoneOnce(ctx);
            _ringtoneInterval = setInterval(() => {
                if (!_ringtoneActive) { clearInterval(_ringtoneInterval); return; }
                _ringtoneOnce(getCtx());
            }, 2000);
        } catch(e) { console.log('soundIncomingRingtone error', e); }
    };

    // üìû –†–∏–Ω–≥—Ç–æ–Ω –ò–°–•–û–î–Ø–©–ï–ì–û –∑–≤–æ–Ω–∫–∞ ‚Äî –∑–∞—Ü–∏–∫–ª–µ–Ω–Ω—ã–π (–¥—Ä—É–≥–∞—è –º–µ–ª–æ–¥–∏—è)
    window.soundOutgoingRingtone = function() {
        try {
            _ringtoneActive = true;
            const ctx = getCtx();
            const _outOnce = (c) => {
                const now = c.currentTime;
                playTone(440, 0.4, 'sine', 0.25, now,        c);
                playTone(440, 0.4, 'sine', 0.25, now + 0.55, c);
            };
            _outOnce(ctx);
            _ringtoneInterval = setInterval(() => {
                if (!_ringtoneActive) { clearInterval(_ringtoneInterval); return; }
                _outOnce(getCtx());
            }, 2500);
        } catch(e) { console.log('soundOutgoingRingtone error', e); }
    };

    // ‚èπ –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ä–∏–Ω–≥—Ç–æ–Ω
    window.soundStopRingtone = function() {
        _ringtoneActive = false;
        if (_ringtoneInterval) {
            clearInterval(_ringtoneInterval);
            _ringtoneInterval = null;
        }
    };

    // –û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å ‚Äî soundCall = incoming ringtone (–æ–¥–∏–Ω —Ä–∞–∑)
    window.soundCall = function() {
        try {
            const ctx = getCtx();
            _ringtoneOnce(ctx);
        } catch(e) {}
    };

    // üîï –ö–æ—Ä–æ—Ç–∫–∏–π ¬´–≥—É–¥–æ–∫¬ª ‚Äî –∑–≤–æ–Ω–æ–∫ –∑–∞–≤–µ—Ä—à—ë–Ω / –æ—Ç–∫–ª–æ–Ω—ë–Ω
    window.soundCallEnd = function() {
        try {
            const ctx = getCtx();
            const now = ctx.currentTime;
            playTone(300, 0.3, 'sine', 0.3, now, ctx);
            playTone(250, 0.4, 'sine', 0.2, now + 0.35, ctx);
        } catch(e) {}
    };

    // –¢–µ—Å—Ç–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
    window.testMessageSound    = function() { soundSendMessage();      showNotification('üîî –ó–≤—É–∫ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è', 'info'); };
    window.testReceiveSound    = function() { soundReceiveMessage();   showNotification('üì® –ó–≤—É–∫ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è', 'info'); };
    window.testCallSound       = function() { soundIncomingRingtone(); showNotification('üìû –†–∏–Ω–≥—Ç–æ–Ω –≤—Ö–æ–¥—è—â–µ–≥–æ (5 —Å–µ–∫)', 'info'); setTimeout(soundStopRingtone, 5000); };
    window.testOutgoingSound   = function() { soundOutgoingRingtone(); showNotification('üì≤ –†–∏–Ω–≥—Ç–æ–Ω –∏—Å—Ö–æ–¥—è—â–µ–≥–æ (5 —Å–µ–∫)', 'info'); setTimeout(soundStopRingtone, 5000); };
})();
// ============================================================



// –¢–µ—Å—Ç–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Å–∏–º—É–ª—è—Ü–∏–∏
window.receiveTestMessage = function() {
    if (!currentChat) {
        showNotification('‚ö†Ô∏è –û—Ç–∫—Ä–æ–π—Ç–µ —á–∞—Ç —Å–Ω–∞—á–∞–ª–∞', 'warning');
        return;
    }
    
    const chatId = currentChat.id;
    let msgs = localStorage.getItem('quantum_messages_' + chatId);
    let msgArray = msgs ? JSON.parse(msgs) : [];
    
    const newMsg = {
        id: Date.now(),
        sender: 'other',
        text: '–ü—Ä–∏–≤–µ—Ç! –≠—Ç–æ —Ç–µ—Å—Ç–æ–≤–æ–µ –≤—Ö–æ–¥—è—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ üëã',
        time: new Date().toLocaleTimeString('ru-RU', {hour: '2-digit', minute: '2-digit'}),
        type: 'text',
        timestamp: Date.now()
    };
    
    msgArray.push(newMsg);
    localStorage.setItem('quantum_messages_' + chatId, JSON.stringify(msgArray));
    
    loadMessages(chatId);
    // üîä –ó–≤—É–∫ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è
    if (typeof soundReceiveMessage === 'function') soundReceiveMessage();
    showNotification('üì® –ü–æ–ª—É—á–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ', 'success');
};

window.receiveTestCall = function() {
    if (!currentChat) {
        showNotification('‚ö†Ô∏è –û—Ç–∫—Ä–æ–π—Ç–µ —á–∞—Ç —Å–Ω–∞—á–∞–ª–∞', 'warning');
        return;
    }
    
    // üîä –†–∏–Ω–≥—Ç–æ–Ω –≤—Ö–æ–¥—è—â–µ–≥–æ –∑–≤–æ–Ω–∫–∞
    if (typeof soundIncomingRingtone === 'function') soundIncomingRingtone();
    showNotification('üìû –í—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫ –æ—Ç ' + currentChat.name, 'info');
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —ç–∫—Ä–∞–Ω –∑–≤–æ–Ω–∫–∞ –µ—Å–ª–∏ –µ—Å—Ç—å
    const callScreen = document.getElementById('callScreen');
    if (callScreen) {
        callScreen.style.display = 'flex';
    }
    
    // –ê–≤—Ç–æ-—Å—Ç–æ–ø —Ä–∏–Ω–≥—Ç–æ–Ω–∞ —á–µ—Ä–µ–∑ 30 —Å–µ–∫—É–Ω–¥
    setTimeout(function() {
        if (typeof soundStopRingtone === 'function') soundStopRingtone();
    }, 30000);
};

// ================================================================
// üë• –£–ü–†–ê–í–õ–ï–ù–ò–ï –£–ß–ê–°–¢–ù–ò–ö–ê–ú–ò –ì–†–£–ü–ü–´ v4.3
// ================================================================

// –û—Ç–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —É—á–∞—Å—Ç–Ω–∏–∫–∞–º–∏
window.openGroupMembersManage = function() {
    if (!currentChat || currentChat.type !== 'group') {
        showNotification('–≠—Ç–æ –Ω–µ –≥—Ä—É–ø–ø–æ–≤–æ–π —á–∞—Ç', 'warning');
        return;
    }

    // –ó–∞–∫—Ä—ã–≤–∞–µ–º –≤—ã–ø–∞–¥–∞—é—â–µ–µ –º–µ–Ω—é –µ—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç–æ
    const optMenu = document.getElementById('chatOptionsMenu');
    if (optMenu) optMenu.remove();

    renderGroupMembersManage();
    openModal('groupMembersManageModal');
};

// –†–µ–Ω–¥–µ—Ä —Å–ø–∏—Å–∫–∞ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
function renderGroupMembersManage() {
    const content = document.getElementById('groupMembersManageContent');
    if (!content || !currentChat) return;

    const isOwner  = currentChat.owner === currentUser.id;
    const admins   = currentChat.admins || [];

    // –ë–µ—Ä—ë–º —Å–ø–∏—Å–æ–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ (–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º –æ–±–∞ –ø–æ–ª—è)
    const membersList = Array.isArray(currentChat.members)
        ? currentChat.members
        : (Array.isArray(currentChat.memberIds) ? currentChat.memberIds : []);

    if (membersList.length === 0) {
        content.innerHTML = '<div style="text-align:center;padding:40px;color:var(--text-secondary);">–ù–µ—Ç —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</div>';
        return;
    }

    let html = '';

    // –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å —Å—á—ë—Ç—á–∏–∫–æ–º
    html += '<div class="members-manage-header">'
        + '<span style="color:var(--text-secondary);font-size:13px;">–°–ø–∏—Å–æ–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</span>'
        + '<span class="members-manage-count">' + membersList.length + ' —á–µ–ª.</span>'
        + '</div>';

    // –õ–µ–≥–µ–Ω–¥–∞ (—Ç–æ–ª—å–∫–æ –¥–ª—è –≤–ª–∞–¥–µ–ª—å—Ü–∞)
    if (isOwner) {
        html += '<div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:14px;font-size:11px;color:var(--text-secondary);">'
            + '<span><span class="member-badge badge-owner">üëë –í–õ–ê–î–ï–õ–ï–¶</span> ‚Äî –Ω–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å</span>'
            + '<span><span class="member-badge badge-admin">‚≠ê ADMIN</span> ‚Äî –µ—Å—Ç—å –ø—Ä–∏–≤–∏–ª–µ–≥–∏–∏</span>'
            + '</div>';
    }

    // –°–Ω–∞—á–∞–ª–∞ –≤–ª–∞–¥–µ–ª–µ—Ü, –ø–æ—Ç–æ–º –∞–¥–º–∏–Ω—ã, –ø–æ—Ç–æ–º –æ—Å—Ç–∞–ª—å–Ω—ã–µ
    const sorted = [...membersList].sort(function(a, b) {
        if (a === currentChat.owner) return -1;
        if (b === currentChat.owner) return  1;
        const aA = admins.includes(a), bA = admins.includes(b);
        if (aA && !bA) return -1;
        if (!aA && bA) return  1;
        return 0;
    });

    sorted.forEach(function(memberId) {
        const isMemberOwner = memberId === currentChat.owner;
        const isAdmin       = admins.includes(memberId);
        const isMe          = memberId === currentUser.id;

        const name     = isMe ? currentUser.name : '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ' + memberId;
        const initials = name[0].toUpperCase();

        let cardClass = 'member-manage-card';
        if (isMemberOwner) cardClass += ' owner-card';
        else if (isAdmin)  cardClass += ' admin-card';

        let avatarBg = isMemberOwner
            ? 'linear-gradient(135deg,#ffd700,#ff9500)'
            : isAdmin
                ? 'linear-gradient(135deg,#a78bfa,#667eea)'
                : 'var(--gradient-primary)';

        html += '<div class="' + cardClass + '">';

        // –ê–≤–∞—Ç–∞—Ä
        html += '<div class="member-manage-avatar" style="background:' + avatarBg + ';'
            + (isMemberOwner ? 'box-shadow:0 0 12px rgba(255,215,0,0.5);' : '')
            + (isAdmin && !isMemberOwner ? 'box-shadow:0 0 10px rgba(167,139,250,0.4);' : '')
            + '">' + initials + '</div>';

        // –ò–Ω—Ñ–æ
        html += '<div class="member-manage-info">'
            + '<div class="member-manage-name">' + escapeHtml(name);

        if (isMemberOwner) html += '<span class="member-badge badge-owner"><i class="fas fa-crown"></i> –í–õ–ê–î–ï–õ–ï–¶</span>';
        else if (isAdmin)  html += '<span class="member-badge badge-admin"><i class="fas fa-star"></i> ADMIN</span>';
        if (isMe)          html += '<span class="member-badge badge-me">–í–´</span>';

        html += '</div>'
            + '<div class="member-manage-id">' + memberId + '</div>'
            + '</div>';

        // –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π (—Ç–æ–ª—å–∫–æ –¥–ª—è –≤–ª–∞–¥–µ–ª—å—Ü–∞ –∏ –Ω–µ –Ω–∞–¥ —Å–∞–º–∏–º —Å–æ–±–æ–π)
        if (isOwner && !isMemberOwner) {
            html += '<div class="member-manage-actions">';

            // –ö–Ω–æ–ø–∫–∞ –ê–¥–º–∏–Ω (–≤—ã–¥–∞—Ç—å/—Å–Ω—è—Ç—å)
            if (isAdmin) {
                html += '<button class="mmbtn mmbtn-admin-on" '
                    + 'onclick="window._toggleAdminMember(\'' + memberId + '\')" '
                    + 'title="–°–Ω—è—Ç—å –ø—Ä–∏–≤–∏–ª–µ–≥–∏–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞">'
                    + '<i class="fas fa-star"></i></button>';
            } else {
                html += '<button class="mmbtn mmbtn-admin-off" '
                    + 'onclick="window._toggleAdminMember(\'' + memberId + '\')" '
                    + 'title="–ù–∞–∑–Ω–∞—á–∏—Ç—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º">'
                    + '<i class="fas fa-star"></i></button>';
            }

            // –ö–Ω–æ–ø–∫–∞ –£–¥–∞–ª–∏—Ç—å
            if (!isMe) {
                html += '<button class="mmbtn mmbtn-kick" '
                    + 'onclick="window._kickMember(\'' + memberId + '\')" '
                    + 'title="–£–¥–∞–ª–∏—Ç—å –∏–∑ –≥—Ä—É–ø–ø—ã">'
                    + '<i class="fas fa-user-times"></i></button>';
            }

            html += '</div>';
        }

        html += '</div>';
    });

    content.innerHTML = html;
}

// –£–¥–∞–ª–∏—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–∞ –∏–∑ –≥—Ä—É–ø–ø—ã
window._kickMember = function(memberId) {
    if (!currentChat || currentChat.owner !== currentUser.id) return;
    const name = memberId === currentUser.id ? currentUser.name : '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ' + memberId;
    if (!confirm('–£–¥–∞–ª–∏—Ç—å ' + name + ' –∏–∑ –≥—Ä—É–ø–ø—ã "' + currentChat.name + '"?')) return;

    // –û–±–Ω–æ–≤–ª—è–µ–º –æ–±–∞ –ø–æ–ª—è members/memberIds
    if (Array.isArray(currentChat.members)) {
        currentChat.members = currentChat.members.filter(function(m){ return m !== memberId; });
    }
    if (Array.isArray(currentChat.memberIds)) {
        currentChat.memberIds = currentChat.memberIds.filter(function(m){ return m !== memberId; });
    }
    // –°–Ω–∏–º–∞–µ–º —Ç–∞–∫–∂–µ —Ä–æ–ª—å –∞–¥–º–∏–Ω–∞ –µ—Å–ª–∏ –±—ã–ª–∞
    if (currentChat.admins) {
        currentChat.admins = currentChat.admins.filter(function(m){ return m !== memberId; });
    }

    saveToLocalStorage();
    updateUI();
    renderGroupMembersManage();
    showNotification('‚úÖ –£—á–∞—Å—Ç–Ω–∏–∫ —É–¥–∞–ª—ë–Ω –∏–∑ –≥—Ä—É–ø–ø—ã', 'success');
    logSecurityEvent('–£—á–∞—Å—Ç–Ω–∏–∫ ' + memberId + ' —É–¥–∞–ª—ë–Ω –∏–∑ –≥—Ä—É–ø–ø—ã ' + currentChat.name, 'info');
};

// –í—ã–¥–∞—Ç—å/—Å–Ω—è—Ç—å –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
window._toggleAdminMember = function(memberId) {
    if (!currentChat || currentChat.owner !== currentUser.id) return;
    if (memberId === currentChat.owner) return; // –í–ª–∞–¥–µ–ª—å—Ü–∞ –Ω–µ —Ç—Ä–æ–≥–∞–µ–º

    if (!currentChat.admins) currentChat.admins = [];
    const name = memberId === currentUser.id ? currentUser.name : '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ' + memberId;

    if (currentChat.admins.includes(memberId)) {
        // –°–Ω—è—Ç—å –ø—Ä–∞–≤–∞
        currentChat.admins = currentChat.admins.filter(function(m){ return m !== memberId; });
        showNotification('‚≠ê –ü—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ —Å–Ω—è—Ç—ã —Å ' + name, 'info');
        logSecurityEvent('–°–Ω—è—Ç—ã –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∞ —É ' + memberId, 'info');
    } else {
        // –ù–∞–∑–Ω–∞—á–∏—Ç—å
        currentChat.admins.push(memberId);
        showNotification('‚≠ê ' + name + ' –Ω–∞–∑–Ω–∞—á–µ–Ω –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º', 'success');
        logSecurityEvent('–ù–∞–∑–Ω–∞—á–µ–Ω –∞–¥–º–∏–Ω: ' + memberId, 'info');
    }

    saveToLocalStorage();
    renderGroupMembersManage();
};

// ================================================================
// –û–±–Ω–æ–≤–ª—ë–Ω–Ω–æ–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é ‚ãÆ ‚Äî –¥–æ–±–∞–≤–ª—è–µ–º –ø—É–Ω–∫—Ç –¥–ª—è –≥—Ä—É–ø–ø—ã
// ================================================================
(function() {
    const _origOptionsMenu = window.showChatOptionsMenu || function(){};

    window.showChatOptionsMenu = function(e) {
        e.preventDefault();
        const existing = document.getElementById('chatOptionsMenu');
        if (existing) { existing.remove(); return; }

        const menu = document.createElement('div');
        menu.id = 'chatOptionsMenu';
        menu.className = 'msg-context-menu';

        const btn = e.target.closest('button');
        if (!btn) return;
        const rect = btn.getBoundingClientRect();
        menu.style.right  = (window.innerWidth - rect.right) + 'px';
        menu.style.top    = (rect.bottom + 5) + 'px';
        menu.style.left   = 'auto';
        menu.style.zIndex = '9999';

        const isGroup   = currentChat && currentChat.type === 'group';
        const isOwner   = isGroup && currentChat.owner === currentUser.id;
        const blocked   = currentChat ? isBlocked(currentChat.id) : false;

        let items = '';

        if (isGroup) {
            // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —É—á–∞—Å—Ç–Ω–∏–∫–∞–º–∏ ‚Äî –≤—Å–µ–≥–¥–∞ –¥–ª—è –≥—Ä—É–ø–ø—ã
            items += '<div class="ctx-item" onclick="openGroupMembersManage();document.getElementById(\'chatOptionsMenu\')&&document.getElementById(\'chatOptionsMenu\').remove();">'
                + '<i class="fas fa-users-cog" style="color:var(--primary-color)"></i> '
                + '<strong>–£—á–∞—Å—Ç–Ω–∏–∫–∏ –≥—Ä—É–ø–ø—ã</strong></div>'
                + '<div class="ctx-separator"></div>';

            items += '<div class="ctx-item" onclick="clearChatHistory();"><i class="fas fa-broom"></i> –û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é</div>';

            if (isOwner) {
                items += '<div class="ctx-item danger" onclick="confirmDeleteGroup();document.getElementById(\'chatOptionsMenu\')&&document.getElementById(\'chatOptionsMenu\').remove();">'
                    + '<i class="fas fa-trash-alt"></i> –£–¥–∞–ª–∏—Ç—å –≥—Ä—É–ø–ø—É</div>';
            } else {
                items += '<div class="ctx-item" style="color:var(--accent-yellow)" onclick="leaveGroup();document.getElementById(\'chatOptionsMenu\')&&document.getElementById(\'chatOptionsMenu\').remove();">'
                    + '<i class="fas fa-sign-out-alt"></i> –ü–æ–∫–∏–Ω—É—Ç—å –≥—Ä—É–ø–ø—É</div>';
            }
        } else {
            items += '<div class="ctx-item" onclick="clearChatHistory()"><i class="fas fa-broom"></i> –û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é</div>'
                + '<div class="ctx-item" onclick="deleteChatFromList()"><i class="fas fa-trash-alt"></i> –£–¥–∞–ª–∏—Ç—å —á–∞—Ç</div>'
                + '<div class="ctx-separator"></div>'
                + '<div class="ctx-item ' + (blocked ? '' : 'danger') + '" onclick="toggleBlockCurrentChat()">'
                + '<i class="fas fa-' + (blocked ? 'unlock' : 'ban') + '"></i> '
                + (blocked ? '–†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å' : '–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å') + '</div>'
                + '<div class="ctx-item danger" onclick="deleteContactAndChat()">'
                + '<i class="fas fa-user-slash"></i> –£–¥–∞–ª–∏—Ç—å —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞</div>';
        }

        menu.innerHTML = items;
        document.body.appendChild(menu);

        setTimeout(function() {
            document.addEventListener('click', function _h(ev) {
                if (!menu.contains(ev.target)) { menu.remove(); document.removeEventListener('click', _h); }
            });
        }, 50);
    };
})();
// ================================================================

// ===== –ù–û–í–´–ï –§–£–ù–ö–¶–ò–ò –ö–ê–ú–ï–†–´ v5.4 =====
let realCameraStream = null;
let realCameraMediaRecorder = null;
let realCameraRecordedChunks = [];
let currentRealFacingMode = 'user';
let isRealCameraRecording = false;

function openMediaSourceModal() {
    document.getElementById('mediaSourceModal').classList.add('active');
}

function closeMediaSourceModal() {
    document.getElementById('mediaSourceModal').classList.remove('active');
}

async function openRealCamera(facingMode) {
    closeMediaSourceModal();
    currentRealFacingMode = facingMode;

    // On iOS, try native file input with capture first for better compatibility
    const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
    
    if (isIOS) {
        // Use native camera via file input - much more reliable on iOS
        if (facingMode === 'user') {
            document.getElementById('cameraFileInputSelfie').click();
        } else {
            document.getElementById('cameraFileInput').click();
        }
        return;
    }

    try {
        const constraints = {
            video: {
                facingMode: facingMode,
                width: { ideal: 1920 },
                height: { ideal: 1080 }
            },
            audio: true
        };

        realCameraStream = await navigator.mediaDevices.getUserMedia(constraints);
        const video = document.getElementById('cameraPreview');
        video.srcObject = realCameraStream;
        document.getElementById('realCameraModal').classList.add('active');

        // Show switch button only on mobile
        const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
        document.getElementById('cameraSwitchBtn').style.display = isMobile ? 'inline-flex' : 'none';

        logSecurityEvent('–ö–∞–º–µ—Ä–∞ –æ—Ç–∫—Ä—ã—Ç–∞ (—Ä–µ–∂–∏–º: ' + facingMode + ')', 'info');
        showNotification('üì∑ –ö–∞–º–µ—Ä–∞ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞', 'success');
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ:', error);
        // Fallback: use file input
        if (facingMode === 'user') {
            document.getElementById('cameraFileInputSelfie').click();
        } else {
            document.getElementById('cameraFileInput').click();
        }
        logSecurityEvent('–ö–∞–º–µ—Ä–∞ fallback –Ω–∞ —Ñ–∞–π–ª: ' + error.message, 'info');
    }
}

async function openScreenCapture() {
    closeMediaSourceModal();

    try {
        realCameraStream = await navigator.mediaDevices.getDisplayMedia({
            video: {
                cursor: "always",
                width: { ideal: 1920 },
                height: { ideal: 1080 }
            },
            audio: true
        });

        const video = document.getElementById('cameraPreview');
        video.srcObject = realCameraStream;
        document.getElementById('realCameraModal').classList.add('active');
        document.getElementById('cameraSwitchBtn').style.display = 'none';

        logSecurityEvent('–ó–∞—Ö–≤–∞—Ç —ç–∫—Ä–∞–Ω–∞ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω', 'info');
        showNotification('üñ•Ô∏è –ó–∞—Ö–≤–∞—Ç —ç–∫—Ä–∞–Ω–∞ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω', 'success');
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞—Ö–≤–∞—Ç–∞ —ç–∫—Ä–∞–Ω–∞:', error);
        showNotification('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞—Ö–≤–∞—Ç–∏—Ç—å —ç–∫—Ä–∞–Ω', 'error');
        logSecurityEvent('–û—à–∏–±–∫–∞ –∑–∞—Ö–≤–∞—Ç–∞ —ç–∫—Ä–∞–Ω–∞: ' + error.message, 'error');
    }
}

function switchCameraReal() {
    closeCameraReal();
    currentRealFacingMode = currentRealFacingMode === 'user' ? 'environment' : 'user';
    openRealCamera(currentRealFacingMode);
}

function capturePhotoReal() {
    const video = document.getElementById('cameraPreview');
    const canvas = document.createElement('canvas');
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(video, 0, 0);

    // –ü—Ä—è–º–∞—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –≤ base64 –±–µ–∑ blob URL
    const base64data = canvas.toDataURL('image/jpeg', 0.95);
    
    // –í—ã—á–∏—Å–ª—è–µ–º —Ä–∞–∑–º–µ—Ä
    const sizeInBytes = Math.round((base64data.length - 'data:image/jpeg;base64,'.length) * 3/4);
    const fileSize = sizeInBytes > 1024 * 1024 ? 
        (sizeInBytes / (1024 * 1024)).toFixed(2) + ' MB' : 
        (sizeInBytes / 1024).toFixed(2) + ' KB';
    
    sendMediaMessageDirect(base64data, 'photo', fileSize);
    closeCameraReal();
    showNotification('üì∏ –§–æ—Ç–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ', 'success');
    logSecurityEvent('–°–¥–µ–ª–∞–Ω–æ —Ñ–æ—Ç–æ —á–µ—Ä–µ–∑ –∫–∞–º–µ—Ä—É', 'info');
}

function startVideoRecordingReal() {
    if (!realCameraStream) return;

    realCameraRecordedChunks = [];

    try {
        const options = {
            mimeType: 'video/webm;codecs=vp9',
            videoBitsPerSecond: 2500000
        };

        if (!MediaRecorder.isTypeSupported(options.mimeType)) {
            options.mimeType = 'video/webm';
        }

        realCameraMediaRecorder = new MediaRecorder(realCameraStream, options);

        realCameraMediaRecorder.ondataavailable = event => {
            if (event.data.size > 0) {
                realCameraRecordedChunks.push(event.data);
            }
        };

        realCameraMediaRecorder.onstop = () => {
            const blob = new Blob(realCameraRecordedChunks, { type: 'video/webm' });
            
            // –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è blob –≤ base64
            const reader = new FileReader();
            reader.onloadend = function() {
                const base64data = reader.result;
                const fileSize = blob.size > 1024 * 1024 ? 
                    (blob.size / (1024 * 1024)).toFixed(2) + ' MB' : 
                    (blob.size / 1024).toFixed(2) + ' KB';
                
                sendMediaMessageDirect(base64data, 'video', fileSize);
                closeCameraReal();
                showNotification('üé• –í–∏–¥–µ–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ', 'success');
            };
            reader.readAsDataURL(blob);
        };

        realCameraMediaRecorder.start();
        isRealCameraRecording = true;
        document.getElementById('cameraRecordingIndicator').classList.add('active');
        document.getElementById('cameraRecordBtn').style.display = 'none';
        document.getElementById('cameraStopBtn').style.display = 'inline-flex';

        logSecurityEvent('–ù–∞—á–∞—Ç–∞ –∑–∞–ø–∏—Å—å –≤–∏–¥–µ–æ', 'info');
        showNotification('üé• –ó–∞–ø–∏—Å—å –Ω–∞—á–∞–ª–∞—Å—å', 'info');
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∏ –≤–∏–¥–µ–æ:', error);
        showNotification('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞—á–∞—Ç—å –∑–∞–ø–∏—Å—å –≤–∏–¥–µ–æ', 'error');
        logSecurityEvent('–û—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∏ –≤–∏–¥–µ–æ: ' + error.message, 'error');
    }
}

function stopVideoRecordingReal() {
    if (realCameraMediaRecorder && isRealCameraRecording) {
        realCameraMediaRecorder.stop();
        isRealCameraRecording = false;
        document.getElementById('cameraRecordingIndicator').classList.remove('active');
        document.getElementById('cameraRecordBtn').style.display = 'inline-flex';
        document.getElementById('cameraStopBtn').style.display = 'none';

        logSecurityEvent('–ó–∞–ø–∏—Å—å –≤–∏–¥–µ–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∞', 'info');
    }
}

function closeCameraReal() {
    if (isRealCameraRecording) {
        stopVideoRecordingReal();
    }

    if (realCameraStream) {
        realCameraStream.getTracks().forEach(track => track.stop());
        realCameraStream = null;
    }

    document.getElementById('realCameraModal').classList.remove('active');
    document.getElementById('cameraRecordBtn').style.display = 'inline-flex';
    document.getElementById('cameraStopBtn').style.display = 'none';
}

function openFileUpload() {
    closeMediaSourceModal();
    document.getElementById('cameraFileInputGallery').click();
}

function handleFileUpload(event) {
    const files = event.target.files;
    if (files.length === 0) return;

    for (let file of files) {
        const reader = new FileReader();
        reader.onload = e => {
            if (file.type.startsWith('image/')) {
                sendMediaMessage(e.target.result, 'photo');
                showNotification('üì∑ –§–æ—Ç–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ', 'success');
            } else if (file.type.startsWith('video/')) {
                sendMediaMessage(e.target.result, 'video');
                showNotification('üé• –í–∏–¥–µ–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ', 'success');
            }
        };
        reader.readAsDataURL(file);
    }

    event.target.value = '';
    logSecurityEvent('–§–∞–π–ª—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã: ' + files.length, 'info');
}

async function sendMediaMessageDirect(base64data, mediaType, fileSize) {
    if (!currentChat) {
        showNotification('‚ùå –°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç', 'error');
        return;
    }
    
    const timestamp = Date.now();
    const mediaId = String(timestamp); // —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∫–ª—é—á –≤ IndexedDB

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –º–µ–¥–∏–∞—Ñ–∞–π–ª –≤ IndexedDB (–±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π –ø–æ —Ä–∞–∑–º–µ—Ä—É)
    try {
        await saveMediaToIDB(mediaId, base64data, mediaType === 'photo' ? 'image' : 'video', currentChat.id);
    } catch(e) {
        console.warn('IndexedDB –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞, fallback –≤ –ø–∞–º—è—Ç—å:', e);
        // –î–∞–∂–µ –µ—Å–ª–∏ IndexedDB –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª ‚Äî –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º, –¥–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –≤ –ø–∞–º—è—Ç–∏
    }

    const message = {
        id: timestamp,
        sender: 'me',
        text: '',
        time: new Date(timestamp).toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' }),
        timestamp: timestamp,
        type: mediaType === 'photo' ? 'image' : 'video',
        fileName: mediaType === 'photo' ? 'photo_' + timestamp + '.jpg' : 'video_' + timestamp + '.webm',
        fileSize: fileSize,
        mediaId: mediaId,   // –∫–ª—é—á –≤ IndexedDB
        fileData: base64data, // –≤ –ø–∞–º—è—Ç–∏ –¥–ª—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è (–Ω–µ –≤ localStorage)
        reactions: {}
    };

    if (!currentChat.messages) currentChat.messages = [];
    currentChat.messages.push(message);
    currentChat.lastMessage = mediaType === 'photo' ? 'üì∑ –§–æ—Ç–æ' : 'üé• –í–∏–¥–µ–æ';
    currentChat.lastMessageTime = timestamp;

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage –ë–ï–ó fileData (—Ç–æ–ª—å–∫–æ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ + mediaId)
    const msgKey = `quantum_messages_${currentChat.id}`;
    let storedMsgs = [];
    try { storedMsgs = JSON.parse(localStorage.getItem(msgKey) || '[]'); } catch(e) { storedMsgs = []; }
    const msgToStore = Object.assign({}, message, { fileData: null }); // –Ω–µ –¥—É–±–ª–∏—Ä—É–µ–º base64 –≤ localStorage
    storedMsgs.push(msgToStore);
    try { localStorage.setItem(msgKey, JSON.stringify(storedMsgs)); } catch(storageErr) {
        console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ localStorage:', storageErr);
    }

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –º–µ–¥–∏–∞-–≥–∞–ª–µ—Ä–µ—é —á–∞—Ç–∞ (–º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –±–µ–∑ fileData)
    const mediaKey = `quantum_media_${currentChat.id}`;
    let mediaGallery = [];
    try { mediaGallery = JSON.parse(localStorage.getItem(mediaKey) || '[]'); } catch(e) { mediaGallery = []; }
    mediaGallery.push({
        id: timestamp,
        mediaId: mediaId,
        type: mediaType === 'photo' ? 'image' : 'video',
        fileName: message.fileName,
        fileSize: fileSize,
        time: message.time,
        date: new Date(timestamp).toLocaleDateString('ru-RU')
    });
    try { localStorage.setItem(mediaKey, JSON.stringify(mediaGallery)); } catch(e) {}

    saveToLocalStorage();
    
    loadMessages(currentChat.id);
    renderChats();
    if (typeof soundSendMessage === 'function') soundSendMessage();
    
    // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –≤–Ω–∏–∑
    setTimeout(() => {
        const messagesArea = document.getElementById('messagesArea');
        if (messagesArea) messagesArea.scrollTop = messagesArea.scrollHeight;
    }, 100);
}

function sendMediaMessage(mediaUrl, mediaType) {
    if (!currentChat) {
        showNotification('‚ùå –°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç', 'error');
        return;
    }

    // –ï—Å–ª–∏ —ç—Ç–æ —É–∂–µ base64 (–∏–∑ handleFileUpload)
    if (mediaUrl.startsWith('data:')) {
        // –í—ã—á–∏—Å–ª—è–µ–º —Ä–∞–∑–º–µ—Ä –∏–∑ base64
        const base64str = mediaUrl.split(',')[1];
        const sizeInBytes = Math.round(base64str.length * 3/4);
        const fileSize = sizeInBytes > 1024 * 1024 ? 
            (sizeInBytes / (1024 * 1024)).toFixed(2) + ' MB' : 
            (sizeInBytes / 1024).toFixed(2) + ' KB';
        
        sendMediaMessageDirect(mediaUrl, mediaType, fileSize);
        return;
    }

    // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º blob URL –≤ base64
    fetch(mediaUrl)
        .then(res => res.blob())
        .then(blob => {
            const reader = new FileReader();
            reader.onloadend = function() {
                const base64data = reader.result;
                const fileSize = blob.size > 1024 * 1024 ? 
                    (blob.size / (1024 * 1024)).toFixed(2) + ' MB' : 
                    (blob.size / 1024).toFixed(2) + ' KB';
                
                sendMediaMessageDirect(base64data, mediaType, fileSize);
            };
            reader.readAsDataURL(blob);
        })
        .catch(err => {
            console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –º–µ–¥–∏–∞:', err);
            showNotification('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –º–µ–¥–∏–∞', 'error');
        });
}

    </script>


    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ: –ß—ë—Ä–Ω—ã–π —Å–ø–∏—Å–æ–∫ -->
    <div id="blacklistModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">üö´ –ß—ë—Ä–Ω—ã–π —Å–ø–∏—Å–æ–∫</div>
                <button class="close-modal" onclick="closeModal('blacklistModal')">√ó</button>
            </div>
            <div style="padding: 10px 0; color: var(--text-secondary); font-size: 13px; margin-bottom: 15px;">
                –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –º–æ–≥—É—Ç –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –≤–∞–º —Å–æ–æ–±—â–µ–Ω–∏—è.
            </div>
            <div id="blacklistContainer" style="max-height: 350px; overflow-y: auto;">
                <!-- –°–ø–∏—Å–æ–∫ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫ –∑–∞–≥—Ä—É–∑–∏—Ç—Å—è —á–µ—Ä–µ–∑ JS -->
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ: –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏/—É–¥–∞–ª–µ–Ω–∏—è -->
    <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —á–∞—Ç–µ -->
    <!-- –ü—Ä–æ—Å–º–æ—Ç—Ä —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –≥—Ä—É–ø–ø—ã -->
    <div id="viewMembersModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">üë• –£—á–∞—Å—Ç–Ω–∏–∫–∏ –≥—Ä—É–ø–ø—ã</div>
                <button class="close-modal" onclick="closeModal('viewMembersModal')">√ó</button>
            </div>
            <div id="membersListContent" style="padding: 10px 0; max-height: 400px; overflow-y: auto;">
            </div>
            <div class="action-buttons" style="margin-top: 20px;">
                <button class="action-btn action-btn-primary" onclick="closeModal('viewMembersModal')" style="width: 100%;">
                    <i class="fas fa-check"></i> –ó–∞–∫—Ä—ã—Ç—å
                </button>
            </div>
        </div>
    </div>


    <div id="chatInfoModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">‚ÑπÔ∏è –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</div>
                <button class="close-modal" onclick="closeModal('chatInfoModal')">√ó</button>
            </div>
            <div id="chatInfoContent" style="padding: 10px 0; max-height: 500px; overflow-y: auto;">
            </div>
            <div class="action-buttons" style="margin-top: 20px;">
                <button class="action-btn action-btn-primary" onclick="closeModal('chatInfoModal')" style="width: 100%;">
                    <i class="fas fa-check"></i> –ó–∞–∫—Ä—ã—Ç—å
                </button>
            </div>
        </div>
    </div>


    <div id="confirmActionModal" class="modal">
        <div class="modal-content" style="max-width: 380px;">
            <div class="modal-header">
                <div class="modal-title" id="confirmActionTitle">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –¥–µ–π—Å—Ç–≤–∏–µ</div>
                <button class="close-modal" onclick="closeModal('confirmActionModal')">√ó</button>
            </div>
            <p id="confirmActionText" style="color:var(--text-secondary);margin-bottom:20px;font-size:14px;line-height:1.6;"></p>
            <div class="action-buttons" style="margin-top:10px;">
                <button class="action-btn action-btn-secondary" onclick="closeModal('confirmActionModal')">
                    <i class="fas fa-times"></i> –û—Ç–º–µ–Ω–∞
                </button>
                <button class="action-btn" id="confirmActionBtn" style="flex:1;padding:15px;border:none;border-radius:15px;cursor:pointer;font-weight:600;font-size:15px;display:flex;align-items:center;justify-content:center;gap:10px;">
                    –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å
                </button>
            </div>
        </div>
    </div>


    <!-- ===== –ú–û–î–ê–õ: –£–ü–†–ê–í–õ–ï–ù–ò–ï –£–ß–ê–°–¢–ù–ò–ö–ê–ú–ò –ì–†–£–ü–ü–´ v4.3 ===== -->
    <div id="groupMembersManageModal" class="modal">
        <div class="modal-content" style="max-width:460px;">
            <div class="modal-header">
                <div class="modal-title">üë• –£—á–∞—Å—Ç–Ω–∏–∫–∏ –≥—Ä—É–ø–ø—ã</div>
                <button class="close-modal" onclick="closeModal('groupMembersManageModal')">√ó</button>
            </div>
            <div id="groupMembersManageContent" style="padding:10px 0;max-height:500px;overflow-y:auto;">
            </div>
            <div class="action-buttons" style="margin-top:15px;">
                <button class="action-btn action-btn-primary" onclick="closeModal('groupMembersManageModal')" style="width:100%;">
                    <i class="fas fa-check"></i> –ó–∞–∫—Ä—ã—Ç—å
                </button>
            </div>
        </div>
    </div>

    <!-- ===== –ú–ï–î–ò–ê-–ì–ê–õ–ï–†–ï–Ø ===== -->
    <div id="mediaGalleryModal" class="media-gallery-modal">
        <div class="media-gallery-container">
            <div class="media-gallery-header">
                <div class="media-gallery-title">üìÅ –ú–µ–¥–∏–∞—Ñ–∞–π–ª—ã</div>
                <button style="background:none;border:none;color:var(--text-secondary);cursor:pointer;font-size:22px;" onclick="closeMediaGallery()">√ó</button>
            </div>
            <div class="media-gallery-tabs">
                <button class="media-gallery-tab active" onclick="switchGalleryTab('all')" id="galleryTabAll">–í—Å–µ</button>
                <button class="media-gallery-tab" onclick="switchGalleryTab('photo')" id="galleryTabPhoto">üì∑ –§–æ—Ç–æ</button>
                <button class="media-gallery-tab" onclick="switchGalleryTab('video')" id="galleryTabVideo">üé• –í–∏–¥–µ–æ</button>
            </div>
            <div class="media-gallery-grid" id="mediaGalleryGrid"></div>
            <div class="media-gallery-count" id="mediaGalleryCount"></div>
        </div>
    </div>

    <!-- –ü–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä -->
    <div id="mediaFullscreen" class="media-fullscreen" onclick="closeMediaFullscreen()">
        <button class="media-fullscreen-close" onclick="closeMediaFullscreen()">√ó</button>
        <img id="mediaFullscreenImg" src="" alt="" style="display:none;">
        <video id="mediaFullscreenVideo" controls style="max-width:90vw;max-height:80vh;border-radius:12px;display:none;"></video>
    </div>

</body>
    <script>
    // ===== –ú–ï–î–ò–ê-–ì–ê–õ–ï–†–ï–Ø v5.5 =====
    let galleryCurrentFilter = 'all';

    function openMediaGallery() {
        if (!currentChat) {
            showNotification('‚ùå –°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç', 'error');
            return;
        }
        galleryCurrentFilter = 'all';
        document.querySelectorAll('.media-gallery-tab').forEach(t => t.classList.remove('active'));
        document.getElementById('galleryTabAll').classList.add('active');
        renderMediaGallery();
        document.getElementById('mediaGalleryModal').classList.add('active');
    }

    function closeMediaGallery() {
        document.getElementById('mediaGalleryModal').classList.remove('active');
    }

    function switchGalleryTab(filter) {
        galleryCurrentFilter = filter;
        document.querySelectorAll('.media-gallery-tab').forEach(t => t.classList.remove('active'));
        const tabMap = { all: 'galleryTabAll', photo: 'galleryTabPhoto', video: 'galleryTabVideo' };
        const tabEl = document.getElementById(tabMap[filter]);
        if (tabEl) tabEl.classList.add('active');
        renderMediaGallery();
    }

    async function renderMediaGallery() {
        if (!currentChat) return;
        const grid = document.getElementById('mediaGalleryGrid');
        const countEl = document.getElementById('mediaGalleryCount');

        // –ó–∞–≥—Ä—É–∂–∞–µ–º –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –∏–∑ localStorage
        let galleryItems = [];
        const mediaKey = `quantum_media_${currentChat.id}`;
        try {
            const stored = localStorage.getItem(mediaKey);
            if (stored) galleryItems = JSON.parse(stored);
        } catch(e) { galleryItems = []; }

        // –¢–∞–∫–∂–µ –ø—Ä–æ–≤–µ—Ä—è–µ–º –∏—Å—Ç–æ—Ä–∏—é —Å–æ–æ–±—â–µ–Ω–∏–π (–¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å–æ —Å—Ç–∞—Ä—ã–º–∏ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏)
        const msgKey = `quantum_messages_${currentChat.id}`;
        try {
            const msgs = JSON.parse(localStorage.getItem(msgKey) || '[]');
            msgs.forEach(msg => {
                if ((msg.type === 'image' || msg.type === 'video') && msg.mediaId) {
                    const alreadyAdded = galleryItems.find(g => String(g.id) === String(msg.id));
                    if (!alreadyAdded) {
                        galleryItems.push({
                            id: msg.id,
                            mediaId: msg.mediaId,
                            type: msg.type === 'image' ? 'image' : 'video',
                            fileName: msg.fileName || '',
                            fileSize: msg.fileSize || '',
                            time: msg.time || '',
                            date: msg.timestamp ? new Date(msg.timestamp).toLocaleDateString('ru-RU') : ''
                        });
                    }
                }
            });
        } catch(e) {}

        // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ id (–Ω–æ–≤—ã–µ —Å–Ω–∞—á–∞–ª–∞)
        galleryItems.sort((a, b) => (b.id || 0) - (a.id || 0));

        // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è
        let filtered = galleryItems;
        if (galleryCurrentFilter === 'photo') {
            filtered = galleryItems.filter(i => i.type === 'image');
        } else if (galleryCurrentFilter === 'video') {
            filtered = galleryItems.filter(i => i.type === 'video');
        }

        countEl.textContent = `${filtered.length} —Ñ–∞–π–ª(–æ–≤) ‚Ä¢ –í—Å–µ–≥–æ: ${galleryItems.length}`;

        if (filtered.length === 0) {
            grid.innerHTML = `<div class="media-gallery-empty" style="grid-column:1/-1">
                <i class="fas fa-photo-video"></i>
                <span>–ú–µ–¥–∏–∞—Ñ–∞–π–ª–æ–≤ –Ω–µ—Ç</span>
                <span style="font-size:12px;">–û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ –∏–ª–∏ –≤–∏–¥–µ–æ –≤ —á–∞—Ç</span>
            </div>`;
            return;
        }

        grid.innerHTML = '';
        for (const item of filtered) {
            const el = document.createElement('div');
            el.className = 'media-gallery-item';

            // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ IndexedDB
            let fileData = null;
            if (item.mediaId) {
                try { fileData = await getMediaFromIDB(item.mediaId); } catch(e) {}
            }
            if (!fileData && item.fileData) fileData = item.fileData; // fallback —Å—Ç–∞—Ä—ã—Ö –∑–∞–ø–∏—Å–µ–π

            const itemWithData = Object.assign({}, item, { fileData });

            if (item.type === 'image') {
                if (fileData) {
                    el.innerHTML = `
                        <img src="${fileData}" alt="${item.fileName || '—Ñ–æ—Ç–æ'}" loading="lazy" style="width:100%;height:100%;object-fit:cover;">
                        <div class="media-type-badge">üì∑</div>
                        <div class="media-date">${item.date || item.time || ''}</div>`;
                } else {
                    el.innerHTML = `
                        <div class="media-gallery-video-thumb">üñºÔ∏è</div>
                        <div class="media-type-badge">üì∑</div>
                        <div class="media-date">${item.date || item.time || ''}</div>`;
                }
                el.onclick = () => viewMediaFullscreen(itemWithData);
            } else {
                el.innerHTML = `
                    <div class="media-gallery-video-thumb">üé•</div>
                    <div class="media-type-badge">üé¨ ${item.fileSize || ''}</div>
                    <div class="media-date">${item.date || item.time || ''}</div>`;
                el.onclick = () => viewMediaFullscreen(itemWithData);
            }
            grid.appendChild(el);
        }
    }

    function viewMediaFullscreen(item) {
        const fs = document.getElementById('mediaFullscreen');
        const img = document.getElementById('mediaFullscreenImg');
        const vid = document.getElementById('mediaFullscreenVideo');
        
        img.style.display = 'none';
        vid.style.display = 'none';
        // –û—Å–≤–æ–±–æ–∂–¥–∞–µ–º —Å—Ç–∞—Ä—ã–π blob URL
        if (vid._blobUrl) { URL.revokeObjectURL(vid._blobUrl); vid._blobUrl = null; }
        
        if (item.type === 'image') {
            img.src = item.fileData || '';
            img.style.display = 'block';
        } else {
            if (item.fileData && item.fileData.startsWith('data:')) {
                // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º base64 ‚Üí blob URL –¥–ª—è –Ω–∞–¥—ë–∂–Ω–æ–≥–æ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è
                try {
                    const parts = item.fileData.split(',');
                    const mime = parts[0].match(/:(.*?);/)[1];
                    const bstr = atob(parts[1]);
                    const arr = new Uint8Array(bstr.length);
                    for (let i = 0; i < bstr.length; i++) arr[i] = bstr.charCodeAt(i);
                    const blob = new Blob([arr], { type: mime });
                    const blobUrl = URL.createObjectURL(blob);
                    vid._blobUrl = blobUrl;
                    vid.src = blobUrl;
                } catch(e) { vid.src = item.fileData; }
            } else {
                vid.src = item.fileData || '';
            }
            vid.style.display = 'block';
        }
        fs.classList.add('active');
    }

    function closeMediaFullscreen() {
        const fs = document.getElementById('mediaFullscreen');
        const vid = document.getElementById('mediaFullscreenVideo');
        vid.pause();
        if (vid._blobUrl) { URL.revokeObjectURL(vid._blobUrl); vid._blobUrl = null; }
        vid.src = '';
        fs.classList.remove('active');
    }
    </script>
</html>
